<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>36.4 Lowering CPU Overhead With Interrupts</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part369.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part371.htm">下一个 &gt;</a></p><p class="s40" style="padding-top: 2pt;padding-left: 38pt;text-indent: 0pt;text-align: left;">36.4 Lowering CPU Overhead With Interrupts</p><p style="padding-top: 7pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: right;">The invention that many engineers came upon years ago to improve this interaction is something we’ve seen already: the <b>interrupt</b>. Instead of polling the device repeatedly, the OS can issue a request, put the call- ing process to sleep, and context switch to another task. When the device is finally finished with the operation, it will raise a hardware interrupt, causing the CPU to jump into the OS at a pre-determined <b>interrupt ser- vice routine (ISR) </b>or more simply an <b>interrupt handler</b>. The handler is just a piece of operating system code that will finish the request (for ex- ample, by reading data and perhaps an error code from the device) and wake the process waiting for the I/O, which can then proceed as desired.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Interrupts thus allow for <b>overlap </b>of computation and I/O, which is key for improved utilization. This timeline shows the problem:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:15pt"><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s154" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">p</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s154" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">p</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s154" style="padding-top: 3pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">p</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s154" style="padding-top: 3pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">p</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s154" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">p</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td></tr><tr style="height:16pt"><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-right-style:solid;border-right-width:1pt" colspan="5"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 4pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 4pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt" colspan="5"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-left: 86pt;text-indent: 0pt;text-align: left;">CPU</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">Disk</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">In the diagram, Process 1 runs on the CPU for some time (indicated by a repeated <span class="s41">1 </span>on the CPU line), and then issues an I/O request to the disk to read some data. Without interrupts, the system simply spins, polling the status of the device repeatedly until the I/O is complete (indicated by a <span class="s41">p</span>). The disk services the request and finally Process 1 can run again.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">If instead we utilize interrupts and allow for overlap, the OS can do something else while waiting for the disk:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:15pt"><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt" bgcolor="#000000"><p class="s154" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:15pt" bgcolor="#000000"><p class="s154" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">2</p></td><td style="width:16pt" bgcolor="#000000"><p class="s154" style="padding-top: 3pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">2</p></td><td style="width:15pt" bgcolor="#000000"><p class="s154" style="padding-top: 3pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">2</p></td><td style="width:15pt" bgcolor="#000000"><p class="s154" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td></tr><tr style="height:15pt"><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-right-style:solid;border-right-width:1pt" colspan="5"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">1</p></td><td style="width:16pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;padding-right: 4pt;text-indent: 0pt;text-align: right;">1</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s96" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt" colspan="5"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-left: 86pt;text-indent: 0pt;text-align: left;">CPU</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">Disk</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: right;">In this example, the OS runs Process 2 on the CPU while the disk ser- vices Process 1’s request. When the disk request is finished, an interrupt occurs, and the OS wakes up Process 1 and runs it again. Thus, <i>both </i>the CPU and the disk are properly utilized during the middle stretch of time. Note that using interrupts is not <i>always </i>the best solution. For example, imagine a device that performs its tasks very quickly: the first poll usually finds the device to be done with task. Using an interrupt in this case will actually <i>slow down </i>the system: switching to another process, handling the interrupt, and switching back to the issuing process is expensive. Thus, if a device is fast, it may be best to poll; if it is slow, interrupts, which allow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: center;">T<span class="s7">IP</span>: I<span class="s7">NTERRUPTS </span>N<span class="s7">OT </span>A<span class="s7">LWAYS </span>B<span class="s7">ETTER </span>T<span class="s7">HAN </span>PIO</p><p style="padding-left: 9pt;text-indent: 0pt;line-height: 89%;text-align: justify;">Although interrupts allow for overlap of computation and I/O, they only really make sense for slow devices. Otherwise, the cost of interrupt han- dling and context switching may outweigh the benefits interrupts pro- vide. There are also cases where a flood of interrupts may overload a sys- tem and lead it to livelock [MR96]; in such cases, polling provides more control to the OS in its scheduling and thus is again useful.</p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"/><p style="padding-top: 1pt;padding-left: 41pt;text-indent: 0pt;line-height: 89%;text-align: justify;">overlap, are best. If the speed of the device is not known, or sometimes fast and sometimes slow, it may be best to use a <b>hybrid </b>that polls for a little while and then, if the device is not yet finished, uses interrupts. This <b>two-phased </b>approach may achieve the best of both worlds.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Another reason not to use interrupts arises in networks [MR96]. When a huge stream of incoming packets each generate an interrupt, it is pos- sible for the OS to <b>livelock</b>, that is, find itself only processing interrupts and never allowing a user-level process to run and actually service the requests. For example, imagine a web server that suddenly experiences a high load due to the “slashdot effect”. In this case, it is better to occa- sionally use polling to better control what is happening in the system and allow the web server to service some requests before going back to the device to check for more packet arrivals.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Another interrupt-based optimization is <b>coalescing</b>. In such a setup, a device which needs to raise an interrupt first waits for a bit before deliv- ering the interrupt to the CPU. While waiting, other requests may soon complete, and thus multiple interrupts can be coalesced into a single in- terrupt delivery, thus lowering the overhead of interrupt processing. Of course, waiting too long will increase the latency of a request, a common trade-off in systems. See Ahmad et al. [A+11] for an excellent summary.</p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part369.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part371.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
