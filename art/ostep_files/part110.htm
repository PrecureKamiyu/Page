<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>10.5 Multi-Queue Scheduling</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part109.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part111.htm">下一个 &gt;</a></p><p class="s40" style="padding-left: 11pt;text-indent: 0pt;text-align: left;">10.5 Multi-Queue Scheduling</p><p style="padding-top: 7pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Because of the problems caused in single-queue schedulers, some sys- tems opt for multiple queues, e.g., one per CPU. We call this approach <b>multi-queue multiprocessor scheduling </b>(or <b>MQMS</b>).</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: left;">In MQMS, our basic scheduling framework consists of multiple schedul- ing queues. Each queue will likely follow a particular scheduling disci- pline, such as round robin, though of course any algorithm can be used. When a job enters the system, it is placed on exactly one scheduling queue, according to some heuristic (e.g., random, or picking one with fewer jobs than others). Then it is scheduled essentially independently, thus avoiding the problems of information sharing and synchronization found in the single-queue approach.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">For example, assume we have a system where there are just two CPUs (labeled CPU 0 and CPU 1), and some number of jobs enter the system: <span class="s43">A</span>, <span class="s43">B</span>, <span class="s43">C</span>, and <span class="s43">D </span>for example. Given that each CPU has a scheduling queue now, the OS has to decide into which queue to place each job. It might do something like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_114.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">A</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">C</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_115.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-top: 3pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">Q0           Q1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Depending on the queue scheduling policy, each CPU now has two jobs to choose from when deciding what should run. For example, with <b>round robin</b>, the system might produce a schedule that looks like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-top: 3pt;padding-left: 39pt;text-indent: 0pt;text-align: left;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">CPU 1</p><p class="s77" style="padding-top: 4pt;padding-left: 39pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">C</p></td></tr><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:37pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:37pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:38pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">MQMS has a distinct advantage of SQMS in that it should be inher- ently more scalable. As the number of CPUs grows, so too does the num- ber of queues, and thus lock and cache contention should not become a central problem. In addition, MQMS intrinsically provides cache affinity;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: justify;">jobs stay on the same CPU and thus reap the advantage of reusing cached contents therein.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">But, if you’ve been paying attention, you might see that we have a new problem, which is fundamental in the multi-queue based approach: <b>load imbalance</b>. Let’s assume we have the same set up as above (four jobs, two CPUs), but then one of the jobs (say <span class="s43">C</span>) finishes. We now have the following scheduling queues:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="38" height="22" alt="image" src="Image_116.png"/></span></p><p class="s67" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">A</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_117.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Q0           Q1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: left;">If we then run our round-robin policy on each queue of the system, we will see this resulting schedule:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-top: 3pt;padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 1</p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td></tr><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:37pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:37pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:38pt" colspan="2" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-left: 54pt;text-indent: 0pt;text-align: center;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">As you can see from this diagram, <span class="s43">A </span>gets twice as much CPU as <span class="s43">B </span>and <span class="s43">D</span>, which is not the desired outcome. Even worse, let’s imagine that both <span class="s43">A </span>and <span class="s43">C </span>finish, leaving just jobs <span class="s43">B </span>and <span class="s43">D </span>in the system. The scheduling queues will look like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="15" height="5" alt="image" src="Image_118.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_119.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-left: 21pt;text-indent: 0pt;text-align: center;">Q0            Q1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 2pt;padding-left: 68pt;text-indent: 0pt;line-height: 11pt;text-align: left;">As a result, CPU 0 will be left idle! <i>(insert dramatic and sinister music here)</i></p><p style="padding-left: 68pt;text-indent: 0pt;line-height: 11pt;text-align: left;">And hence our CPU usage timeline looks sad:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:37pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:38pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:38pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s80" style="padding-top: 5pt;padding-left: 67pt;text-indent: 0pt;text-align: left;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-top: 3pt;padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 1</p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 12pt;line-height: 94%;text-align: justify;">So what should a poor multi-queue multiprocessor scheduler do? How can we overcome the insidious problem of load imbalance and defeat the evil forces of ... the Decepticons<span class="s35">1</span>? How do we stop asking questions that are hardly relevant to this otherwise wonderful book?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="154" height="1" alt="image" src="Image_120.png"/></span></p><p class="s11" style="padding-top: 2pt;padding-left: 68pt;text-indent: 13pt;line-height: 92%;text-align: justify;">1<span class="s12">Little known fact is that the home planet of Cybertron was destroyed by bad CPU scheduling decisions. And now let that be the first and last reference to Transformers in this book, for which we sincerely apologize.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 56pt;text-indent: 0pt;line-height: 11pt;text-align: left;">C<span class="s7">RUX</span>: H<span class="s7">OW </span>T<span class="s7">O </span>D<span class="s7">EAL </span>W<span class="s7">ITH </span>L<span class="s7">OAD </span>I<span class="s7">MBALANCE</span></p><p style="padding-left: 9pt;text-indent: 11pt;line-height: 89%;text-align: left;">How should a multi-queue multiprocessor scheduler handle load im- balance, so as to better achieve its desired scheduling goals?</p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 90%;text-align: justify;">The obvious answer to this query is to move jobs around, a technique which we (once again) refer to as <b>migration</b>. By migrating a job from one CPU to another, true load balance can be achieved.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Let’s look at a couple of examples to add some clarity. Once again, we have a situation where one CPU is idle and the other has some jobs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="15" height="5" alt="image" src="Image_121.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_122.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-top: 5pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">Q0            Q1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">In this case, the desired migration is easy to understand: the OS should simply move one of <span class="s43">B </span>or <span class="s43">D </span>to CPU 0. The result of this single job migra- tion is evenly balanced load and everyone is happy.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">A more tricky case arises in our earlier example, where <span class="s43">A </span>was left alone on CPU 0 and <span class="s43">B </span>and <span class="s43">D </span>were alternating on CPU 1:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="38" height="22" alt="image" src="Image_123.png"/></span></p><p class="s67" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">A</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="79" height="22" alt="image" src="Image_124.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-top: 3pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">Q0           Q1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">In this case, a single migration does not solve the problem. What would you do in this case? The answer, alas, is continuous migration of one or more jobs. One possible solution is to keep switching jobs, as we see in the following timeline. In the figure, first <span class="s43">A </span>is alone on CPU 0, and <span class="s43">B </span>and <span class="s43">D </span>alternate on CPU 1. After a few time slices, <span class="s43">B </span>is moved to compete with <span class="s43">A </span>on CPU 0, while <span class="s43">D </span>enjoys a few time slices alone on CPU</p><p style="padding-left: 41pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">1. And thus load is balanced:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-top: 3pt;padding-left: 39pt;text-indent: 0pt;text-align: left;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">CPU 1</p><p class="s77" style="padding-top: 4pt;padding-left: 39pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td></tr><tr style="height:19pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">B</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:18pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:18pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s81" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt" bgcolor="#000000"><p class="s82" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: right;">Of course, many other possible migration patterns exist. But now for the tricky part: how should the system decide to enact such a migration? One basic approach is to use a technique known as <b>work stealing </b>[FLR98]. With a work-stealing approach, a (source) queue that is low on jobs will occasionally peek at another (target) queue, to see how full it is. If the target queue is (notably) more full than the source queue, the source will “steal” one or more jobs from the target to help balance load. Of course, there is a natural tension in such an approach. If you look around at other queues too often, you will suffer from high overhead and have trouble scaling, which was the entire purpose of implementing the</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: justify;">multiple queue scheduling in the first place! If, on the other hand, you don’t look at other queues very often, you are in danger of suffering from severe load balances. Finding the right threshold remains, as is common in system policy design, a black art.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part109.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part111.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
