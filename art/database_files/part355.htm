<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>19.9  ARIES</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part354.htm">&lt; 上一个</a><span> | </span><a href="../database.html">内容</a><span> | </span><a href="part356.htm">下一个 &gt;</a></p><p class="s65" style="padding-left: 72pt;text-indent: 0pt;text-align: left;">19.9  <span style=" color: #00AEEF;">ARIES</span></p><p style="padding-top: 12pt;padding-left: 119pt;text-indent: 0pt;text-align: justify;">The state of the art in recovery methods is best illustrated by the <span class="s64">ARIES </span>recovery method. The recovery technique that we described in Section 19.4, along with the log- ical undo logging techniques described in Section 19.8, are modeled after <span class="s44">ARIES</span>, but they have been simpliﬁed signiﬁcantly to bring out key concepts and make them easier to understand. In contrast, <span class="s44">ARIES </span>uses a number of techniques to reduce the time taken for recovery and to reduce the overhead of checkpointing. In particular, <span class="s44">ARIES </span>is able to avoid redoing many logged operations that have already been applied and to reduce the amount of information logged. The price paid is greater complexity; the beneﬁts are worth the price.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">The four major diﬀerences between <span class="s44">ARIES </span>and the recovery algorithm presented earlier are that <span class="s44">ARIES</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 145pt;text-indent: -16pt;text-align: justify;"><span class="s63">1. </span>Uses a <span class="s63">log sequence number </span>(<span class="s64">LSN</span>) to identify log records and stores <span class="s44">LSN</span>s in database pages to identify which operations have been applied to a database page.</p><p class="s63" style="padding-top: 6pt;padding-left: 145pt;text-indent: -17pt;text-align: justify;">2. <span class="p">Supports </span>physiological redo <span class="p">operations, which are physical in that the aﬀected page is physically identiﬁed but can be logical within the page.</span></p><p style="padding-left: 145pt;text-indent: 17pt;text-align: justify;">For instance, the deletion of a record from a page may result in many other records in the page being shifted, if a slotted page structure (Section 13.2.2) is used. With physical redo logging, all bytes of the page aﬀected by the shifting of records must be logged. With physiological logging, the deletion operation can be logged, resulting in a much smaller log record. Redo of the deletion operation would delete the record and shift other records as required.</p><p class="s63" style="padding-top: 6pt;padding-left: 145pt;text-indent: -17pt;text-align: justify;">3. <span class="p">Uses a </span>dirty page table <span class="p">to minimize unnecessary redos during recovery. As men- tioned earlier, dirty pages are those that have been updated in memory, and the disk version is not up-to-date.</span></p><p class="s63" style="padding-top: 6pt;padding-left: 145pt;text-indent: -17pt;text-align: justify;">4. <span class="p">Uses a fuzzy-checkpointing scheme that records only information about dirty pages and associated information and does not even require writing of dirty pages to disk. It ﬂushes dirty pages in the background, continuously, instead of writing them during checkpoints.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: justify;">In the rest of this section, we provide an overview of <span class="s44">ARIES</span>. The bibliographical notes list some references that provide a complete description of <span class="s44">ARIES</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s68" style="padding-top: 4pt;padding-left: 88pt;text-indent: 0pt;text-align: left;">19.9.1 Data Structures</p><p style="padding-top: 6pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">Each log record in <span class="s44">ARIES </span>has a log sequence number (<span class="s44">LSN</span>) that uniquely identiﬁes the record. The number is conceptually just a logical identiﬁer whose value is greater for log records that occur later in the log. In practice, the <span class="s44">LSN </span>is generated in such a way that it can also be used to locate the log record on disk. Typically, <span class="s44">ARIES </span>splits a log into multiple log ﬁles, each of which has a ﬁle number. When a log ﬁle grows to some limit, <span class="s44">ARIES </span>appends further log records to a new log ﬁle; the new log ﬁle has a ﬁle number that is higher by 1 than the previous log ﬁle. The <span class="s44">LSN </span>then consists of a ﬁle number and an oﬀset within the ﬁle.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">Each page also maintains an identiﬁer called the <span class="s63">Page</span><span class="s82">LSN</span>. Whenever an update operation (whether physical or physiological) occurs on a page, the operation stores the <span class="s44">LSN </span>of its log record in the Page<span class="s44">LSN </span>ﬁeld of the page. During the redo phase of recovery, any log records with <span class="s44">LSN </span>less than or equal to the Page<span class="s44">LSN </span>of a page should not be executed on the page, since their actions are already reﬂected on the page. In combination with a scheme for recording Page<span class="s44">LSN</span>s as part of checkpointing, which we present later, <span class="s44">ARIES </span>can avoid even reading many pages for which logged operations are already reﬂected on disk. Thereby, recovery time is reduced signiﬁcantly.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">The Page<span class="s44">LSN </span>is essential for ensuring idempotence in the presence of physiological redo operations, since reapplying a physiological redo that has already been applied to a page could cause incorrect changes to a page.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">Pages should not be ﬂushed to disk while an update is in progress, since physio- logical operations cannot be redone on the partially updated state of the page on disk. Therefore, <span class="s44">ARIES </span>uses latches on buﬀer pages to prevent them from being written to disk while they are being updated. It releases the buﬀer page latch only after the update is completed and the log record for the update has been written to the log.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">Each log record also contains the <span class="s44">LSN </span>of the previous log record of the same trans- action. This value, stored in the Prev<span class="s44">LSN </span>ﬁeld, permits log records of a transaction to be fetched backward, without reading the whole log. There are special redo-only log records generated during transaction rollback, called <span class="s63">compensation log records </span>(<span class="s64">CLR</span><span class="s84">s</span>) in <span class="s44">ARIES</span>. These serve the same purpose as the redo-only log records in our earlier re- covery scheme. In addition, <span class="s44">CLR</span>s serve the role of the <span class="s49">operation-abort </span>log records in our scheme. The <span class="s44">CLR</span>s have an extra ﬁeld, called the UndoNext<span class="s44">LSN</span>, that records the <span class="s44">LSN </span>of the log that needs to be undone next, when the transaction is being rolled back. This ﬁeld serves the same purpose as the operation identiﬁer in the <span class="s49">operation-abort </span>log record in our earlier recovery scheme, which helps to skip over log records that have already been rolled back.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">The <span class="s63">DirtyPageTable </span>contains a list of pages that have been updated in the database buﬀer. For each page, it stores the Page<span class="s44">LSN </span>and a ﬁeld called the Rec<span class="s44">LSN</span>, which helps identify log records that have been applied already to the version of the page on disk. When a page is inserted into the DirtyPageTable (when it is ﬁrst modiﬁed in the buﬀer pool), the value of Rec<span class="s44">LSN </span>is set to the current end of log. Whenever the page is ﬂushed to disk, the page is removed from the DirtyPageTable.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 119pt;text-indent: 17pt;text-align: justify;">A <span class="s63">checkpoint log record </span>contains the DirtyPageTable and a list of active transac- tions. For each transaction, the checkpoint log record also notes Last<span class="s44">LSN</span>, the <span class="s44">LSN </span>of the last log record written by the transaction. A ﬁxed position on disk also notes the <span class="s44">LSN </span>of the last (complete) checkpoint log record.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">Figure 19.9 illustrates some of the data structures used in <span class="s44">ARIES</span>. The log records shown in the ﬁgure are preﬁxed by their <span class="s44">LSN</span>; these may not be explicitly stored, but inferred from the position in the log, in an actual implementation. The data item iden- tiﬁer in a log record is shown in two parts, for example, 4894.1; the ﬁrst identiﬁes the page, and the second part identiﬁes a record within the page (we assume a slotted page record organization within a page). Note that the log is shown with the newest records on top, since older log records, which are on disk, are shown lower in the ﬁgure.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">Each page (whether in the buﬀer or on disk) has an associated Page<span class="s44">LSN </span>ﬁeld. You can verify that the <span class="s44">LSN </span>for the last log record that updated page 4894 is 7567. By com- paring Page<span class="s44">LSN</span>s for the pages in the buﬀer with the Page<span class="s44">LSN</span>s for the corresponding pages in stable storage, you can observe that the DirtyPageTable contains entries for all pages in the buﬀer that have been modiﬁed since they were fetched from stable stor- age. The Rec<span class="s44">LSN </span>entry in the DirtyPageTable reﬂects the <span class="s44">LSN </span>at the end of the log</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:318.723pt" cellspacing="0"><tr style="height:14pt"><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 1pt;text-indent: 0pt;text-align: center;">PageID</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 2pt;padding-right: 1pt;text-indent: 0pt;text-align: center;">PageLSN</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-right: 2pt;text-indent: 0pt;text-align: center;">RecLSN</p></td></tr><tr style="height:12pt"><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-top: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4894</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-top: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">7567</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-top: 1pt;padding-left: 3pt;padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: center;">7564</p></td></tr><tr style="height:13pt"><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-left: 2pt;text-indent: 0pt;text-align: center;">7200</p></td><td style="width:44pt;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;text-align: center;">7565</p></td><td style="width:39pt;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#FFFFFF"><p class="s456" style="padding-left: 4pt;padding-right: 2pt;text-indent: 0pt;text-align: center;">7565</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><span><img width="161" height="62" alt="image" src="Image_3078.png"/></span></p><p class="s449" style="padding-top: 1pt;padding-left: 1pt;text-indent: 0pt;line-height: 12pt;text-align: left;">7566: &lt;T<span class="s457">143</span>, commit&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 1pt;text-indent: 0pt;text-align: left;">7567: &lt;T<span class="s457">145</span>,4894.1, 40, 60&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="178" height="139" alt="image" src="Image_3079.png"/></span></p><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">7567</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">2345</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">Page 4894</p><p class="s449" style="padding-top: 8pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">7565</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">Page 9923</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">Page 7200</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="154" height="52" alt="image" src="Image_3080.png"/></span></p><p class="s275" style="padding-top: 3pt;padding-left: 318pt;text-indent: 0pt;text-align: left;">Dirty Page Table</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s275" style="padding-top: 2pt;padding-left: 119pt;text-indent: 0pt;text-align: right;">Database Buffer</p><p class="s275" style="padding-top: 2pt;padding-left: 119pt;text-indent: 0pt;text-align: right;">Log Buffer</p><p class="s449" style="padding-top: 1pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">(PrevLSN and UndoNextLSN fields not shown)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 123pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="482" height="1" alt="image" src="Image_3081.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="177" height="170" alt="image" src="Image_3082.png"/></span></p><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">Page 4894  Page 7200</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">Page 9923</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">2345</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">4404</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">4566</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="173" height="133" alt="image" src="Image_3083.png"/></span></p><p class="s449" style="padding-top: 1pt;padding-left: 1pt;text-indent: 0pt;text-align: left;">7563: &lt;T<span class="s457">145</span>begin&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 2pt;padding-left: 1pt;text-indent: 0pt;text-align: left;">7564: &lt;T<span class="s457">145</span>,4894.1, 20, 40&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">7565: &lt;T<span class="s457">143</span>,7200.2, 60, 80&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s458" style="padding-top: 4pt;padding-bottom: 1pt;padding-left: 142pt;text-indent: 0pt;text-align: left;">Stable data                <span class="s275">Stable log</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-top: 4pt;padding-left: 212pt;text-indent: 0pt;text-align: left;"><span class="s73">Figure 19.9 </span>Data structures used in <span class="s157">ARIES</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">when the page was added to DirtyPageTable and would be greater than or equal to the Page<span class="s44">LSN </span>for that page on stable storage.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s68" style="padding-left: 88pt;text-indent: 0pt;text-align: justify;">19.9.2 Recovery Algorithm</p><p class="s42" style="padding-top: 6pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">ARIES <span class="s43">recovers from a system crash in three passes.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 107pt;text-indent: -16pt;text-align: justify;"><span class="s39">• </span><span class="s63">Analysis pass</span>: This pass determines which transactions to undo, which pages were dirty at the time of the crash, and the <span class="s44">LSN </span>from which the redo pass should start.</p><p class="s39" style="padding-top: 4pt;padding-left: 107pt;text-indent: -16pt;text-align: justify;">• <span class="s63">Redo pass</span><span class="p">: This pass starts from a position determined during analysis and per- forms a redo, repeating history, to bring the database to a state it was in before the crash.</span></p><p class="s39" style="padding-top: 4pt;padding-left: 107pt;text-indent: -16pt;text-align: justify;">• <span class="s63">Undo pass</span><span class="p">: This pass rolls back all transactions that were incomplete at the time of crash.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s183" style="padding-left: 88pt;text-indent: 0pt;text-align: justify;">19.9.2.1 Analysis Pass</p><p style="padding-top: 6pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">The analysis pass ﬁnds the last complete checkpoint log record and reads in the Dirty- PageTable from this record. It then sets Redo<span class="s44">LSN </span>to the minimum of the Rec<span class="s44">LSN</span>s of the pages in the DirtyPageTable. If there are no dirty pages, it sets Redo<span class="s44">LSN </span>to the <span class="s44">LSN </span>of the checkpoint log record. The redo pass starts its scan of the log from Redo<span class="s44">LSN</span>. All the log records earlier than this point have already been applied to the database pages on disk. The analysis pass initially sets the list of transactions to be undone, undo-list, to the list of transactions in the checkpoint log record. The analysis pass also reads from the checkpoint log record the <span class="s44">LSN</span>s of the last log record for each transaction in undo-list.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">The analysis pass continues scanning forward from the checkpoint. Whenever it ﬁnds a log record for a transaction not in the undo-list, it adds the transaction to undo- list. Whenever it ﬁnds a transaction end log record, it deletes the transaction from undo-list. All transactions left in undo-list at the end of analysis have to be rolled back later, in the undo pass. The analysis pass also keeps track of the last record of each transaction in undo-list, which is used in the undo pass.</p><p style="padding-left: 88pt;text-indent: 17pt;text-align: justify;">The analysis pass also updates DirtyPageTable whenever it ﬁnds a log record for an update on a page. If the page is not in DirtyPageTable, the analysis pass adds it to DirtyPageTable and sets the Rec<span class="s44">LSN </span>of the page to the <span class="s44">LSN </span>of the log record.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s183" style="padding-left: 88pt;text-indent: 0pt;text-align: justify;">19.9.2.2 Redo Pass</p><p style="padding-top: 6pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">The redo pass repeats history by replaying every action that is not already reﬂected in the page on disk. The redo pass scans the log forward from Redo<span class="s44">LSN</span>. Whenever it ﬁnds an update log record, it takes this action:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 4pt;padding-left: 139pt;text-indent: -16pt;text-align: justify;"><span class="s39">• </span>If the page is not in DirtyPageTable or if the <span class="s41">LSN </span>of the update log record is less than the Rec<span class="s41">LSN </span>of the page in DirtyPageTable, then the redo pass skips the log record.</p><p class="s40" style="padding-top: 4pt;padding-left: 139pt;text-indent: -16pt;text-align: justify;"><span class="s39">• </span>Otherwise the redo pass fetches the page from disk, and if the Page<span class="s41">LSN </span>is less than the <span class="s41">LSN </span>of the log record, it redoes the log record.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">Note that if either of the tests is negative, then the eﬀects of the log record have already appeared on the page; otherwise the eﬀects of the log record are not reﬂected on the page. Since <span class="s44">ARIES </span>allows non-idempotent physiological log records, a log record should not be redone if its eﬀect is already reﬂected on the page. If the ﬁrst test is negative, it is not even necessary to fetch the page from disk to check its Page<span class="s44">LSN</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s183" style="padding-left: 119pt;text-indent: 0pt;text-align: justify;">19.9.2.3 Undo Pass and Transaction Rollback</p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: justify;">The undo pass is relatively straightforward. It performs a single backward scan of the log, undoing all transactions in undo-list. The undo pass examines only log records of transactions in undo-list; the last <span class="s44">LSN </span>recorded during the analysis pass is used to ﬁnd the last log record for each transaction in undo-list.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">Whenever an update log record is found, it is used to perform an undo (whether for transaction rollback during normal processing, or during the restart undo pass). The undo pass generates a <span class="s44">CLR </span>containing the undo action performed (which must be physiological). It sets the UndoNext<span class="s44">LSN </span>of the <span class="s44">CLR </span>to the Prev<span class="s44">LSN </span>value of the update log record.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">If a <span class="s44">CLR </span>is found, its UndoNext<span class="s44">LSN </span>value indicates the <span class="s44">LSN </span>of the next log record to be undone for that transaction; later log records for that transaction have already been rolled back. For log records other than <span class="s44">CLR</span>s, the Prev<span class="s44">LSN </span>ﬁeld of the log record indicates the <span class="s44">LSN </span>of the next log record to be undone for that transaction. The next log record to be processed at each stop in the undo pass is the maximum, across all transactions in undo-list, of next log record <span class="s44">LSN</span>.</p><p style="padding-left: 119pt;text-indent: 17pt;text-align: justify;">Figure 19.10 illustrates the recovery actions performed by <span class="s44">ARIES </span>on an example log. We assume that the last completed checkpoint pointer on disk points to the check- point log record with <span class="s44">LSN </span>7568. The Prev<span class="s44">LSN </span>values in the log records are shown using arrows in the ﬁgure, while the UndoNext<span class="s44">LSN </span>value is shown using a dashed arrow for the one compensation log record, with <span class="s44">LSN </span>7565, in the ﬁgure. The analysis pass would start from <span class="s44">LSN </span>7568, and when it is complete, Redo<span class="s44">LSN </span>would be 7564. Thus, the redo pass must start at the log record with <span class="s44">LSN </span>7564. Note that this <span class="s44">LSN </span>is less than the <span class="s44">LSN </span>of the checkpoint log record, since the <span class="s44">ARIES </span>checkpointing algorithm does not ﬂush modiﬁed pages to stable storage. The DirtyPageTable at the end of analysis would include pages 4894, 7200 from the checkpoint log record, and 2390 which is updated by the log record with <span class="s44">LSN </span>7570. At the end of the analysis pass, the list of transactions to be undone consists of only <i>T</i><span class="s130">145 </span><span class="s94">in this example.</span></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 11pt;text-align: right;">The redo pass for the preceding example starts from <span class="s44">LSN </span>7564 and performs redo</p><p style="padding-left: 119pt;text-indent: 0pt;text-align: right;">of log records whose pages appear in DirtyPageTable. The undo pass needs to undo</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="157" height="17" alt="image" src="Image_3084.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="101" height="16" alt="image" src="Image_3085.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="296" height="341" alt="image" src="Image_3086.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="189" alt="image" src="Image_3087.png"/></span></p><p class="s449" style="padding-top: 1pt;text-indent: 0pt;text-align: left;">7571: &lt;T<span class="s457">146 </span>commit&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s449" style="padding-left: 1pt;text-indent: 0pt;text-align: left;">7569: &lt;T<span class="s457">146 </span>begin&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s275" style="padding-top: 1pt;text-indent: 0pt;line-height: 106%;text-align: left;">Analysis pass</p><p class="s449" style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">CLR</p><p style="text-indent: 0pt;text-align: left;"/><p class="s275" style="padding-top: 1pt;padding-left: 33pt;text-indent: 0pt;line-height: 106%;text-align: left;">Redo pass</p><p class="s449" style="padding-top: 7pt;text-indent: 0pt;text-align: left;">UndoNextLSN</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">7570: &lt;T<span class="s457">146</span>, 2390.4, 50, 90&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">7566: &lt;T<span class="s457">143 </span>commit&gt;</p><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">7567: &lt;T<span class="s457">145</span>,4894.1, 40, 60&gt;</p><p style="text-indent: 0pt;text-align: left;"/><table style="border-collapse:collapse" cellspacing="0"><tr style="height:12pt"><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 2pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">Txn</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">lastLSN</p></td></tr><tr style="height:12pt"><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">T145</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">7567</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-bottom: 2pt;padding-left: 119pt;text-indent: 0pt;text-align: right;">newer</p><p style="padding-left: 140pt;text-indent: 0pt;text-align: left;"><span><img width="5" height="325" alt="image" src="Image_3088.png"/></span></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:16pt"><td style="width:122pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">7565: &lt;T<span class="s459">143</span>,7200.2, 60&gt;</p></td></tr><tr style="height:15pt"><td style="width:122pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">7564: &lt;T<span class="s459">145</span>,4894.1, 20, 40&gt;</p></td></tr><tr style="height:14pt"><td style="width:122pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 11pt;text-align: left;">7563: &lt;T<span class="s459">145 </span>begin&gt;</p></td></tr><tr style="height:16pt"><td style="width:122pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">7562: &lt;T<span class="s459">143</span>, 7200.2, 60, 80&gt;</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s449" style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: right;">older</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s275" style="padding-top: 9pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">End of log at crash</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:-0.451116pt" cellspacing="0"><tr style="height:52pt"><td style="width:122pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" colspan="3"><p class="s456" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">7568: checkpoint</p></td></tr><tr style="height:13pt"><td style="width:36pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 4pt;text-indent: 0pt;text-align: left;">PageID</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 4pt;text-indent: 0pt;text-align: left;">PageLSN</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">RecLSN</p></td></tr><tr style="height:23pt"><td style="width:36pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">4894</p><p class="s456" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">7200</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">7567</p><p class="s456" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">7565</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s456" style="padding-left: 8pt;text-indent: 0pt;text-align: left;">7564</p><p class="s456" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">7565</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s449" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">PrevLSN pointers</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="60" height="55" alt="image" src="Image_3089.png"/></span></p><p class="s275" style="padding-top: 9pt;padding-bottom: 1pt;padding-left: 14pt;text-indent: 0pt;line-height: 106%;text-align: center;">Undo pass</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="6" height="104" alt="image" src="Image_3090.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 59pt;text-indent: 0pt;text-align: center;"><span class="s73">Figure 19.10 </span>Recovery actions in <span class="s157">ARIES</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 88pt;text-indent: 0pt;line-height: 84%;text-align: justify;">only transaction <i>T</i><span class="s98">145</span>, and hence it starts from its Last<span class="s44">LSN </span>value 7567 and continues backwards until the record <span class="s83">&lt;</span><i>T</i><span class="s130">145 </span><span class="s49">start</span><span class="s83">&gt; </span>is found at <span class="s44">LSN </span>7563.</p><p class="s68" style="padding-top: 10pt;padding-left: 88pt;text-indent: 0pt;text-align: left;">19.9.3 Other Features</p><p style="padding-top: 6pt;padding-left: 88pt;text-indent: 0pt;text-align: justify;">Among other key features that <span class="s44">ARIES </span>provides are:</p><p style="padding-top: 5pt;padding-left: 107pt;text-indent: -16pt;text-align: justify;"><span class="s39">• </span><span class="s63">Nested top actions</span>: <span class="s44">ARIES </span>allows the logging of operations that should not be un- done even if a transaction gets rolled back; for example, if a transaction allocates a page to a relation, even if the transaction is rolled back, the page allocation should not be undone since other transactions may have stored records in the page. Such operations that should not be undone are called nested top actions. Such opera- tions can be modeled as operations whose undo action does nothing. In <span class="s44">ARIES</span>, such operations are implemented by creating a dummy <span class="s44">CLR </span>whose UndoNext<span class="s44">LSN </span>is set such that transaction rollback skips the log records generated by the opera- tion.</p><p class="s39" style="padding-top: 3pt;padding-left: 107pt;text-indent: -16pt;text-align: justify;">• <span class="s63">Recovery independence</span><span class="p">: Some pages can be recovered independently from others so that they can be used even while other pages are being recovered. If some pages</span></p><p class="s66" style="padding-top: 3pt;padding-left: 283pt;text-indent: 0pt;text-align: left;"><a name="bookmark404">19.10 </a><span style=" color: #00AEEF;">Recovery in Main-Memory Databases  </span><span class="s164">947</span><a name="bookmark444">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 139pt;text-indent: 0pt;text-align: justify;">of a disk fail, they can be recovered without stopping transaction processing on other pages.</p><p class="s39" style="padding-top: 3pt;padding-left: 139pt;text-indent: -16pt;text-align: justify;">• <span class="s63">Savepoints</span><span class="p">: Transactions can record savepoints and can be rolled back partially up to a savepoint. This can be quite useful for deadlock handling, since transactions can be rolled back up to a point that permits release of required locks and then restarted from that point.</span></p><p style="padding-left: 139pt;text-indent: 14pt;text-align: justify;">Programmers can also use savepoints to undo a transaction partially, and then continue execution; this approach can be useful to handle certain kinds of errors detected during the transaction execution.</p><p style="padding-top: 3pt;padding-left: 139pt;text-indent: -16pt;text-align: justify;"><span class="s39">• </span><span class="s63">Fine-grained locking</span>: The <span class="s44">ARIES </span>recovery algorithm can be used with index concurrency-control algorithms that permit tuple-level locking on indices, instead of page-level locking, which improves concurrency signiﬁcantly.</p><p class="s39" style="padding-top: 4pt;padding-left: 139pt;text-indent: -16pt;text-align: justify;">• <span class="s63">Recovery optimizations</span><span class="p">: The DirtyPageTable can be used to prefetch pages during redo, instead of fetching a page only when the system ﬁnds a log record to be applied to the page. Out-of-order redo is also possible: Redo can be postponed on a page being fetched from disk and performed when the page is fetched. Meanwhile, other log records can continue to be processed.</span></p><p style="padding-top: 4pt;padding-left: 119pt;text-indent: 17pt;text-align: justify;">In summary, the <span class="s44">ARIES </span>algorithm is a state-of-the-art recovery algorithm, incor- porating a variety of optimizations designed to improve concurrency, reduce logging overhead, and reduce recovery time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part354.htm">&lt; 上一个</a><span> | </span><a href="../database.html">内容</a><span> | </span><a href="part356.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
