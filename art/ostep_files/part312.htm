<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Better, But Still Broken: While, Not If</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part311.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part313.htm">下一个 &gt;</a></p><p class="s32" style="padding-left: 41pt;text-indent: 0pt;text-align: justify;">Better, But Still Broken: While, Not If</p><p style="padding-top: 6pt;padding-left: 41pt;text-indent: 0pt;line-height: 89%;text-align: justify;">Fortunately, this fix is easy (Figure <span style=" color: #00AEEF;">30.7</span>): change the <span class="s41">if </span>to a <span class="s41">while</span>. Think <span class="s61">about why this works; now consumer </span><span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span><span class="s61">wakes up and (with the lock </span>held) immediately re-checks the state of the shared variable (c2). If the buffer is empty at that point, the consumer simply goes back to sleep (c3). The corollary <span class="s41">if </span>is also changed to a <span class="s41">while </span>in the producer (p2).</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Thanks to Mesa semantics, a simple rule to remember with condition variables is to <b>always use while loops</b>. Sometimes you don’t have to re- check the condition, but it is always safe to do so; just do it and be happy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:69.7477pt" cellspacing="0"><tr style="height:9pt"><td style="width:23pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s142" style="padding-left: 6pt;text-indent: 0pt;line-height: 8pt;text-align: left;">T<span class="s144">c</span><span class="s139">1</span></p></td><td style="width:40pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">State</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s142" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">T<span class="s144">c</span><span class="s139">2</span></p></td><td style="width:39pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">State</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s138" style="padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: right;">T<span class="s145">p</span></p></td><td style="width:40pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">State</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s69" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">Count</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s134" style="padding-left: 20pt;text-indent: 0pt;line-height: 8pt;text-align: left;">Comment</p></td></tr><tr style="height:8pt"><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c1</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c3</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 11pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Nothing to get</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c1</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c2</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c3</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 11pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Nothing to get</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p1</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p4</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 10pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Buffer now full</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p5</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 15pt;text-indent: 0pt;line-height: 7pt;text-align: left;">T<span class="s144">c</span><span class="s139">1 </span>awoken</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p6</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p1</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-right: 6pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p3</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Must sleep (full)</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Recheck condition</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c4</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 11pt;text-indent: 0pt;line-height: 7pt;text-align: left;">T<span class="s144">c</span><span class="s139">1 </span>grabs data</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c5</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Oops! Woke T<span class="s144">c</span><span class="s139">2</span></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c6</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c1</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c3</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 11pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Nothing to get</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c2</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c3</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:32pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:68pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 6pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Everyone asleep...</p></td></tr></table><p style="padding-top: 6pt;padding-left: 104pt;text-indent: 0pt;text-align: justify;">Table 30.2: <b>Thread Trace: Broken Solution (Version 2)</b></p><p style="padding-top: 2pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">However, this code still has a bug, the second of two problems men- tioned above. Can you see it? It has something to do with the fact that there is only one condition variable. Try to figure out what the problem is, before reading ahead. DO IT!</p><p class="s6" style="padding-left: 80pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">... (another pause for you to think, or close your eyes for a bit) ...</p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;"><span class="p">Let’s confirm you figured it out correctly, or perhaps let’s confirm that you are now awake and reading this part of the book. The problem oc- </span>curs when two consumers run first (<span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>and <span class="s57">T</span><span class="s58">c</span><span class="s62">2</span>), and both go to sleep <span class="p">(c3). Then, a producer runs, put a value in the buffer, wakes one of the </span>consumers (say <span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>), and goes back to sleep. Now we have one consumer ready to run (<span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>), and two threads sleeping on a condition (<span class="s57">T</span><span class="s58">c</span><span class="s62">2 </span>and <span class="s57">T</span><span class="s58">p</span>). <span class="p">And we are about to cause a problem to occur: things are getting exciting!</span></p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: left;">The consumer <span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>then wakes by returning from <span class="s147">wait() </span>(c3), re-checks <span class="p">the condition (c2), and finding the buffer full, consumes the value (c4). This consumer then, critically, signals on the condition (c5), waking one thread that is sleeping. However, which thread should it wake?</span></p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;"><span class="p">Because the consumer has emptied the buffer, it clearly should wake </span>the producer. However, if it wakes the consumer <span class="s57">T</span><span class="s58">c</span><span class="s62">2 </span>(which is definitely <span class="p">possible, depending on how the wait queue is managed), we have a prob- </span>lem. Specifically, the consumer <span class="s57">T</span><span class="s58">c</span><span class="s62">2 </span>will wake up and find the buffer empty (c2), and go back to sleep (c3). The producer <span class="s57">T</span><span class="s58">p</span>, which has a value to put into the buffer, is left sleeping. The other consumer thread, <span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>, <span class="p">also goes back to sleep. All three threads are left sleeping, a clear bug; see Table </span><span class="s28">30.2 </span><span class="p">for the brutal step-by-step of this terrible calamity.</span></p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Signaling is clearly needed, but must be more directed. A consumer should not wake other consumers, only producers, and vice-versa.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s37" style="padding-top: 4pt;padding-left: 26pt;text-indent: 0pt;text-align: left;">1  <span class="s38">cond_t empty, fill;</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">2  <span class="s38">mutex_t mutex;</span></p><p class="s37" style="padding-top: 1pt;padding-left: 26pt;text-indent: 0pt;text-align: left;">3</p><p class="s38" style="padding-left: 26pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><span class="s37">4  </span>void <span class="s39">*</span>producer(void <span class="s39">*</span>arg) {</p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;line-height: 7pt;text-align: left;">5    <span class="s38">int i;</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">6     <span class="s38">for (i = 0; i &lt; loops; i++) {</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">7       <span class="s38">Pthread_mutex_lock(&amp;mutex);</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">8       <span class="s38">while (count == 1)</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">9          <span class="s38">Pthread_cond_wait(&amp;empty, &amp;mutex);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">10       <span class="s38">put(i);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">11       <span class="s38">Pthread_cond_signal(&amp;fill);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">12       <span class="s38">Pthread_mutex_unlock(&amp;mutex);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">13    <span class="s38">}</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">14  <span class="s38">}</span></p><p class="s37" style="padding-top: 1pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">15</p><p class="s38" style="padding-left: 24pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><span class="s37">16  </span>void <span class="s39">*</span>consumer(void <span class="s39">*</span>arg) {</p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;line-height: 7pt;text-align: left;">17    <span class="s38">int i;</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">18     <span class="s38">for (i = 0; i &lt; loops; i++) {</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">19       <span class="s38">Pthread_mutex_lock(&amp;mutex);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">20       <span class="s38">while (count == 0)</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">21          <span class="s38">Pthread_cond_wait(&amp;fill, &amp;mutex);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">22       <span class="s38">int tmp = get();</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">23       <span class="s38">Pthread_cond_signal(&amp;empty);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">24       <span class="s38">Pthread_mutex_unlock(&amp;mutex);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">25       <span class="s38">printf(&quot;%d\n&quot;, tmp);</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">26    <span class="s38">}</span></p><p class="s37" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">27  <span class="s38">}</span></p><p style="padding-left: 76pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Figure 30.8: <b>Producer/Consumer: Two CVs and While</b></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part311.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part313.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
