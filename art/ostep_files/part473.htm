<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Tricky Case: Block Reuse</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part472.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part474.htm">下一个 &gt;</a></p><p class="s32" style="padding-left: 41pt;text-indent: 0pt;text-align: justify;">Tricky Case: Block Reuse</p><p style="padding-top: 5pt;padding-left: 41pt;text-indent: 0pt;line-height: 89%;text-align: justify;">There are some interesting corner cases that make journaling more tricky, and thus are worth discussing. A number of them revolve around block reuse; as Stephen Tweedie (one of the main forces behind ext3) said:</p><p class="s5" style="padding-top: 4pt;padding-left: 64pt;text-indent: 0pt;text-align: justify;">“What’s the hideous part of the entire system? ... It’s deleting files. Everything to do with delete is hairy. Everything to do with delete... you have nightmares around what happens if blocks get deleted and then reallocated.” [T00]</p><p class="s47" style="padding-left: 1pt;text-indent: 0pt;text-align: left;">Journal</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 4pt;padding-left: 41pt;text-indent: 11pt;line-height: 88%;text-align: justify;">The particular example Tweedie gives is as follows. Suppose you are using some form of metadata journaling (and thus data blocks for files are <i>not </i>journaled). Let’s say you have a directory called <span class="s41">foo</span>. The user adds an entry to <span class="s41">foo </span>(say by creating a file), and thus the contents of <span class="s41">foo </span>(because directories are considered metadata) are written to the log; assume the location of the <span class="s41">foo </span>directory data is block 1000. The log thus contains something like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:62.7497pt" cellspacing="0"><tr style="height:29pt"><td style="width:14pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxB</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=1</p></td><td style="width:29pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="padding-left: 6pt;text-indent: 0pt;line-height: 8pt;text-align: left;">I[foo]</p><p class="s89" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">ptr:1000</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="padding-left: 11pt;padding-right: 11pt;text-indent: 0pt;line-height: 8pt;text-align: center;">D[foo]</p><p class="s89" style="padding-left: 11pt;padding-right: 11pt;text-indent: 0pt;line-height: 7pt;text-align: center;">[final addr:1000]</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxE</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=1</p></td><td style="width:129pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 4pt;text-align: left;"><span><img width="63" height="5" alt="image" src="Image_625.png"/></span></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s47" style="padding-left: 1pt;text-indent: 0pt;text-align: left;">Journal</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">At this point, the user deletes everything in the directory as well as the directory itself, freeing up block 1000 for reuse. Finally, the user creates a new file (say <span class="s41">foobar</span>), which ends up reusing the same block (1000) that used to belong to <span class="s41">foo</span>. The inode of <span class="s41">foobar </span>is committed to disk, as is its data; note, however, because metadata journaling is in use, only the inode of <span class="s41">foobar </span>is committed to the journal; the newly-written data in block 1000 in the file <span class="s41">foobar </span>is <i>not </i>journaled.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:62.7497pt" cellspacing="0"><tr style="height:29pt"><td style="width:14pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxB</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=1</p></td><td style="width:29pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="padding-left: 6pt;text-indent: 0pt;line-height: 8pt;text-align: left;">I[foo]</p><p class="s89" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">ptr:1000</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="padding-left: 11pt;padding-right: 11pt;text-indent: 0pt;line-height: 8pt;text-align: center;">D[foo]</p><p class="s89" style="padding-left: 11pt;padding-right: 11pt;text-indent: 0pt;line-height: 7pt;text-align: center;">[final addr:1000]</p></td><td style="width:15pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxE</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=1</p></td><td style="width:14pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxB</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=2</p></td><td style="width:29pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="padding-left: 1pt;text-indent: 0pt;line-height: 8pt;text-align: left;">I[foobar]</p><p class="s89" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">ptr:1000</p></td><td style="width:14pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s95" style="text-indent: 0pt;line-height: 8pt;text-align: left;">TxE</p><p class="s89" style="text-indent: 0pt;line-height: 7pt;text-align: left;">id=2</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 4pt;text-align: left;"><span><img width="63" height="5" alt="image" src="Image_626.png"/></span></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:97.588pt" cellspacing="0"><tr style="height:29pt"><td style="width:38pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s108" style="padding-left: 12pt;text-indent: 0pt;text-align: left;">TxB</p></td><td style="width:81pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s123" style="padding-left: 24pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Journal</p><p class="s108" style="padding-left: 22pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Contents</p><p class="s70" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">(metadata)  (data)</p></td><td style="width:33pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s108" style="padding-left: 7pt;text-indent: 0pt;text-align: left;">TxE</p></td><td style="width:77pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s123" style="padding-left: 16pt;text-indent: 0pt;line-height: 9pt;text-align: left;">File System</p><p class="s108" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Metadata  Data</p></td></tr><tr style="height:38pt"><td style="width:38pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">issue</p><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">complete</p></td><td style="width:81pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s123" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">issue  issue</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s123" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">complete</p><p class="s123" style="padding-left: 40pt;text-indent: 0pt;line-height: 9pt;text-align: left;">complete</p></td><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:19pt"><td style="width:152pt;border-top-style:dashed;border-top-width:1pt;border-top-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F" colspan="3"><p class="s123" style="padding-left: 115pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">issue</p><p class="s123" style="padding-left: 115pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">complete</p></td><td style="width:77pt;border-top-style:dashed;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:dashed;border-bottom-width:1pt;border-bottom-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:29pt"><td style="width:152pt;border-top-style:dashed;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F" colspan="3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-top-style:dashed;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">issue</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">complete</p></td><td style="width:38pt;border-top-style:dashed;border-top-width:1pt;border-top-color:#221E1F"><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">issue</p><p class="s123" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">complete</p></td></tr></table><p style="padding-top: 4pt;padding-left: 138pt;text-indent: 0pt;text-align: justify;">Table 42.1: <b>Data Journaling Timeline</b></p><p style="padding-top: 4pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Now assume a crash occurs and all of this information is still in the log. During replay, the recovery process simply replays everything in the log, including the write of directory data in block 1000; the replay thus overwrites the user data of current file <span class="s41">foobar </span>with old directory contents! Clearly this is not a correct recovery action, and certainly it will be a surprise to the user when reading the file <span class="s41">foobar</span>.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">There are a number of solutions to this problem. One could, for ex- ample, never reuse blocks until the delete of said blocks is checkpointed out of the journal. What Linux ext3 does instead is to add a new type of record to the journal, known as a <b>revoke </b>record. In the case above, deleting the directory would cause a revoke record to be written to the journal. When replaying the journal, the system first scans for such re- voke records; any such revoked data is never replayed, thus avoiding the problem mentioned above.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part472.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part474.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
