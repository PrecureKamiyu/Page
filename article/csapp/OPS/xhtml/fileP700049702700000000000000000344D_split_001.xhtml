<?xml version='1.0' encoding='utf-8'?>
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg" xmlns:epub="http://www.idpf.org/2007/ops" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" epub:prefix="index: http://www.index.com/">
  <head>
    <meta name="dcterms.conformsTo" content="PXE Basic 1.0"/>
    <meta name="generator" content="PXE Tools version 1.39.52"/>
    <!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
    <title>Solutions to Practice Problems </title>
    <link rel="alternate stylesheet" type="text/css" title="night" href="../css/theme/night.css"/>
    <link rel="alternate stylesheet" type="text/css" title="sepia" href="../css/theme/sepia.css"/>
    <script src="js/format_lg_obj.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body epub:type="bodymatter" class="calibre pcalibre pcalibre1">
<section id="P700049702700000000000000000344D" class="pcalibre halftitlepage pcalibre1">
<section id="P70004970270000000000000000036B1" data-uri="chapter03.xhtml#P70004970270000000000000000036B1" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000418A2" data-uri="chapter03.xhtml#P70004970270000000000000000418A2" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002782"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.29 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002779">232</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000418A3" data-uri="chapter03.xhtml#P70004970270000000000000000418A3">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000418A4" data-uri="chapter03.xhtml#P70004970270000000000000000418A4"><p id="P70004970270000000000000000418A5" data-uri="chapter03.xhtml#P70004970270000000000000000418A5" class="calibre13 pcalibre pcalibre1">Our stated rule for translating a for loop into a <code id="P70004970270000000000000000418A6" data-uri="chapter03.xhtml#P70004970270000000000000000418A6" class="pcalibre1 calibre8 pcalibre">while</code> loop is just a bit too simplistic—this is the only aspect that requires special consideration.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P70004970270000000000000000418A7" data-uri="chapter03.xhtml#P70004970270000000000000000418A7">
<li id="P70004970270000000000000000418A8" data-uri="chapter03.xhtml#P70004970270000000000000000418A8" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418A9" data-uri="chapter03.xhtml#P70004970270000000000000000418A9" class="calibre13 pcalibre pcalibre1">Applying our translation rule would yield the following code:</p>
<pre id="P70004970270000000000000000418AA" data-uri="chapter03.xhtml#P70004970270000000000000000418AA" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000418AB" data-uri="chapter03.xhtml#P70004970270000000000000000418AB" class="calibre10 pcalibre pcalibre1">
/* Naive translation of for loop into while loop */
/* WARNING: This is buggy code */
long sum = 0;
long i = 0;
while (i &lt; 10) {
	if (i &amp; 1)
	  /* This will cause an infinite loop */
	continue;
	sum += i;
	i++;
}
</code></pre>
<p class="calibre13 pcalibre pcalibre1" id="P70004970270000000000000000418AC" data-uri="chapter03.xhtml#P70004970270000000000000000418AC">This code has an infinite loop, since the continue statement would prevent index variable <code id="P70004970270000000000000000418AD" data-uri="chapter03.xhtml#P70004970270000000000000000418AD" class="pcalibre1 calibre8 pcalibre">i</code> from being updated.</p></li>
<li id="P70004970270000000000000000418AE" data-uri="chapter03.xhtml#P70004970270000000000000000418AE" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418AF" data-uri="chapter03.xhtml#P70004970270000000000000000418AF" class="calibre13 pcalibre pcalibre1">The general solution is to replace the continue statement with a <code id="P70004970270000000000000000418B0" data-uri="chapter03.xhtml#P70004970270000000000000000418B0" class="pcalibre1 calibre8 pcalibre">goto</code> statement that skips the rest of the loop body and goes directly to the update portion:</p>
<pre id="P70004970270000000000000000418B1" data-uri="chapter03.xhtml#P70004970270000000000000000418B1" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000418B2" data-uri="chapter03.xhtml#P70004970270000000000000000418B2" class="calibre10 pcalibre pcalibre1">
/* Correct translation of for loop into while loop */
long sum = 0;
long i = 0;
while (i &lt; 10) {
	if (i &amp; 1)
	  goto update;
	sum += i;
update:
	i++;
}
</code></pre>
</li></ol></li></ul>
</section>
<section id="P70004970270000000000000000036C3" data-uri="chapter03.xhtml#P70004970270000000000000000036C3" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000418B3" data-uri="chapter03.xhtml#P70004970270000000000000000418B3" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000036C5" title="338" data-uri="chapter03.xhtml#P70004970270000000000000000036C5" epub:type="pagebreak"></span><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000027EF"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.30 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000027DC">236</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000418B4" data-uri="chapter03.xhtml#P70004970270000000000000000418B4">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000418B5" data-uri="chapter03.xhtml#P70004970270000000000000000418B5"><p id="P70004970270000000000000000418B6" data-uri="chapter03.xhtml#P70004970270000000000000000418B6" class="calibre13 pcalibre pcalibre1">This problem gives you a chance to reason about the control flow of a switch statement. Answering the questions requires you to combine information from several places in the assembly code.</p>
<ul id="P70004970270000000000000000418B7" data-uri="chapter03.xhtml#P70004970270000000000000000418B7" class="pcalibre calibre39 pcalibre1">
<li id="P70004970270000000000000000418B8" data-uri="chapter03.xhtml#P70004970270000000000000000418B8" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418B9" data-uri="chapter03.xhtml#P70004970270000000000000000418B9" class="calibre13 pcalibre pcalibre1">Line 2 of the assembly code adds 1 to <var class="calibre5 pcalibre pcalibre1">x</var> to set the lower range of the cases to zero. That means that the minimum case label is –1.</p></li>
<li id="P70004970270000000000000000418BA" data-uri="chapter03.xhtml#P70004970270000000000000000418BA" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418BB" data-uri="chapter03.xhtml#P70004970270000000000000000418BB" class="calibre13 pcalibre pcalibre1">Lines 3 and 4 cause the program to jump to the default case when the adjusted case value is greater than 8. This implies that the maximum case label is –1 + 8 = 7.</p></li>
<li id="P70004970270000000000000000418BC" data-uri="chapter03.xhtml#P70004970270000000000000000418BC" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418BD" data-uri="chapter03.xhtml#P70004970270000000000000000418BD" class="calibre13 pcalibre pcalibre1">In the jump table, we see that the entry on lines 6 (case value 3) and 9 (case value 6) have the same destination (<code id="P70004970270000000000000000418BE" data-uri="chapter03.xhtml#P70004970270000000000000000418BE" class="pcalibre1 calibre8 pcalibre">.L2</code>) as the jump instruction on line 4, indicating the default case behavior. Thus, case labels 3 and 5 are missing in the switch statement body.</p></li>
<li id="P70004970270000000000000000418BF" data-uri="chapter03.xhtml#P70004970270000000000000000418BF" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418C0" data-uri="chapter03.xhtml#P70004970270000000000000000418C0" class="calibre13 pcalibre pcalibre1">In the jump table, we see that the entries on lines 3 and 10 have the same destination. These correspond to cases 0 and 7.</p></li>
<li id="P70004970270000000000000000418C1" data-uri="chapter03.xhtml#P70004970270000000000000000418C1" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418C2" data-uri="chapter03.xhtml#P70004970270000000000000000418C2" class="calibre13 pcalibre pcalibre1">In the jump table, we see that the entries on lines 5 and 7 have the same destination. These correspond to cases 2 and 4.</p></li></ul>
<p id="P70004970270000000000000000418C3" data-uri="chapter03.xhtml#P70004970270000000000000000418C3" class="calibre13 pcalibre pcalibre1">From this reasoning, we draw the following conclusions:</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P70004970270000000000000000418C4" data-uri="chapter03.xhtml#P70004970270000000000000000418C4">
<li id="P70004970270000000000000000418C5" data-uri="chapter03.xhtml#P70004970270000000000000000418C5" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418C6" data-uri="chapter03.xhtml#P70004970270000000000000000418C6" class="calibre13 pcalibre pcalibre1">The case labels in the switch statement body have values –1, 0, 1, 2, 4, 5, and 7.</p></li>
<li id="P70004970270000000000000000418C7" data-uri="chapter03.xhtml#P70004970270000000000000000418C7" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418C8" data-uri="chapter03.xhtml#P70004970270000000000000000418C8" class="calibre13 pcalibre pcalibre1">The case with destination <code id="P70004970270000000000000000418C9" data-uri="chapter03.xhtml#P70004970270000000000000000418C9" class="pcalibre1 calibre8 pcalibre">.L5</code> has labels 0 and 7.</p></li>
<li id="P70004970270000000000000000418CA" data-uri="chapter03.xhtml#P70004970270000000000000000418CA" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000418CB" data-uri="chapter03.xhtml#P70004970270000000000000000418CB" class="calibre13 pcalibre pcalibre1">The case with destination <code id="P70004970270000000000000000418CC" data-uri="chapter03.xhtml#P70004970270000000000000000418CC" class="pcalibre1 calibre8 pcalibre">.L7</code> has labels 2 and 4.</p></li>
</ol></li></ul>
</section>
<section id="P70004970270000000000000000036DF" data-uri="chapter03.xhtml#P70004970270000000000000000036DF" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000418CD" data-uri="chapter03.xhtml#P70004970270000000000000000418CD" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002808"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.31 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000027FE">237</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000418CE" data-uri="chapter03.xhtml#P70004970270000000000000000418CE">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000418CF" data-uri="chapter03.xhtml#P70004970270000000000000000418CF"><p id="P70004970270000000000000000418D0" data-uri="chapter03.xhtml#P70004970270000000000000000418D0" class="calibre13 pcalibre pcalibre1">The key to reverse engineering compiled switch statements is to combine the information from the assembly code and the jump table to sort out the different cases. We can see from the <code id="P70004970270000000000000000418D1" data-uri="chapter03.xhtml#P70004970270000000000000000418D1" class="pcalibre1 calibre8 pcalibre">ja</code> instruction (line 3) that the code for the default case has label <code id="P70004970270000000000000000418D2" data-uri="chapter03.xhtml#P70004970270000000000000000418D2" class="pcalibre1 calibre8 pcalibre">.L2.</code> We can see that the only other repeated label in the jump table is <code id="P70004970270000000000000000418D3" data-uri="chapter03.xhtml#P70004970270000000000000000418D3" class="pcalibre1 calibre8 pcalibre">.L5</code>, and so this must be the code for the cases C and D. We can see that the code falls through at line 8, and so label <code id="P70004970270000000000000000418D4" data-uri="chapter03.xhtml#P70004970270000000000000000418D4" class="pcalibre1 calibre8 pcalibre">.L7</code> must match case A and label <code id="P70004970270000000000000000418D5" data-uri="chapter03.xhtml#P70004970270000000000000000418D5" class="pcalibre1 calibre8 pcalibre">.L3</code> must match case B. That leaves only label <code id="P70004970270000000000000000418D6" data-uri="chapter03.xhtml#P70004970270000000000000000418D6" class="pcalibre1 calibre8 pcalibre">.L6</code> to match case E.</p>
<p id="P70004970270000000000000000418D7" data-uri="chapter03.xhtml#P70004970270000000000000000418D7" class="calibre15 pcalibre pcalibre1">The original C code is as follows:</p>
<pre id="P70004970270000000000000000418D8" data-uri="chapter03.xhtml#P70004970270000000000000000418D8" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000418D9" data-uri="chapter03.xhtml#P70004970270000000000000000418D9" class="calibre10 pcalibre pcalibre1">
void switcher(long a, long b, long c, long *dest)
{
	long val;
	switch(a) {
	case 5:
	  c = b ^ 15;
	  /* Fall through */
	case 0:
	  val = c + 112;
	  break;
<span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000036ED" title="339" data-uri="chapter03.xhtml#P70004970270000000000000000036ED" epub:type="pagebreak"></span>	case 2:
	case 7:
	  val = (c + b) &lt;&lt; 2;
	  break;
	case 4:
	  val = a;
	  break;
	default:
	  val = b;
	}
	*dest = val;
}
</code></pre>
</li></ul>
</section>
<section id="P70004970270000000000000000036EE" data-uri="chapter03.xhtml#P70004970270000000000000000036EE" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000418DA" data-uri="chapter03.xhtml#P70004970270000000000000000418DA" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000281F.xhtml#P700049702700000000000000000294B"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.32 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002934">244</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000418DB" data-uri="chapter03.xhtml#P70004970270000000000000000418DB">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000418DC" data-uri="chapter03.xhtml#P70004970270000000000000000418DC"><p id="P70004970270000000000000000418DD" data-uri="chapter03.xhtml#P70004970270000000000000000418DD" class="calibre13 pcalibre pcalibre1">Tracing through the program execution at this level of detail reinforces many aspects of procedure call and return. We can see clearly how control is passed to the function when it is called, and how the calling function resumes upon return. We can also see how arguments get passed through registers <code id="P70004970270000000000000000418DE" data-uri="chapter03.xhtml#P70004970270000000000000000418DE" class="pcalibre1 calibre8 pcalibre">%rdi</code> and <code id="P70004970270000000000000000418DF" data-uri="chapter03.xhtml#P70004970270000000000000000418DF" class="pcalibre1 calibre8 pcalibre">%rsi</code>, and how results are returned via register <code id="P70004970270000000000000000418E0" data-uri="chapter03.xhtml#P70004970270000000000000000418E0" class="pcalibre1 calibre8 pcalibre">%rax</code>.</p>
<table class="informaltable pcalibre pcalibre1" id="P70004970270000000000000000418E1" data-uri="chapter03.xhtml#P70004970270000000000000000418E1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th colspan="3" id="P70004970270000000000000000418E2" data-uri="chapter03.xhtml#P70004970270000000000000000418E2" class="calibre18 pcalibre pcalibre1">Instruction</th>
<th colspan="6" id="P70004970270000000000000000418E3" data-uri="chapter03.xhtml#P70004970270000000000000000418E3" class="calibre18 pcalibre pcalibre1">State values (at beginning)</th>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000418E4" data-uri="chapter03.xhtml#P70004970270000000000000000418E4" class="calibre18 pcalibre pcalibre1">Label</th>
<th id="P70004970270000000000000000418E5" data-uri="chapter03.xhtml#P70004970270000000000000000418E5" class="calibre18 pcalibre pcalibre1">PC</th>
<th id="P70004970270000000000000000418E6" data-uri="chapter03.xhtml#P70004970270000000000000000418E6" class="calibre18 pcalibre pcalibre1">Instruction</th>
<th id="P70004970270000000000000000418E7" data-uri="chapter03.xhtml#P70004970270000000000000000418E7" class="calibre18 pcalibre pcalibre1"><code id="P70004970270000000000000000418E8" data-uri="chapter03.xhtml#P70004970270000000000000000418E8" class="calibre10 pcalibre pcalibre1">%rdi</code></th>
<th id="P70004970270000000000000000418E9" data-uri="chapter03.xhtml#P70004970270000000000000000418E9" class="calibre18 pcalibre pcalibre1"><code id="P70004970270000000000000000418EA" data-uri="chapter03.xhtml#P70004970270000000000000000418EA" class="calibre10 pcalibre pcalibre1">%rsi</code></th>
<th id="P70004970270000000000000000418EB" data-uri="chapter03.xhtml#P70004970270000000000000000418EB" class="calibre18 pcalibre pcalibre1"><code id="P70004970270000000000000000418EC" data-uri="chapter03.xhtml#P70004970270000000000000000418EC" class="calibre10 pcalibre pcalibre1">%rax</code></th>
<th id="P70004970270000000000000000418ED" data-uri="chapter03.xhtml#P70004970270000000000000000418ED" class="calibre18 pcalibre pcalibre1"><code id="P70004970270000000000000000418EE" data-uri="chapter03.xhtml#P70004970270000000000000000418EE" class="calibre10 pcalibre pcalibre1">%rsp</code></th>
<th id="P70004970270000000000000000418EF" data-uri="chapter03.xhtml#P70004970270000000000000000418EF" class="calibre18 pcalibre pcalibre1"><code id="P70004970270000000000000000418F0" data-uri="chapter03.xhtml#P70004970270000000000000000418F0" class="calibre10 pcalibre pcalibre1">*%rsp</code></th>
<th id="P70004970270000000000000000418F1" data-uri="chapter03.xhtml#P70004970270000000000000000418F1" class="calibre18 pcalibre pcalibre1">Description</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000418F2" data-uri="chapter03.xhtml#P70004970270000000000000000418F2" class="calibre20 pcalibre pcalibre1">M1</td>
<td id="P70004970270000000000000000418F3" data-uri="chapter03.xhtml#P70004970270000000000000000418F3" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000418F4" data-uri="chapter03.xhtml#P70004970270000000000000000418F4" class="calibre10 pcalibre pcalibre1">0x400560</code></td>
<td id="P70004970270000000000000000418F5" data-uri="chapter03.xhtml#P70004970270000000000000000418F5" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000418F6" data-uri="chapter03.xhtml#P70004970270000000000000000418F6" class="calibre10 pcalibre pcalibre1">callq</code></td>
<td id="P70004970270000000000000000418F7" data-uri="chapter03.xhtml#P70004970270000000000000000418F7" class="calibre20 pcalibre pcalibre1">10</td>
<td id="P70004970270000000000000000418F8" data-uri="chapter03.xhtml#P70004970270000000000000000418F8" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P70004970270000000000000000418F9" data-uri="chapter03.xhtml#P70004970270000000000000000418F9" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P70004970270000000000000000418FA" data-uri="chapter03.xhtml#P70004970270000000000000000418FA" class="calibre20 pcalibre pcalibre1">0x7fffffffe820</td>
<td id="P70004970270000000000000000418FB" data-uri="chapter03.xhtml#P70004970270000000000000000418FB" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P70004970270000000000000000418FC" data-uri="chapter03.xhtml#P70004970270000000000000000418FC" class="calibre20 pcalibre pcalibre1">Call first(10)</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000418FD" data-uri="chapter03.xhtml#P70004970270000000000000000418FD" class="calibre20 pcalibre pcalibre1">F1</td>
<td id="P70004970270000000000000000418FE" data-uri="chapter03.xhtml#P70004970270000000000000000418FE" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000418FF" data-uri="chapter03.xhtml#P70004970270000000000000000418FF" class="calibre10 pcalibre pcalibre1">0x400548</code></td>
<td id="P7000497027000000000000000041900" data-uri="chapter03.xhtml#P7000497027000000000000000041900" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041901" data-uri="chapter03.xhtml#P7000497027000000000000000041901" class="calibre10 pcalibre pcalibre1">lea</code></td>
<td id="P7000497027000000000000000041902" data-uri="chapter03.xhtml#P7000497027000000000000000041902" class="calibre20 pcalibre pcalibre1">10</td>
<td id="P7000497027000000000000000041903" data-uri="chapter03.xhtml#P7000497027000000000000000041903" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P7000497027000000000000000041904" data-uri="chapter03.xhtml#P7000497027000000000000000041904" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P7000497027000000000000000041905" data-uri="chapter03.xhtml#P7000497027000000000000000041905" class="calibre20 pcalibre pcalibre1">0x7fffffffe818</td>
<td id="P7000497027000000000000000041906" data-uri="chapter03.xhtml#P7000497027000000000000000041906" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041907" data-uri="chapter03.xhtml#P7000497027000000000000000041907" class="calibre10 pcalibre pcalibre1">0x400565</code></td>
<td id="P7000497027000000000000000041908" data-uri="chapter03.xhtml#P7000497027000000000000000041908" class="calibre20 pcalibre pcalibre1">Entry of first</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041909" data-uri="chapter03.xhtml#P7000497027000000000000000041909" class="calibre20 pcalibre pcalibre1">F2</td>
<td id="P700049702700000000000000004190A" data-uri="chapter03.xhtml#P700049702700000000000000004190A" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004190B" data-uri="chapter03.xhtml#P700049702700000000000000004190B" class="calibre10 pcalibre pcalibre1">0x40054c</code></td>
<td id="P700049702700000000000000004190C" data-uri="chapter03.xhtml#P700049702700000000000000004190C" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004190D" data-uri="chapter03.xhtml#P700049702700000000000000004190D" class="calibre10 pcalibre pcalibre1">sub</code></td>
<td id="P700049702700000000000000004190E" data-uri="chapter03.xhtml#P700049702700000000000000004190E" class="calibre20 pcalibre pcalibre1">10</td>
<td id="P700049702700000000000000004190F" data-uri="chapter03.xhtml#P700049702700000000000000004190F" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P7000497027000000000000000041910" data-uri="chapter03.xhtml#P7000497027000000000000000041910" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P7000497027000000000000000041911" data-uri="chapter03.xhtml#P7000497027000000000000000041911" class="calibre20 pcalibre pcalibre1">0x7fffffffe818</td>
<td id="P7000497027000000000000000041912" data-uri="chapter03.xhtml#P7000497027000000000000000041912" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041913" data-uri="chapter03.xhtml#P7000497027000000000000000041913" class="calibre10 pcalibre pcalibre1">0x400565</code></td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041914" data-uri="chapter03.xhtml#P7000497027000000000000000041914" class="calibre20 pcalibre pcalibre1">F3</td>
<td id="P7000497027000000000000000041915" data-uri="chapter03.xhtml#P7000497027000000000000000041915" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041916" data-uri="chapter03.xhtml#P7000497027000000000000000041916" class="calibre10 pcalibre pcalibre1">0x400550</code></td>
<td id="P7000497027000000000000000041917" data-uri="chapter03.xhtml#P7000497027000000000000000041917" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041918" data-uri="chapter03.xhtml#P7000497027000000000000000041918" class="calibre10 pcalibre pcalibre1">callq</code></td>
<td id="P7000497027000000000000000041919" data-uri="chapter03.xhtml#P7000497027000000000000000041919" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P700049702700000000000000004191A" data-uri="chapter03.xhtml#P700049702700000000000000004191A" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P700049702700000000000000004191B" data-uri="chapter03.xhtml#P700049702700000000000000004191B" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P700049702700000000000000004191C" data-uri="chapter03.xhtml#P700049702700000000000000004191C" class="calibre20 pcalibre pcalibre1">0x7fffffffe818</td>
<td id="P700049702700000000000000004191D" data-uri="chapter03.xhtml#P700049702700000000000000004191D" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004191E" data-uri="chapter03.xhtml#P700049702700000000000000004191E" class="calibre10 pcalibre pcalibre1">0x400565</code></td>
<td id="P700049702700000000000000004191F" data-uri="chapter03.xhtml#P700049702700000000000000004191F" class="calibre20 pcalibre pcalibre1">Call last(9, 11)</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041920" data-uri="chapter03.xhtml#P7000497027000000000000000041920" class="calibre20 pcalibre pcalibre1">L1</td>
<td id="P7000497027000000000000000041921" data-uri="chapter03.xhtml#P7000497027000000000000000041921" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041922" data-uri="chapter03.xhtml#P7000497027000000000000000041922" class="calibre10 pcalibre pcalibre1">0x400540</code></td>
<td id="P7000497027000000000000000041923" data-uri="chapter03.xhtml#P7000497027000000000000000041923" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041924" data-uri="chapter03.xhtml#P7000497027000000000000000041924" class="calibre10 pcalibre pcalibre1">mov</code></td>
<td id="P7000497027000000000000000041925" data-uri="chapter03.xhtml#P7000497027000000000000000041925" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P7000497027000000000000000041926" data-uri="chapter03.xhtml#P7000497027000000000000000041926" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P7000497027000000000000000041927" data-uri="chapter03.xhtml#P7000497027000000000000000041927" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P7000497027000000000000000041928" data-uri="chapter03.xhtml#P7000497027000000000000000041928" class="calibre20 pcalibre pcalibre1">0x7fffffffe810</td>
<td id="P7000497027000000000000000041929" data-uri="chapter03.xhtml#P7000497027000000000000000041929" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004192A" data-uri="chapter03.xhtml#P700049702700000000000000004192A" class="calibre10 pcalibre pcalibre1">0x400555</code></td>
<td id="P700049702700000000000000004192B" data-uri="chapter03.xhtml#P700049702700000000000000004192B" class="calibre20 pcalibre pcalibre1">Entry of last</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004192C" data-uri="chapter03.xhtml#P700049702700000000000000004192C" class="calibre20 pcalibre pcalibre1">L2</td>
<td id="P700049702700000000000000004192D" data-uri="chapter03.xhtml#P700049702700000000000000004192D" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004192E" data-uri="chapter03.xhtml#P700049702700000000000000004192E" class="calibre10 pcalibre pcalibre1">0x400543</code></td>
<td id="P700049702700000000000000004192F" data-uri="chapter03.xhtml#P700049702700000000000000004192F" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041930" data-uri="chapter03.xhtml#P7000497027000000000000000041930" class="calibre10 pcalibre pcalibre1">imul</code></td>
<td id="P7000497027000000000000000041931" data-uri="chapter03.xhtml#P7000497027000000000000000041931" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P7000497027000000000000000041932" data-uri="chapter03.xhtml#P7000497027000000000000000041932" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P7000497027000000000000000041933" data-uri="chapter03.xhtml#P7000497027000000000000000041933" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P7000497027000000000000000041934" data-uri="chapter03.xhtml#P7000497027000000000000000041934" class="calibre20 pcalibre pcalibre1">0x7fffffffe810</td>
<td id="P7000497027000000000000000041935" data-uri="chapter03.xhtml#P7000497027000000000000000041935" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041936" data-uri="chapter03.xhtml#P7000497027000000000000000041936" class="calibre10 pcalibre pcalibre1">0x400555</code></td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041937" data-uri="chapter03.xhtml#P7000497027000000000000000041937" class="calibre20 pcalibre pcalibre1">L3</td>
<td id="P7000497027000000000000000041938" data-uri="chapter03.xhtml#P7000497027000000000000000041938" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041939" data-uri="chapter03.xhtml#P7000497027000000000000000041939" class="calibre10 pcalibre pcalibre1">0x400547</code></td>
<td id="P700049702700000000000000004193A" data-uri="chapter03.xhtml#P700049702700000000000000004193A" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004193B" data-uri="chapter03.xhtml#P700049702700000000000000004193B" class="calibre10 pcalibre pcalibre1">retq</code></td>
<td id="P700049702700000000000000004193C" data-uri="chapter03.xhtml#P700049702700000000000000004193C" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P700049702700000000000000004193D" data-uri="chapter03.xhtml#P700049702700000000000000004193D" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P700049702700000000000000004193E" data-uri="chapter03.xhtml#P700049702700000000000000004193E" class="calibre20 pcalibre pcalibre1">99</td>
<td id="P700049702700000000000000004193F" data-uri="chapter03.xhtml#P700049702700000000000000004193F" class="calibre20 pcalibre pcalibre1">0x7fffffffe810</td>
<td id="P7000497027000000000000000041940" data-uri="chapter03.xhtml#P7000497027000000000000000041940" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041941" data-uri="chapter03.xhtml#P7000497027000000000000000041941" class="calibre10 pcalibre pcalibre1">0x400555</code></td>
<td id="P7000497027000000000000000041942" data-uri="chapter03.xhtml#P7000497027000000000000000041942" class="calibre20 pcalibre pcalibre1">Return 99 from last</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041943" data-uri="chapter03.xhtml#P7000497027000000000000000041943" class="calibre20 pcalibre pcalibre1">F4</td>
<td id="P7000497027000000000000000041944" data-uri="chapter03.xhtml#P7000497027000000000000000041944" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041945" data-uri="chapter03.xhtml#P7000497027000000000000000041945" class="calibre10 pcalibre pcalibre1">0x400555</code></td>
<td id="P7000497027000000000000000041946" data-uri="chapter03.xhtml#P7000497027000000000000000041946" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041947" data-uri="chapter03.xhtml#P7000497027000000000000000041947" class="calibre10 pcalibre pcalibre1">repz repq</code></td>
<td id="P7000497027000000000000000041948" data-uri="chapter03.xhtml#P7000497027000000000000000041948" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P7000497027000000000000000041949" data-uri="chapter03.xhtml#P7000497027000000000000000041949" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P700049702700000000000000004194A" data-uri="chapter03.xhtml#P700049702700000000000000004194A" class="calibre20 pcalibre pcalibre1">99</td>
<td id="P700049702700000000000000004194B" data-uri="chapter03.xhtml#P700049702700000000000000004194B" class="calibre20 pcalibre pcalibre1">0x7fffffffe818</td>
<td id="P700049702700000000000000004194C" data-uri="chapter03.xhtml#P700049702700000000000000004194C" class="calibre20 pcalibre pcalibre1"><code id="P700049702700000000000000004194D" data-uri="chapter03.xhtml#P700049702700000000000000004194D" class="calibre10 pcalibre pcalibre1">0x400565</code></td>
<td id="P700049702700000000000000004194E" data-uri="chapter03.xhtml#P700049702700000000000000004194E" class="calibre20 pcalibre pcalibre1">Return 99 from first</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004194F" data-uri="chapter03.xhtml#P700049702700000000000000004194F" class="calibre20 pcalibre pcalibre1">M2</td>
<td id="P7000497027000000000000000041950" data-uri="chapter03.xhtml#P7000497027000000000000000041950" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041951" data-uri="chapter03.xhtml#P7000497027000000000000000041951" class="calibre10 pcalibre pcalibre1">0x400565</code></td>
<td id="P7000497027000000000000000041952" data-uri="chapter03.xhtml#P7000497027000000000000000041952" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041953" data-uri="chapter03.xhtml#P7000497027000000000000000041953" class="calibre10 pcalibre pcalibre1">mov</code></td>
<td id="P7000497027000000000000000041954" data-uri="chapter03.xhtml#P7000497027000000000000000041954" class="calibre20 pcalibre pcalibre1">9</td>
<td id="P7000497027000000000000000041955" data-uri="chapter03.xhtml#P7000497027000000000000000041955" class="calibre20 pcalibre pcalibre1">11</td>
<td id="P7000497027000000000000000041956" data-uri="chapter03.xhtml#P7000497027000000000000000041956" class="calibre20 pcalibre pcalibre1">99</td>
<td id="P7000497027000000000000000041957" data-uri="chapter03.xhtml#P7000497027000000000000000041957" class="calibre20 pcalibre pcalibre1">0x7fffffffe820</td>
<td id="P7000497027000000000000000041958" data-uri="chapter03.xhtml#P7000497027000000000000000041958" class="calibre20 pcalibre pcalibre1">—</td>
<td id="P7000497027000000000000000041959" data-uri="chapter03.xhtml#P7000497027000000000000000041959" class="calibre20 pcalibre pcalibre1">Resume main</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section id="P700049702700000000000000000376F" data-uri="chapter03.xhtml#P700049702700000000000000000376F" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P700049702700000000000000004195A" data-uri="chapter03.xhtml#P700049702700000000000000004195A" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002A2A"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.33 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002A13">246</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P700049702700000000000000004195B" data-uri="chapter03.xhtml#P700049702700000000000000004195B">
<li class="calibre12 pcalibre pcalibre1" id="P700049702700000000000000004195C" data-uri="chapter03.xhtml#P700049702700000000000000004195C"><p id="P700049702700000000000000004195D" data-uri="chapter03.xhtml#P700049702700000000000000004195D" class="calibre13 pcalibre pcalibre1">This problem is a bit tricky due to the mixing of different data sizes.</p>
<p id="P700049702700000000000000004195E" data-uri="chapter03.xhtml#P700049702700000000000000004195E" class="calibre15 pcalibre pcalibre1">Let us first describe one answer and then explain the second possibility. If we assume the first addition (line 3) implements *<code id="P700049702700000000000000004195F" data-uri="chapter03.xhtml#P700049702700000000000000004195F" class="pcalibre1 calibre8 pcalibre">u</code> += <code id="P7000497027000000000000000041960" data-uri="chapter03.xhtml#P7000497027000000000000000041960" class="pcalibre1 calibre8 pcalibre">a</code>, while the second (line 4) implements <code id="P7000497027000000000000000041961" data-uri="chapter03.xhtml#P7000497027000000000000000041961" class="pcalibre1 calibre8 pcalibre">v += b</code>, then we can see that a was passed as the first argument in <code id="P7000497027000000000000000041962" data-uri="chapter03.xhtml#P7000497027000000000000000041962" class="pcalibre1 calibre8 pcalibre">%edi</code> and converted from 4 bytes to 8 before adding it to the 8 bytes pointed to by <code id="P7000497027000000000000000041963" data-uri="chapter03.xhtml#P7000497027000000000000000041963" class="pcalibre1 calibre8 pcalibre">%rdx</code>. This implies that a must be of type <code id="P7000497027000000000000000041964" data-uri="chapter03.xhtml#P7000497027000000000000000041964" class="pcalibre1 calibre8 pcalibre">int</code> and <code id="P7000497027000000000000000041965" data-uri="chapter03.xhtml#P7000497027000000000000000041965" class="pcalibre1 calibre8 pcalibre">u</code> must be of type <code id="P7000497027000000000000000041966" data-uri="chapter03.xhtml#P7000497027000000000000000041966" class="pcalibre1 calibre8 pcalibre">long</code> *. We can also see that the low-order byte of argument <code id="P7000497027000000000000000041967" data-uri="chapter03.xhtml#P7000497027000000000000000041967" class="pcalibre1 calibre8 pcalibre">b</code> is added to the byte pointed to by <code id="P7000497027000000000000000041968" data-uri="chapter03.xhtml#P7000497027000000000000000041968" class="pcalibre1 calibre8 pcalibre">%rcx</code>. This implies that <code id="P7000497027000000000000000041969" data-uri="chapter03.xhtml#P7000497027000000000000000041969" class="pcalibre1 calibre8 pcalibre">v</code> must be of type <code id="P700049702700000000000000004196A" data-uri="chapter03.xhtml#P700049702700000000000000004196A" class="pcalibre1 calibre8 pcalibre">char *</code>, but the type of <code id="P700049702700000000000000004196B" data-uri="chapter03.xhtml#P700049702700000000000000004196B" class="pcalibre1 calibre8 pcalibre">b</code> is ambiguous—it could be 1, 2, 4, or 8 bytes long. This ambiguity is resolved by noting the return value of <span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003782" title="340" data-uri="chapter03.xhtml#P7000497027000000000000000003782" epub:type="pagebreak"></span>6, computed as the sum of the sizes of <code id="P700049702700000000000000004196C" data-uri="chapter03.xhtml#P700049702700000000000000004196C" class="pcalibre1 calibre8 pcalibre">a</code> and <code id="P700049702700000000000000004196D" data-uri="chapter03.xhtml#P700049702700000000000000004196D" class="pcalibre1 calibre8 pcalibre">b</code>. Since we know a is 4 bytes long, we can deduce that <code id="P700049702700000000000000004196E" data-uri="chapter03.xhtml#P700049702700000000000000004196E" class="pcalibre1 calibre8 pcalibre">b</code> must be 2.</p>
<p id="P700049702700000000000000004196F" data-uri="chapter03.xhtml#P700049702700000000000000004196F" class="calibre15 pcalibre pcalibre1">An annotated version of this function explains these details:</p>
<pre id="P7000497027000000000000000041970" data-uri="chapter03.xhtml#P7000497027000000000000000041970" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041971" data-uri="chapter03.xhtml#P7000497027000000000000000041971" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">int procprobl(int a, short b, long *u, char *v)</i>
	<i class="calibre5 pcalibre pcalibre1">a in %edi, b in %si, u in %rdx, v in %rcx</i>
1	procprob:
2	  movslq	%edi, %rdi	<i class="calibre5 pcalibre pcalibre1">Convert a to long</i>
3	  addq		%rdi, (%rdx)	<i class="calibre5 pcalibre pcalibre1">Add to *u (long)</i>
4	  addb		%sil, (%rcx)	<i class="calibre5 pcalibre pcalibre1">Add low-order byte of b to *v</i>
5	  movl		$6, %eax	<i class="calibre5 pcalibre pcalibre1">Return 4+2</i>
6	  ret
</code></pre>
<p id="P7000497027000000000000000041972" data-uri="chapter03.xhtml#P7000497027000000000000000041972" class="calibre13 pcalibre pcalibre1">Alternatively, we can see that the same assembly code would be valid if the two sums were computed in the assembly code in the opposite ordering as they are in the C code. This would result in interchanging arguments <code id="P7000497027000000000000000041973" data-uri="chapter03.xhtml#P7000497027000000000000000041973" class="pcalibre1 calibre8 pcalibre">a</code> and <code id="P7000497027000000000000000041974" data-uri="chapter03.xhtml#P7000497027000000000000000041974" class="pcalibre1 calibre8 pcalibre">b</code> and arguments <code id="P7000497027000000000000000041975" data-uri="chapter03.xhtml#P7000497027000000000000000041975" class="pcalibre1 calibre8 pcalibre">u</code> and <code id="P7000497027000000000000000041976" data-uri="chapter03.xhtml#P7000497027000000000000000041976" class="pcalibre1 calibre8 pcalibre">v</code>, yielding the following prototype:</p>
<pre id="P7000497027000000000000000041977" data-uri="chapter03.xhtml#P7000497027000000000000000041977" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041978" data-uri="chapter03.xhtml#P7000497027000000000000000041978" class="calibre10 pcalibre pcalibre1">
int procprob(int b, short a, long *v, char *u);
</code></pre>
</li></ul>
</section>
<section id="P7000497027000000000000000003790" data-uri="chapter03.xhtml#P7000497027000000000000000003790" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041979" data-uri="chapter03.xhtml#P7000497027000000000000000041979" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002AD8"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.34 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002AC0">252</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P700049702700000000000000004197A" data-uri="chapter03.xhtml#P700049702700000000000000004197A">
<li class="calibre12 pcalibre pcalibre1" id="P700049702700000000000000004197B" data-uri="chapter03.xhtml#P700049702700000000000000004197B"><p id="P700049702700000000000000004197C" data-uri="chapter03.xhtml#P700049702700000000000000004197C" class="calibre13 pcalibre pcalibre1">This example demonstrates the use of callee-saved registers as well as the stack for holding local data.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P700049702700000000000000004197D" data-uri="chapter03.xhtml#P700049702700000000000000004197D">
<li id="P700049702700000000000000004197E" data-uri="chapter03.xhtml#P700049702700000000000000004197E" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004197F" data-uri="chapter03.xhtml#P700049702700000000000000004197F" class="calibre13 pcalibre pcalibre1">We can see that lines 9-14 save local values <code id="P7000497027000000000000000041980" data-uri="chapter03.xhtml#P7000497027000000000000000041980" class="pcalibre1 calibre8 pcalibre">a0-a5</code> into callee-saved registers <code id="P7000497027000000000000000041981" data-uri="chapter03.xhtml#P7000497027000000000000000041981" class="pcalibre1 calibre8 pcalibre">%rbx, %r15, %r14, %r13, %r12</code>, and <code id="P7000497027000000000000000041982" data-uri="chapter03.xhtml#P7000497027000000000000000041982" class="pcalibre1 calibre8 pcalibre">%rbp</code>, respectively.</p></li>
<li id="P7000497027000000000000000041983" data-uri="chapter03.xhtml#P7000497027000000000000000041983" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041984" data-uri="chapter03.xhtml#P7000497027000000000000000041984" class="calibre13 pcalibre pcalibre1">Local values <code id="P7000497027000000000000000041985" data-uri="chapter03.xhtml#P7000497027000000000000000041985" class="pcalibre1 calibre8 pcalibre">a6</code> and <code id="P7000497027000000000000000041986" data-uri="chapter03.xhtml#P7000497027000000000000000041986" class="pcalibre1 calibre8 pcalibre">a7</code> are stored on the stack at offsets 0 and 8 relative to the stack pointer (lines 16 and 18).</p></li>
<li id="P7000497027000000000000000041987" data-uri="chapter03.xhtml#P7000497027000000000000000041987" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041988" data-uri="chapter03.xhtml#P7000497027000000000000000041988" class="calibre13 pcalibre pcalibre1">After storing six local variables, the program has used up the supply of callee-saved registers. It stores the remaining two local values on the stack.</p></li>
</ol></li></ul>
</section>
<section id="P70004970270000000000000000037A1" data-uri="chapter03.xhtml#P70004970270000000000000000037A1" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041989" data-uri="chapter03.xhtml#P7000497027000000000000000041989" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002B06"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.35 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP700049702700000000000000000281F.xhtml#P7000497027000000000000000002AF4">254</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P700049702700000000000000004198A" data-uri="chapter03.xhtml#P700049702700000000000000004198A">
<li class="calibre12 pcalibre pcalibre1" id="P700049702700000000000000004198B" data-uri="chapter03.xhtml#P700049702700000000000000004198B"><p id="P700049702700000000000000004198C" data-uri="chapter03.xhtml#P700049702700000000000000004198C" class="calibre13 pcalibre pcalibre1">This problem provides a chance to examine the code for a recursive function. An important lesson to learn is that recursive code has the exact same structure as the other functions we have seen. The stack and register-saving disciplines suffice to make recursive functions operate correctly.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P700049702700000000000000004198D" data-uri="chapter03.xhtml#P700049702700000000000000004198D">
<li id="P700049702700000000000000004198E" data-uri="chapter03.xhtml#P700049702700000000000000004198E" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004198F" data-uri="chapter03.xhtml#P700049702700000000000000004198F" class="calibre13 pcalibre pcalibre1">Register <code id="P7000497027000000000000000041990" data-uri="chapter03.xhtml#P7000497027000000000000000041990" class="pcalibre1 calibre8 pcalibre">%rbx</code> holds the value of parameter <code id="P7000497027000000000000000041991" data-uri="chapter03.xhtml#P7000497027000000000000000041991" class="pcalibre1 calibre8 pcalibre">x</code>, so that it can be used to compute the result expression.</p></li>
<li id="P7000497027000000000000000041992" data-uri="chapter03.xhtml#P7000497027000000000000000041992" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041993" data-uri="chapter03.xhtml#P7000497027000000000000000041993" class="calibre13 pcalibre pcalibre1">The assembly code was generated from the following C code:</p>
<pre id="P7000497027000000000000000041994" data-uri="chapter03.xhtml#P7000497027000000000000000041994" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041995" data-uri="chapter03.xhtml#P7000497027000000000000000041995" class="calibre10 pcalibre pcalibre1">
long rfun(unsigned long x) {
	if (x == 0)
	  return 0;
	unsigned long nx = x&gt;&gt;2;
	long rv = rfun(nx);
	return x + rv;
}
</code></pre>
</li></ol></li></ul>
</section>
<section id="P70004970270000000000000000037AF" data-uri="chapter03.xhtml#P70004970270000000000000000037AF" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041996" data-uri="chapter03.xhtml#P7000497027000000000000000041996" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000037B1" title="341" data-uri="chapter03.xhtml#P70004970270000000000000000037B1" epub:type="pagebreak"></span><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002B62"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.36 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002B23">256</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041997" data-uri="chapter03.xhtml#P7000497027000000000000000041997">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041998" data-uri="chapter03.xhtml#P7000497027000000000000000041998"><p id="P7000497027000000000000000041999" data-uri="chapter03.xhtml#P7000497027000000000000000041999" class="calibre13 pcalibre pcalibre1">This exercise tests your understanding of data sizes and array indexing. Observe that a pointer of any kind is 8 bytes long. Data type short requires 2 bytes, while <code id="P700049702700000000000000004199A" data-uri="chapter03.xhtml#P700049702700000000000000004199A" class="pcalibre1 calibre8 pcalibre">int</code> requires 4.</p>
<table id="P700049702700000000000000004199B" data-uri="chapter03.xhtml#P700049702700000000000000004199B" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P700049702700000000000000004199C" data-uri="chapter03.xhtml#P700049702700000000000000004199C" class="calibre18 pcalibre pcalibre1">Array</th>
<th id="P700049702700000000000000004199D" data-uri="chapter03.xhtml#P700049702700000000000000004199D" class="calibre18 pcalibre pcalibre1">Element size</th>
<th id="P700049702700000000000000004199E" data-uri="chapter03.xhtml#P700049702700000000000000004199E" class="calibre18 pcalibre pcalibre1">Total size</th>
<th id="P700049702700000000000000004199F" data-uri="chapter03.xhtml#P700049702700000000000000004199F" class="calibre18 pcalibre pcalibre1">Start address</th>
<th id="P70004970270000000000000000419A0" data-uri="chapter03.xhtml#P70004970270000000000000000419A0" class="calibre18 pcalibre pcalibre1">Element <var class="calibre5 pcalibre pcalibre1">i</var></th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419A1" data-uri="chapter03.xhtml#P70004970270000000000000000419A1" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419A2" data-uri="chapter03.xhtml#P70004970270000000000000000419A2" class="calibre10 pcalibre pcalibre1">S</code></td>
<td id="P70004970270000000000000000419A3" data-uri="chapter03.xhtml#P70004970270000000000000000419A3" class="calibre20 pcalibre pcalibre1">2</td>
<td id="P70004970270000000000000000419A4" data-uri="chapter03.xhtml#P70004970270000000000000000419A4" class="calibre20 pcalibre pcalibre1">14</td>
<td id="P70004970270000000000000000419A5" data-uri="chapter03.xhtml#P70004970270000000000000000419A5" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">S</sub></td>
<td id="P70004970270000000000000000419A6" data-uri="chapter03.xhtml#P70004970270000000000000000419A6" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">S</sub> + 2<var class="calibre5 pcalibre pcalibre1">i</var></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419A7" data-uri="chapter03.xhtml#P70004970270000000000000000419A7" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419A8" data-uri="chapter03.xhtml#P70004970270000000000000000419A8" class="calibre10 pcalibre pcalibre1">T</code></td>
<td id="P70004970270000000000000000419A9" data-uri="chapter03.xhtml#P70004970270000000000000000419A9" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P70004970270000000000000000419AA" data-uri="chapter03.xhtml#P70004970270000000000000000419AA" class="calibre20 pcalibre pcalibre1">24</td>
<td id="P70004970270000000000000000419AB" data-uri="chapter03.xhtml#P70004970270000000000000000419AB" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">T</sub></td>
<td id="P70004970270000000000000000419AC" data-uri="chapter03.xhtml#P70004970270000000000000000419AC" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">T</sub> + 8<var class="calibre5 pcalibre pcalibre1">i</var></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419AD" data-uri="chapter03.xhtml#P70004970270000000000000000419AD" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419AE" data-uri="chapter03.xhtml#P70004970270000000000000000419AE" class="calibre10 pcalibre pcalibre1">U</code></td>
<td id="P70004970270000000000000000419AF" data-uri="chapter03.xhtml#P70004970270000000000000000419AF" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P70004970270000000000000000419B0" data-uri="chapter03.xhtml#P70004970270000000000000000419B0" class="calibre20 pcalibre pcalibre1">48</td>
<td id="P70004970270000000000000000419B1" data-uri="chapter03.xhtml#P70004970270000000000000000419B1" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">U</sub></td>
<td id="P70004970270000000000000000419B2" data-uri="chapter03.xhtml#P70004970270000000000000000419B2" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">U</sub> +8<var class="calibre5 pcalibre pcalibre1">i</var></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419B3" data-uri="chapter03.xhtml#P70004970270000000000000000419B3" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419B4" data-uri="chapter03.xhtml#P70004970270000000000000000419B4" class="calibre10 pcalibre pcalibre1">V</code></td>
<td id="P70004970270000000000000000419B5" data-uri="chapter03.xhtml#P70004970270000000000000000419B5" class="calibre20 pcalibre pcalibre1">4</td>
<td id="P70004970270000000000000000419B6" data-uri="chapter03.xhtml#P70004970270000000000000000419B6" class="calibre20 pcalibre pcalibre1">32</td>
<td id="P70004970270000000000000000419B7" data-uri="chapter03.xhtml#P70004970270000000000000000419B7" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">V</sub></td>
<td id="P70004970270000000000000000419B8" data-uri="chapter03.xhtml#P70004970270000000000000000419B8" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">V</sub> + 4<var class="calibre5 pcalibre pcalibre1">i</var></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419B9" data-uri="chapter03.xhtml#P70004970270000000000000000419B9" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419BA" data-uri="chapter03.xhtml#P70004970270000000000000000419BA" class="calibre10 pcalibre pcalibre1">W</code></td>
<td id="P70004970270000000000000000419BB" data-uri="chapter03.xhtml#P70004970270000000000000000419BB" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P70004970270000000000000000419BC" data-uri="chapter03.xhtml#P70004970270000000000000000419BC" class="calibre20 pcalibre pcalibre1">32</td>
<td id="P70004970270000000000000000419BD" data-uri="chapter03.xhtml#P70004970270000000000000000419BD" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">W</sub></td>
<td id="P70004970270000000000000000419BE" data-uri="chapter03.xhtml#P70004970270000000000000000419BE" class="calibre20 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre59 pcalibre pcalibre1">W</sub> + 8<var class="calibre5 pcalibre pcalibre1">i</var></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section id="P70004970270000000000000000037DA" data-uri="chapter03.xhtml#P70004970270000000000000000037DA" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000419BF" data-uri="chapter03.xhtml#P70004970270000000000000000419BF" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002BF3"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.37 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002BF5">258</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000419C0" data-uri="chapter03.xhtml#P70004970270000000000000000419C0">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000419C1" data-uri="chapter03.xhtml#P70004970270000000000000000419C1"><p id="P70004970270000000000000000419C2" data-uri="chapter03.xhtml#P70004970270000000000000000419C2" class="calibre13 pcalibre pcalibre1">This problem is a variant of the one shown for integer array E. It is important to understand the difference between a pointer and the object being pointed to. Since data type short requires 2 bytes, all of the array indices are scaled by a factor of 2. Rather than using <code id="P70004970270000000000000000419C3" data-uri="chapter03.xhtml#P70004970270000000000000000419C3" class="pcalibre1 calibre8 pcalibre">movl</code>, as before, we now use <code id="P70004970270000000000000000419C4" data-uri="chapter03.xhtml#P70004970270000000000000000419C4" class="pcalibre1 calibre8 pcalibre">movw</code>.</p>
<table id="P70004970270000000000000000419C5" data-uri="chapter03.xhtml#P70004970270000000000000000419C5" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000419C6" data-uri="chapter03.xhtml#P70004970270000000000000000419C6" class="calibre18 pcalibre pcalibre1">Expression</th>
<th id="P70004970270000000000000000419C7" data-uri="chapter03.xhtml#P70004970270000000000000000419C7" class="calibre18 pcalibre pcalibre1">Type</th>
<th id="P70004970270000000000000000419C8" data-uri="chapter03.xhtml#P70004970270000000000000000419C8" class="calibre18 pcalibre pcalibre1">Value</th>
<th id="P70004970270000000000000000419C9" data-uri="chapter03.xhtml#P70004970270000000000000000419C9" class="calibre18 pcalibre pcalibre1">Assembly</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419CA" data-uri="chapter03.xhtml#P70004970270000000000000000419CA" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419CB" data-uri="chapter03.xhtml#P70004970270000000000000000419CB" class="calibre10 pcalibre pcalibre1">S+1</code></td>
<td id="P70004970270000000000000000419CC" data-uri="chapter03.xhtml#P70004970270000000000000000419CC" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419CD" data-uri="chapter03.xhtml#P70004970270000000000000000419CD" class="calibre10 pcalibre pcalibre1">short *</code></td>
<td id="P70004970270000000000000000419CE" data-uri="chapter03.xhtml#P70004970270000000000000000419CE" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419CF" data-uri="chapter03.xhtml#P70004970270000000000000000419CF" class="calibre10 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">S</sub> +2</code></td>
<td id="P70004970270000000000000000419D0" data-uri="chapter03.xhtml#P70004970270000000000000000419D0" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419D1" data-uri="chapter03.xhtml#P70004970270000000000000000419D1" class="calibre10 pcalibre pcalibre1">leaq 2(%rdx),%rax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419D2" data-uri="chapter03.xhtml#P70004970270000000000000000419D2" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419D3" data-uri="chapter03.xhtml#P70004970270000000000000000419D3" class="calibre10 pcalibre pcalibre1">S[3]</code></td>
<td id="P70004970270000000000000000419D4" data-uri="chapter03.xhtml#P70004970270000000000000000419D4" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419D5" data-uri="chapter03.xhtml#P70004970270000000000000000419D5" class="calibre10 pcalibre pcalibre1">short</code></td>
<td id="P70004970270000000000000000419D6" data-uri="chapter03.xhtml#P70004970270000000000000000419D6" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419D7" data-uri="chapter03.xhtml#P70004970270000000000000000419D7" class="calibre10 pcalibre pcalibre1">M[<var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">S</sub> + 6]</code></td>
<td id="P70004970270000000000000000419D8" data-uri="chapter03.xhtml#P70004970270000000000000000419D8" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419D9" data-uri="chapter03.xhtml#P70004970270000000000000000419D9" class="calibre10 pcalibre pcalibre1">movw 6(%rdx),%ax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419DA" data-uri="chapter03.xhtml#P70004970270000000000000000419DA" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419DB" data-uri="chapter03.xhtml#P70004970270000000000000000419DB" class="calibre10 pcalibre pcalibre1">&amp;S[i]</code></td>
<td id="P70004970270000000000000000419DC" data-uri="chapter03.xhtml#P70004970270000000000000000419DC" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419DD" data-uri="chapter03.xhtml#P70004970270000000000000000419DD" class="calibre10 pcalibre pcalibre1">short *</code></td>
<td id="P70004970270000000000000000419DE" data-uri="chapter03.xhtml#P70004970270000000000000000419DE" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419DF" data-uri="chapter03.xhtml#P70004970270000000000000000419DF" class="calibre10 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">S</sub> + 2<var class="calibre5 pcalibre pcalibre1">i</var></code></td>
<td id="P70004970270000000000000000419E0" data-uri="chapter03.xhtml#P70004970270000000000000000419E0" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419E1" data-uri="chapter03.xhtml#P70004970270000000000000000419E1" class="calibre10 pcalibre pcalibre1">leaq (%rdx,%rcx,2),%rax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419E2" data-uri="chapter03.xhtml#P70004970270000000000000000419E2" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419E3" data-uri="chapter03.xhtml#P70004970270000000000000000419E3" class="calibre10 pcalibre pcalibre1">S[4*i+1]</code></td>
<td id="P70004970270000000000000000419E4" data-uri="chapter03.xhtml#P70004970270000000000000000419E4" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419E5" data-uri="chapter03.xhtml#P70004970270000000000000000419E5" class="calibre10 pcalibre pcalibre1">short</code></td>
<td id="P70004970270000000000000000419E6" data-uri="chapter03.xhtml#P70004970270000000000000000419E6" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419E7" data-uri="chapter03.xhtml#P70004970270000000000000000419E7" class="calibre10 pcalibre pcalibre1">M[<var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">S</sub> + 8<var class="calibre5 pcalibre pcalibre1">i</var> + 2]</code></td>
<td id="P70004970270000000000000000419E8" data-uri="chapter03.xhtml#P70004970270000000000000000419E8" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419E9" data-uri="chapter03.xhtml#P70004970270000000000000000419E9" class="calibre10 pcalibre pcalibre1">movw 2(%rdx,%rcx,8),%ax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000419EA" data-uri="chapter03.xhtml#P70004970270000000000000000419EA" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419EB" data-uri="chapter03.xhtml#P70004970270000000000000000419EB" class="calibre10 pcalibre pcalibre1">S+i-5</code></td>
<td id="P70004970270000000000000000419EC" data-uri="chapter03.xhtml#P70004970270000000000000000419EC" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419ED" data-uri="chapter03.xhtml#P70004970270000000000000000419ED" class="calibre10 pcalibre pcalibre1">short *</code></td>
<td id="P70004970270000000000000000419EE" data-uri="chapter03.xhtml#P70004970270000000000000000419EE" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419EF" data-uri="chapter03.xhtml#P70004970270000000000000000419EF" class="calibre10 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">S</sub> + 2<var class="calibre5 pcalibre pcalibre1">i</var> - 10</code></td>
<td id="P70004970270000000000000000419F0" data-uri="chapter03.xhtml#P70004970270000000000000000419F0" class="calibre20 pcalibre pcalibre1"><code id="P70004970270000000000000000419F1" data-uri="chapter03.xhtml#P70004970270000000000000000419F1" class="calibre10 pcalibre pcalibre1">leaq -10(%rdx,%rcx,2),%rax</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section id="P700049702700000000000000000380E" data-uri="chapter03.xhtml#P700049702700000000000000000380E" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000419F2" data-uri="chapter03.xhtml#P70004970270000000000000000419F2" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C4D"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.38 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C3B">259</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000419F3" data-uri="chapter03.xhtml#P70004970270000000000000000419F3">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000419F4" data-uri="chapter03.xhtml#P70004970270000000000000000419F4"><p id="P70004970270000000000000000419F5" data-uri="chapter03.xhtml#P70004970270000000000000000419F5" class="calibre13 pcalibre pcalibre1">This problem requires you to work through the scaling operations to determine the address computations, and to apply <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C39"><span class="pcalibre label pcalibre1">Equation </span><span class="pcalibre label pcalibre1">3.1</span></a> for row-major indexing. The first step is to annotate the assembly code to determine how the address references are computed:</p>
<pre id="P70004970270000000000000000419F6" data-uri="chapter03.xhtml#P70004970270000000000000000419F6" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000419F7" data-uri="chapter03.xhtml#P70004970270000000000000000419F7" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">long sum_element(long i, long j)</i>
	<i class="calibre5 pcalibre pcalibre1">i in %rdi, j in %rsi</i>
1	sum_element:	
2	  leaq	0(,%rdi,8), %rdx	<i class="calibre5 pcalibre pcalibre1">Compute</i> 8<var class="calibre5 pcalibre pcalibre1">i</var>
3	  subq	%rdi, %rdx		<i class="calibre5 pcalibre pcalibre1">Compute</i> 7<var class="calibre5 pcalibre pcalibre1">i</var>
4	  addq %rsi, %rdx		<i class="calibre5 pcalibre pcalibre1">Compute</i> 7<var class="calibre5 pcalibre pcalibre1">i</var> + <var class="calibre5 pcalibre pcalibre1">j</var>
5	  leaq	(%rsi,%rsi,4), %rax	<i class="calibre5 pcalibre pcalibre1">Compute</i> 5<var class="calibre5 pcalibre pcalibre1">j</var>
6	  addq	%rax, %rdi		<i class="calibre5 pcalibre pcalibre1">Compute i</i> + 5<var class="calibre5 pcalibre pcalibre1">j</var>
7	  movq	Q(,%rdi,8), %rax	<i class="calibre5 pcalibre pcalibre1">Retrieve</i> M[<var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">Q</sub> + 8 (5<var class="calibre5 pcalibre pcalibre1">j</var> + <var class="calibre5 pcalibre pcalibre1">i</var>)]
8	  addq	P(,%rdx,8), %rax	<i class="calibre5 pcalibre pcalibre1">Add</i> M[<var class="calibre5 pcalibre pcalibre1">x</var><sub class="calibre85 pcalibre pcalibre1">P</sub> + 8 (7<var class="calibre5 pcalibre pcalibre1">i</var> + <i class="calibre5 pcalibre pcalibre1">j)</i>]
9	  ret		
</code></pre>
<p id="P70004970270000000000000000419F8" data-uri="chapter03.xhtml#P70004970270000000000000000419F8" class="calibre13 pcalibre pcalibre1">We can see that the reference to matrix <code id="P70004970270000000000000000419F9" data-uri="chapter03.xhtml#P70004970270000000000000000419F9" class="pcalibre1 calibre8 pcalibre">P</code> is at byte offset 8 · (7<var class="calibre5 pcalibre pcalibre1">i</var> + <var class="calibre5 pcalibre pcalibre1">j</var>), while the reference to matrix <code id="P70004970270000000000000000419FA" data-uri="chapter03.xhtml#P70004970270000000000000000419FA" class="pcalibre1 calibre8 pcalibre">Q</code> is at byte offset 8 · (5<var class="calibre5 pcalibre pcalibre1">j</var> + <var class="calibre5 pcalibre pcalibre1">i</var>). From this, we can determine that <code id="P70004970270000000000000000419FB" data-uri="chapter03.xhtml#P70004970270000000000000000419FB" class="pcalibre1 calibre8 pcalibre">P</code> has 7 columns, while <code id="P70004970270000000000000000419FC" data-uri="chapter03.xhtml#P70004970270000000000000000419FC" class="pcalibre1 calibre8 pcalibre">Q</code> has 5, giving <var class="calibre5 pcalibre pcalibre1">M</var> = 5 and <var class="calibre5 pcalibre pcalibre1">N</var> = 7.</p>
</li></ul>
</section>
<section id="P700049702700000000000000000381A" data-uri="chapter03.xhtml#P700049702700000000000000000381A" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000419FD" data-uri="chapter03.xhtml#P70004970270000000000000000419FD" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000381C" title="342" data-uri="chapter03.xhtml#P700049702700000000000000000381C" epub:type="pagebreak"></span><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C90"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.39 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C8F">262</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P70004970270000000000000000419FE" data-uri="chapter03.xhtml#P70004970270000000000000000419FE">
<li class="calibre12 pcalibre pcalibre1" id="P70004970270000000000000000419FF" data-uri="chapter03.xhtml#P70004970270000000000000000419FF"><p id="P7000497027000000000000000041A00" data-uri="chapter03.xhtml#P7000497027000000000000000041A00" class="calibre13 pcalibre pcalibre1">These computations are direct applications of <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C39"><span class="pcalibre label pcalibre1">Equation </span><span class="pcalibre label pcalibre1">3.1</span></a>:</p>
<ul id="P7000497027000000000000000041A01" data-uri="chapter03.xhtml#P7000497027000000000000000041A01" class="pcalibre calibre39 pcalibre1">
<li id="P7000497027000000000000000041A02" data-uri="chapter03.xhtml#P7000497027000000000000000041A02" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A03" data-uri="chapter03.xhtml#P7000497027000000000000000041A03" class="calibre13 pcalibre pcalibre1">For <var class="calibre5 pcalibre pcalibre1">L</var> = 4, <var class="calibre5 pcalibre pcalibre1">C</var> = 16, and <var class="calibre5 pcalibre pcalibre1">j</var> = 0, pointer <code id="P7000497027000000000000000041A04" data-uri="chapter03.xhtml#P7000497027000000000000000041A04" class="pcalibre1 calibre8 pcalibre">Aptr</code> is computed as <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">A</sub> + 4 · (16<var class="calibre5 pcalibre pcalibre1">i</var> + 0) = <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">A</sub> + 64<var class="calibre5 pcalibre pcalibre1">i</var>.</p></li>
<li id="P7000497027000000000000000041A05" data-uri="chapter03.xhtml#P7000497027000000000000000041A05" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A06" data-uri="chapter03.xhtml#P7000497027000000000000000041A06" class="calibre13 pcalibre pcalibre1">For <var class="calibre5 pcalibre pcalibre1">L</var> = 4, <var class="calibre5 pcalibre pcalibre1">C</var> = 16, <var class="calibre5 pcalibre pcalibre1">i</var> = 0, and <var class="calibre5 pcalibre pcalibre1">j</var> = <var class="calibre5 pcalibre pcalibre1">k</var>, Bptr is computed as <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">B</sub> + 4 · (16 · 0 + <var class="calibre5 pcalibre pcalibre1">k</var>) = <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">B</sub> + 4<var class="calibre5 pcalibre pcalibre1">k</var>.</p></li>
<li id="P7000497027000000000000000041A07" data-uri="chapter03.xhtml#P7000497027000000000000000041A07" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A08" data-uri="chapter03.xhtml#P7000497027000000000000000041A08" class="calibre13 pcalibre pcalibre1">For <var class="calibre5 pcalibre pcalibre1">L</var> = 4, <var class="calibre5 pcalibre pcalibre1">C</var> = 16, <var class="calibre5 pcalibre pcalibre1">i</var> = 16, and <var class="calibre5 pcalibre pcalibre1">j</var> = <var class="calibre5 pcalibre pcalibre1">k</var>, Bend is computed as <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">B</sub> + 4 · (16 · 16 + <var class="calibre5 pcalibre pcalibre1">k</var>) = <var class="calibre5 pcalibre pcalibre1">x</var><sub class="pcalibre1 calibre47 pcalibre">B</sub> + 1,024 + 4<var class="calibre5 pcalibre pcalibre1">k</var>.</p></li>
</ul></li></ul>
</section>
<section id="P7000497027000000000000000003828" data-uri="chapter03.xhtml#P7000497027000000000000000003828" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041A09" data-uri="chapter03.xhtml#P7000497027000000000000000041A09" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C99"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.40 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C8F">262</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041A0A" data-uri="chapter03.xhtml#P7000497027000000000000000041A0A">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041A0B" data-uri="chapter03.xhtml#P7000497027000000000000000041A0B"><p id="P7000497027000000000000000041A0C" data-uri="chapter03.xhtml#P7000497027000000000000000041A0C" class="calibre13 pcalibre pcalibre1">This exercise requires that you be able to study compiler-generated assembly code to understand what optimizations have been performed. In this case, the compiler was clever in its optimizations.</p>
<p id="P7000497027000000000000000041A0D" data-uri="chapter03.xhtml#P7000497027000000000000000041A0D" class="calibre15 pcalibre pcalibre1">Let us first study the following C code, and then see how it is derived from the assembly code generated for the original function.</p>
<pre id="P7000497027000000000000000041A0E" data-uri="chapter03.xhtml#P7000497027000000000000000041A0E" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A0F" data-uri="chapter03.xhtml#P7000497027000000000000000041A0F" class="calibre10 pcalibre pcalibre1">
/* Set all diagonal elements to val */
void fix_set_diag_opt(fix_matrix A, int val) {
	int *Abase = &amp;A[0][0];
	long i = 0;
	long iend = N*(N+1);
	do {
	  Abase[i] = val;
	  i += (N+1);
	} while (i != iend);
}
</code></pre>
<p class="calibre13 pcalibre pcalibre1" id="P7000497027000000000000000041A10" data-uri="chapter03.xhtml#P7000497027000000000000000041A10">This function introduces a variable Abase, of type <code id="P7000497027000000000000000041A11" data-uri="chapter03.xhtml#P7000497027000000000000000041A11" class="pcalibre1 calibre8 pcalibre">int</code> *, pointing to the start of array A. This pointer designates a sequence of 4-byte integers consisting of elements of A in row-major order. We introduce an integer variable index that steps through the diagonal elements of A, with the property that diagonal elements <var class="calibre5 pcalibre pcalibre1">i</var> and <var class="calibre5 pcalibre pcalibre1">i</var> + 1 are spaced <var class="calibre5 pcalibre pcalibre1">N</var> + 1 elements apart in the sequence, and that once we reach diagonal element <var class="calibre5 pcalibre pcalibre1">N</var> (index value <i class="calibre5 pcalibre pcalibre1">N(N</i> + 1)), we have gone beyond the end.</p>
<p id="P7000497027000000000000000041A12" data-uri="chapter03.xhtml#P7000497027000000000000000041A12" class="calibre15 pcalibre pcalibre1">The actual assembly code follows this general form, but now the pointer increments must be scaled by a factor of 4. We label register <code id="P7000497027000000000000000041A13" data-uri="chapter03.xhtml#P7000497027000000000000000041A13" class="pcalibre1 calibre8 pcalibre">%rax</code> as holding a value <code id="P7000497027000000000000000041A14" data-uri="chapter03.xhtml#P7000497027000000000000000041A14" class="pcalibre1 calibre8 pcalibre">index4</code> equal to index in our C version but scaled by a factor of 4. For <var class="calibre5 pcalibre pcalibre1">N</var> = 16, we can see that our stopping point for <code id="P7000497027000000000000000041A15" data-uri="chapter03.xhtml#P7000497027000000000000000041A15" class="pcalibre1 calibre8 pcalibre">index4</code> will be 4. 16(16 + 1) = 1,088.</p>
<pre id="P7000497027000000000000000041A16" data-uri="chapter03.xhtml#P7000497027000000000000000041A16" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A17" data-uri="chapter03.xhtml#P7000497027000000000000000041A17" class="calibre10 pcalibre pcalibre1">
1	fix_set_diag:
	<i class="calibre5 pcalibre pcalibre1">void fix_set_diag(fix_matrix A, int val)</i>
	<i class="calibre5 pcalibre pcalibre1">A in %rdi, val in %rsi</i>
2	  movl	0, %eax			<i class="calibre5 pcalibre pcalibre1">Set index4 = 0</i>
3	.L13:			    <b class="calibre4 pcalibre pcalibre1">loop:</b>
4	  movl	%esi, (%rdi,%rax)	<i class="calibre5 pcalibre pcalibre1">Set Abase[index4/4] to val</i>
5	  addq	$68, %rax		<i class="calibre5 pcalibre pcalibre1">Increment index4 += 4(N+1)</i>
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003838" title="343" data-uri="chapter03.xhtml#P7000497027000000000000000003838" epub:type="pagebreak"></span>6	  cmpq	$1088, %rax		<i class="calibre5 pcalibre pcalibre1">Compare index4: 4N(N+1)</i>
7	  jne	.L13			<i class="calibre5 pcalibre pcalibre1">If !=, goto</i> <b class="calibre4 pcalibre pcalibre1">loop</b>
8	  rep;	ret			<i class="calibre5 pcalibre pcalibre1">Return</i>
</code></pre>
</li></ul>
</section>
<section id="P7000497027000000000000000003839" data-uri="chapter03.xhtml#P7000497027000000000000000003839" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041A18" data-uri="chapter03.xhtml#P7000497027000000000000000041A18" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002D32"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.41 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002D34">268</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041A19" data-uri="chapter03.xhtml#P7000497027000000000000000041A19">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041A1A" data-uri="chapter03.xhtml#P7000497027000000000000000041A1A"><p id="P7000497027000000000000000041A1B" data-uri="chapter03.xhtml#P7000497027000000000000000041A1B" class="calibre13 pcalibre pcalibre1">This problem gets you to think about structure layout and the code used to access structure fields. The structure declaration is a variant of the example shown in the text. It shows that nested structures are allocated by embedding the inner structures within the outer ones.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041A1C" data-uri="chapter03.xhtml#P7000497027000000000000000041A1C">
<li id="P7000497027000000000000000041A1D" data-uri="chapter03.xhtml#P7000497027000000000000000041A1D" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A1E" data-uri="chapter03.xhtml#P7000497027000000000000000041A1E" class="calibre13 pcalibre pcalibre1">The layout of the structure is as follows:</p>
<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000003841" data-uri="chapter03.xhtml#P7000497027000000000000000003841">
<img alt="A diagram shows four fields: offset 0 to 8 with contents p; offset 8 to 12 with contents s.x; offset 12 to 16 with contents s.y; offset 16 to 24 with contents next." id="P7000497027000000000000000041A1F" data-uri="P700049702700000000000000000B6C6" src="../images/p343-1.png" class="pcalibre1 pcalibre calibre101"/>
</figure>
</li>
<li id="P7000497027000000000000000041A20" data-uri="chapter03.xhtml#P7000497027000000000000000041A20" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A21" data-uri="chapter03.xhtml#P7000497027000000000000000041A21" class="calibre13 pcalibre pcalibre1">It uses 24 bytes.</p></li>
<li id="P7000497027000000000000000041A22" data-uri="chapter03.xhtml#P7000497027000000000000000041A22" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A23" data-uri="chapter03.xhtml#P7000497027000000000000000041A23" class="calibre13 pcalibre pcalibre1">As always, we start by annotating the assembly code:</p>
<pre id="P7000497027000000000000000041A24" data-uri="chapter03.xhtml#P7000497027000000000000000041A24" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A25" data-uri="chapter03.xhtml#P7000497027000000000000000041A25" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">void sp_init(struct prob *sp)</i>
	<i class="calibre5 pcalibre pcalibre1">sp in %rdi</i>
1	sp_init:
2	  movl	12(%rdi), %eax	<i class="calibre5 pcalibre pcalibre1">Get sp-&gt;s.y</i>
3	  movl	%eax, 8(%rdi)	<i class="calibre5 pcalibre pcalibre1">Save in sp-&gt;s.x</i>
4	  leaq	8(%rdi), %rax	<i class="calibre5 pcalibre pcalibre1">Compute &amp;(sp-&gt;s.x)</i>
5	  movq	%rax, (%rdi)	<i class="calibre5 pcalibre pcalibre1">Store in sp-&gt;p</i>
6	  movq	%rdi, 16(%rdi)	<i class="calibre5 pcalibre pcalibre1">Store sp in sp-&gt;next</i>
7	  ret
</code></pre>
<p id="P7000497027000000000000000041A26" data-uri="chapter03.xhtml#P7000497027000000000000000041A26" class="calibre13 pcalibre pcalibre1">From this, we can generate C code as follows:</p>
<pre id="P7000497027000000000000000041A27" data-uri="chapter03.xhtml#P7000497027000000000000000041A27" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A28" data-uri="chapter03.xhtml#P7000497027000000000000000041A28" class="calibre10 pcalibre pcalibre1">
void sp_init(struct prob *sp)
{
	sp-&gt;s.x	= sp-&gt;s.y;
	sp-&gt;p	= &amp;(sp-&gt;s.x);
	sp-&gt;next	= sp;
}
</code></pre>
</li></ol></li></ul>
</section>
<section id="P700049702700000000000000000384C" data-uri="chapter03.xhtml#P700049702700000000000000000384C" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041A29" data-uri="chapter03.xhtml#P7000497027000000000000000041A29" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002D4D"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.42 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002D4F">269</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041A2A" data-uri="chapter03.xhtml#P7000497027000000000000000041A2A">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041A2B" data-uri="chapter03.xhtml#P7000497027000000000000000041A2B"><p id="P7000497027000000000000000041A2C" data-uri="chapter03.xhtml#P7000497027000000000000000041A2C" class="calibre13 pcalibre pcalibre1">This problem demonstrates how a very common data structure and operation on it is implemented in machine code. We solve the problem by first annotating the assembly code, recognizing that the two fields of the structure are at offsets 0 (for <code id="P7000497027000000000000000041A2D" data-uri="chapter03.xhtml#P7000497027000000000000000041A2D" class="pcalibre1 calibre8 pcalibre">v</code>) and 8 (for <code id="P7000497027000000000000000041A2E" data-uri="chapter03.xhtml#P7000497027000000000000000041A2E" class="pcalibre1 calibre8 pcalibre">p</code>).</p>
<pre id="P7000497027000000000000000041A2F" data-uri="chapter03.xhtml#P7000497027000000000000000041A2F" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A30" data-uri="chapter03.xhtml#P7000497027000000000000000041A30" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">long fun(struct ELE *ptr)</i>
	<i class="calibre5 pcalibre pcalibre1">ptr in %rdi</i>
1	fun:
2	  movl	$0, %eax	<i class="calibre5 pcalibre pcalibre1">result = 0</i>
3	  jmp	.L2		<i class="calibre5 pcalibre pcalibre1">Goto</i> <b class="calibre4 pcalibre pcalibre1">middle</b>
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003855" title="344" data-uri="chapter03.xhtml#P7000497027000000000000000003855" epub:type="pagebreak"></span>4	.L3:		    <b class="calibre4 pcalibre pcalibre1">loop:</b>
5	  addq	(%rdi), %rax	<i class="calibre5 pcalibre pcalibre1">result += ptr-&gt;v</i>
6	  movq	8(%rdi), %rdi	<i class="calibre5 pcalibre pcalibre1">ptr = ptr-&gt;p</i>
7	.L2:		    <b class="calibre4 pcalibre pcalibre1">middle:</b>
8	  testq	%rdi, %rdi	<i class="calibre5 pcalibre pcalibre1">Test ptr</i>
9	  jne	.L3		<i class="calibre5 pcalibre pcalibre1">If ! = NULL, goto</i> <b class="calibre4 pcalibre pcalibre1">loop</b>
10	  rep;	ret
</code></pre>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041A31" data-uri="chapter03.xhtml#P7000497027000000000000000041A31">
<li id="P7000497027000000000000000041A32" data-uri="chapter03.xhtml#P7000497027000000000000000041A32" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A33" data-uri="chapter03.xhtml#P7000497027000000000000000041A33" class="calibre13 pcalibre pcalibre1">Based on the annotated code, we can generate a C version:</p>
<pre id="P7000497027000000000000000041A34" data-uri="chapter03.xhtml#P7000497027000000000000000041A34" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041A35" data-uri="chapter03.xhtml#P7000497027000000000000000041A35" class="calibre10 pcalibre pcalibre1">
long fun(struct ELE *ptr) {
	long val = 0;
	while (ptr) {
	  val += ptr-&gt;v;
	  ptr = ptr-&gt;p;
	}
	return val;
}
</code></pre>
</li>
<li id="P7000497027000000000000000041A36" data-uri="chapter03.xhtml#P7000497027000000000000000041A36" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A37" data-uri="chapter03.xhtml#P7000497027000000000000000041A37" class="calibre13 pcalibre pcalibre1">We can see that each structure is an element in a singly linked list, with field <code id="P7000497027000000000000000041A38" data-uri="chapter03.xhtml#P7000497027000000000000000041A38" class="pcalibre1 calibre8 pcalibre">v</code> being the value of the element and <code id="P7000497027000000000000000041A39" data-uri="chapter03.xhtml#P7000497027000000000000000041A39" class="pcalibre1 calibre8 pcalibre">p</code> being a pointer to the next element. Function fun computes the sum of the element values in the list.</p></li>
</ol></li></ul>
</section>
<section id="P700049702700000000000000000385F" data-uri="chapter03.xhtml#P700049702700000000000000000385F" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041A3A" data-uri="chapter03.xhtml#P7000497027000000000000000041A3A" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002DC2"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.43 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002DB5">272</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041A3B" data-uri="chapter03.xhtml#P7000497027000000000000000041A3B">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041A3C" data-uri="chapter03.xhtml#P7000497027000000000000000041A3C"><p id="P7000497027000000000000000041A3D" data-uri="chapter03.xhtml#P7000497027000000000000000041A3D" class="calibre13 pcalibre pcalibre1">Structures and unions involve a simple set of concepts, but it takes practice to be comfortable with the different referencing patterns and their implementations.</p>
<table class="informaltable pcalibre pcalibre1" id="P7000497027000000000000000041A3E" data-uri="chapter03.xhtml#P7000497027000000000000000041A3E">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041A3F" data-uri="chapter03.xhtml#P7000497027000000000000000041A3F" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A40" data-uri="chapter03.xhtml#P7000497027000000000000000041A40" class="calibre10 pcalibre pcalibre1">EXPR</code></th>
<th id="P7000497027000000000000000041A41" data-uri="chapter03.xhtml#P7000497027000000000000000041A41" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A42" data-uri="chapter03.xhtml#P7000497027000000000000000041A42" class="calibre10 pcalibre pcalibre1">TYPE</code></th>
<th id="P7000497027000000000000000041A43" data-uri="chapter03.xhtml#P7000497027000000000000000041A43" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A44" data-uri="chapter03.xhtml#P7000497027000000000000000041A44" class="calibre10 pcalibre pcalibre1">Code</code></th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A45" data-uri="chapter03.xhtml#P7000497027000000000000000041A45" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A46" data-uri="chapter03.xhtml#P7000497027000000000000000041A46" class="calibre10 pcalibre pcalibre1">up-&gt;t1.u</code></td>
<td id="P7000497027000000000000000041A47" data-uri="chapter03.xhtml#P7000497027000000000000000041A47" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A48" data-uri="chapter03.xhtml#P7000497027000000000000000041A48" class="calibre10 pcalibre pcalibre1">long</code></td>
<td id="P7000497027000000000000000041A49" data-uri="chapter03.xhtml#P7000497027000000000000000041A49" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A4A" data-uri="chapter03.xhtml#P7000497027000000000000000041A4A" class="calibre10 pcalibre pcalibre1">movq (%rdi), %rax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A4B" data-uri="chapter03.xhtml#P7000497027000000000000000041A4B" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A4C" data-uri="chapter03.xhtml#P7000497027000000000000000041A4C" class="calibre10 pcalibre pcalibre1">movq %rax, (%rsi)</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A4D" data-uri="chapter03.xhtml#P7000497027000000000000000041A4D" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A4E" data-uri="chapter03.xhtml#P7000497027000000000000000041A4E" class="calibre10 pcalibre pcalibre1">up-&gt;t1.v</code></td>
<td id="P7000497027000000000000000041A4F" data-uri="chapter03.xhtml#P7000497027000000000000000041A4F" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A50" data-uri="chapter03.xhtml#P7000497027000000000000000041A50" class="calibre10 pcalibre pcalibre1">short</code></td>
<td id="P7000497027000000000000000041A51" data-uri="chapter03.xhtml#P7000497027000000000000000041A51" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A52" data-uri="chapter03.xhtml#P7000497027000000000000000041A52" class="calibre10 pcalibre pcalibre1">movw 8(%rdi), %ax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A53" data-uri="chapter03.xhtml#P7000497027000000000000000041A53" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A54" data-uri="chapter03.xhtml#P7000497027000000000000000041A54" class="calibre10 pcalibre pcalibre1">movw %ax, (%rsi)</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A55" data-uri="chapter03.xhtml#P7000497027000000000000000041A55" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A56" data-uri="chapter03.xhtml#P7000497027000000000000000041A56" class="calibre10 pcalibre pcalibre1">&amp;up-&gt;t1.w</code></td>
<td id="P7000497027000000000000000041A57" data-uri="chapter03.xhtml#P7000497027000000000000000041A57" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A58" data-uri="chapter03.xhtml#P7000497027000000000000000041A58" class="calibre10 pcalibre pcalibre1">char *</code></td>
<td id="P7000497027000000000000000041A59" data-uri="chapter03.xhtml#P7000497027000000000000000041A59" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A5A" data-uri="chapter03.xhtml#P7000497027000000000000000041A5A" class="calibre10 pcalibre pcalibre1">addq $10, %rdi</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A5B" data-uri="chapter03.xhtml#P7000497027000000000000000041A5B" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A5C" data-uri="chapter03.xhtml#P7000497027000000000000000041A5C" class="calibre10 pcalibre pcalibre1">movq %rdi, (%rsi)</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A5D" data-uri="chapter03.xhtml#P7000497027000000000000000041A5D" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A5E" data-uri="chapter03.xhtml#P7000497027000000000000000041A5E" class="calibre10 pcalibre pcalibre1">up-&gt;t2.a</code></td>
<td id="P7000497027000000000000000041A5F" data-uri="chapter03.xhtml#P7000497027000000000000000041A5F" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A60" data-uri="chapter03.xhtml#P7000497027000000000000000041A60" class="calibre10 pcalibre pcalibre1">int *</code></td>
<td id="P7000497027000000000000000041A61" data-uri="chapter03.xhtml#P7000497027000000000000000041A61" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A62" data-uri="chapter03.xhtml#P7000497027000000000000000041A62" class="calibre10 pcalibre pcalibre1">movq %rdi, (%rsi)</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A63" data-uri="chapter03.xhtml#P7000497027000000000000000041A63" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A64" data-uri="chapter03.xhtml#P7000497027000000000000000041A64" class="calibre10 pcalibre pcalibre1">up-&gt;t2.a[up-&gt;t1.u]</code></td>
<td id="P7000497027000000000000000041A65" data-uri="chapter03.xhtml#P7000497027000000000000000041A65" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A66" data-uri="chapter03.xhtml#P7000497027000000000000000041A66" class="calibre10 pcalibre pcalibre1">int</code></td>
<td id="P7000497027000000000000000041A67" data-uri="chapter03.xhtml#P7000497027000000000000000041A67" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A68" data-uri="chapter03.xhtml#P7000497027000000000000000041A68" class="calibre10 pcalibre pcalibre1">movq (%rdi), %rax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A69" data-uri="chapter03.xhtml#P7000497027000000000000000041A69" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A6A" data-uri="chapter03.xhtml#P7000497027000000000000000041A6A" class="calibre10 pcalibre pcalibre1">movl (%rdi,%rax,4), %eax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A6B" data-uri="chapter03.xhtml#P7000497027000000000000000041A6B" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A6C" data-uri="chapter03.xhtml#P7000497027000000000000000041A6C" class="calibre10 pcalibre pcalibre1">movl %eax, (%rsi)</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A6D" data-uri="chapter03.xhtml#P7000497027000000000000000041A6D" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A6E" data-uri="chapter03.xhtml#P7000497027000000000000000041A6E" class="calibre10 pcalibre pcalibre1">*up-&gt;t2.p</code></td>
<td id="P7000497027000000000000000041A6F" data-uri="chapter03.xhtml#P7000497027000000000000000041A6F" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A70" data-uri="chapter03.xhtml#P7000497027000000000000000041A70" class="calibre10 pcalibre pcalibre1">char</code></td>
<td id="P7000497027000000000000000041A71" data-uri="chapter03.xhtml#P7000497027000000000000000041A71" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A72" data-uri="chapter03.xhtml#P7000497027000000000000000041A72" class="calibre10 pcalibre pcalibre1">movq 8(%rdi), %rax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A73" data-uri="chapter03.xhtml#P7000497027000000000000000041A73" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A74" data-uri="chapter03.xhtml#P7000497027000000000000000041A74" class="calibre10 pcalibre pcalibre1">movb (%rax), %al</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000041A75" data-uri="chapter03.xhtml#P7000497027000000000000000041A75" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041A76" data-uri="chapter03.xhtml#P7000497027000000000000000041A76" class="calibre10 pcalibre pcalibre1">movb %al, (%rsi)</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section id="P700049702700000000000000000389D" data-uri="chapter03.xhtml#P700049702700000000000000000389D" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041A77" data-uri="chapter03.xhtml#P7000497027000000000000000041A77" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000389F" title="345" data-uri="chapter03.xhtml#P700049702700000000000000000389F" epub:type="pagebreak"></span><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002E39"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.44 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002E24">275</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041A78" data-uri="chapter03.xhtml#P7000497027000000000000000041A78">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041A79" data-uri="chapter03.xhtml#P7000497027000000000000000041A79"><p id="P7000497027000000000000000041A7A" data-uri="chapter03.xhtml#P7000497027000000000000000041A7A" class="calibre13 pcalibre pcalibre1">Understanding structure layout and alignment is very important for understanding how much storage different data structures require and for understanding the code generated by the compiler for accessing structures. This problem lets you work out the details of some example structures.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041A7B" data-uri="chapter03.xhtml#P7000497027000000000000000041A7B">
<li id="P7000497027000000000000000041A7C" data-uri="chapter03.xhtml#P7000497027000000000000000041A7C" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A7D" data-uri="chapter03.xhtml#P7000497027000000000000000041A7D" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041A7E" data-uri="chapter03.xhtml#P7000497027000000000000000041A7E" class="pcalibre1 calibre8 pcalibre">struct P1 { int i; char c; int j; char d; };</code></p>
<table id="P7000497027000000000000000041A7F" data-uri="chapter03.xhtml#P7000497027000000000000000041A7F" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041A80" data-uri="chapter03.xhtml#P7000497027000000000000000041A80" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A81" data-uri="chapter03.xhtml#P7000497027000000000000000041A81" class="calibre10 pcalibre pcalibre1">i</code></th>
<th id="P7000497027000000000000000041A82" data-uri="chapter03.xhtml#P7000497027000000000000000041A82" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A83" data-uri="chapter03.xhtml#P7000497027000000000000000041A83" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041A84" data-uri="chapter03.xhtml#P7000497027000000000000000041A84" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A85" data-uri="chapter03.xhtml#P7000497027000000000000000041A85" class="calibre10 pcalibre pcalibre1">j</code></th>
<th id="P7000497027000000000000000041A86" data-uri="chapter03.xhtml#P7000497027000000000000000041A86" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A87" data-uri="chapter03.xhtml#P7000497027000000000000000041A87" class="calibre10 pcalibre pcalibre1">d</code></th>
<th id="P7000497027000000000000000041A88" data-uri="chapter03.xhtml#P7000497027000000000000000041A88" class="calibre18 pcalibre pcalibre1">Total</th>
<th id="P7000497027000000000000000041A89" data-uri="chapter03.xhtml#P7000497027000000000000000041A89" class="calibre18 pcalibre pcalibre1">Alignment</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A8A" data-uri="chapter03.xhtml#P7000497027000000000000000041A8A" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041A8B" data-uri="chapter03.xhtml#P7000497027000000000000000041A8B" class="calibre20 pcalibre pcalibre1">4</td>
<td id="P7000497027000000000000000041A8C" data-uri="chapter03.xhtml#P7000497027000000000000000041A8C" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041A8D" data-uri="chapter03.xhtml#P7000497027000000000000000041A8D" class="calibre20 pcalibre pcalibre1">12</td>
<td id="P7000497027000000000000000041A8E" data-uri="chapter03.xhtml#P7000497027000000000000000041A8E" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041A8F" data-uri="chapter03.xhtml#P7000497027000000000000000041A8F" class="calibre20 pcalibre pcalibre1">4</td>
</tr>
</tbody>
</table>
</li>
<li id="P7000497027000000000000000041A90" data-uri="chapter03.xhtml#P7000497027000000000000000041A90" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041A91" data-uri="chapter03.xhtml#P7000497027000000000000000041A91" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041A92" data-uri="chapter03.xhtml#P7000497027000000000000000041A92" class="pcalibre1 calibre8 pcalibre">struct P2 { int i; char c; char d; long j; };</code></p>
<table id="P7000497027000000000000000041A93" data-uri="chapter03.xhtml#P7000497027000000000000000041A93" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041A94" data-uri="chapter03.xhtml#P7000497027000000000000000041A94" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A95" data-uri="chapter03.xhtml#P7000497027000000000000000041A95" class="calibre10 pcalibre pcalibre1">i</code></th>
<th id="P7000497027000000000000000041A96" data-uri="chapter03.xhtml#P7000497027000000000000000041A96" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A97" data-uri="chapter03.xhtml#P7000497027000000000000000041A97" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041A98" data-uri="chapter03.xhtml#P7000497027000000000000000041A98" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A99" data-uri="chapter03.xhtml#P7000497027000000000000000041A99" class="calibre10 pcalibre pcalibre1">d</code></th>
<th id="P7000497027000000000000000041A9A" data-uri="chapter03.xhtml#P7000497027000000000000000041A9A" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041A9B" data-uri="chapter03.xhtml#P7000497027000000000000000041A9B" class="calibre10 pcalibre pcalibre1">j</code></th>
<th id="P7000497027000000000000000041A9C" data-uri="chapter03.xhtml#P7000497027000000000000000041A9C" class="calibre18 pcalibre pcalibre1">Total</th>
<th id="P7000497027000000000000000041A9D" data-uri="chapter03.xhtml#P7000497027000000000000000041A9D" class="calibre18 pcalibre pcalibre1">Alignment</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041A9E" data-uri="chapter03.xhtml#P7000497027000000000000000041A9E" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041A9F" data-uri="chapter03.xhtml#P7000497027000000000000000041A9F" class="calibre20 pcalibre pcalibre1">4</td>
<td id="P7000497027000000000000000041AA0" data-uri="chapter03.xhtml#P7000497027000000000000000041AA0" class="calibre20 pcalibre pcalibre1">5</td>
<td id="P7000497027000000000000000041AA1" data-uri="chapter03.xhtml#P7000497027000000000000000041AA1" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041AA2" data-uri="chapter03.xhtml#P7000497027000000000000000041AA2" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041AA3" data-uri="chapter03.xhtml#P7000497027000000000000000041AA3" class="calibre20 pcalibre pcalibre1">8</td>
</tr>
</tbody>
</table>
</li>
<li id="P7000497027000000000000000041AA4" data-uri="chapter03.xhtml#P7000497027000000000000000041AA4" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AA5" data-uri="chapter03.xhtml#P7000497027000000000000000041AA5" class="calibre13 pcalibre pcalibre1">C. <code id="P7000497027000000000000000041AA6" data-uri="chapter03.xhtml#P7000497027000000000000000041AA6" class="pcalibre1 calibre8 pcalibre">struct P3 { short w[3]; char c[3] };</code></p>
<table id="P7000497027000000000000000041AA7" data-uri="chapter03.xhtml#P7000497027000000000000000041AA7" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041AA8" data-uri="chapter03.xhtml#P7000497027000000000000000041AA8" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AA9" data-uri="chapter03.xhtml#P7000497027000000000000000041AA9" class="calibre10 pcalibre pcalibre1">w</code></th>
<th id="P7000497027000000000000000041AAA" data-uri="chapter03.xhtml#P7000497027000000000000000041AAA" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AAB" data-uri="chapter03.xhtml#P7000497027000000000000000041AAB" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041AAC" data-uri="chapter03.xhtml#P7000497027000000000000000041AAC" class="calibre18 pcalibre pcalibre1">Total</th>
<th id="P7000497027000000000000000041AAD" data-uri="chapter03.xhtml#P7000497027000000000000000041AAD" class="calibre18 pcalibre pcalibre1">Alignment</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041AAE" data-uri="chapter03.xhtml#P7000497027000000000000000041AAE" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041AAF" data-uri="chapter03.xhtml#P7000497027000000000000000041AAF" class="calibre20 pcalibre pcalibre1">6</td>
<td id="P7000497027000000000000000041AB0" data-uri="chapter03.xhtml#P7000497027000000000000000041AB0" class="calibre20 pcalibre pcalibre1">10</td>
<td id="P7000497027000000000000000041AB1" data-uri="chapter03.xhtml#P7000497027000000000000000041AB1" class="calibre20 pcalibre pcalibre1">2</td>
</tr>
</tbody>
</table></li>
<li id="P7000497027000000000000000041AB2" data-uri="chapter03.xhtml#P7000497027000000000000000041AB2" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AB3" data-uri="chapter03.xhtml#P7000497027000000000000000041AB3" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041AB4" data-uri="chapter03.xhtml#P7000497027000000000000000041AB4" class="pcalibre1 calibre8 pcalibre">struct P4 { short w[5]; char *c[3] };</code></p>
<table id="P7000497027000000000000000041AB5" data-uri="chapter03.xhtml#P7000497027000000000000000041AB5" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041AB6" data-uri="chapter03.xhtml#P7000497027000000000000000041AB6" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AB7" data-uri="chapter03.xhtml#P7000497027000000000000000041AB7" class="calibre10 pcalibre pcalibre1">w</code></th>
<th id="P7000497027000000000000000041AB8" data-uri="chapter03.xhtml#P7000497027000000000000000041AB8" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AB9" data-uri="chapter03.xhtml#P7000497027000000000000000041AB9" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041ABA" data-uri="chapter03.xhtml#P7000497027000000000000000041ABA" class="calibre18 pcalibre pcalibre1">Total</th>
<th id="P7000497027000000000000000041ABB" data-uri="chapter03.xhtml#P7000497027000000000000000041ABB" class="calibre18 pcalibre pcalibre1">Alignment</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041ABC" data-uri="chapter03.xhtml#P7000497027000000000000000041ABC" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041ABD" data-uri="chapter03.xhtml#P7000497027000000000000000041ABD" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041ABE" data-uri="chapter03.xhtml#P7000497027000000000000000041ABE" class="calibre20 pcalibre pcalibre1">40</td>
<td id="P7000497027000000000000000041ABF" data-uri="chapter03.xhtml#P7000497027000000000000000041ABF" class="calibre20 pcalibre pcalibre1">8</td>
</tr>
</tbody>
</table>
</li>
<li id="P7000497027000000000000000041AC0" data-uri="chapter03.xhtml#P7000497027000000000000000041AC0" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AC1" data-uri="chapter03.xhtml#P7000497027000000000000000041AC1" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041AC2" data-uri="chapter03.xhtml#P7000497027000000000000000041AC2" class="pcalibre1 calibre8 pcalibre">struct P5 { struct P3 a[2]; struct P2 t };</code></p>
<table id="P7000497027000000000000000041AC3" data-uri="chapter03.xhtml#P7000497027000000000000000041AC3" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041AC4" data-uri="chapter03.xhtml#P7000497027000000000000000041AC4" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AC5" data-uri="chapter03.xhtml#P7000497027000000000000000041AC5" class="calibre10 pcalibre pcalibre1">a</code></th>
<th id="P7000497027000000000000000041AC6" data-uri="chapter03.xhtml#P7000497027000000000000000041AC6" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AC7" data-uri="chapter03.xhtml#P7000497027000000000000000041AC7" class="calibre10 pcalibre pcalibre1">t</code></th>
<th id="P7000497027000000000000000041AC8" data-uri="chapter03.xhtml#P7000497027000000000000000041AC8" class="calibre18 pcalibre pcalibre1">Total</th>
<th id="P7000497027000000000000000041AC9" data-uri="chapter03.xhtml#P7000497027000000000000000041AC9" class="calibre18 pcalibre pcalibre1">Alignment</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041ACA" data-uri="chapter03.xhtml#P7000497027000000000000000041ACA" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041ACB" data-uri="chapter03.xhtml#P7000497027000000000000000041ACB" class="calibre20 pcalibre pcalibre1">24</td>
<td id="P7000497027000000000000000041ACC" data-uri="chapter03.xhtml#P7000497027000000000000000041ACC" class="calibre20 pcalibre pcalibre1">40</td>
<td id="P7000497027000000000000000041ACD" data-uri="chapter03.xhtml#P7000497027000000000000000041ACD" class="calibre20 pcalibre pcalibre1">8</td>
</tr>
</tbody>
</table>
</li></ol></li></ul>
</section>
<section id="P70004970270000000000000000038F6" data-uri="chapter03.xhtml#P70004970270000000000000000038F6" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041ACE" data-uri="chapter03.xhtml#P7000497027000000000000000041ACE" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002E4F"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.45 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002E24">275</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041ACF" data-uri="chapter03.xhtml#P7000497027000000000000000041ACF">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041AD0" data-uri="chapter03.xhtml#P7000497027000000000000000041AD0"><p id="P7000497027000000000000000041AD1" data-uri="chapter03.xhtml#P7000497027000000000000000041AD1" class="calibre13 pcalibre pcalibre1">This is an exercise in understanding structure layout and alignment.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041AD2" data-uri="chapter03.xhtml#P7000497027000000000000000041AD2">
<li id="P7000497027000000000000000041AD3" data-uri="chapter03.xhtml#P7000497027000000000000000041AD3" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AD4" data-uri="chapter03.xhtml#P7000497027000000000000000041AD4" class="calibre13 pcalibre pcalibre1">Here are the object sizes and byte offsets:</p>
<table class="informaltable pcalibre pcalibre1" id="P7000497027000000000000000041AD5" data-uri="chapter03.xhtml#P7000497027000000000000000041AD5">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041AD6" data-uri="chapter03.xhtml#P7000497027000000000000000041AD6" class="calibre18 pcalibre pcalibre1">Field</th>
<th id="P7000497027000000000000000041AD7" data-uri="chapter03.xhtml#P7000497027000000000000000041AD7" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AD8" data-uri="chapter03.xhtml#P7000497027000000000000000041AD8" class="calibre10 pcalibre pcalibre1">a</code></th>
<th id="P7000497027000000000000000041AD9" data-uri="chapter03.xhtml#P7000497027000000000000000041AD9" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041ADA" data-uri="chapter03.xhtml#P7000497027000000000000000041ADA" class="calibre10 pcalibre pcalibre1">b</code></th>
<th id="P7000497027000000000000000041ADB" data-uri="chapter03.xhtml#P7000497027000000000000000041ADB" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041ADC" data-uri="chapter03.xhtml#P7000497027000000000000000041ADC" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041ADD" data-uri="chapter03.xhtml#P7000497027000000000000000041ADD" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041ADE" data-uri="chapter03.xhtml#P7000497027000000000000000041ADE" class="calibre10 pcalibre pcalibre1">d</code></th>
<th id="P7000497027000000000000000041ADF" data-uri="chapter03.xhtml#P7000497027000000000000000041ADF" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AE0" data-uri="chapter03.xhtml#P7000497027000000000000000041AE0" class="calibre10 pcalibre pcalibre1">e</code></th>
<th id="P7000497027000000000000000041AE1" data-uri="chapter03.xhtml#P7000497027000000000000000041AE1" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AE2" data-uri="chapter03.xhtml#P7000497027000000000000000041AE2" class="calibre10 pcalibre pcalibre1">f</code></th>
<th id="P7000497027000000000000000041AE3" data-uri="chapter03.xhtml#P7000497027000000000000000041AE3" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AE4" data-uri="chapter03.xhtml#P7000497027000000000000000041AE4" class="calibre10 pcalibre pcalibre1">g</code></th>
<th id="P7000497027000000000000000041AE5" data-uri="chapter03.xhtml#P7000497027000000000000000041AE5" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041AE6" data-uri="chapter03.xhtml#P7000497027000000000000000041AE6" class="calibre10 pcalibre pcalibre1">h</code></th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041AE7" data-uri="chapter03.xhtml#P7000497027000000000000000041AE7" class="calibre20 pcalibre pcalibre1">Size</td>
<td id="P7000497027000000000000000041AE8" data-uri="chapter03.xhtml#P7000497027000000000000000041AE8" class="calibre20 pcalibre pcalibre1">8</td>

<td id="P7000497027000000000000000041AE9" data-uri="chapter03.xhtml#P7000497027000000000000000041AE9" class="calibre20 pcalibre pcalibre1">2</td>

<td id="P7000497027000000000000000041AEA" data-uri="chapter03.xhtml#P7000497027000000000000000041AEA" class="calibre20 pcalibre pcalibre1">8</td>

<td id="P7000497027000000000000000041AEB" data-uri="chapter03.xhtml#P7000497027000000000000000041AEB" class="calibre20 pcalibre pcalibre1">1</td>

<td id="P7000497027000000000000000041AEC" data-uri="chapter03.xhtml#P7000497027000000000000000041AEC" class="calibre20 pcalibre pcalibre1">4</td>

<td id="P7000497027000000000000000041AED" data-uri="chapter03.xhtml#P7000497027000000000000000041AED" class="calibre20 pcalibre pcalibre1">1</td>

<td id="P7000497027000000000000000041AEE" data-uri="chapter03.xhtml#P7000497027000000000000000041AEE" class="calibre20 pcalibre pcalibre1">8</td>

<td id="P7000497027000000000000000041AEF" data-uri="chapter03.xhtml#P7000497027000000000000000041AEF" class="calibre20 pcalibre pcalibre1">4</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041AF0" data-uri="chapter03.xhtml#P7000497027000000000000000041AF0" class="calibre20 pcalibre pcalibre1">Offset</td>
<td id="P7000497027000000000000000041AF1" data-uri="chapter03.xhtml#P7000497027000000000000000041AF1" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041AF2" data-uri="chapter03.xhtml#P7000497027000000000000000041AF2" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041AF3" data-uri="chapter03.xhtml#P7000497027000000000000000041AF3" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041AF4" data-uri="chapter03.xhtml#P7000497027000000000000000041AF4" class="calibre20 pcalibre pcalibre1">24</td>
<td id="P7000497027000000000000000041AF5" data-uri="chapter03.xhtml#P7000497027000000000000000041AF5" class="calibre20 pcalibre pcalibre1">28</td>
<td id="P7000497027000000000000000041AF6" data-uri="chapter03.xhtml#P7000497027000000000000000041AF6" class="calibre20 pcalibre pcalibre1">32</td>
<td id="P7000497027000000000000000041AF7" data-uri="chapter03.xhtml#P7000497027000000000000000041AF7" class="calibre20 pcalibre pcalibre1">40</td>
<td id="P7000497027000000000000000041AF8" data-uri="chapter03.xhtml#P7000497027000000000000000041AF8" class="calibre20 pcalibre pcalibre1">48</td>
</tr>
</tbody>
</table>
</li>
<li id="P7000497027000000000000000041AF9" data-uri="chapter03.xhtml#P7000497027000000000000000041AF9" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AFA" data-uri="chapter03.xhtml#P7000497027000000000000000041AFA" class="calibre13 pcalibre pcalibre1">The structure is a total of 56 bytes long. The end of the structure must be padded by 4 bytes to satisfy the 8-byte alignment requirement.</p></li>
<li id="P7000497027000000000000000041AFB" data-uri="chapter03.xhtml#P7000497027000000000000000041AFB" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041AFC" data-uri="chapter03.xhtml#P7000497027000000000000000041AFC" class="calibre13 pcalibre pcalibre1">One strategy that works, when all data elements have a length equal to a power of 2, is to order the structure elements in descending order of size. This leads to a declaration</p>
<pre id="P7000497027000000000000000041AFD" data-uri="chapter03.xhtml#P7000497027000000000000000041AFD" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041AFE" data-uri="chapter03.xhtml#P7000497027000000000000000041AFE" class="calibre10 pcalibre pcalibre1">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003928" title="346" data-uri="chapter03.xhtml#P7000497027000000000000000003928" epub:type="pagebreak"></span>struct {
	char	*a;
	double	c;
	long	g;
	float	e;
	int	h;
	short	b;
	char	d;
	char	f;
}
rec;
</code></pre>
<p class="calibre13 pcalibre pcalibre1" id="P7000497027000000000000000041AFF" data-uri="chapter03.xhtml#P7000497027000000000000000041AFF">with the following offsets:</p>
<table class="informaltable pcalibre pcalibre1" id="P7000497027000000000000000041B00" data-uri="chapter03.xhtml#P7000497027000000000000000041B00">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th rowspan="2" id="P7000497027000000000000000041B01" data-uri="chapter03.xhtml#P7000497027000000000000000041B01" class="calibre18 pcalibre pcalibre1"/>
<th colspan="8" id="P7000497027000000000000000041B02" data-uri="chapter03.xhtml#P7000497027000000000000000041B02" class="calibre18 pcalibre pcalibre1">Field</th>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041B03" data-uri="chapter03.xhtml#P7000497027000000000000000041B03" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B04" data-uri="chapter03.xhtml#P7000497027000000000000000041B04" class="calibre10 pcalibre pcalibre1">a</code></th>
<th id="P7000497027000000000000000041B05" data-uri="chapter03.xhtml#P7000497027000000000000000041B05" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B06" data-uri="chapter03.xhtml#P7000497027000000000000000041B06" class="calibre10 pcalibre pcalibre1">c</code></th>
<th id="P7000497027000000000000000041B07" data-uri="chapter03.xhtml#P7000497027000000000000000041B07" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B08" data-uri="chapter03.xhtml#P7000497027000000000000000041B08" class="calibre10 pcalibre pcalibre1">g</code></th>
<th id="P7000497027000000000000000041B09" data-uri="chapter03.xhtml#P7000497027000000000000000041B09" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B0A" data-uri="chapter03.xhtml#P7000497027000000000000000041B0A" class="calibre10 pcalibre pcalibre1">e</code></th>
<th id="P7000497027000000000000000041B0B" data-uri="chapter03.xhtml#P7000497027000000000000000041B0B" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B0C" data-uri="chapter03.xhtml#P7000497027000000000000000041B0C" class="calibre10 pcalibre pcalibre1">h</code></th>
<th id="P7000497027000000000000000041B0D" data-uri="chapter03.xhtml#P7000497027000000000000000041B0D" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B0E" data-uri="chapter03.xhtml#P7000497027000000000000000041B0E" class="calibre10 pcalibre pcalibre1">b</code></th>
<th id="P7000497027000000000000000041B0F" data-uri="chapter03.xhtml#P7000497027000000000000000041B0F" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B10" data-uri="chapter03.xhtml#P7000497027000000000000000041B10" class="calibre10 pcalibre pcalibre1">d</code></th>
<th id="P7000497027000000000000000041B11" data-uri="chapter03.xhtml#P7000497027000000000000000041B11" class="calibre18 pcalibre pcalibre1"><code id="P7000497027000000000000000041B12" data-uri="chapter03.xhtml#P7000497027000000000000000041B12" class="calibre10 pcalibre pcalibre1">f</code></th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041B13" data-uri="chapter03.xhtml#P7000497027000000000000000041B13" class="calibre20 pcalibre pcalibre1">Size</td>
<td id="P7000497027000000000000000041B14" data-uri="chapter03.xhtml#P7000497027000000000000000041B14" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041B15" data-uri="chapter03.xhtml#P7000497027000000000000000041B15" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041B16" data-uri="chapter03.xhtml#P7000497027000000000000000041B16" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041B17" data-uri="chapter03.xhtml#P7000497027000000000000000041B17" class="calibre20 pcalibre pcalibre1">4</td>
<td id="P7000497027000000000000000041B18" data-uri="chapter03.xhtml#P7000497027000000000000000041B18" class="calibre20 pcalibre pcalibre1">4</td>
<td id="P7000497027000000000000000041B19" data-uri="chapter03.xhtml#P7000497027000000000000000041B19" class="calibre20 pcalibre pcalibre1">2</td>
<td id="P7000497027000000000000000041B1A" data-uri="chapter03.xhtml#P7000497027000000000000000041B1A" class="calibre20 pcalibre pcalibre1">1</td>
<td id="P7000497027000000000000000041B1B" data-uri="chapter03.xhtml#P7000497027000000000000000041B1B" class="calibre20 pcalibre pcalibre1">1</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041B1C" data-uri="chapter03.xhtml#P7000497027000000000000000041B1C" class="calibre20 pcalibre pcalibre1">Offset</td>
<td id="P7000497027000000000000000041B1D" data-uri="chapter03.xhtml#P7000497027000000000000000041B1D" class="calibre20 pcalibre pcalibre1">0</td>
<td id="P7000497027000000000000000041B1E" data-uri="chapter03.xhtml#P7000497027000000000000000041B1E" class="calibre20 pcalibre pcalibre1">8</td>
<td id="P7000497027000000000000000041B1F" data-uri="chapter03.xhtml#P7000497027000000000000000041B1F" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041B20" data-uri="chapter03.xhtml#P7000497027000000000000000041B20" class="calibre20 pcalibre pcalibre1">24</td>
<td id="P7000497027000000000000000041B21" data-uri="chapter03.xhtml#P7000497027000000000000000041B21" class="calibre20 pcalibre pcalibre1">28</td>
<td id="P7000497027000000000000000041B22" data-uri="chapter03.xhtml#P7000497027000000000000000041B22" class="calibre20 pcalibre pcalibre1">32</td>
<td id="P7000497027000000000000000041B23" data-uri="chapter03.xhtml#P7000497027000000000000000041B23" class="calibre20 pcalibre pcalibre1">34</td>
<td id="P7000497027000000000000000041B24" data-uri="chapter03.xhtml#P7000497027000000000000000041B24" class="calibre20 pcalibre pcalibre1">35</td>
</tr>
</tbody>
</table>
<p id="P7000497027000000000000000041B25" data-uri="chapter03.xhtml#P7000497027000000000000000041B25" class="calibre13 pcalibre pcalibre1">The structure must be padded by 4 bytes to satisfy the 8-byte alignment requirement, giving a total of 40 bytes.</p>
</li></ol></li></ul>
</section>
<section id="P7000497027000000000000000003950" data-uri="chapter03.xhtml#P7000497027000000000000000003950" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B26" data-uri="chapter03.xhtml#P7000497027000000000000000041B26" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002F7A"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.46 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002F5D">282</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041B27" data-uri="chapter03.xhtml#P7000497027000000000000000041B27">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B28" data-uri="chapter03.xhtml#P7000497027000000000000000041B28"><p id="P7000497027000000000000000041B29" data-uri="chapter03.xhtml#P7000497027000000000000000041B29" class="calibre13 pcalibre pcalibre1">This problem covers a wide range of topics, such as stack frames, string representations, ASCII code, and byte ordering. It demonstrates the dangers of out-of-bounds memory references and the basic ideas behind buffer overflow.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041B2A" data-uri="chapter03.xhtml#P7000497027000000000000000041B2A">
<li id="P7000497027000000000000000041B2B" data-uri="chapter03.xhtml#P7000497027000000000000000041B2B" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B2C" data-uri="chapter03.xhtml#P7000497027000000000000000041B2C" class="calibre13 pcalibre pcalibre1">Stack after line 3:</p>
<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000003958" data-uri="chapter03.xhtml#P7000497027000000000000000003958">
<img alt="A diagram illustrates a stack with five sections." id="P7000497027000000000000000041B2D" data-uri="P700049702700000000000000000B6C7" src="../images/p346-1.png" class="calibre102 pcalibre pcalibre1"/>
<figcaption id="P7000497027000000000000000041B2E" data-uri="chapter03.xhtml#P7000497027000000000000000041B2E" class="calibre11 pcalibre pcalibre1">
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000021E09" data-uri="chapter03.xhtml#P7000497027000000000000000021E09">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000041B2F" data-uri="chapter03.xhtml#P7000497027000000000000000041B2F" class="calibre13 pcalibre pcalibre1">A diagram illustrates a stack with five sections: three blank sections on bottom with middle for buf = %rsp; second from top for Saved %rbx containing 01 23 45 67 89 AB CD EF; top for Return Address containing 00 00 00 00 00 40 00 76.</p>
</details>
</figcaption>
</figure></li>
<li id="P7000497027000000000000000041B30" data-uri="chapter03.xhtml#P7000497027000000000000000041B30" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B31" data-uri="chapter03.xhtml#P7000497027000000000000000041B31" class="calibre13 pcalibre pcalibre1">Stack after line 5:</p>
<figure class="pcalibre5 figure pcalibre" id="P700049702700000000000000000395C" data-uri="chapter03.xhtml#P700049702700000000000000000395C">
<img alt="A diagram illustrates a stack with five sections." id="P7000497027000000000000000041B32" data-uri="P700049702700000000000000000B6C8" src="../images/p346-2.png" class="calibre102 pcalibre pcalibre1"/>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000021E0E" data-uri="chapter03.xhtml#P7000497027000000000000000021E0E">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000041B33" data-uri="chapter03.xhtml#P7000497027000000000000000041B33" class="calibre13 pcalibre pcalibre1">A diagram illustrates a stack with five sections: bottom blank; second for buf = %rsp containing 37 36 35 34 33 32 31 30; third containing 35 34 33 32 31 30 39 38; fourth for Saved %rbx containing 33 32 31 30 39 38 37 36; top for Return address containing 00 00 00 00 00 40 00 34.</p>
</details>
</figure></li>
<li id="P7000497027000000000000000041B34" data-uri="chapter03.xhtml#P7000497027000000000000000041B34" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B35" data-uri="chapter03.xhtml#P7000497027000000000000000041B35" class="calibre13 pcalibre pcalibre1">The program is attempting to return to address <code id="P7000497027000000000000000041B36" data-uri="chapter03.xhtml#P7000497027000000000000000041B36" class="pcalibre1 calibre8 pcalibre">0x040034</code>. The low-order 2 bytes were overwritten by the code for character `4' and the terminating null character.</p></li>
<li id="P7000497027000000000000000041B37" data-uri="chapter03.xhtml#P7000497027000000000000000041B37" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B38" data-uri="chapter03.xhtml#P7000497027000000000000000041B38" class="calibre13 pcalibre pcalibre1">The saved value of register <code id="P7000497027000000000000000041B39" data-uri="chapter03.xhtml#P7000497027000000000000000041B39" class="pcalibre1 calibre8 pcalibre">%rbx</code> was set to <code id="P7000497027000000000000000041B3A" data-uri="chapter03.xhtml#P7000497027000000000000000041B3A" class="pcalibre1 calibre8 pcalibre">0x3332313039383736</code>. This value will be loaded into the register before <code id="P7000497027000000000000000041B3B" data-uri="chapter03.xhtml#P7000497027000000000000000041B3B" class="pcalibre1 calibre8 pcalibre">get_line</code> returns.</p></li>
<li id="P7000497027000000000000000041B3C" data-uri="chapter03.xhtml#P7000497027000000000000000041B3C" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B3D" data-uri="chapter03.xhtml#P7000497027000000000000000041B3D" class="calibre13 pcalibre pcalibre1"><span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003968" title="347" data-uri="chapter03.xhtml#P7000497027000000000000000003968" epub:type="pagebreak"></span>The call to <code id="P7000497027000000000000000041B3E" data-uri="chapter03.xhtml#P7000497027000000000000000041B3E" class="pcalibre1 calibre8 pcalibre">malloc</code> should have had <code id="P7000497027000000000000000041B3F" data-uri="chapter03.xhtml#P7000497027000000000000000041B3F" class="pcalibre1 calibre8 pcalibre">strlen(buf)+1</code> as its argument, and the code should also check that the returned value is not equal to <code id="P7000497027000000000000000041B40" data-uri="chapter03.xhtml#P7000497027000000000000000041B40" class="pcalibre1 calibre8 pcalibre">NULL</code>.</p>
</li></ol></li></ul>
</section>
<section id="P700049702700000000000000000396C" data-uri="chapter03.xhtml#P700049702700000000000000000396C" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B41" data-uri="chapter03.xhtml#P7000497027000000000000000041B41" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002FC6"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.47 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002FC3">286</a>)</h1></header>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041B42" data-uri="chapter03.xhtml#P7000497027000000000000000041B42">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B43" data-uri="chapter03.xhtml#P7000497027000000000000000041B43"><p id="P7000497027000000000000000041B44" data-uri="chapter03.xhtml#P7000497027000000000000000041B44" class="pcalibre calibre3 pcalibre1">This corresponds to a range of around 2<sup class="calibre51 pcalibre pcalibre1">13</sup> addresses.</p></li>
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B45" data-uri="chapter03.xhtml#P7000497027000000000000000041B45"><p id="P7000497027000000000000000041B46" data-uri="chapter03.xhtml#P7000497027000000000000000041B46" class="pcalibre calibre3 pcalibre1">A 128-byte nop sled would cover 2<sup class="calibre51 pcalibre pcalibre1">7</sup> addresses with each test, and so we would only require around 2<sup class="calibre51 pcalibre pcalibre1">6</sup> = 64 attempts.</p>
<p id="P7000497027000000000000000041B47" data-uri="chapter03.xhtml#P7000497027000000000000000041B47" class="pcalibre calibre3 pcalibre1">This example clearly shows that the degree of randomization in this version of Linux would provide only minimal deterrence against an overflow attack.</p>
</li></ol>
</section>
<section id="P7000497027000000000000000003974" data-uri="chapter03.xhtml#P7000497027000000000000000003974" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B48" data-uri="chapter03.xhtml#P7000497027000000000000000041B48" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002FEF"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.48 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002FEA">288</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041B49" data-uri="chapter03.xhtml#P7000497027000000000000000041B49">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B4A" data-uri="chapter03.xhtml#P7000497027000000000000000041B4A"><p id="P7000497027000000000000000041B4B" data-uri="chapter03.xhtml#P7000497027000000000000000041B4B" class="calibre13 pcalibre pcalibre1">This problem gives you another chance to see how x86-64 code manages the stack, and to also better understand how to defend against buffer overflow attacks.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041B4C" data-uri="chapter03.xhtml#P7000497027000000000000000041B4C">
<li id="P7000497027000000000000000041B4D" data-uri="chapter03.xhtml#P7000497027000000000000000041B4D" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B4E" data-uri="chapter03.xhtml#P7000497027000000000000000041B4E" class="calibre13 pcalibre pcalibre1">For the unprotected code, we can see that lines 4 and 5 compute the positions of <code id="P7000497027000000000000000041B4F" data-uri="chapter03.xhtml#P7000497027000000000000000041B4F" class="pcalibre1 calibre8 pcalibre">v</code> and <code id="P7000497027000000000000000041B50" data-uri="chapter03.xhtml#P7000497027000000000000000041B50" class="pcalibre1 calibre8 pcalibre">buf</code> to be at offsets 24 and 0 relative to <code id="P7000497027000000000000000041B51" data-uri="chapter03.xhtml#P7000497027000000000000000041B51" class="pcalibre1 calibre8 pcalibre">%rsp.</code> In the protected code, the canary is stored at offset 40 (line 4), while <code id="P7000497027000000000000000041B52" data-uri="chapter03.xhtml#P7000497027000000000000000041B52" class="pcalibre1 calibre8 pcalibre">v</code> and <code id="P7000497027000000000000000041B53" data-uri="chapter03.xhtml#P7000497027000000000000000041B53" class="pcalibre1 calibre8 pcalibre">buf</code> are at offsets 8 and 16 (lines 7 and 8).</p></li>
<li id="P7000497027000000000000000041B54" data-uri="chapter03.xhtml#P7000497027000000000000000041B54" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B55" data-uri="chapter03.xhtml#P7000497027000000000000000041B55" class="calibre13 pcalibre pcalibre1">In the protected code, local variable <code id="P7000497027000000000000000041B56" data-uri="chapter03.xhtml#P7000497027000000000000000041B56" class="pcalibre1 calibre8 pcalibre">v</code> is positioned closer to the top of the stack than <code id="P7000497027000000000000000041B57" data-uri="chapter03.xhtml#P7000497027000000000000000041B57" class="pcalibre1 calibre8 pcalibre">buf</code>, and so an overrun of <code id="P7000497027000000000000000041B58" data-uri="chapter03.xhtml#P7000497027000000000000000041B58" class="pcalibre1 calibre8 pcalibre">buf</code> will not corrupt the value of <code id="P7000497027000000000000000041B59" data-uri="chapter03.xhtml#P7000497027000000000000000041B59" class="pcalibre1 calibre8 pcalibre">v</code>.</p></li>
</ol></li></ul>
</section>
<section id="P7000497027000000000000000003987" data-uri="chapter03.xhtml#P7000497027000000000000000003987" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B5A" data-uri="chapter03.xhtml#P7000497027000000000000000041B5A" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000003055"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.49 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000003052">293</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041B5B" data-uri="chapter03.xhtml#P7000497027000000000000000041B5B">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B5C" data-uri="chapter03.xhtml#P7000497027000000000000000041B5C"><p id="P7000497027000000000000000041B5D" data-uri="chapter03.xhtml#P7000497027000000000000000041B5D" class="calibre13 pcalibre pcalibre1">This code combines many of the tricks we have seen for performing bit-level arithmetic. It requires careful study to make any sense of it.</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041B5E" data-uri="chapter03.xhtml#P7000497027000000000000000041B5E">
<li id="P7000497027000000000000000041B5F" data-uri="chapter03.xhtml#P7000497027000000000000000041B5F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B60" data-uri="chapter03.xhtml#P7000497027000000000000000041B60" class="calibre13 pcalibre pcalibre1">The <code id="P7000497027000000000000000041B61" data-uri="chapter03.xhtml#P7000497027000000000000000041B61" class="pcalibre1 calibre8 pcalibre">leaq</code> instruction of line 5 computes the value 8<var class="calibre5 pcalibre pcalibre1">n</var> + 22, which is then rounded down to the nearest multiple of 16 by the <code id="P7000497027000000000000000041B62" data-uri="chapter03.xhtml#P7000497027000000000000000041B62" class="pcalibre1 calibre8 pcalibre">andq</code> instruction of line 6. The resulting value will be 8<var class="calibre5 pcalibre pcalibre1">n</var> + 8 when <var class="calibre5 pcalibre pcalibre1">n</var> is odd and 8<var class="calibre5 pcalibre pcalibre1">n</var> + 16 when <var class="calibre5 pcalibre pcalibre1">n</var> is even, and this value is subtracted from <var class="calibre5 pcalibre pcalibre1">s</var><sub class="pcalibre1 calibre47 pcalibre">1</sub> to give <var class="calibre5 pcalibre pcalibre1">s</var><sub class="pcalibre1 calibre47 pcalibre">2</sub>.</p></li>
<li id="P7000497027000000000000000041B63" data-uri="chapter03.xhtml#P7000497027000000000000000041B63" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B64" data-uri="chapter03.xhtml#P7000497027000000000000000041B64" class="calibre13 pcalibre pcalibre1">The three instructions in this sequence round <var class="calibre5 pcalibre pcalibre1">s</var><sub class="pcalibre1 calibre47 pcalibre">2</sub> up to the nearest multiple of 8. They make use of the combination of biasing and shifting that we saw for dividing by a power of 2 in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000000CB3_split_001.xhtml#P7000497027000000000000000000FF6"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">2.3.7</span></a>.</p></li>
<li id="P7000497027000000000000000041B65" data-uri="chapter03.xhtml#P7000497027000000000000000041B65" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B66" data-uri="chapter03.xhtml#P7000497027000000000000000041B66" class="calibre13 pcalibre pcalibre1">These two examples can be seen as the cases that minimize and maximize the values of <var class="calibre5 pcalibre pcalibre1">e</var><sub class="pcalibre1 calibre47 pcalibre">1</sub> and <var class="calibre5 pcalibre pcalibre1">e</var><sub class="pcalibre1 calibre47 pcalibre">2</sub>.</p>
<table id="P7000497027000000000000000041B67" data-uri="chapter03.xhtml#P7000497027000000000000000041B67" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041B68" data-uri="chapter03.xhtml#P7000497027000000000000000041B68" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">n</var></th>
<th id="P7000497027000000000000000041B69" data-uri="chapter03.xhtml#P7000497027000000000000000041B69" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">s</var><sub class="calibre59 pcalibre pcalibre1">1</sub></th>
<th id="P7000497027000000000000000041B6A" data-uri="chapter03.xhtml#P7000497027000000000000000041B6A" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">s</var><sub class="calibre59 pcalibre pcalibre1">2</sub></th>
<th id="P7000497027000000000000000041B6B" data-uri="chapter03.xhtml#P7000497027000000000000000041B6B" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">p</var></th>
<th id="P7000497027000000000000000041B6C" data-uri="chapter03.xhtml#P7000497027000000000000000041B6C" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">e</var><sub class="calibre59 pcalibre pcalibre1">1</sub></th>
<th id="P7000497027000000000000000041B6D" data-uri="chapter03.xhtml#P7000497027000000000000000041B6D" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">e</var><sub class="calibre59 pcalibre pcalibre1">2</sub></th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041B6E" data-uri="chapter03.xhtml#P7000497027000000000000000041B6E" class="calibre20 pcalibre pcalibre1">5</td>
<td id="P7000497027000000000000000041B6F" data-uri="chapter03.xhtml#P7000497027000000000000000041B6F" class="calibre20 pcalibre pcalibre1">2,065</td>
<td id="P7000497027000000000000000041B70" data-uri="chapter03.xhtml#P7000497027000000000000000041B70" class="calibre20 pcalibre pcalibre1">2,017</td>
<td id="P7000497027000000000000000041B71" data-uri="chapter03.xhtml#P7000497027000000000000000041B71" class="calibre20 pcalibre pcalibre1">2,024</td>
<td id="P7000497027000000000000000041B72" data-uri="chapter03.xhtml#P7000497027000000000000000041B72" class="calibre20 pcalibre pcalibre1">1</td>
<td id="P7000497027000000000000000041B73" data-uri="chapter03.xhtml#P7000497027000000000000000041B73" class="calibre20 pcalibre pcalibre1">7</td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041B74" data-uri="chapter03.xhtml#P7000497027000000000000000041B74" class="calibre20 pcalibre pcalibre1">6</td>
<td id="P7000497027000000000000000041B75" data-uri="chapter03.xhtml#P7000497027000000000000000041B75" class="calibre20 pcalibre pcalibre1">2,064</td>
<td id="P7000497027000000000000000041B76" data-uri="chapter03.xhtml#P7000497027000000000000000041B76" class="calibre20 pcalibre pcalibre1">2,000</td>
<td id="P7000497027000000000000000041B77" data-uri="chapter03.xhtml#P7000497027000000000000000041B77" class="calibre20 pcalibre pcalibre1">2,000</td>
<td id="P7000497027000000000000000041B78" data-uri="chapter03.xhtml#P7000497027000000000000000041B78" class="calibre20 pcalibre pcalibre1">16</td>
<td id="P7000497027000000000000000041B79" data-uri="chapter03.xhtml#P7000497027000000000000000041B79" class="calibre20 pcalibre pcalibre1">0</td>
</tr>
</tbody>
</table></li>
<li id="P7000497027000000000000000041B7A" data-uri="chapter03.xhtml#P7000497027000000000000000041B7A" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B7B" data-uri="chapter03.xhtml#P7000497027000000000000000041B7B" class="calibre13 pcalibre pcalibre1">We can see that <var class="calibre5 pcalibre pcalibre1">s</var><sub class="pcalibre1 calibre47 pcalibre">2</sub> is computed in a way that preserves whatever offset <var class="calibre5 pcalibre pcalibre1">s</var><sub class="pcalibre1 calibre47 pcalibre">1</sub> has with the nearest multiple of 16. We can also see that <var class="calibre5 pcalibre pcalibre1">p</var> will be aligned on a multiple of 8, as is recommended for an array of 8-byte elements.</p></li>
</ol></li></ul>
</section>
<section id="P70004970270000000000000000039AA" data-uri="chapter03.xhtml#P70004970270000000000000000039AA" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B7C" data-uri="chapter03.xhtml#P7000497027000000000000000041B7C" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003145"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.50 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003147">300</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041B7D" data-uri="chapter03.xhtml#P7000497027000000000000000041B7D">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B7E" data-uri="chapter03.xhtml#P7000497027000000000000000041B7E"><p id="P7000497027000000000000000041B7F" data-uri="chapter03.xhtml#P7000497027000000000000000041B7F" class="calibre13 pcalibre pcalibre1">This exercise requires that you step through the code, paying careful attention to which conversion and data movement instructions are used. We can see the values being retrieved and converted as follows:</p>
<ul id="P7000497027000000000000000041B80" data-uri="chapter03.xhtml#P7000497027000000000000000041B80" class="pcalibre calibre39 pcalibre1">
<li id="P7000497027000000000000000041B81" data-uri="chapter03.xhtml#P7000497027000000000000000041B81" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B82" data-uri="chapter03.xhtml#P7000497027000000000000000041B82" class="calibre13 pcalibre pcalibre1"><span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000039B2" title="348" data-uri="chapter03.xhtml#P70004970270000000000000000039B2" epub:type="pagebreak"></span>The value at <code id="P7000497027000000000000000041B83" data-uri="chapter03.xhtml#P7000497027000000000000000041B83" class="pcalibre1 calibre8 pcalibre">dp</code> is retrieved, converted to an <code id="P7000497027000000000000000041B84" data-uri="chapter03.xhtml#P7000497027000000000000000041B84" class="pcalibre1 calibre8 pcalibre">int</code> (line 4), and then stored at <code id="P7000497027000000000000000041B85" data-uri="chapter03.xhtml#P7000497027000000000000000041B85" class="pcalibre1 calibre8 pcalibre">ip</code>. We can therefore infer that <code id="P7000497027000000000000000041B86" data-uri="chapter03.xhtml#P7000497027000000000000000041B86" class="pcalibre1 calibre8 pcalibre">val1</code> is <code id="P7000497027000000000000000041B87" data-uri="chapter03.xhtml#P7000497027000000000000000041B87" class="pcalibre1 calibre8 pcalibre">d</code>.</p></li>
<li id="P7000497027000000000000000041B88" data-uri="chapter03.xhtml#P7000497027000000000000000041B88" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B89" data-uri="chapter03.xhtml#P7000497027000000000000000041B89" class="calibre13 pcalibre pcalibre1">The value at <code id="P7000497027000000000000000041B8A" data-uri="chapter03.xhtml#P7000497027000000000000000041B8A" class="pcalibre1 calibre8 pcalibre">ip</code> is retrieved, converted to a <code id="P7000497027000000000000000041B8B" data-uri="chapter03.xhtml#P7000497027000000000000000041B8B" class="pcalibre1 calibre8 pcalibre">float</code> (line 6), and then stored at <code id="P7000497027000000000000000041B8C" data-uri="chapter03.xhtml#P7000497027000000000000000041B8C" class="pcalibre1 calibre8 pcalibre">fp</code>. We can therefore infer that <code id="P7000497027000000000000000041B8D" data-uri="chapter03.xhtml#P7000497027000000000000000041B8D" class="pcalibre1 calibre8 pcalibre">val2</code> is <code id="P7000497027000000000000000041B8E" data-uri="chapter03.xhtml#P7000497027000000000000000041B8E" class="pcalibre1 calibre8 pcalibre">i</code>.</p></li>
<li id="P7000497027000000000000000041B8F" data-uri="chapter03.xhtml#P7000497027000000000000000041B8F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B90" data-uri="chapter03.xhtml#P7000497027000000000000000041B90" class="calibre13 pcalibre pcalibre1">The value of <code id="P7000497027000000000000000041B91" data-uri="chapter03.xhtml#P7000497027000000000000000041B91" class="pcalibre1 calibre8 pcalibre">l</code> is converted to a <code id="P7000497027000000000000000041B92" data-uri="chapter03.xhtml#P7000497027000000000000000041B92" class="pcalibre1 calibre8 pcalibre">double</code> (line 8) and stored at <code id="P7000497027000000000000000041B93" data-uri="chapter03.xhtml#P7000497027000000000000000041B93" class="pcalibre1 calibre8 pcalibre">dp</code>. We can therefore infer that <code id="P7000497027000000000000000041B94" data-uri="chapter03.xhtml#P7000497027000000000000000041B94" class="pcalibre1 calibre8 pcalibre">val3</code> is <code id="P7000497027000000000000000041B95" data-uri="chapter03.xhtml#P7000497027000000000000000041B95" class="pcalibre1 calibre8 pcalibre">l</code>.</p></li>
<li id="P7000497027000000000000000041B96" data-uri="chapter03.xhtml#P7000497027000000000000000041B96" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041B97" data-uri="chapter03.xhtml#P7000497027000000000000000041B97" class="calibre13 pcalibre pcalibre1">The value at <code id="P7000497027000000000000000041B98" data-uri="chapter03.xhtml#P7000497027000000000000000041B98" class="pcalibre1 calibre8 pcalibre">fp</code> is retrieved on line 3. The two instructions at lines 10-11 convert this to double precision as the value returned in register <code id="P7000497027000000000000000041B99" data-uri="chapter03.xhtml#P7000497027000000000000000041B99" class="pcalibre1 calibre8 pcalibre">%xmm0</code>. We can therefore infer that <code id="P7000497027000000000000000041B9A" data-uri="chapter03.xhtml#P7000497027000000000000000041B9A" class="pcalibre1 calibre8 pcalibre">val4</code> is <code id="P7000497027000000000000000041B9B" data-uri="chapter03.xhtml#P7000497027000000000000000041B9B" class="pcalibre1 calibre8 pcalibre">f</code>.</p></li>
</ul></li></ul>
</section>
<section id="P70004970270000000000000000039CC" data-uri="chapter03.xhtml#P70004970270000000000000000039CC" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041B9C" data-uri="chapter03.xhtml#P7000497027000000000000000041B9C" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003154"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.51 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003147">300</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041B9D" data-uri="chapter03.xhtml#P7000497027000000000000000041B9D">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041B9E" data-uri="chapter03.xhtml#P7000497027000000000000000041B9E"><p id="P7000497027000000000000000041B9F" data-uri="chapter03.xhtml#P7000497027000000000000000041B9F" class="calibre13 pcalibre pcalibre1">These cases can be handled by selecting the appropriate entries from the tables in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000030CF"><span class="pcalibre label pcalibre1">Figures </span><span class="pcalibre label pcalibre1">3.47</span></a> and <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000030F1"><span class="pcalibre label pcalibre1">3.48</span></a>, or using one of the code sequences for converting between floating-point formats.</p>
<table id="P7000497027000000000000000041BA0" data-uri="chapter03.xhtml#P7000497027000000000000000041BA0" class="pcalibre largetable pcalibre1">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000041BA1" data-uri="chapter03.xhtml#P7000497027000000000000000041BA1" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">T</var><sub class="calibre59 pcalibre pcalibre1">x</sub></th>
<th id="P7000497027000000000000000041BA2" data-uri="chapter03.xhtml#P7000497027000000000000000041BA2" class="calibre18 pcalibre pcalibre1"><var class="calibre5 pcalibre pcalibre1">T</var><sub class="calibre59 pcalibre pcalibre1">y</sub></th>
<th id="P7000497027000000000000000041BA3" data-uri="chapter03.xhtml#P7000497027000000000000000041BA3" class="calibre18 pcalibre pcalibre1">Instruction(s)</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041BA4" data-uri="chapter03.xhtml#P7000497027000000000000000041BA4" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BA5" data-uri="chapter03.xhtml#P7000497027000000000000000041BA5" class="calibre10 pcalibre pcalibre1">long</code></td>
<td id="P7000497027000000000000000041BA6" data-uri="chapter03.xhtml#P7000497027000000000000000041BA6" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BA7" data-uri="chapter03.xhtml#P7000497027000000000000000041BA7" class="calibre10 pcalibre pcalibre1">double</code></td>
<td id="P7000497027000000000000000041BA8" data-uri="chapter03.xhtml#P7000497027000000000000000041BA8" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BA9" data-uri="chapter03.xhtml#P7000497027000000000000000041BA9" class="calibre10 pcalibre pcalibre1">vcvtsi2sdq %rdi, %xmm0, %xmm0</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041BAA" data-uri="chapter03.xhtml#P7000497027000000000000000041BAA" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BAB" data-uri="chapter03.xhtml#P7000497027000000000000000041BAB" class="calibre10 pcalibre pcalibre1">double</code></td>
<td id="P7000497027000000000000000041BAC" data-uri="chapter03.xhtml#P7000497027000000000000000041BAC" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BAD" data-uri="chapter03.xhtml#P7000497027000000000000000041BAD" class="calibre10 pcalibre pcalibre1">int</code></td>
<td id="P7000497027000000000000000041BAE" data-uri="chapter03.xhtml#P7000497027000000000000000041BAE" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BAF" data-uri="chapter03.xhtml#P7000497027000000000000000041BAF" class="calibre10 pcalibre pcalibre1">vcvttsd2si %xmm0, %eax</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041BB0" data-uri="chapter03.xhtml#P7000497027000000000000000041BB0" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BB1" data-uri="chapter03.xhtml#P7000497027000000000000000041BB1" class="calibre10 pcalibre pcalibre1">float</code></td>
<td id="P7000497027000000000000000041BB2" data-uri="chapter03.xhtml#P7000497027000000000000000041BB2" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BB3" data-uri="chapter03.xhtml#P7000497027000000000000000041BB3" class="calibre10 pcalibre pcalibre1">double</code></td>
<td id="P7000497027000000000000000041BB4" data-uri="chapter03.xhtml#P7000497027000000000000000041BB4" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BB5" data-uri="chapter03.xhtml#P7000497027000000000000000041BB5" class="calibre10 pcalibre pcalibre1">vunpcklpd %xmm0, %xmm0, %xmm0 vcvtpd2ps %xmm0, %xmm0</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041BB6" data-uri="chapter03.xhtml#P7000497027000000000000000041BB6" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BB7" data-uri="chapter03.xhtml#P7000497027000000000000000041BB7" class="calibre10 pcalibre pcalibre1">long</code></td>
<td id="P7000497027000000000000000041BB8" data-uri="chapter03.xhtml#P7000497027000000000000000041BB8" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BB9" data-uri="chapter03.xhtml#P7000497027000000000000000041BB9" class="calibre10 pcalibre pcalibre1">float</code></td>
<td id="P7000497027000000000000000041BBA" data-uri="chapter03.xhtml#P7000497027000000000000000041BBA" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BBB" data-uri="chapter03.xhtml#P7000497027000000000000000041BBB" class="calibre10 pcalibre pcalibre1">vcvtsi2ssq %rdi, %xmm0, %xmm0</code></td>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000041BBC" data-uri="chapter03.xhtml#P7000497027000000000000000041BBC" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BBD" data-uri="chapter03.xhtml#P7000497027000000000000000041BBD" class="calibre10 pcalibre pcalibre1">float</code></td>
<td id="P7000497027000000000000000041BBE" data-uri="chapter03.xhtml#P7000497027000000000000000041BBE" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BBF" data-uri="chapter03.xhtml#P7000497027000000000000000041BBF" class="calibre10 pcalibre pcalibre1">long</code></td>
<td id="P7000497027000000000000000041BC0" data-uri="chapter03.xhtml#P7000497027000000000000000041BC0" class="calibre20 pcalibre pcalibre1"><code id="P7000497027000000000000000041BC1" data-uri="chapter03.xhtml#P7000497027000000000000000041BC1" class="calibre10 pcalibre pcalibre1">vcvttss2siq %xmm0, %rax</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section id="P70004970270000000000000000039F3" data-uri="chapter03.xhtml#P70004970270000000000000000039F3" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041BC2" data-uri="chapter03.xhtml#P7000497027000000000000000041BC2" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P700049702700000000000000000319C"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.52 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003166">301</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041BC3" data-uri="chapter03.xhtml#P7000497027000000000000000041BC3">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041BC4" data-uri="chapter03.xhtml#P7000497027000000000000000041BC4"><p id="P7000497027000000000000000041BC5" data-uri="chapter03.xhtml#P7000497027000000000000000041BC5" class="calibre13 pcalibre pcalibre1">The basic rules for mapping arguments to registers are fairly simple (although they become much more complex with more and other types of arguments <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B43D">[77]</a>).</p>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041BC6" data-uri="chapter03.xhtml#P7000497027000000000000000041BC6">
<li id="P7000497027000000000000000041BC7" data-uri="chapter03.xhtml#P7000497027000000000000000041BC7" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041BC8" data-uri="chapter03.xhtml#P7000497027000000000000000041BC8" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041BC9" data-uri="chapter03.xhtml#P7000497027000000000000000041BC9" class="pcalibre1 calibre8 pcalibre">double g1(double a, long b, float c, int d);</code></p>
<p id="P7000497027000000000000000041BCA" data-uri="chapter03.xhtml#P7000497027000000000000000041BCA" class="calibre15 pcalibre pcalibre1">Registers: <code id="P7000497027000000000000000041BCB" data-uri="chapter03.xhtml#P7000497027000000000000000041BCB" class="pcalibre1 calibre8 pcalibre">a</code> in <code id="P7000497027000000000000000041BCC" data-uri="chapter03.xhtml#P7000497027000000000000000041BCC" class="pcalibre1 calibre8 pcalibre">%xmm0, b</code> in <code id="P7000497027000000000000000041BCD" data-uri="chapter03.xhtml#P7000497027000000000000000041BCD" class="pcalibre1 calibre8 pcalibre">%rdi c</code> in <code id="P7000497027000000000000000041BCE" data-uri="chapter03.xhtml#P7000497027000000000000000041BCE" class="pcalibre1 calibre8 pcalibre">%xmm1, d</code> in <code id="P7000497027000000000000000041BCF" data-uri="chapter03.xhtml#P7000497027000000000000000041BCF" class="pcalibre1 calibre8 pcalibre">%esi</code></p></li>
<li id="P7000497027000000000000000041BD0" data-uri="chapter03.xhtml#P7000497027000000000000000041BD0" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041BD1" data-uri="chapter03.xhtml#P7000497027000000000000000041BD1" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041BD2" data-uri="chapter03.xhtml#P7000497027000000000000000041BD2" class="pcalibre1 calibre8 pcalibre">double g2(int a, double *b, float *c, long d);</code></p>
<p id="P7000497027000000000000000041BD3" data-uri="chapter03.xhtml#P7000497027000000000000000041BD3" class="calibre15 pcalibre pcalibre1">Registers: <code id="P7000497027000000000000000041BD4" data-uri="chapter03.xhtml#P7000497027000000000000000041BD4" class="pcalibre1 calibre8 pcalibre">a</code> in <code id="P7000497027000000000000000041BD5" data-uri="chapter03.xhtml#P7000497027000000000000000041BD5" class="pcalibre1 calibre8 pcalibre">%edi, b</code> in <code id="P7000497027000000000000000041BD6" data-uri="chapter03.xhtml#P7000497027000000000000000041BD6" class="pcalibre1 calibre8 pcalibre">%rsi, c</code> in <code id="P7000497027000000000000000041BD7" data-uri="chapter03.xhtml#P7000497027000000000000000041BD7" class="pcalibre1 calibre8 pcalibre">%rdx, d</code> in <code id="P7000497027000000000000000041BD8" data-uri="chapter03.xhtml#P7000497027000000000000000041BD8" class="pcalibre1 calibre8 pcalibre">%rcx</code></p></li>
<li id="P7000497027000000000000000041BD9" data-uri="chapter03.xhtml#P7000497027000000000000000041BD9" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041BDA" data-uri="chapter03.xhtml#P7000497027000000000000000041BDA" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041BDB" data-uri="chapter03.xhtml#P7000497027000000000000000041BDB" class="pcalibre1 calibre8 pcalibre">double g3(double *a, double b, int c, float d);</code></p>
<p id="P7000497027000000000000000041BDC" data-uri="chapter03.xhtml#P7000497027000000000000000041BDC" class="calibre15 pcalibre pcalibre1">Registers: <code id="P7000497027000000000000000041BDD" data-uri="chapter03.xhtml#P7000497027000000000000000041BDD" class="pcalibre1 calibre8 pcalibre">a</code> in <code id="P7000497027000000000000000041BDE" data-uri="chapter03.xhtml#P7000497027000000000000000041BDE" class="pcalibre1 calibre8 pcalibre">%rdi, b</code> in <code id="P7000497027000000000000000041BDF" data-uri="chapter03.xhtml#P7000497027000000000000000041BDF" class="pcalibre1 calibre8 pcalibre">%xmm0, c</code> in <code id="P7000497027000000000000000041BE0" data-uri="chapter03.xhtml#P7000497027000000000000000041BE0" class="pcalibre1 calibre8 pcalibre">%esi, d</code> in <code id="P7000497027000000000000000041BE1" data-uri="chapter03.xhtml#P7000497027000000000000000041BE1" class="pcalibre1 calibre8 pcalibre">%xmm1</code></p></li>
<li id="P7000497027000000000000000041BE2" data-uri="chapter03.xhtml#P7000497027000000000000000041BE2" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041BE3" data-uri="chapter03.xhtml#P7000497027000000000000000041BE3" class="calibre13 pcalibre pcalibre1"><code id="P7000497027000000000000000041BE4" data-uri="chapter03.xhtml#P7000497027000000000000000041BE4" class="pcalibre1 calibre8 pcalibre">double g4(float a, int *b, float c, double d);</code></p>
<p id="P7000497027000000000000000041BE5" data-uri="chapter03.xhtml#P7000497027000000000000000041BE5" class="calibre15 pcalibre pcalibre1">Registers: <code id="P7000497027000000000000000041BE6" data-uri="chapter03.xhtml#P7000497027000000000000000041BE6" class="pcalibre1 calibre8 pcalibre">a</code> in <code id="P7000497027000000000000000041BE7" data-uri="chapter03.xhtml#P7000497027000000000000000041BE7" class="pcalibre1 calibre8 pcalibre">%xmm0, b</code> in <code id="P7000497027000000000000000041BE8" data-uri="chapter03.xhtml#P7000497027000000000000000041BE8" class="pcalibre1 calibre8 pcalibre">%rdi, c</code> in <code id="P7000497027000000000000000041BE9" data-uri="chapter03.xhtml#P7000497027000000000000000041BE9" class="pcalibre1 calibre8 pcalibre">%xmm1, d</code> in <code id="P7000497027000000000000000041BEA" data-uri="chapter03.xhtml#P7000497027000000000000000041BEA" class="pcalibre1 calibre8 pcalibre">%xmm2</code></p></li>
</ol></li></ul>
</section>
<section id="P7000497027000000000000000003A1D" data-uri="chapter03.xhtml#P7000497027000000000000000003A1D" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041BEB" data-uri="chapter03.xhtml#P7000497027000000000000000041BEB" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000031F9"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.53 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000031EF">303</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041BEC" data-uri="chapter03.xhtml#P7000497027000000000000000041BEC">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041BED" data-uri="chapter03.xhtml#P7000497027000000000000000041BED"><p id="P7000497027000000000000000041BEE" data-uri="chapter03.xhtml#P7000497027000000000000000041BEE" class="calibre13 pcalibre pcalibre1">We can see from the assembly code that there are two integer arguments, passed in registers <code id="P7000497027000000000000000041BEF" data-uri="chapter03.xhtml#P7000497027000000000000000041BEF" class="pcalibre1 calibre8 pcalibre">%rdi</code> and <code id="P7000497027000000000000000041BF0" data-uri="chapter03.xhtml#P7000497027000000000000000041BF0" class="pcalibre1 calibre8 pcalibre">%rsi</code>. Let us name these <code id="P7000497027000000000000000041BF1" data-uri="chapter03.xhtml#P7000497027000000000000000041BF1" class="pcalibre1 calibre8 pcalibre">i1</code> and <code id="P7000497027000000000000000041BF2" data-uri="chapter03.xhtml#P7000497027000000000000000041BF2" class="pcalibre1 calibre8 pcalibre">i2</code>. Similarly, there are two floating-point arguments, passed in registers <code id="P7000497027000000000000000041BF3" data-uri="chapter03.xhtml#P7000497027000000000000000041BF3" class="pcalibre1 calibre8 pcalibre">%xmm0</code> and <code id="P7000497027000000000000000041BF4" data-uri="chapter03.xhtml#P7000497027000000000000000041BF4" class="pcalibre1 calibre8 pcalibre">%xmm1</code>, which we name <code id="P7000497027000000000000000041BF5" data-uri="chapter03.xhtml#P7000497027000000000000000041BF5" class="pcalibre1 calibre8 pcalibre">f1</code> and <code id="P7000497027000000000000000041BF6" data-uri="chapter03.xhtml#P7000497027000000000000000041BF6" class="pcalibre1 calibre8 pcalibre">f2</code>.</p>
<p id="P7000497027000000000000000041BF7" data-uri="chapter03.xhtml#P7000497027000000000000000041BF7" class="calibre15 pcalibre pcalibre1">We can then annotate the assembly code:</p>
<pre id="P7000497027000000000000000041BF8" data-uri="chapter03.xhtml#P7000497027000000000000000041BF8" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041BF9" data-uri="chapter03.xhtml#P7000497027000000000000000041BF9" class="calibre10 pcalibre pcalibre1">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003A2D" title="349" data-uri="chapter03.xhtml#P7000497027000000000000000003A2D" epub:type="pagebreak"></span>	<i class="calibre5 pcalibre pcalibre1">Refer to arguments as i1 (%rdi), i2 (%esi)</i>
	<i class="calibre5 pcalibre pcalibre1">f1 (%xmm0), and f2 (%xmm1)</i>

	<i class="calibre5 pcalibre pcalibre1">double funct1(arg1_t p, arg2_t q, arg3_t r, arg4_t s)</i>
1	funct1:
2	  vcvtsi2ssq	%rsi, %xmm2, %xmm2	<i class="calibre5 pcalibre pcalibre1">Get i2 and convert from long to float</i>
3	  vaddss %xmm0, %xmm2, %xmm0		<i class="calibre5 pcalibre pcalibre1">Add f1 (type float)</i>
4	  vcvtsi2ss	%edi, %xmm2, %xmm2	<i class="calibre5 pcalibre pcalibre1">Get i1 and convert from int to float</i>
5	  vdivss %xmm0, %xmm2, %xmm0		<i class="calibre5 pcalibre pcalibre1">Compute i1 / (i2 + f1)</i>
6	  vunpcklps	%xmm0, %xmm0, %xmm0
7	  vcvtps2pd	%xmm0, %xmm0		<i class="calibre5 pcalibre pcalibre1">Convert to double</i>
8	  vsubsd %xmm1, %xmm0, %xmm0		<i class="calibre5 pcalibre pcalibre1">Compute i1 / (i2 + f1) - f2 (double)</i>
9	  ret
</code></pre>
<p class="calibre13 pcalibre pcalibre1" id="P7000497027000000000000000041BFA" data-uri="chapter03.xhtml#P7000497027000000000000000041BFA">From this we see that the code computes the value <code id="P7000497027000000000000000041BFB" data-uri="chapter03.xhtml#P7000497027000000000000000041BFB" class="pcalibre1 calibre8 pcalibre">i1/(i2+f1)-f2</code>. We can also see that <code id="P7000497027000000000000000041BFC" data-uri="chapter03.xhtml#P7000497027000000000000000041BFC" class="pcalibre1 calibre8 pcalibre">i1</code> has type <code id="P7000497027000000000000000041BFD" data-uri="chapter03.xhtml#P7000497027000000000000000041BFD" class="pcalibre1 calibre8 pcalibre">int, i2</code> has type long, <code id="P7000497027000000000000000041BFE" data-uri="chapter03.xhtml#P7000497027000000000000000041BFE" class="pcalibre1 calibre8 pcalibre">f1</code> has type float, and <code id="P7000497027000000000000000041BFF" data-uri="chapter03.xhtml#P7000497027000000000000000041BFF" class="pcalibre1 calibre8 pcalibre">f2</code> has type double. The only ambiguity in matching arguments to the named values stems from the commutativity of multiplication—yielding two possible results:</p>
<pre id="P7000497027000000000000000041C00" data-uri="chapter03.xhtml#P7000497027000000000000000041C00" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041C01" data-uri="chapter03.xhtml#P7000497027000000000000000041C01" class="calibre10 pcalibre pcalibre1">
double funct1a(int p, float q, long r, double s);
double funct1b(int p, long q, float r, double s);
</code></pre>
</li></ul>
</section>
<section id="P7000497027000000000000000003A36" data-uri="chapter03.xhtml#P7000497027000000000000000003A36" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041C02" data-uri="chapter03.xhtml#P7000497027000000000000000041C02" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003206"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.54 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000031EF">303</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041C03" data-uri="chapter03.xhtml#P7000497027000000000000000041C03">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041C04" data-uri="chapter03.xhtml#P7000497027000000000000000041C04"><p id="P7000497027000000000000000041C05" data-uri="chapter03.xhtml#P7000497027000000000000000041C05" class="calibre13 pcalibre pcalibre1">This problem can readily be solved by stepping through the assembly code and determining what is computed on each step, as shown with the annotations below:</p>
<pre id="P7000497027000000000000000041C06" data-uri="chapter03.xhtml#P7000497027000000000000000041C06" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041C07" data-uri="chapter03.xhtml#P7000497027000000000000000041C07" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">double funct2(double w, int x, float y, long z)</i>
	 <i class="calibre5 pcalibre pcalibre1">w in %xmm0, x in %edi, y in %xmm1, z in %rsi</i>
1	funct2:
2	  vcvtsi2ss	%edi, %xmm2, %xmm2	<i class="calibre5 pcalibre pcalibre1">Convert x to float</i>
3	  vmulss	%xmm1, %xmm2, %xmm1	<i class="calibre5 pcalibre pcalibre1">Multiply by y</i>
4	  vunpcklps	%xmm1, %xmm1, %xmm1
5	  vcvtps2pd	%xmm1, %xmm2		<i class="calibre5 pcalibre pcalibre1">Convert x*y to double</i>
6 	  vcvtsi2sdq	%rsi, %xmm1, %xmm1	<i class="calibre5 pcalibre pcalibre1">Convert z to double</i>
7	  vdivsd	%xmm1, %xmm0, %xmm0	<i class="calibre5 pcalibre pcalibre1">Compute w/z</i>
8	  vsubsd	%xmm0, %xmm2, %xmm0	<i class="calibre5 pcalibre pcalibre1">Subtract from x*y</i>
9	  ret					<i class="calibre5 pcalibre pcalibre1">Return</i>
</code></pre>
<p class="calibre13 pcalibre pcalibre1" id="P7000497027000000000000000041C08" data-uri="chapter03.xhtml#P7000497027000000000000000041C08">We can conclude from this analysis that the function computes <code id="P7000497027000000000000000041C09" data-uri="chapter03.xhtml#P7000497027000000000000000041C09" class="pcalibre1 calibre8 pcalibre">y * x — w/z.</code></p>
</li></ul>
</section>
<section id="P7000497027000000000000000003A3F" data-uri="chapter03.xhtml#P7000497027000000000000000003A3F" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041C0A" data-uri="chapter03.xhtml#P7000497027000000000000000041C0A" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P700049702700000000000000000323C"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.55 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003228">305</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041C0B" data-uri="chapter03.xhtml#P7000497027000000000000000041C0B">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041C0C" data-uri="chapter03.xhtml#P7000497027000000000000000041C0C"><p id="P7000497027000000000000000041C0D" data-uri="chapter03.xhtml#P7000497027000000000000000041C0D" class="calibre13 pcalibre pcalibre1">This problem involves the same reasoning as was required to see that numbers declared at label <code id="P7000497027000000000000000041C0E" data-uri="chapter03.xhtml#P7000497027000000000000000041C0E" class="pcalibre1 calibre8 pcalibre">.LC2</code> encode 1.8, but with a simpler example.</p>
<p id="P7000497027000000000000000041C0F" data-uri="chapter03.xhtml#P7000497027000000000000000041C0F" class="calibre15 pcalibre pcalibre1">We see that the two values are 0 and 1077936128 (<code id="P7000497027000000000000000041C10" data-uri="chapter03.xhtml#P7000497027000000000000000041C10" class="pcalibre1 calibre8 pcalibre">0x40400000</code>). From the high-order bytes, we can extract an exponent field of <code id="P7000497027000000000000000041C11" data-uri="chapter03.xhtml#P7000497027000000000000000041C11" class="pcalibre1 calibre8 pcalibre">0x404</code> (1028), from which we subtract a bias of 1023 to get an exponent of 5. Concatenating the fraction bits of the two values, we get a fraction field of 0, but with the implied leading value giving value 1.0. The constant is therefore 1.0 × 2<sup class="calibre51 pcalibre pcalibre1">5</sup> = 32.0.</p>
</li></ul>
</section>
<section id="P7000497027000000000000000003A48" data-uri="chapter03.xhtml#P7000497027000000000000000003A48" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041C12" data-uri="chapter03.xhtml#P7000497027000000000000000041C12" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000003A4A" title="350" data-uri="chapter03.xhtml#P7000497027000000000000000003A4A" epub:type="pagebreak"></span><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003246"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.56 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003228">305</a>)</h1></header>
<ol class="pcalibre ol_upper-alpha pcalibre1" id="P7000497027000000000000000041C13" data-uri="chapter03.xhtml#P7000497027000000000000000041C13">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041C14" data-uri="chapter03.xhtml#P7000497027000000000000000041C14"><p id="P7000497027000000000000000041C15" data-uri="chapter03.xhtml#P7000497027000000000000000041C15" class="pcalibre calibre3 pcalibre1">We see here that the 16 bytes starting at address <code id="P7000497027000000000000000041C16" data-uri="chapter03.xhtml#P7000497027000000000000000041C16" class="pcalibre1 calibre8 pcalibre">.LC1</code> form a mask, where the low-order 8 bytes contain all ones, except for the most significant bit, which is the sign bit of a double-precision value. When we compute the <span class="smallcaps pcalibre pcalibre1">AND </span>of this mask with <code id="P7000497027000000000000000041C17" data-uri="chapter03.xhtml#P7000497027000000000000000041C17" class="pcalibre1 calibre8 pcalibre">%xmm0</code>, it will clear the sign bit of <code id="P7000497027000000000000000041C18" data-uri="chapter03.xhtml#P7000497027000000000000000041C18" class="pcalibre1 calibre8 pcalibre">x</code>, yielding the absolute value. In fact, we generated this code by defining <code id="P7000497027000000000000000041C19" data-uri="chapter03.xhtml#P7000497027000000000000000041C19" class="pcalibre1 calibre8 pcalibre">EXPR(x)</code> to be <code id="P7000497027000000000000000041C1A" data-uri="chapter03.xhtml#P7000497027000000000000000041C1A" class="pcalibre1 calibre8 pcalibre">fabs(x)</code>, where <code id="P7000497027000000000000000041C1B" data-uri="chapter03.xhtml#P7000497027000000000000000041C1B" class="pcalibre1 calibre8 pcalibre">fabs</code> is defined in <code id="P7000497027000000000000000041C1C" data-uri="chapter03.xhtml#P7000497027000000000000000041C1C" class="pcalibre1 calibre8 pcalibre">&lt;math.h&gt;.</code></p></li>
<li id="P7000497027000000000000000041C1D" data-uri="chapter03.xhtml#P7000497027000000000000000041C1D" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041C1E" data-uri="chapter03.xhtml#P7000497027000000000000000041C1E" class="pcalibre calibre3 pcalibre1">We see that the vxorpd instruction sets the entire register to zero, and so this is a way to generate floating-point constant 0.0.</p></li>
<li id="P7000497027000000000000000041C1F" data-uri="chapter03.xhtml#P7000497027000000000000000041C1F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000041C20" data-uri="chapter03.xhtml#P7000497027000000000000000041C20" class="pcalibre calibre3 pcalibre1">We see that the 16 bytes starting at address <code id="P7000497027000000000000000041C21" data-uri="chapter03.xhtml#P7000497027000000000000000041C21" class="pcalibre1 calibre8 pcalibre">.LC2</code> form a mask with a single 1 bit, at the position of the sign bit for the low-order value in the XMM register. When we compute the <span class="smallcaps pcalibre pcalibre1">EXCLUSIVE-OR </span>of this mask with <code id="P7000497027000000000000000041C22" data-uri="chapter03.xhtml#P7000497027000000000000000041C22" class="pcalibre1 calibre8 pcalibre">%xmm0</code>, we change the sign of <code id="P7000497027000000000000000041C23" data-uri="chapter03.xhtml#P7000497027000000000000000041C23" class="pcalibre1 calibre8 pcalibre">x</code>, computing the expression <code id="P7000497027000000000000000041C24" data-uri="chapter03.xhtml#P7000497027000000000000000041C24" class="pcalibre1 calibre8 pcalibre">-x</code>.</p></li>
</ol>
</section>
<section id="P7000497027000000000000000003A5D" data-uri="chapter03.xhtml#P7000497027000000000000000003A5D" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P7000497027000000000000000041C25" data-uri="chapter03.xhtml#P7000497027000000000000000041C25" epub:type="title"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003080.xhtml#P70004970270000000000000000032BE"><span class="pcalibre label pcalibre1">Solution to Problem </span><span class="pcalibre label pcalibre1">3.57 </span></a>(page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP7000497027000000000000000003080.xhtml#P700049702700000000000000000329F">308</a>)</h1></header>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000041C26" data-uri="chapter03.xhtml#P7000497027000000000000000041C26">
<li class="calibre12 pcalibre pcalibre1" id="P7000497027000000000000000041C27" data-uri="chapter03.xhtml#P7000497027000000000000000041C27"><p id="P7000497027000000000000000041C28" data-uri="chapter03.xhtml#P7000497027000000000000000041C28" class="calibre13 pcalibre pcalibre1">Again, we annotate the code, including dealing with the conditional branch:</p>
<pre id="P7000497027000000000000000041C29" data-uri="chapter03.xhtml#P7000497027000000000000000041C29" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041C2A" data-uri="chapter03.xhtml#P7000497027000000000000000041C2A" class="calibre10 pcalibre pcalibre1">
	<i class="calibre5 pcalibre pcalibre1">double funct3(int *ap, double b, long c, float *dp)</i>
	<i class="calibre5 pcalibre pcalibre1">ap in %rdi, b in %xmm0, c in %rsi, dp in %rdx</i>
1	funct3:
2	  vmovss	(%rdx), %xmm1		<i class="calibre5 pcalibre pcalibre1">Get d = *dp</i>
3	  vcvtsi2sd	(%rdi), %xmm2, %xmm2	<i class="calibre5 pcalibre pcalibre1">Get a = *ap and convert to double</i>
4	  vucomisd	%xmm2, %xmm0		<i class="calibre5 pcalibre pcalibre1">Compare b:a</i>
5	  jbe	.L8				<i class="calibre5 pcalibre pcalibre1">If &lt;=, goto</i> <b class="calibre4 pcalibre pcalibre1">lesseq</b>
6	  vcvtsi2ssq	%rsi, %xmm0, %xmm0	<i class="calibre5 pcalibre pcalibre1">Convert c to float</i>
7	  vmulss	%xmm1, %xmm0, %xmm1	<i class="calibre5 pcalibre pcalibre1">Multiply by d</i>
8	  vunpcklps	%xmm1, %xmm1, %xmm1
9	  vcvtps2pd	%xmm1, %xmm0		<i class="calibre5 pcalibre pcalibre1">Convert to double</i>
10	  ret					<i class="calibre5 pcalibre pcalibre1">Return</i>
11	.L8:				    <b class="calibre4 pcalibre pcalibre1">lesseq:</b>
12	  vaddss	%xmm1, %xmm1, %xmm1	<i class="calibre5 pcalibre pcalibre1">Compute d+d = 2.0 * d</i>
13	  vcvtsi2ssq	%rsi, %xmm0, %xmm0	<i class="calibre5 pcalibre pcalibre1">Convert c to float</i>
14	  vaddss %xmm1, %xmm0, %xmm0		<i class="calibre5 pcalibre pcalibre1">Compute c + 2*d</i>
15	  vunpcklps	%xmm0, %xmm0, %xmm0
16	  vcvtps2pd	%xmm0, %xmm0		<i class="calibre5 pcalibre pcalibre1">Convert to double</i>
17	  ret					<i class="calibre5 pcalibre pcalibre1">Return</i>
</code></pre>
<p id="P7000497027000000000000000041C2B" data-uri="chapter03.xhtml#P7000497027000000000000000041C2B" class="calibre13 pcalibre pcalibre1">From this, we can write the following code for <code id="P7000497027000000000000000041C2C" data-uri="chapter03.xhtml#P7000497027000000000000000041C2C" class="pcalibre1 calibre8 pcalibre">funct3:</code></p>
<pre id="P7000497027000000000000000041C2D" data-uri="chapter03.xhtml#P7000497027000000000000000041C2D" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000041C2E" data-uri="chapter03.xhtml#P7000497027000000000000000041C2E" class="calibre10 pcalibre pcalibre1">
double funct3(int *ap, double b, long c, float *dp) {
	int a = *ap;
	float d = *dp;
	if (a &lt; b)
	  return c*d;
	else
	  return c+2*d;
}
</code></pre>
</li></ul>
</section>
</section></body></html>
