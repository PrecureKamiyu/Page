<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>16.2 Which Segment Are We Referring To?</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part151.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part153.htm">下一个 &gt;</a></p><p class="s40" style="padding-top: 6pt;padding-left: 38pt;text-indent: 0pt;text-align: left;">16.2 Which Segment Are We Referring To?</p><p style="padding-top: 7pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: right;">The hardware uses segment registers during translation. How does it know the offset into a segment, and to which segment an address refers? One common approach, sometimes referred to as an <b>explicit </b>approach,</p><p style="padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: justify;">is to chop up the address space into segments based on the top few bits of the virtual address; this technique was used in the VAX/VMS system [LL82]. In our example above, we have three segments; thus we need two bits to accomplish our task. If we use the top two bits of our 14-bit virtual address to select the segment, our virtual address looks like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-left: 151pt;text-indent: 0pt;text-align: left;">13 12 11 10 9 8 7 6 5 4 3 2 1 0</p><table style="border-collapse:collapse;margin-left:149.97pt" cellspacing="0"><tr style="height:8pt"><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:3pt"><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p class="s47" style="padding-left: 27pt;text-indent: 0pt;text-align: center;">Segment     Offset</p><p style="padding-top: 5pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">In our example, then, if the top two bits are 00, the hardware knows the virtual address is in the code segment, and thus uses the code base and bounds pair to relocate the address to the correct physical location. If the top two bits are 01, the hardware knows the address is in the heap, and thus uses the heap base and bounds. Let’s take our example heap virtual address from above (4200) and translate it, just to make sure this is clear. The virtual address 4200, in binary form, can be seen here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">13 12 11 10 9</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">8 7 6</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">5 4 3</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">2 1 0</p><table style="border-collapse:collapse;margin-left:149.97pt" cellspacing="0"><tr style="height:8pt"><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">1</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">1</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">1</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">1</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt;border-right-color:#D3D3D3"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-left-color:#D3D3D3;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s95" style="padding-left: 2pt;text-indent: 0pt;line-height: 7pt;text-align: left;">0</p></td></tr><tr style="height:3pt"><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt;border-top-style:solid;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p class="s47" style="padding-left: 27pt;text-indent: 0pt;text-align: center;">Segment     Offset</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">As you can see from the picture, the top two bits (01) tell the hardware which <i>segment </i>we are referring to. The bottom 12 bits are the <i>offset </i>into the segment: 0000 0110 1000, or hex 0x068, or 104 in decimal. Thus, the hardware simply takes the first two bits to determine which segment reg- ister to use, and then takes the next 12 bits as the offset into the segment. By adding the base register to the offset, the hardware arrives at the fi- nal physical address. Note the offset eases the bounds check too: we can simply check if the offset is less than the bounds; if not, the address is ille- gal. Thus, if base and bounds were arrays (with one entry per segment), the hardware would be doing something like this to obtain the desired physical address:</p><p class="s37" style="padding-top: 3pt;padding-left: 26pt;text-indent: 0pt;text-align: left;">1  <span class="s38">// get top 2 bits of 14-bit VA</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">2  <span class="s38">Segment = (VirtualAddress &amp; SEG_MASK) &gt;&gt; SEG_SHIFT</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">3  <span class="s38">// now get offset</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">4  <span class="s38">Offset = VirtualAddress &amp; OFFSET_MASK</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">5  <span class="s38">if (Offset &gt;= Bounds[Segment])</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">6    <span class="s38">RaiseException(PROTECTION_FAULT)</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">7  <span class="s38">else</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">8    <span class="s38">PhysAddr = Base[Segment] + Offset</span></p><p class="s37" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">9    <span class="s38">Register = AccessMemory(PhysAddr)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="1" alt="image" src="Image_151.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="1" alt="image" src="Image_152.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="1" alt="image" src="Image_153.png"/></span></p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 88%;text-align: justify;">In our running example, we can fill in values for the constants above. Specifically, <span class="s41">SEG MASK </span>would be set to <span class="s41">0x3000</span>, <span class="s41">SEG SHIFT </span>to <span class="s41">12</span>, and <span class="s41">OFFSET MASK </span>to <span class="s41">0xFFF</span>.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: right;">You may also have noticed that when we use the top two bits, and we only have three segments (code, heap, stack), one segment of the address space goes unused. Thus, some systems put code in the same segment as the heap and thus use only one bit to select which segment to use [LL82].</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">There are other ways for the hardware to determine which segment a particular address is in. In the <b>implicit </b>approach, the hardware deter- mines the segment by noticing how the address was formed. If, for ex- ample, the address was generated from the program counter (i.e., it was an instruction fetch), then the address is within the code segment; if the address is based off of the stack or base pointer, it must be in the stack segment; any other address must be in the heap.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part151.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part153.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
