<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Linux Kernel Development, Third Edition</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<div id="filepos1300073" style="height:0pt"></div><h2 class="calibre_4" id="calibre_pb_83"><span class="bold">20. Patches, Hacking, and the Community</span></h2><div class="calibre_5"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1300254"> </div>
<p class="calibre_2">One of the greatest benefits of Linux is the large community of users and developers that surround it. The community provides eyes to check your code, experts to provide advice, and users to test and report issues. Most important, the community is the final arbiter of what code is accepted into Linus’ official kernel tree. Understanding how the system works is extremely important.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1300745"> </div>
<h3 class="calibre_21"><span class="bold">The Community</span></h3><div class="calibre_22"> </div>
<p class="calibre_2">If the Linux kernel community had to call somewhere home, it would be the <em class="calibre4">Linux Kernel Mailing List</em>. The Linux Kernel Mailing List (or as the regulars abbreviate it, just <em class="calibre4">lkml</em>) is the location of the majority of the announcements, discussions, debates, and flame wars over the kernel. New features are discussed, and most code is posted to the list before any action is taken. The list sees upward of 300 messages a day, so it is not for the faint of heart. Subscribing (or at least reading a digest or the archives) is recommended for anyone interested in serious kernel development. You can learn a lot simply by watching the wizards at work.</p><div class="calibre_3"> </div>
<p class="calibre_2">You can subscribe by sending the following message in plain text to <a href="mailto:majordomo@vger.kernel.org">majordomo@vger.kernel.org</a>:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">subscribe linux-kernel <span><tt class="calibre6"><span class="calibre20">&lt;your@email.address&gt;</span></tt></span></span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">You can get more information at <a href="http://vger.kernel.org/">http://vger.kernel.org/</a> and a FAQ is available at <a href="http://www.tux.org/lkml/">http://www.tux.org/lkml/</a>.</p><div class="calibre_3"> </div>
<p class="calibre_2">Numerous websites and other mailing lists pertain to the kernel specifically and Linux in general. An excellent resource for beginning kernel hackers is <a href="http://kernel-newbies.org/">http://kernel-newbies.org/</a>—a website that, of all things, caters to those cutting their teeth on the kernel. Two other excellent sources of kernel information are <a href="http://www.lwn.net/">http://www.lwn.net/</a>, Linux Weekly News, which has a great kernel news section, and <a href="http://www.kerneltrap.org/">http://www.kerneltrap.org/</a>, Kernel Trap, which provides insightful commentary on kernel development.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1302884"> </div>
<h3 class="calibre_21"><span class="bold">Linux Coding Style</span></h3><div class="calibre_22"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1303005"> </div>
<p class="calibre_2">The Linux Kernel, like any large software project, has a defined coding style that stipulates the formatting, style, and layout of your code. This is done not because the Linux kernel style is superior (although it might be) or because your style is illegible, but because <em class="calibre4">consistency</em> of coding style is crucial to <em class="calibre4">productivity</em> in coding. Yet it is often argued that coding style is irrelevant because it does not affect the compiled object code. In a large project, such as the kernel, in which many developers are involved, consistency of coding style is crucial. Consistency implies familiarity, which leads to ease of reading, lack of confusion, and further expectations that code will continue to follow a given style. This increases the number of developers who can read your code, and the amount of code in which you can read. In an open-source project, the more eyes the better.</p><div class="calibre_3"> </div>
<p class="calibre_2">It is not so important <em class="calibre4">what</em> style is chosen as long as one is indeed selected and used exclusively. Fortunately, Linus long ago laid out the style we should use and most code sticks to it. The majority of the style is covered in Linus’s usual humor in the file <code class="calibre6"><span class="calibre7">Documentation/CodingStyle</span></code> in the kernel source tree.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1304425"> </div>
<h4 class="calibre_27"><span class="calibre3">Indention</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">The stylistic convention for indention is to use tabs that are eight characters in length. This does not mean it is okay to use eight spaces for indention. Each level of indention is a tab over from the previous, and a tab is eight characters in length. For example:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00261.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2">For unclear reasons, this rule is one of the most commonly broken, despite its high impact on readability. Eight-character tabs make clearly identifying indention of different code blocks orders of magnitude easier after hours of hacking. The downside, of course, of eight character tabs is that after several levels of indention, not much usable space is left on the line. This is compounded by 80-character line length limits (see subsequent section). Linus’ rejoinder to this is that your code should not be so complex and convoluted as to require more than two or three levels of indention. Need you go that deep, he argues, you should refactor your code to pull out layers of complexity (and thus levels of indention) into separate functions.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1305745"> </div>
<h4 class="calibre_27"><span class="calibre3">Switch Statements</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Subordinate <code class="calibre6"><span class="calibre7">case</span></code> labels should be indented to the same level as the parent <code class="calibre6"><span class="calibre7">switch</span></code> statement, which helps alleviate the impact of eight character tabs. For example:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00262.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2"><a id="filepos1306236"></a>It is common (and good) practice to comment when deliberately falling through from one case statement to another, as shown in this example.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1306426"> </div>
<h4 class="calibre_27"><span class="calibre3">Spacing</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">This section covers the spacing around symbols and keywords, not the spacing used in indention, which we covered in the last two sections. Generally speaking, Linux coding style dictates spaces around most keywords and no spaces between functions and their parentheses. For example:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">if (foo)<br class="calibre1"/>while (foo)<br class="calibre1"/>for (i = 0; i &lt; NR_CPUS; i++)<br class="calibre1"/>switch (foo)</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Conversely, functions, macros, and keywords that look like functions—such as <code class="calibre6"><span class="calibre7">sizeof</span></code>, <code class="calibre6"><span class="calibre7">typeof</span></code>, and <code class="calibre6"><span class="calibre7">alignof</span></code>—similarly have no space between the keyword and the parenthesis.</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">wake_up_process(task);<br class="calibre1"/>size_t nlongs = BITS_TO_LONG(nbits);<br class="calibre1"/>int len = sizeof(struct task_struct);<br class="calibre1"/>typeof(*p)<br class="calibre1"/>__alignof__(struct sockaddr *)<br class="calibre1"/>__attribute__((packed))</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Within parentheses, there is no space proceeding or preceding the argument, as previously shown. For example, this is verboten:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">int prio = task_prio( task );  /* BAD STYLE! */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Around most binary and tertiary operators, put a space on either side of the operator. For example:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">int sum = a + b;<br class="calibre1"/>int product = a * b;<br class="calibre1"/>int mod = a % b;<br class="calibre1"/>int ret = (bar) ? bar : 0;<br class="calibre1"/>return (ret ? 0 : size);<br class="calibre1"/>int nr = nr ? : 1; /* allowed shortcut, same as "nr ? nr : 1" */<br class="calibre1"/>if (x &lt; y)<br class="calibre1"/>if (tsk-&gt;flags &amp; PF_SUPERPRIV)<br class="calibre1"/>mask = POLLIN | POLLRDNORM;</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2"><a id="filepos1308546"></a>Conversely, around most unary operators, put no space between the operator and the operand:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">if (!foo)<br class="calibre1"/>int len = foo.len;<br class="calibre1"/>struct work_struct *work = &amp;dwork-&gt;work;<br class="calibre1"/>foo++;<br class="calibre1"/>—bar;<br class="calibre1"/>unsigned long inverted = ~mask;</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Getting the spacing right around the dereference operator is particularly important. The correct style is</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">char *strcpy(char *dest, const char *src)</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Placing a space on either side of the dereference operator is incorrect style:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">char * strcpy(char * dest, const char * src)  /* BAD STYLE */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Also incorrect is the C++ style of placing the dereference operator next to the type:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">char* strcpy(char* dest, const char* src)  /* BAD STYLE */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1309848"> </div>
<h4 class="calibre_27"><span class="calibre3">Braces</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Brace placement is personal, and few technical reasons exist for one convention over the other, but we have to agree on something. The accepted kernel style is to put the opening brace on the first line, at the end of the statement. The closing brace goes on a new line as the first character. Following is an example:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">if (strncmp(buf, "NO_", 3) == 0) {<br class="calibre1"/>        neg = 1;<br class="calibre1"/>        cmp += 3;<br class="calibre1"/>}</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">If the following token is a continuation of the same statement, the closing brace is not on a line by itself, but on a line shared with that token. For example:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00263.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2"><a id="filepos1310890"></a>And this example:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00264.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2">This rule is broken for functions, because functions cannot nest inside functions:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">unsigned long func(void)<br class="calibre1"/>{<br class="calibre1"/>  /* ... */<br class="calibre1"/>}</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Finally, statements that do not <em class="calibre4">need</em> braces can omit them. For example, the following is encouraged but not required:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">if (cnt &gt; 63)<br class="calibre1"/>       cnt = 63;</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">The logic behind all this is <em class="calibre4">K&amp;R.</em><sup class="calibre8"><a id="filepos1311747" href="#filepos1311964">1</a></sup> Most of Linux coding style follows <em class="calibre4">K&amp;R Style</em>, which is the C coding style used in that famous book.</p><div class="calibre_3"> </div>
<p class="calibre_2"><sup class="calibre8"><a id="filepos1311964" href="#filepos1311747">1</a></sup> The C Programming Language, <em class="calibre4">by Brian Kernighan and Dennis Ritchie (Prentice Hall, ISBN# 0-13-11-362-8), nicknamed K&amp;R, is the bible of C, written by C’s author and his colleague.</em></p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1312265"> </div>
<h4 class="calibre_27"><span class="calibre3">Line Length</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Lines of source code should be kept to fewer than 80 characters in length. This allows code to fit lengthwise on a standard 80×24 terminal.</p><div class="calibre_3"> </div>
<p class="calibre_2">There is no accepted standard on what to do in cases where code absolutely must wrap 80 characters. Some developers just allow the line to wrap, letting their editor handle the chore of displaying the code in a readable fashion. Other developers break up the lines, manually inserting line breaks where appropriate, perhaps starting each new line a tab stop over from the original.</p><div class="calibre_3"> </div>
<p class="calibre_2">Similarly, some developers line up function parameters that wrap lines with the open parenthesis. For example:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00265.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2">Other developers break up the lines but do not line the parameters up, instead use a standard two tabs:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00266.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2"><a id="filepos1313496"></a>As there is no definitive rule in this case, the choice is left up to you, the developer. Many kernel contributors, including myself, prefer the former example: Manually break up lines greater than 80 characters in length, trying to align the resulting new lines cleanly with the previous line.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1313841"> </div>
<h4 class="calibre_27"><span class="calibre3">Naming</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">No name should employ <em class="calibre4">CamelCase</em>, <em class="calibre4">Studly Caps</em>, or other mixed case schemes. Calling a local variable <code class="calibre6"><span class="calibre7">idx</span></code> or even just <code class="calibre6"><span class="calibre7">i</span></code> is perfectly fine if it is clear what it does. A cute name such as <code class="calibre6"><span class="calibre7">theLoopIndex</span></code> is unacceptable. Hungarian notation (encoding the variable type in the variable name) is unnecessary and should never be used. This is C, not Java; Unix, not Windows.</p><div class="calibre_3"> </div>
<p class="calibre_2">Nonetheless, global variables and functions should have descriptive names, in lowercase and delimited via an underscore as needed. Calling a global function <code class="calibre6"><span class="calibre7">atty()</span></code> is confusing; a name such as <code class="calibre6"><span class="calibre7">get_active_tty()</span></code> is much more acceptable. This is Linux, not BSD.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1314867"> </div>
<h4 class="calibre_27"><span class="calibre3">Functions</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">As a rule of thumb, functions should not exceed one or two screens of text and should have fewer than ten local variables. A function should do one thing and do it well. There is no harm in breaking a function into a series of smaller functions. If you are worried about function call overhead, employ <em class="calibre4">inline functions</em> via the <code class="calibre6"><span class="calibre7">inline</span></code> keyword.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1315415"> </div>
<h4 class="calibre_27"><span class="calibre3">Comments</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Commenting your code is important, but the commenting must be done correctly. Generally, you want to describe <em class="calibre4">what</em> and <em class="calibre4">why</em> your code is doing what it is doing, not <em class="calibre4">how</em> it is doing it. The <em class="calibre4">how</em> should be apparent from the code itself. If not, you might need to rethink and refactor what you wrote. Additionally, comments should not include who wrote a function, the modification date, or other trivial nonsense. Such information is generally acceptable at the top of the source file, however.</p><div class="calibre_3"> </div>
<p class="calibre_2">The kernel uses C-style comments, even though <code class="calibre6"><span class="calibre7">gcc</span></code> supports C++-style comments, too. The general style of a comment in the kernel resembles:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">/*<br class="calibre1"/> * get_ship_speed() - return the current speed of the pirate ship<br class="calibre1"/> * We need this to calculate the ship coordinates. As this function can sleep,<br class="calibre1"/> * do not call while holding a spinlock.<br class="calibre1"/> */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">In comments, important notes are often prefixed with <code class="calibre6"><span class="calibre7">"XXX:"</span></code>, and bugs are often prefixed with <code class="calibre6"><span class="calibre7">"FIXME:"</span></code> like so:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">/*<br class="calibre1"/> * FIXME: We assume dog == cat which may not be true in the future<br class="calibre1"/> */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2"><a id="filepos1317084"></a>The kernel has a facility for self-generating documentation. It is based on GNOME-doc, but slightly modified and renamed Kernel-doc. To create the standalone documentation in HTML format, run</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">make htmldocs</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Or for postscript</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">make psdocs</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">You can use the system to document your functions by following a special format for your comments:</p><div class="calibre_3"> </div>
<p class="calibre_31"><img alt="image" src="images/00267.jpg" class="calibre2"/></p><div class="calibre_7"> </div>
<p class="calibre_2">For more information, see <code class="calibre6"><span class="calibre7">Documentation/kernel-doc-nano-HOWTO.txt</span></code>.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1318013"> </div>
<h4 class="calibre_27"><span class="calibre3"><code class="calibre6"><span class="calibre7">Typedefs</span></code></span></h4><div class="calibre_24"> </div>
<p class="calibre_2">The Linux kernel developer community employs a strong dislike of the <code class="calibre6"><span class="calibre7">typedef</span></code> operator. Their rationale is</p><div class="calibre_3"> </div>
<blockquote class="calibre10"><p class="calibre_25">• <code class="calibre6"><span class="calibre7">typedef</span></code> hides the real type of data structures.</p></blockquote><div class="calibre_3"> </div>
<blockquote class="calibre10"><p class="calibre_25">• Because the type is hidden, code is more prone to do bad things, such as pass a structure by value on the stack.</p></blockquote><div class="calibre_3"> </div>
<blockquote class="calibre10"><p class="calibre_25">• <code class="calibre6"><span class="calibre7">typedef</span></code> is just being lazy.</p></blockquote><div class="calibre_3"> </div>
<p class="calibre_2">Therefore, to avoid ridicule, avoid <code class="calibre6"><span class="calibre7">typedef</span></code>.</p><div class="calibre_3"> </div>
<p class="calibre_2">Of course, there are a few good uses of <code class="calibre6"><span class="calibre7">typedefs</span></code>: hiding an architecture-specific implementation of a variable or providing forward compatibility when a type may change. Decide carefully whether the <code class="calibre6"><span class="calibre7">typedef</span></code> is truly needed or exists just to reduce the number of characters you need to type.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1319404"> </div>
<h4 class="calibre_27"><span class="calibre3">Use Existing Routines</span></h4><div class="calibre_24"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1319527"> </div>
<p class="calibre_2"><em class="calibre4">Do not reinvent the wheel</em>. The kernel provides string manipulation functions, compression routines, and a linked list interface, so use them.</p><div class="calibre_3"> </div>
<p class="calibre_2">Do not wrap existing interfaces in generic interfaces. Often you see code that was obviously ported from one operating system to Linux, and various kernel interfaces are wrapped in some gross glue function. No one likes this, so just use the provided interfaces directly.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1320101"> </div>
<h4 class="calibre_27"><span class="calibre3">Minimize <code class="calibre6"><span class="calibre7">ifdef</span></code>s in the Source</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Putting <code class="calibre6"><span class="calibre7">ifdef</span></code> preprocessor directives directly in the C source is frowned upon. You should never do something like the following in your functions:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">        ...<br class="calibre1"/>#ifdef CONFIG_FOO<br class="calibre1"/>        foo();<br class="calibre1"/>#endif<br class="calibre1"/>        ...</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Instead, define <code class="calibre6"><span class="calibre7">foo()</span></code> to nothing if <code class="calibre6"><span class="calibre7">CONFIG_FOO</span></code> is not set:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">#ifdef CONFIG_FOO<br class="calibre1"/>static int foo(void)<br class="calibre1"/>{<br class="calibre1"/>        /* .. */<br class="calibre1"/>}<br class="calibre1"/>#else<br class="calibre1"/>static inline int foo(void) { }<br class="calibre1"/>#endif /* CONFIG_FOO */</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Then, you can unconditionally call <code class="calibre6"><span class="calibre7">foo()</span></code>. Let the compiler do the work for you.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1321438"> </div>
<h4 class="calibre_27"><span class="calibre3">Structure Initializers</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">Labeled identifiers need to be used to initialize structures. This is good because it prevents structure changes from resulting in incorrect initialization. It also enables values to be omitted. Unfortunately, C99 adopted quite an ugly format for labeled identifiers, and <code class="calibre6"><span class="calibre7">gcc</span></code> is deprecating usage of the previous GNU-style labeled identifier, which was rather handsome. Consequently, kernel code needs to use the new C99 labeled identifier format, however ugly it is:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">struct foo my_foo = {<br class="calibre1"/>    .a    = INITIAL_A,<br class="calibre1"/>    .b    = INITIAL_B,<br class="calibre1"/>};</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">In this code, <code class="calibre6"><span class="calibre7">a</span></code> and <code class="calibre6"><span class="calibre7">b</span></code> are members of <code class="calibre6"><span class="calibre7">struct foo</span></code> and <code class="calibre6"><span class="calibre7">INITIAL_A</span></code> and <code class="calibre6"><span class="calibre7">INITIAL_B</span></code> are their initialized values, respectively. If a field is not set, it is set to its default value per ANSI C (for example, pointers are <code class="calibre6"><span class="calibre7">NULL</span></code>, integers are zero, and floats are 0.0). For <a id="filepos1322852"></a>example, if <code class="calibre6"><span class="calibre7">struct foo</span></code> also has <code class="calibre6"><span class="calibre7">int c</span></code> as a member, the previous statement would initialize <code class="calibre6"><span class="calibre7">c</span></code> to zero.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1323109"> </div>
<h4 class="calibre_27"><span class="calibre3">Fixing Up Code Ex Post Facto</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">If a pile of code falls into your lap that fails to even mildly resemble the Linux kernel coding style, do not fret. A little elbow grease and the <code class="calibre6"><span class="calibre7">indent</span></code> utility can make everything perfect. <code class="calibre6"><span class="calibre7">indent</span></code>, an excellent GNU utility found on most Linux systems, formats source according to given rules. The default settings are for the GNU coding style, which is not too pretty. To get the utility to follow the Linux kernel style, execute the following:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">indent -kr -i8 -ts8 -sob -l80 -ss -bs -psl &lt;file&gt;</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">This instructs the utility to format the code according to the kernel coding style. Alternatively, the script <code class="calibre6"><span class="calibre7">scripts/Lindent</span></code> automatically invokes <code class="calibre6"><span class="calibre7">indent</span></code> with the desired options.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1324264"> </div>
<h3 class="calibre_21"><span class="bold">Chain of Command</span></h3><div class="calibre_22"> </div>
<p class="calibre_2">Kernel hackers are the developers who work on the kernel. Some do it for pay, some as a hobby, but nearly all for fun. Kernel hackers with significant contributions are listed in the <code class="calibre6"><span class="calibre7">CREDITS</span></code> file in the root of the kernel source tree.</p><div class="calibre_3"> </div>
<p class="calibre_2">Most parts of the kernel have an associated <em class="calibre4">maintainer</em>. The maintainer is the individual (or individuals) who is in charge of specific parts of the kernel. For example, each individual driver has an associated maintainer. Each kernel subsystem—for example, networking—also has an associated maintainer. The maintainer for a specific driver or subsystem is usually listed in the file <code class="calibre6"><span class="calibre7">MAINTAINERS</span></code>, which is also located in the root of the kernel source tree.</p><div class="calibre_3"> </div>
<p class="calibre_2">There is a special type of maintainer, known as the kernel maintainer. This individual actually maintains the kernel tree. Historically, Linus maintains the development kernel (where the real fun is) and the stable kernel for some period after development ends. Shortly after a development kernel becomes a stable kernel, Linus passes the torch to one of the top kernel developers. That developer continues to maintain the tree while Linus begins work on the new development tree. Given the “new world order” in which development on 2.6 continues in perpetuity, Linus remains the maintainer of the 2.6 kernel series. Another developer maintains the 2.4 series, which is in a strict bug-fix-only mode.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1326029"> </div>
<h3 class="calibre_21"><span class="bold">Submitting Bug Reports</span></h3><div class="calibre_22"> </div>
<p class="calibre_2">If you encounter a bug, the best course of action is to write a fix, create a patch, test it, and submit it as discussed in the following sections. Of course, you can also report the problem and get someone to fix it for you.</p><div class="calibre_3"> </div>
<p class="calibre_2"><a id="filepos1326430"></a>The most important part of submitting a bug report is fully describing the problem. Describe the symptoms, any system output, and a fully decoded oops (if there is an oops). More important, if you can, provide steps to reliably reproduce the problem and a brief description of your hardware.</p><div class="calibre_3"> </div>
<p class="calibre_2">Deciding to whom to send the bug report is the next step. The file <code class="calibre6"><span class="calibre7">MAINTAINERS</span></code>, in the root of the kernel source tree, lists the individuals associated with each driver and subsystem—they should receive any issues related to the code they maintain. If you cannot find an interested party, send the report to the Linux Kernel Mailing List at <a href="mailto:linux-kernel@vger.kernel.org">linux-kernel@vger.kernel.org</a>. Even if you do find a maintainer, CC the kernel mailing list.</p><div class="calibre_3"> </div>
<p class="calibre_2">The files <code class="calibre6"><span class="calibre7">REPORTING-BUGS</span></code> and <code class="calibre6"><span class="calibre7">Documentation/oops-tracing.txt</span></code> provide more information.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1327552"> </div>
<h3 class="calibre_21"><span class="bold">Patches</span></h3><div class="calibre_22"> </div>
<p class="calibre_2">All changes to the Linux kernel are distributed in the form of patches, which are the output of the GNU <code class="calibre6"><span class="calibre7">diff</span></code>(1) program in a form that is readable by the <code class="calibre6"><span class="calibre7">patch</span></code>(1) program.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1327954"> </div>
<h4 class="calibre_27"><span class="calibre3">Generating Patches</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">The simplest way to generate a patch is to have two source trees, one that is the vanilla stock kernel and another that is the stock tree with your modifications. A common scheme is to name the stock tree <code class="calibre6"><span class="calibre7">linux-x.y.z</span></code> (which is what the source tarball extracts to, initially) and to name your modified tree simply <code class="calibre6"><span class="calibre7">linux</span></code>. Then, to generate a patch of the two trees, issue the following command from one directory below your trees:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">diff -urN linux-x.y.z/ linux/ &gt; my-patch</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">This is typically done somewhere in your home, and not <code class="calibre6"><span class="calibre7">/usr/src/linux</span></code> so that you do not need to be root. The <code class="calibre6"><span class="calibre7">-u</span></code> flag specifies that the unified diff format should be used. Without this, the patch is ugly and not readable by humans. The <code class="calibre6"><span class="calibre7">-r</span></code> flag instructs <code class="calibre6"><span class="calibre7">diff</span></code> to recursively diff all directories, and the <code class="calibre6"><span class="calibre7">-N</span></code> flag specifies that new files in the modified tree should be included in the diff. Alternatively, if you need to diff only a single file, you can do</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">diff -u linux-x.y.z/some/file linux/some/file &gt; my-patch</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">You need to always diff the trees from one directory below your source trees. This creates a patch that is usable by others, even if their directory names differ. To apply a patch made in this format, do the following from the root of your source tree:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">patch -p1 &lt; ../my-patch</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">In this example, the patch is named <code class="calibre6"><span class="calibre7">my-patch</span></code> and is created one directory below the current. The <code class="calibre6"><span class="calibre7">-p1</span></code> flag instructs <code class="calibre6"><span class="calibre7">diff</span></code> to strip the first directory from the patch. This enables you to apply a patch regardless of the directory-naming convention used by the patch maker.</p><div class="calibre_3"> </div>
<p class="calibre_2"><a id="filepos1330471"></a>A useful utility is <code class="calibre6"><span class="calibre7">diffstat</span></code>, which generates a histogram of a patch’s changes (line additions and removals). To generate the output on one of your patches, do</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">diffstat -p1 my-patch</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">It is often useful to include this output when you post a patch to lkml. Because the <code class="calibre6"><span class="calibre7">patch(1)</span></code> program ignores all lines until a diff is detected, you can even include a short description at the top of the patch.</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1331143"> </div>
<h4 class="calibre_27"><span class="calibre3">Generating Patches with Git</span></h4><div class="calibre_24"> </div>
<p class="calibre_2">If you use Git to manage your source tree, you need to use Git to likewise generate your patches—there is no point going through all the aforementioned manual steps <em class="calibre4">and</em> bear the complexity of Git. Generating patches with Git is an easy two-part process. First, you need to author and then locally <em class="calibre4">commit</em> your changes. Making changes to a Git tree is the same as a standard source tree. You do not need to do anything special to edit a file stored in Git. After you make your changes, you need to commit them to your Git repository:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git commit -a</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">The <code class="calibre6"><span class="calibre7">-a</span></code> flag instructs Git to commit <em class="calibre4">all</em> your changes. If you only want to commit changes to a specific file, you can do that, too:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git commit some/file.c</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">Even with the <code class="calibre6"><span class="calibre7">-a</span></code> flag, however, Git will not commit new files until they are explicitly added to the repository. To add a file and then commit it (and all other changes), issue the following two commands:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git add some/other/file.c<br class="calibre1"/>git commit -a</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">When you run <em class="calibre4">git commit</em>, Git enables you to enter a change log. Make this entry verbose and complete, fully explaining the commit. (We cover exactly what to include in the next section.) You can create multiple commits against your repository. Thanks to Git’s design, subsequent commits can even be against the same file, building off of each other. When you have a commit (or two) in your tree, you can generate a patch for each commit, which you can treat as you do the patches described in the previous section:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git format-patch origin</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">This generates patches for all commits in your repository and not in the original tree. Git creates the patches in the root of your kernel source tree. To generate patches for only the last <em class="calibre4">N</em> commits, you can execute the following:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git format-patch -<span><tt class="calibre6"><span class="calibre19">N</span></tt></span></span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2">For example, this command generates a patch for only the last commit:</p><div class="calibre_3"> </div>
<p class="calibre_28"><tt class="calibre6"><span class="calibre12">git format-patch -1</span></tt></p><div class="calibre_22"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1334202"> </div>
<h4 class="calibre_27"><span class="calibre3">Submitting Patches</span></h4><div class="calibre_24"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1334322"> </div>
<p class="calibre_2">Patches should be generated as described in the previous section. If the patch touches a specific driver or subsystem, the patch should be sent to the maintainer listed in <code class="calibre6"><span class="calibre7">MAINTAINER</span></code>. Either way, the Linux Kernel Mailing List at <a href="mailto:linux-kernel@vger.kernel.org">linux-kernel@vger.kernel.org</a> should be carbon copied. The patch should be sent to the kernel maintainer (for example, Linus) only after extensive discussion, or if the patch is trivial and clearly correct.</p><div class="calibre_3"> </div>
<p class="calibre_2">Typically, the subject line of the email containing the patch is of the form “<em class="calibre4">[PATCH] brief description.</em>” The body of the email describes in technical detail the changes your patch makes and the rationale behind them. Be as specific as possible. Somewhere in the email, note the kernel version against which the patch was created.</p><div class="calibre_3"> </div>
<p class="calibre_2">Most kernel developers want to read your patch inline with your email and optionally save the whole thing to a single file. Consequently, it is best to insert the patch directly inline in the email, at the end of your message. Be aware that some email clients might wrap lines or otherwise change formatting; this breaks the patch and annoys developers. If your email client does this, see whether it has an “Insert Inline,” “Preformat,” or similar feature. Otherwise, attaching the patch as plain text without encoding works, too.</p><div class="calibre_3"> </div>
<p class="calibre_2">If your patch is large or contains several logical changes, you should break the patch into chunks, with each chunk representing a logical change. For example, if you both introduce a new API and change a handful of drivers to use it, you can break the changes into two patches (the new API and then the driver changeover) and two emails. If any chunk requires a previous patch, explicitly state that.</p><div class="calibre_3"> </div>
<p class="calibre_2">After posting, remain patient and wait for a reply. Do not be discouraged by any negative response—at least you got a response! Discuss the issues and provide updated patches as needed. If you fail to receive <em class="calibre4">any</em> response, try to discover what was wrong and resolve the issues. Solicit additional comments from the mailing list and maintainer. With luck, you might see your changes in a future kernel release—congratulations!</p><div class="calibre_3"> </div>
<p class="calibre_2"></p><div class="calibre_3" id="filepos1336900"> </div>
<h3 class="calibre_21"><span class="bold">Conclusion</span></h3><div class="calibre_22"> </div>
<p class="calibre_2">The most important quality of any hacker is desire and drive—an itch to scratch, and the determination to scratch it. This book provided a tour of key parts of the kernel, discussing interfaces, data structures, algorithms, and rationale. It provided an insider’s view of the kernel, in a practical fashion, to satisfy your curiosity or get you off the ground running in your kernel endeavors.</p><div class="calibre_3"> </div>
<p class="calibre_2">As I have said before, however, the only way to start is by <em class="calibre4">reading</em> and <em class="calibre4">writing</em> code. Linux provides a community that not only enables but also <em class="calibre4">encourages</em> both activities—so start reading and coding! Happy hacking!</p><div class="calibre_3"> </div>  <div class="mbp_pagebreak" id="calibre_pb_84"></div>
</body></html>
