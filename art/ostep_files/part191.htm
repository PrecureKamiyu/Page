<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>19.1 TLB Basic Algorithm</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part190.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part192.htm">下一个 &gt;</a></p><p class="s40" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">19.1 TLB Basic Algorithm</p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Figure <span style=" color: #00AEEF;">19.1 </span>shows a rough sketch of how hardware might handle a virtual address translation, assuming a simple <b>linear page table </b>(i.e., the page table is an array) and a <b>hardware-managed TLB </b>(i.e., the hardware handles much of the responsibility of page table accesses; we’ll explain more about this below).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;text-align: center;">183</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s37" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: left;">1  <span class="s38">VPN = (VirtualAddress &amp; VPN_MASK) &gt;&gt; SHIFT</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">2  <span class="s38">(Success, TlbEntry) = TLB_Lookup(VPN)</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">3  <span class="s38">if (Success == True) // TLB Hit</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">4    <span class="s38">if (CanAccess(TlbEntry.ProtectBits) == True)</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">5       <span class="s38">Offset  = VirtualAddress &amp; OFFSET_MASK</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">6       <span class="s38">PhysAddr = (TlbEntry.PFN &lt;&lt; SHIFT) | Offset</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">7       <span class="s38">AccessMemory(PhysAddr)</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">8    <span class="s38">else</span></p><p class="s37" style="padding-left: 54pt;text-indent: 0pt;text-align: left;">9       <span class="s38">RaiseException(PROTECTION_FAULT)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">10  <span class="s38">else       // TLB Miss</span></p><p class="s38" style="padding-left: 52pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><span class="s37">11     </span>PTEAddr = PTBR + (VPN <span class="s39">* </span>sizeof(PTE))</p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;line-height: 7pt;text-align: left;">12    <span class="s38">PTE = AccessMemory(PTEAddr)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">13    <span class="s38">if (PTE.Valid == False)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">14       <span class="s38">RaiseException(SEGMENTATION_FAULT)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">15    <span class="s38">else if (CanAccess(PTE.ProtectBits) == False)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">16       <span class="s38">RaiseException(PROTECTION_FAULT)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">17    <span class="s38">else</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">18       <span class="s38">TLB_Insert(VPN, PTE.PFN, PTE.ProtectBits)</span></p><p class="s37" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">19       <span class="s38">RetryInstruction()</span></p><p style="padding-top: 5pt;padding-left: 129pt;text-indent: 0pt;text-align: left;">Figure 19.1: <b>TLB Control Flow Algorithm</b></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: left;">The algorithm the hardware follows works like this: first, extract the virtual page number (VPN) from the virtual address (Line 1 in Figure <span style=" color: #00AEEF;">19.1</span>), and check if the TLB holds the translation for this VPN (Line 2). If it does, we have a <b>TLB hit</b>, which means the TLB holds the translation. Success! We can now extract the page frame number (PFN) from the relevant TLB entry, concatenate that onto the offset from the original virtual address, and form the desired physical address (PA), and access memory (Lines 5–7), assuming protection checks do not fail (Line 4).</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">If the CPU does not find the translation in the TLB (a <b>TLB miss</b>), we have some more work to do. In this example, the hardware accesses the page table to find the translation (Lines 11–12), and, assuming that the virtual memory reference generated by the process is valid and accessi- ble (Lines 13, 15), updates the TLB with the translation (Line 18). These set of actions are costly, primarily because of the extra memory reference needed to access the page table (Line 12). Finally, once the TLB is up- dated, the hardware retries the instruction; this time, the translation is found in the TLB, and the memory reference is processed quickly.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">The TLB, like all caches, is built on the premise that in the common case, translations are found in the cache (i.e., are hits). If so, little over- head is added, as the TLB is found near the processing core and is de- signed to be quite fast. When a miss occurs, the high cost of paging is incurred; the page table must be accessed to find the translation, and an extra memory reference (or more, with more complex page tables) results. If this happens often, the program will likely run noticeably more slowly; memory accesses, relative to most CPU instructions, are quite costly, and TLB misses lead to more memory accesses. Thus, it is our hope to avoid TLB misses as much as we can.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s80" style="padding-top: 3pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">Offset</p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[0]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;text-indent: 0pt;line-height: 8pt;text-align: left;">a[1]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[2]</p></td></tr><tr style="height:10pt"><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[3]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[4]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;text-indent: 0pt;line-height: 8pt;text-align: left;">a[5]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[6]</p></td></tr><tr style="height:10pt"><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[7]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;padding-right: 3pt;text-indent: 0pt;line-height: 8pt;text-align: center;">a[8]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:dashed;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s106" style="padding-left: 4pt;text-indent: 0pt;line-height: 8pt;text-align: left;">a[9]</p></td><td style="width:23pt;border-top-style:solid;border-top-width:2pt;border-left-style:dashed;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:92pt;border-top-style:solid;border-top-width:2pt;border-left-style:solid;border-left-width:2pt;border-bottom-style:solid;border-bottom-width:2pt;border-right-style:solid;border-right-width:2pt" colspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s80" style="padding-left: 54pt;text-indent: 0pt;text-align: center;">00  04  08  12  16</p><p class="s80" style="padding-top: 2pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 00</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 01</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 02</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 03</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 04</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 05</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 06</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 07</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 08</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 09</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 10</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 11</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 12</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 13</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 14</p><p class="s80" style="padding-top: 1pt;padding-left: 110pt;text-indent: 0pt;text-align: left;">VPN = 15</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 69pt;text-indent: 0pt;text-align: left;">Figure 19.2: <b>Example: An Array In A Tiny Address Space</b></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part190.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part192.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
