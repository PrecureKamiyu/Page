<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>A Broken Solution</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part310.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part312.htm">下一个 &gt;</a></p><p class="s32" style="padding-top: 5pt;padding-left: 41pt;text-indent: 0pt;text-align: justify;">A Broken Solution</p><p style="padding-top: 6pt;padding-left: 41pt;text-indent: 0pt;line-height: 88%;text-align: justify;">Now imagine that we have just a single producer and a single consumer. Obviously the <span class="s41">put() </span>and <span class="s41">get() </span>routines have critical sections within them, as <span class="s41">put() </span>updates the buffer, and <span class="s41">get() </span>reads from it. However, putting a lock around the code doesn’t work; we need something more. Not surprisingly, that something more is some condition variables. In this (broken) first try (Figure <span style=" color: #00AEEF;">30.6</span>), we have a single condition variable <span class="s41">cond </span>and associated lock <span class="s41">mutex</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:71.5477pt" cellspacing="0"><tr style="height:9pt"><td style="width:23pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s142" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">T<span class="s144">c</span><span class="s139">1</span></p></td><td style="width:40pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">State</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s142" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">T<span class="s144">c</span><span class="s139">2</span></p></td><td style="width:39pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">State</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s138" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">T<span class="s145">p</span></p></td><td style="width:39pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 11pt;text-indent: 0pt;line-height: 8pt;text-align: left;">State</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s69" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">Count</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#221E1F"><p class="s134" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 8pt;text-align: center;">Comment</p></td></tr><tr style="height:8pt"><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c1</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-top-style:solid;border-top-width:1pt;border-top-color:#221E1F;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c2</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c3</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Nothing to get</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p1</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p2</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Sleep</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p4</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 4pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Buffer now full</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p5</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">T<span class="s144">c</span><span class="s139">1 </span>awoken</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p6</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p1</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p2</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Running</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">p3</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 10pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Sleep</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Buffer full; sleep</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c1</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 10pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Sleep</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 5pt;padding-right: 4pt;text-indent: 0pt;line-height: 7pt;text-align: center;">T<span class="s144">c</span><span class="s139">2 </span>sneaks in ...</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c2</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 10pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Sleep</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">1</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c4</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 10pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Sleep</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">... and grabs data</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c5</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s142" style="padding-left: 4pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">T<span class="s144">p </span>awoken</p></td></tr><tr style="height:8pt"><td style="width:23pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 8pt;text-indent: 0pt;line-height: 7pt;text-align: left;">c6</p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:23pt"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">c4</p></td><td style="width:40pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Running</p></td><td style="width:23pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Ready</p></td><td style="width:21pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="padding-right: 9pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Ready</p></td><td style="width:33pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F;border-right-style:solid;border-right-width:1pt;border-right-color:#221E1F"><p class="s70" style="text-indent: 0pt;line-height: 7pt;text-align: center;">0</p></td><td style="width:65pt;border-left-style:solid;border-left-width:1pt;border-left-color:#221E1F"><p class="s70" style="padding-left: 5pt;padding-right: 5pt;text-indent: 0pt;line-height: 7pt;text-align: center;">Oh oh! No data</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 2pt;padding-left: 104pt;text-indent: 0pt;text-align: justify;">Table 30.1: <b>Thread Trace: Broken Solution (Version 1)</b></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Let’s examine the signaling logic between producers and consumers. When a producer wants to fill the buffer, it waits for it to be empty (p1– p3). The consumer has the exact same logic, but waits for a different condition: fullness (c1–c3).</p><p style="padding-left: 80pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">With just a single producer and a single consumer, the code in Figure</p><p class="s28" style="padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: justify;">30.6 <span style=" color: #231F20;">works. However, if we have more than one of these threads (e.g., two consumers), the solution has two critical problems. What are they?</span></p><p class="s6" style="padding-left: 80pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">... (pause here to think) ...</p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;"><span class="p">Let’s understand the first problem, which has to do with the </span><span class="s41">if </span><span class="p">state- </span>ment before the wait. Assume there are two consumers (<span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>and <span class="s57">T</span><span class="s58">c</span><span class="s62">2 </span>) and one producer (<span class="s57">T</span><span class="s58">p</span>). First, a consumer (<span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>) runs; it acquires the lock (c1), <span class="p">checks if any buffers are ready for consumption (c2), and finding that none are, waits (c3) (which releases the lock).</span></p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Then the producer (<span class="s57">T</span><span class="s58">p</span>) runs. It acquires the lock (p1), checks if all <span class="p">buffers are full (p2), and finding that not to be the case, goes ahead and fills the buffer (p4). The producer then signals that a buffer has been </span>filled (p5). Critically, this moves the first consumer (<span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>) from sleeping on a condition variable to the ready queue; <span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>is now able to run (but <span class="p">not yet running). The producer then continues until realizing the buffer is full, at which point it sleeps (p6, p1–p3).</span></p><p class="s61" style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Here is where the problem occurs: another consumer (<span class="s57">T</span><span class="s58">c</span><span class="s62">2</span>) sneaks in <span class="p">and consumes the one existing value in the buffer (c1, c2, c4, c5, c6, skip- </span>ping the wait at c3 because the buffer is full). Now assume <span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>runs; just <span class="p">before returning from the wait, it re-acquires the lock and then returns. It then calls </span><span class="s41">get() </span><span class="p">(c4), but there are no buffers to consume! An assertion triggers, and the code has not functioned as desired. Clearly, we should </span>have somehow prevented <span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>from trying to consume because <span class="s57">T</span><span class="s58">c</span><span class="s62">2 </span>snuck <span class="p">in and consumed the one value in the buffer that had been produced. Ta- ble </span><span class="s28">30.1 </span><span class="p">shows the action each thread takes, as well as its scheduler state (Ready, Running, or Sleeping) over time.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:21.6598pt" cellspacing="0"><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">1</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 6pt;text-align: left;">cond_t cond;</p></td><td style="width:25pt" colspan="2" rowspan="6"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:9pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">mutex_t mutex;</p></td></tr><tr style="height:7pt"><td style="width:13pt"><p class="s135" style="padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">3</p></td><td style="width:197pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:9pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">4</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 7pt;text-align: left;">void <span class="s136">*</span>producer(void <span class="s136">*</span>arg) {</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">5</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 6pt;text-align: left;">int i;</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">6</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 7pt;text-align: left;">for (i = 0; i &lt; loops; i++) {</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">7</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_mutex_lock(&amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p1</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">8</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">while (count == 1)</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p2</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 4pt;text-indent: 0pt;line-height: 6pt;text-align: left;">9</p></td><td style="width:197pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Pthread_cond_wait(&amp;cond, &amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p3</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">10</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">put(i);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p4</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">11</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_cond_signal(&amp;cond);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p5</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">12</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_mutex_unlock(&amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">p6</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">13</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 7pt;text-align: left;">}</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:9pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">14</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">}</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:7pt"><td style="width:13pt"><p class="s135" style="padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">15</p></td><td style="width:197pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:9pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">16</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 7pt;text-align: left;">void <span class="s136">*</span>consumer(void <span class="s136">*</span>arg) {</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">17</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 6pt;text-align: left;">int i;</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">18</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 7pt;text-align: left;">for (i = 0; i &lt; loops; i++) {</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">19</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_mutex_lock(&amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c1</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">20</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">while (count == 0)</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c2</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">21</p></td><td style="width:197pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">Pthread_cond_wait(&amp;cond, &amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c3</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">22</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">int tmp = get();</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c4</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">23</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_cond_signal(&amp;cond);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c5</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">24</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">Pthread_mutex_unlock(&amp;mutex);</p></td><td style="width:12pt"><p class="s42" style="padding-right: 1pt;text-indent: 0pt;line-height: 7pt;text-align: right;">//</p></td><td style="width:13pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 7pt;text-align: right;">c6</p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">25</p></td><td style="width:197pt"><p class="s42" style="padding-left: 39pt;text-indent: 0pt;line-height: 7pt;text-align: left;">printf(&quot;%d\n&quot;, tmp);</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 6pt;text-align: left;">26</p></td><td style="width:197pt"><p class="s42" style="padding-left: 22pt;text-indent: 0pt;line-height: 7pt;text-align: left;">}</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:8pt"><td style="width:13pt"><p class="s135" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;line-height: 5pt;text-align: left;">27</p></td><td style="width:197pt"><p class="s42" style="padding-left: 5pt;text-indent: 0pt;line-height: 6pt;text-align: left;">}</p></td><td style="width:12pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 2pt;padding-left: 73pt;text-indent: 0pt;text-align: left;">Figure 30.7: <b>Producer/Consumer: Single CV and While</b></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s61" style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">The problem arises for a simple reason: after the producer woke <span class="s57">T</span><span class="s58">c</span><span class="s62">1</span>, but <i>before </i><span class="s57">T</span><span class="s58">c</span><span class="s62">1 </span>ever ran, the state of the bounded buffer changed (thanks to <span class="s57">T</span><span class="s58">c</span><span class="s62">2</span>). Signaling a thread only wakes them up; it is thus a <i>hint </i>that the state <span class="p">of the world has changed (in this case, that a value has been placed in the buffer), but there is no guarantee that when the woken thread runs, the state will </span><i>still </i><span class="p">be as desired. This interpretation of what a signal means is often referred to as </span><b>Mesa semantics</b><span class="p">, after the first research that built a condition variable in such a manner [LR80]; the contrast, referred to as </span><b>Hoare semantics</b><span class="p">, is harder to build but provides a stronger guarantee that the woken thread will run immediately upon being woken [H74]. Virtually every system ever built employs Mesa semantics.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part310.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part312.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
