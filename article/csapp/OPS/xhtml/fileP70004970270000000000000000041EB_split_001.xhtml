<?xml version='1.0' encoding='utf-8'?>
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg" xmlns:epub="http://www.idpf.org/2007/ops" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" epub:prefix="index: http://www.index.com/">
  <head>
    <meta name="dcterms.conformsTo" content="PXE Basic 1.0"/>
    <meta name="generator" content="PXE Tools version 1.39.52"/>
    <!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
    <title>4.5 Pipelined Y86-64 Implementations</title>
    <link rel="alternate stylesheet" type="text/css" title="night" href="../css/theme/night.css"/>
    <link rel="alternate stylesheet" type="text/css" title="sepia" href="../css/theme/sepia.css"/>
    <script src="js/format_lg_obj.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body epub:type="bodymatter" class="calibre pcalibre pcalibre1">
<section id="P70004970270000000000000000041EB" class="pcalibre halftitlepage pcalibre1">
<section id="P7000497027000000000000000004251" data-uri="chapter04.xhtml#P7000497027000000000000000004251" class="pcalibre halftitlepage pcalibre1">
<section id="P70004970270000000000000000042B5" data-uri="chapter04.xhtml#P70004970270000000000000000042B5" class="pcalibre halftitlepage pcalibre1">
<figure class="pcalibre5 figure pcalibre" id="P70004970270000000000000000042C2" data-uri="chapter04.xhtml#P70004970270000000000000000042C2">
<figcaption id="P70004970270000000000000000426D4" data-uri="chapter04.xhtml#P70004970270000000000000000426D4" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P70004970270000000000000000426D5" data-uri="chapter04.xhtml#P70004970270000000000000000426D5" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.47 </span>Pipelined execution of <code id="P70004970270000000000000000426D6" data-uri="chapter04.xhtml#P70004970270000000000000000426D6" class="pcalibre1 calibre8 pcalibre">prog2</code> using stalls.</h1></header>
<div class="edition pcalibre pcalibre1" id="P70004970270000000000000000426D7" data-uri="chapter04.xhtml#P70004970270000000000000000426D7"><p id="P70004970270000000000000000426D8" data-uri="chapter04.xhtml#P70004970270000000000000000426D8" class="pcalibre1 pcalibre calibre2">After decoding the <code id="P70004970270000000000000000426D9" data-uri="chapter04.xhtml#P70004970270000000000000000426D9" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in cycle 6, the stall control logic detects a data hazard due to the pending write to register <code id="P70004970270000000000000000426DA" data-uri="chapter04.xhtml#P70004970270000000000000000426DA" class="pcalibre1 calibre8 pcalibre">%rax</code> in the write-back stage. It injects a bubble into the execute stage and repeats the decoding of the <code id="P70004970270000000000000000426DB" data-uri="chapter04.xhtml#P70004970270000000000000000426DB" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in cycle 7. In effect, the machine has dynamically inserted a <code id="P70004970270000000000000000426DC" data-uri="chapter04.xhtml#P70004970270000000000000000426DC" class="pcalibre1 calibre8 pcalibre">nop</code> instruction, giving a flow similar to that shown for <code id="P70004970270000000000000000426DD" data-uri="chapter04.xhtml#P70004970270000000000000000426DD" class="pcalibre1 calibre8 pcalibre">prog1</code> (<a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004254"><span class="pcalibre label pcalibre1">Figure </span><span class="number pcalibre pcalibre1">4.43</span></a>).</p><p id="P70004970270000000000000000426DE" data-uri="chapter04.xhtml#P70004970270000000000000000426DE" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P70004970270000000000000000229BA" data-uri="chapter04.xhtml#P70004970270000000000000000229BA">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000426DF" data-uri="chapter04.xhtml#P70004970270000000000000000426DF" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P70004970270000000000000000426E0" data-uri="chapter04.xhtml#P70004970270000000000000000426E0">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000426E1" data-uri="chapter04.xhtml#P70004970270000000000000000426E1" class="calibre18 pcalibre pcalibre1">Prog2</th>
<th id="P70004970270000000000000000426E2" data-uri="chapter04.xhtml#P70004970270000000000000000426E2" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P70004970270000000000000000426E3" data-uri="chapter04.xhtml#P70004970270000000000000000426E3" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P70004970270000000000000000426E4" data-uri="chapter04.xhtml#P70004970270000000000000000426E4" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P70004970270000000000000000426E5" data-uri="chapter04.xhtml#P70004970270000000000000000426E5" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P70004970270000000000000000426E6" data-uri="chapter04.xhtml#P70004970270000000000000000426E6" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P70004970270000000000000000426E7" data-uri="chapter04.xhtml#P70004970270000000000000000426E7" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P70004970270000000000000000426E8" data-uri="chapter04.xhtml#P70004970270000000000000000426E8" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P70004970270000000000000000426E9" data-uri="chapter04.xhtml#P70004970270000000000000000426E9" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P70004970270000000000000000426EA" data-uri="chapter04.xhtml#P70004970270000000000000000426EA" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P70004970270000000000000000426EB" data-uri="chapter04.xhtml#P70004970270000000000000000426EB" class="calibre18 pcalibre pcalibre1">10</th>
<th id="P70004970270000000000000000426EC" data-uri="chapter04.xhtml#P70004970270000000000000000426EC" class="calibre18 pcalibre pcalibre1">11</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000426ED" data-uri="chapter04.xhtml#P70004970270000000000000000426ED" class="calibre20 pcalibre pcalibre1">0x000: irmovq $10, %rdx</td>
<td id="P70004970270000000000000000426EE" data-uri="chapter04.xhtml#P70004970270000000000000000426EE" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000426EF" data-uri="chapter04.xhtml#P70004970270000000000000000426EF" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000426F0" data-uri="chapter04.xhtml#P70004970270000000000000000426F0" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000426F1" data-uri="chapter04.xhtml#P70004970270000000000000000426F1" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000426F2" data-uri="chapter04.xhtml#P70004970270000000000000000426F2" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000426F3" data-uri="chapter04.xhtml#P70004970270000000000000000426F3" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000426F4" data-uri="chapter04.xhtml#P70004970270000000000000000426F4" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000426F5" data-uri="chapter04.xhtml#P70004970270000000000000000426F5" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000426F6" data-uri="chapter04.xhtml#P70004970270000000000000000426F6" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000426F7" data-uri="chapter04.xhtml#P70004970270000000000000000426F7" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000426F8" data-uri="chapter04.xhtml#P70004970270000000000000000426F8" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000426F9" data-uri="chapter04.xhtml#P70004970270000000000000000426F9" class="calibre20 pcalibre pcalibre1">0x014: nop</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000426FA" data-uri="chapter04.xhtml#P70004970270000000000000000426FA" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000426FB" data-uri="chapter04.xhtml#P70004970270000000000000000426FB" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000426FC" data-uri="chapter04.xhtml#P70004970270000000000000000426FC" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000426FD" data-uri="chapter04.xhtml#P70004970270000000000000000426FD" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000426FE" data-uri="chapter04.xhtml#P70004970270000000000000000426FE" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000426FF" data-uri="chapter04.xhtml#P70004970270000000000000000426FF" class="calibre20 pcalibre pcalibre1">0x015: nop </td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042700" data-uri="chapter04.xhtml#P7000497027000000000000000042700" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042701" data-uri="chapter04.xhtml#P7000497027000000000000000042701" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042702" data-uri="chapter04.xhtml#P7000497027000000000000000042702" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042703" data-uri="chapter04.xhtml#P7000497027000000000000000042703" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042704" data-uri="chapter04.xhtml#P7000497027000000000000000042704" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042705" data-uri="chapter04.xhtml#P7000497027000000000000000042705" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042706" data-uri="chapter04.xhtml#P7000497027000000000000000042706" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042707" data-uri="chapter04.xhtml#P7000497027000000000000000042707" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042708" data-uri="chapter04.xhtml#P7000497027000000000000000042708" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042709" data-uri="chapter04.xhtml#P7000497027000000000000000042709" class="calibre20 pcalibre pcalibre1">0x016: addq %rdx, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004270A" data-uri="chapter04.xhtml#P700049702700000000000000004270A" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004270B" data-uri="chapter04.xhtml#P700049702700000000000000004270B" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004270C" data-uri="chapter04.xhtml#P700049702700000000000000004270C" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004270D" data-uri="chapter04.xhtml#P700049702700000000000000004270D" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004270E" data-uri="chapter04.xhtml#P700049702700000000000000004270E" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004270F" data-uri="chapter04.xhtml#P700049702700000000000000004270F" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042710" data-uri="chapter04.xhtml#P7000497027000000000000000042710" class="calibre20 pcalibre pcalibre1">0x018: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042711" data-uri="chapter04.xhtml#P7000497027000000000000000042711" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042712" data-uri="chapter04.xhtml#P7000497027000000000000000042712" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042713" data-uri="chapter04.xhtml#P7000497027000000000000000042713" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042714" data-uri="chapter04.xhtml#P7000497027000000000000000042714" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042715" data-uri="chapter04.xhtml#P7000497027000000000000000042715" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042716" data-uri="chapter04.xhtml#P7000497027000000000000000042716" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
</details>

</figcaption>
</figure>
<figure class="pcalibre5 figure pcalibre" id="P70004970270000000000000000042CF" data-uri="chapter04.xhtml#P70004970270000000000000000042CF">
<img alt="A diagram illustrates a pipelined execution of prog4 using stalls" id="P7000497027000000000000000042717" data-uri="P700049702700000000000000000B6F5" src="../images/p434-2.png" class="calibre146 pcalibre pcalibre1"/>
<figcaption id="P7000497027000000000000000042718" data-uri="chapter04.xhtml#P7000497027000000000000000042718" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P7000497027000000000000000042719" data-uri="chapter04.xhtml#P7000497027000000000000000042719" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.48 </span>Pipelined execution of <code id="P700049702700000000000000004271A" data-uri="chapter04.xhtml#P700049702700000000000000004271A" class="pcalibre1 calibre8 pcalibre">prog4</code> using stalls.</h1></header>
<div class="edition pcalibre pcalibre1" id="P700049702700000000000000004271B" data-uri="chapter04.xhtml#P700049702700000000000000004271B"><p id="P700049702700000000000000004271C" data-uri="chapter04.xhtml#P700049702700000000000000004271C" class="pcalibre1 pcalibre calibre2">After decoding the <code id="P700049702700000000000000004271D" data-uri="chapter04.xhtml#P700049702700000000000000004271D" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in cycle 4, the stall control logic detects data hazards for both source registers. It injects a bubble into the execute stage and repeats the decoding of the <code id="P700049702700000000000000004271E" data-uri="chapter04.xhtml#P700049702700000000000000004271E" class="pcalibre1 calibre8 pcalibre">addq</code> instruction on cycle 5. It again detects hazards for both source registers, injects a bubble into the execute stage, and repeats the decoding of the <code id="P700049702700000000000000004271F" data-uri="chapter04.xhtml#P700049702700000000000000004271F" class="pcalibre1 calibre8 pcalibre">addq</code> instruction on cycle 6. Still, it detects a hazard for source register <code id="P7000497027000000000000000042720" data-uri="chapter04.xhtml#P7000497027000000000000000042720" class="pcalibre1 calibre8 pcalibre">%rax</code>, injects a bubble into the execute stage, and repeats the decoding of the <code id="P7000497027000000000000000042721" data-uri="chapter04.xhtml#P7000497027000000000000000042721" class="pcalibre1 calibre8 pcalibre">addq</code> instruction on cycle 7. In effect, the machine has dynamically inserted three <code id="P7000497027000000000000000042722" data-uri="chapter04.xhtml#P7000497027000000000000000042722" class="pcalibre1 calibre8 pcalibre">nop</code> instructions, giving a flow similar to that shown for <code id="P7000497027000000000000000042723" data-uri="chapter04.xhtml#P7000497027000000000000000042723" class="pcalibre1 calibre8 pcalibre">prog1</code> (<a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004254"><span class="pcalibre label pcalibre1">Figure </span><span class="number pcalibre pcalibre1">4.43</span></a>).</p><p id="P7000497027000000000000000042724" data-uri="chapter04.xhtml#P7000497027000000000000000042724" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022A00" data-uri="chapter04.xhtml#P7000497027000000000000000022A00">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000042725" data-uri="chapter04.xhtml#P7000497027000000000000000042725" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P7000497027000000000000000042726" data-uri="chapter04.xhtml#P7000497027000000000000000042726">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000042727" data-uri="chapter04.xhtml#P7000497027000000000000000042727" class="calibre18 pcalibre pcalibre1">Prog4</th>
<th id="P7000497027000000000000000042728" data-uri="chapter04.xhtml#P7000497027000000000000000042728" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P7000497027000000000000000042729" data-uri="chapter04.xhtml#P7000497027000000000000000042729" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P700049702700000000000000004272A" data-uri="chapter04.xhtml#P700049702700000000000000004272A" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P700049702700000000000000004272B" data-uri="chapter04.xhtml#P700049702700000000000000004272B" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P700049702700000000000000004272C" data-uri="chapter04.xhtml#P700049702700000000000000004272C" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P700049702700000000000000004272D" data-uri="chapter04.xhtml#P700049702700000000000000004272D" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P700049702700000000000000004272E" data-uri="chapter04.xhtml#P700049702700000000000000004272E" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P700049702700000000000000004272F" data-uri="chapter04.xhtml#P700049702700000000000000004272F" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P7000497027000000000000000042730" data-uri="chapter04.xhtml#P7000497027000000000000000042730" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P7000497027000000000000000042731" data-uri="chapter04.xhtml#P7000497027000000000000000042731" class="calibre18 pcalibre pcalibre1">10</th>
<th id="P7000497027000000000000000042732" data-uri="chapter04.xhtml#P7000497027000000000000000042732" class="calibre18 pcalibre pcalibre1">11</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042733" data-uri="chapter04.xhtml#P7000497027000000000000000042733" class="calibre20 pcalibre pcalibre1">0x000: irmovq $10, %rdx</td>
<td id="P7000497027000000000000000042734" data-uri="chapter04.xhtml#P7000497027000000000000000042734" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042735" data-uri="chapter04.xhtml#P7000497027000000000000000042735" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042736" data-uri="chapter04.xhtml#P7000497027000000000000000042736" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042737" data-uri="chapter04.xhtml#P7000497027000000000000000042737" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042738" data-uri="chapter04.xhtml#P7000497027000000000000000042738" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042739" data-uri="chapter04.xhtml#P7000497027000000000000000042739" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004273A" data-uri="chapter04.xhtml#P700049702700000000000000004273A" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004273B" data-uri="chapter04.xhtml#P700049702700000000000000004273B" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004273C" data-uri="chapter04.xhtml#P700049702700000000000000004273C" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004273D" data-uri="chapter04.xhtml#P700049702700000000000000004273D" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004273E" data-uri="chapter04.xhtml#P700049702700000000000000004273E" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004273F" data-uri="chapter04.xhtml#P700049702700000000000000004273F" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042740" data-uri="chapter04.xhtml#P7000497027000000000000000042740" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042741" data-uri="chapter04.xhtml#P7000497027000000000000000042741" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042742" data-uri="chapter04.xhtml#P7000497027000000000000000042742" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042743" data-uri="chapter04.xhtml#P7000497027000000000000000042743" class="calibre20 pcalibre pcalibre1">Bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042744" data-uri="chapter04.xhtml#P7000497027000000000000000042744" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042745" data-uri="chapter04.xhtml#P7000497027000000000000000042745" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042746" data-uri="chapter04.xhtml#P7000497027000000000000000042746" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042747" data-uri="chapter04.xhtml#P7000497027000000000000000042747" class="calibre20 pcalibre pcalibre1">Bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042748" data-uri="chapter04.xhtml#P7000497027000000000000000042748" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042749" data-uri="chapter04.xhtml#P7000497027000000000000000042749" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004274A" data-uri="chapter04.xhtml#P700049702700000000000000004274A" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004274B" data-uri="chapter04.xhtml#P700049702700000000000000004274B" class="calibre20 pcalibre pcalibre1">0x014: addq %rdx, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004274C" data-uri="chapter04.xhtml#P700049702700000000000000004274C" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004274D" data-uri="chapter04.xhtml#P700049702700000000000000004274D" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004274E" data-uri="chapter04.xhtml#P700049702700000000000000004274E" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004274F" data-uri="chapter04.xhtml#P700049702700000000000000004274F" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042750" data-uri="chapter04.xhtml#P7000497027000000000000000042750" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042751" data-uri="chapter04.xhtml#P7000497027000000000000000042751" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042752" data-uri="chapter04.xhtml#P7000497027000000000000000042752" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042753" data-uri="chapter04.xhtml#P7000497027000000000000000042753" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042754" data-uri="chapter04.xhtml#P7000497027000000000000000042754" class="calibre20 pcalibre pcalibre1">0x016: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042755" data-uri="chapter04.xhtml#P7000497027000000000000000042755" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042756" data-uri="chapter04.xhtml#P7000497027000000000000000042756" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042757" data-uri="chapter04.xhtml#P7000497027000000000000000042757" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042758" data-uri="chapter04.xhtml#P7000497027000000000000000042758" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042759" data-uri="chapter04.xhtml#P7000497027000000000000000042759" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004275A" data-uri="chapter04.xhtml#P700049702700000000000000004275A" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004275B" data-uri="chapter04.xhtml#P700049702700000000000000004275B" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004275C" data-uri="chapter04.xhtml#P700049702700000000000000004275C" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p id="P700049702700000000000000004275D" data-uri="chapter04.xhtml#P700049702700000000000000004275D" class="pcalibre1 pcalibre calibre2">In holding back the <code id="P700049702700000000000000004275E" data-uri="chapter04.xhtml#P700049702700000000000000004275E" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in the decode stage, we must also hold back the halt instruction following it in the fetch stage. We can do this by keeping the program counter at a fixed value, so that the halt instruction will be fetched repeatedly until the stall has completed.</p>
<p id="P700049702700000000000000004275F" data-uri="chapter04.xhtml#P700049702700000000000000004275F" class="pcalibre1 pcalibre calibre2">Stalling involves holding back one group of instructions in their stages while allowing other instructions to continue flowing through the pipeline. What then should we do in the stages that would normally be processing the <code id="P7000497027000000000000000042760" data-uri="chapter04.xhtml#P7000497027000000000000000042760" class="pcalibre1 calibre8 pcalibre">addq</code> instruction? We handle these by injecting a <i class="calibre5 pcalibre pcalibre1">bubble</i> into the execute stage each time we hold an instruction back in the decode stage. A bubble is like a dynamically generated <code id="P7000497027000000000000000042761" data-uri="chapter04.xhtml#P7000497027000000000000000042761" class="pcalibre1 calibre8 pcalibre">nop</code> instruction—it does not cause any changes to the registers, the memory, the</p>

<aside class="sidebar pcalibre5 pcalibre" id="P70004970270000000000000000042E2" data-uri="chapter04.xhtml#P70004970270000000000000000042E2"><header class="pcalibre halftitlepage pcalibre1"><h1 class="pcalibre1 title2 pcalibre" id="P7000497027000000000000000042762" data-uri="chapter04.xhtml#P7000497027000000000000000042762" epub:type="title"><span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000042E4" title="435" data-uri="chapter04.xhtml#P70004970270000000000000000042E4" epub:type="pagebreak"></span><span class="pcalibre label1 pcalibre1">Aside </span>Enumerating classes of data hazards</h1></header>
<p id="P7000497027000000000000000042763" data-uri="chapter04.xhtml#P7000497027000000000000000042763" class="calibre13 pcalibre pcalibre1">Hazards can potentially occur when one instruction updates part of the program state that will be read by a later instruction. For Y86-64, the program state includes the program registers, the program counter, the memory, the condition code register, and the status register. Let us look at the hazard possibilities in our proposed design for each of these forms of state.</p>
<ul class="pcalibre ul_none pcalibre1" id="P7000497027000000000000000042764" data-uri="chapter04.xhtml#P7000497027000000000000000042764">
<li id="P7000497027000000000000000042765" data-uri="chapter04.xhtml#P7000497027000000000000000042765" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042766" data-uri="chapter04.xhtml#P7000497027000000000000000042766" class="calibre13 pcalibre pcalibre1"><span class="pcalibre leadin pcalibre1">Program registers. </span>These are the hazards we have already identified. They arise because the register file is read in one stage and written in another, leading to possible unintended interactions between different instructions.</p></li>
<li id="P7000497027000000000000000042767" data-uri="chapter04.xhtml#P7000497027000000000000000042767" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042768" data-uri="chapter04.xhtml#P7000497027000000000000000042768" class="calibre13 pcalibre pcalibre1"><span class="pcalibre leadin pcalibre1">Program counter. </span>Conflicts between updating and reading the program counter give rise to control hazards. No hazard arises when our fetch-stage logic correctly predicts the new value of the program counter before fetching the next instruction. Mispredicted branches and <code id="P7000497027000000000000000042769" data-uri="chapter04.xhtml#P7000497027000000000000000042769" class="pcalibre1 calibre8 pcalibre">ret</code> instructions require special handling, as will be discussed in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004251"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.5</span></a>.</p></li>
<li id="P700049702700000000000000004276A" data-uri="chapter04.xhtml#P700049702700000000000000004276A" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004276B" data-uri="chapter04.xhtml#P700049702700000000000000004276B" class="calibre13 pcalibre pcalibre1"><span class="pcalibre leadin pcalibre1">Memory. </span>Writes and reads of the data memory both occur in the memory stage. By the time an instruction reading memory reaches this stage, any preceding instructions writing memory will have already done so. On the other hand, there can be interference between instructions writing data in the memory stage and the reading of instructions in the fetch stage, since the instruction and data memories reference a single address space. This can only happen with programs containing <i class="calibre5 pcalibre pcalibre1">self-modifying code</i>, where instructions write to a portion of memory from which instructions are later fetched. Some systems have complex mechanisms to detect and avoid such hazards, while others simply mandate that programs should not use self-modifying code. We will assume for simplicity that programs do not modify themselves, and therefore we do not need to take special measures to update the instruction memory based on updates to the data memory during program execution.</p></li>
<li id="P700049702700000000000000004276C" data-uri="chapter04.xhtml#P700049702700000000000000004276C" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004276D" data-uri="chapter04.xhtml#P700049702700000000000000004276D" class="calibre13 pcalibre pcalibre1"><span class="pcalibre leadin pcalibre1">Condition code register. </span>These are written by integer operations in the execute stage. They are read by conditional moves in the execute stage and by conditional jumps in the memory stage. By the time a conditional move or jump reaches the execute stage, any preceding integer operation will have already completed this stage. No hazards can arise.</p></li>
<li id="P700049702700000000000000004276E" data-uri="chapter04.xhtml#P700049702700000000000000004276E" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004276F" data-uri="chapter04.xhtml#P700049702700000000000000004276F" class="calibre13 pcalibre pcalibre1"><span class="pcalibre leadin pcalibre1">Status register. </span>The program status can be affected by instructions as they flow through the pipeline. Our mechanism of associating a status code with each instruction in the pipeline enables the processor to come to an orderly halt when an exception occurs, as will be discussed in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P700049702700000000000000000438D"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.6</span></a>.</p></li>
</ul>
<p id="P7000497027000000000000000042770" data-uri="chapter04.xhtml#P7000497027000000000000000042770" class="pcalibre calibre3 pcalibre1">This analysis shows that we only need to deal with register data hazards, control hazards, and making sure exceptions are handled properly. A systematic analysis of this form is important when designing a complex system. It can identify the potential difficulties in implementing the system, and it can guide the generation of test programs to be used in checking the correctness of the system.</p>
</aside>
<p class="pcalibre1 pcalibre calibre2" id="P7000497027000000000000000042771" data-uri="chapter04.xhtml#P7000497027000000000000000042771">condition codes, or the program status. These are shown as white boxes in the pipeline diagrams of <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P700049702700000000000000000431E"><span class="pcalibre label pcalibre1">Figures </span><span class="pcalibre label pcalibre1">4.47</span></a> and <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004349"><span class="pcalibre label pcalibre1">4.48</span></a>. In these figures the arrow between the box labeled "D" for the <code id="P7000497027000000000000000042772" data-uri="chapter04.xhtml#P7000497027000000000000000042772" class="pcalibre1 calibre8 pcalibre">addq</code> instruction and the box labeled "E" for one of the pipeline bubbles indicates that a bubble was injected into the execute stage in place of the <code id="P7000497027000000000000000042773" data-uri="chapter04.xhtml#P7000497027000000000000000042773" class="pcalibre1 calibre8 pcalibre">addq</code> instruction that would normally have passed from the decode to <span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000042F6" title="436" data-uri="chapter04.xhtml#P70004970270000000000000000042F6" epub:type="pagebreak"></span>the execute stage. We will look at the detailed mechanisms for making the pipeline stall and for injecting bubbles in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.8</span></a>.</p>
<p id="P7000497027000000000000000042774" data-uri="chapter04.xhtml#P7000497027000000000000000042774" class="pcalibre1 pcalibre calibre2">In using stalling to handle data hazards, we effectively execute programs <code id="P7000497027000000000000000042775" data-uri="chapter04.xhtml#P7000497027000000000000000042775" class="pcalibre1 calibre8 pcalibre">prog2</code> and <code id="P7000497027000000000000000042776" data-uri="chapter04.xhtml#P7000497027000000000000000042776" class="pcalibre1 calibre8 pcalibre">prog4</code> by dynamically generating the pipeline flow seen for <code id="P7000497027000000000000000042777" data-uri="chapter04.xhtml#P7000497027000000000000000042777" class="pcalibre1 calibre8 pcalibre">prog1</code> (<a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004254"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.43</span></a>). Injecting one bubble for <code id="P7000497027000000000000000042778" data-uri="chapter04.xhtml#P7000497027000000000000000042778" class="pcalibre1 calibre8 pcalibre">prog2</code> and three for <code id="P7000497027000000000000000042779" data-uri="chapter04.xhtml#P7000497027000000000000000042779" class="pcalibre1 calibre8 pcalibre">prog4</code> has the same effect as having three <code id="P700049702700000000000000004277A" data-uri="chapter04.xhtml#P700049702700000000000000004277A" class="pcalibre1 calibre8 pcalibre">nop</code> instructions between the second <code id="P700049702700000000000000004277B" data-uri="chapter04.xhtml#P700049702700000000000000004277B" class="pcalibre1 calibre8 pcalibre">irmovq</code> instruction and the <code id="P700049702700000000000000004277C" data-uri="chapter04.xhtml#P700049702700000000000000004277C" class="pcalibre1 calibre8 pcalibre">addq</code> instruction. This mechanism can be implemented fairly easily (see <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000045E1.xhtml#P7000497027000000000000000004634"><span class="pcalibre label pcalibre1">Problem </span><span class="pcalibre label pcalibre1">4.53</span></a>), but the resulting performance is not very good. There are numerous cases in which one instruction updates a register and a closely following instruction uses the same register. This will cause the pipeline to stall for up to three cycles, reducing the overall throughput significantly.</p>
</section>
<section id="P7000497027000000000000000004300" data-uri="chapter04.xhtml#P7000497027000000000000000004300" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title5 pcalibre pcalibre1" id="P700049702700000000000000004277D" data-uri="chapter04.xhtml#P700049702700000000000000004277D" epub:type="title">Avoiding Data Hazards by Forwarding</h1></header>
<p id="P700049702700000000000000004277E" data-uri="chapter04.xhtml#P700049702700000000000000004277E" class="pcalibre1 pcalibre calibre2">Our design for PIPE— reads source operands from the register file in the decode stage, but there can also be a pending write to one of these source registers in the write-back stage. Rather than stalling until the write has completed, it can simply pass the value that is about to be written to pipeline register E as the source operand. <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004304"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.49</span></a> shows this strategy with an expanded view of the pipeline diagram for cycle 6 of <code id="P700049702700000000000000004277F" data-uri="chapter04.xhtml#P700049702700000000000000004277F" class="pcalibre1 calibre8 pcalibre">prog2</code>. The decode-stage logic detects that register</p>
<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004304" data-uri="chapter04.xhtml#P7000497027000000000000000004304">
<img alt="A diagram illustrates a pipelined execution of prog2 using forwarding." id="P7000497027000000000000000042780" data-uri="P700049702700000000000000000B6F6" src="../images/p436-1.png" class="pcalibre1 calibre147 pcalibre"/>
<figcaption id="P7000497027000000000000000042781" data-uri="chapter04.xhtml#P7000497027000000000000000042781" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P7000497027000000000000000042782" data-uri="chapter04.xhtml#P7000497027000000000000000042782" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.49 </span>Pipelined execution of <code id="P7000497027000000000000000042783" data-uri="chapter04.xhtml#P7000497027000000000000000042783" class="pcalibre1 calibre8 pcalibre">prog2</code> <b class="calibre4 pcalibre pcalibre1">using forwarding.</b></h1></header>
<div class="edition pcalibre pcalibre1" id="P7000497027000000000000000042784" data-uri="chapter04.xhtml#P7000497027000000000000000042784"><p id="P7000497027000000000000000042785" data-uri="chapter04.xhtml#P7000497027000000000000000042785" class="pcalibre1 pcalibre calibre2">In cycle 6, the decode-stage logic detects the presence of a pending write to register <code id="P7000497027000000000000000042786" data-uri="chapter04.xhtml#P7000497027000000000000000042786" class="pcalibre1 calibre8 pcalibre">%rax</code> in the write-back stage. It uses this value for source operand valB rather than the value read from the register file.</p><p id="P7000497027000000000000000042787" data-uri="chapter04.xhtml#P7000497027000000000000000042787" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022A63" data-uri="chapter04.xhtml#P7000497027000000000000000022A63">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000042788" data-uri="chapter04.xhtml#P7000497027000000000000000042788" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P7000497027000000000000000042789" data-uri="chapter04.xhtml#P7000497027000000000000000042789">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P700049702700000000000000004278A" data-uri="chapter04.xhtml#P700049702700000000000000004278A" class="calibre18 pcalibre pcalibre1">Prog2</th>
<th id="P700049702700000000000000004278B" data-uri="chapter04.xhtml#P700049702700000000000000004278B" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P700049702700000000000000004278C" data-uri="chapter04.xhtml#P700049702700000000000000004278C" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P700049702700000000000000004278D" data-uri="chapter04.xhtml#P700049702700000000000000004278D" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P700049702700000000000000004278E" data-uri="chapter04.xhtml#P700049702700000000000000004278E" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P700049702700000000000000004278F" data-uri="chapter04.xhtml#P700049702700000000000000004278F" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P7000497027000000000000000042790" data-uri="chapter04.xhtml#P7000497027000000000000000042790" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P7000497027000000000000000042791" data-uri="chapter04.xhtml#P7000497027000000000000000042791" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P7000497027000000000000000042792" data-uri="chapter04.xhtml#P7000497027000000000000000042792" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P7000497027000000000000000042793" data-uri="chapter04.xhtml#P7000497027000000000000000042793" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P7000497027000000000000000042794" data-uri="chapter04.xhtml#P7000497027000000000000000042794" class="calibre18 pcalibre pcalibre1">10</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042795" data-uri="chapter04.xhtml#P7000497027000000000000000042795" class="calibre20 pcalibre pcalibre1">0x000: irmovq $10, %rdx</td>
<td id="P7000497027000000000000000042796" data-uri="chapter04.xhtml#P7000497027000000000000000042796" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042797" data-uri="chapter04.xhtml#P7000497027000000000000000042797" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042798" data-uri="chapter04.xhtml#P7000497027000000000000000042798" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042799" data-uri="chapter04.xhtml#P7000497027000000000000000042799" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004279A" data-uri="chapter04.xhtml#P700049702700000000000000004279A" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004279B" data-uri="chapter04.xhtml#P700049702700000000000000004279B" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004279C" data-uri="chapter04.xhtml#P700049702700000000000000004279C" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004279D" data-uri="chapter04.xhtml#P700049702700000000000000004279D" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004279E" data-uri="chapter04.xhtml#P700049702700000000000000004279E" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004279F" data-uri="chapter04.xhtml#P700049702700000000000000004279F" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427A0" data-uri="chapter04.xhtml#P70004970270000000000000000427A0" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427A1" data-uri="chapter04.xhtml#P70004970270000000000000000427A1" class="calibre20 pcalibre pcalibre1">0x014: nop</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427A2" data-uri="chapter04.xhtml#P70004970270000000000000000427A2" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427A3" data-uri="chapter04.xhtml#P70004970270000000000000000427A3" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427A4" data-uri="chapter04.xhtml#P70004970270000000000000000427A4" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427A5" data-uri="chapter04.xhtml#P70004970270000000000000000427A5" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427A6" data-uri="chapter04.xhtml#P70004970270000000000000000427A6" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427A7" data-uri="chapter04.xhtml#P70004970270000000000000000427A7" class="calibre20 pcalibre pcalibre1">0x015: nop</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427A8" data-uri="chapter04.xhtml#P70004970270000000000000000427A8" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427A9" data-uri="chapter04.xhtml#P70004970270000000000000000427A9" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427AA" data-uri="chapter04.xhtml#P70004970270000000000000000427AA" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427AB" data-uri="chapter04.xhtml#P70004970270000000000000000427AB" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427AC" data-uri="chapter04.xhtml#P70004970270000000000000000427AC" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427AD" data-uri="chapter04.xhtml#P70004970270000000000000000427AD" class="calibre20 pcalibre pcalibre1">0x016: addq %rdx, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427AE" data-uri="chapter04.xhtml#P70004970270000000000000000427AE" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427AF" data-uri="chapter04.xhtml#P70004970270000000000000000427AF" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427B0" data-uri="chapter04.xhtml#P70004970270000000000000000427B0" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427B1" data-uri="chapter04.xhtml#P70004970270000000000000000427B1" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427B2" data-uri="chapter04.xhtml#P70004970270000000000000000427B2" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427B3" data-uri="chapter04.xhtml#P70004970270000000000000000427B3" class="calibre20 pcalibre pcalibre1">0x018: halt </td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427B4" data-uri="chapter04.xhtml#P70004970270000000000000000427B4" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427B5" data-uri="chapter04.xhtml#P70004970270000000000000000427B5" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427B6" data-uri="chapter04.xhtml#P70004970270000000000000000427B6" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427B7" data-uri="chapter04.xhtml#P70004970270000000000000000427B7" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427B8" data-uri="chapter04.xhtml#P70004970270000000000000000427B8" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
<p id="P70004970270000000000000000427B9" data-uri="chapter04.xhtml#P70004970270000000000000000427B9" class="pcalibre calibre3 pcalibre1">Cycle 6 is illustrated with W W_dstE = %rax, W_valE = 3, R[%rax] ← 3 and D srcA = %rdx, srcB = %rax, valA ← R[%rdx] = 10, valB ← W_valE = 3.</p>
</details>
</figcaption>
</figure>

<figure class="pcalibre5 figure pcalibre" id="P700049702700000000000000000430C" data-uri="chapter04.xhtml#P700049702700000000000000000430C">
<span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000430D" title="437" data-uri="chapter04.xhtml#P700049702700000000000000000430D" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipelined execution of prog3 using forwarding." id="P70004970270000000000000000427BA" data-uri="P700049702700000000000000000B6F7" src="../images/p437-1.png" class="calibre148 pcalibre pcalibre1"/>
<figcaption id="P70004970270000000000000000427BB" data-uri="chapter04.xhtml#P70004970270000000000000000427BB" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P70004970270000000000000000427BC" data-uri="chapter04.xhtml#P70004970270000000000000000427BC" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.50 </span>Pipelined execution of <code id="P70004970270000000000000000427BD" data-uri="chapter04.xhtml#P70004970270000000000000000427BD" class="pcalibre1 calibre8 pcalibre">prog3</code> <b class="calibre4 pcalibre pcalibre1">using forwarding.</b></h1></header>
<div class="edition pcalibre pcalibre1" id="P70004970270000000000000000427BE" data-uri="chapter04.xhtml#P70004970270000000000000000427BE"><p id="P70004970270000000000000000427BF" data-uri="chapter04.xhtml#P70004970270000000000000000427BF" class="pcalibre1 pcalibre calibre2">In cycle 5, the decode-stage logic detects a pending write to register <code id="P70004970270000000000000000427C0" data-uri="chapter04.xhtml#P70004970270000000000000000427C0" class="pcalibre1 calibre8 pcalibre">%rdx</code> in the write-back stage and to register <code id="P70004970270000000000000000427C1" data-uri="chapter04.xhtml#P70004970270000000000000000427C1" class="pcalibre1 calibre8 pcalibre">%rax</code> in the memory stage. It uses these as the values for valA and valB rather than the values read from the register file.</p><p id="P70004970270000000000000000427C2" data-uri="chapter04.xhtml#P70004970270000000000000000427C2" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022A9E" data-uri="chapter04.xhtml#P7000497027000000000000000022A9E">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000427C3" data-uri="chapter04.xhtml#P70004970270000000000000000427C3" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P70004970270000000000000000427C4" data-uri="chapter04.xhtml#P70004970270000000000000000427C4">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000427C5" data-uri="chapter04.xhtml#P70004970270000000000000000427C5" class="calibre18 pcalibre pcalibre1">Prog3</th>
<th id="P70004970270000000000000000427C6" data-uri="chapter04.xhtml#P70004970270000000000000000427C6" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P70004970270000000000000000427C7" data-uri="chapter04.xhtml#P70004970270000000000000000427C7" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P70004970270000000000000000427C8" data-uri="chapter04.xhtml#P70004970270000000000000000427C8" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P70004970270000000000000000427C9" data-uri="chapter04.xhtml#P70004970270000000000000000427C9" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P70004970270000000000000000427CA" data-uri="chapter04.xhtml#P70004970270000000000000000427CA" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P70004970270000000000000000427CB" data-uri="chapter04.xhtml#P70004970270000000000000000427CB" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P70004970270000000000000000427CC" data-uri="chapter04.xhtml#P70004970270000000000000000427CC" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P70004970270000000000000000427CD" data-uri="chapter04.xhtml#P70004970270000000000000000427CD" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P70004970270000000000000000427CE" data-uri="chapter04.xhtml#P70004970270000000000000000427CE" class="calibre18 pcalibre pcalibre1">9</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427CF" data-uri="chapter04.xhtml#P70004970270000000000000000427CF" class="calibre20 pcalibre pcalibre1">0x000: irmovq $10, %rdx</td>
<td id="P70004970270000000000000000427D0" data-uri="chapter04.xhtml#P70004970270000000000000000427D0" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427D1" data-uri="chapter04.xhtml#P70004970270000000000000000427D1" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427D2" data-uri="chapter04.xhtml#P70004970270000000000000000427D2" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427D3" data-uri="chapter04.xhtml#P70004970270000000000000000427D3" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427D4" data-uri="chapter04.xhtml#P70004970270000000000000000427D4" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427D5" data-uri="chapter04.xhtml#P70004970270000000000000000427D5" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427D6" data-uri="chapter04.xhtml#P70004970270000000000000000427D6" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427D7" data-uri="chapter04.xhtml#P70004970270000000000000000427D7" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427D8" data-uri="chapter04.xhtml#P70004970270000000000000000427D8" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427D9" data-uri="chapter04.xhtml#P70004970270000000000000000427D9" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427DA" data-uri="chapter04.xhtml#P70004970270000000000000000427DA" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427DB" data-uri="chapter04.xhtml#P70004970270000000000000000427DB" class="calibre20 pcalibre pcalibre1">0x014: nop</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427DC" data-uri="chapter04.xhtml#P70004970270000000000000000427DC" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427DD" data-uri="chapter04.xhtml#P70004970270000000000000000427DD" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427DE" data-uri="chapter04.xhtml#P70004970270000000000000000427DE" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427DF" data-uri="chapter04.xhtml#P70004970270000000000000000427DF" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427E0" data-uri="chapter04.xhtml#P70004970270000000000000000427E0" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427E1" data-uri="chapter04.xhtml#P70004970270000000000000000427E1" class="calibre20 pcalibre pcalibre1">0x015: addq %rdx, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427E2" data-uri="chapter04.xhtml#P70004970270000000000000000427E2" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427E3" data-uri="chapter04.xhtml#P70004970270000000000000000427E3" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427E4" data-uri="chapter04.xhtml#P70004970270000000000000000427E4" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427E5" data-uri="chapter04.xhtml#P70004970270000000000000000427E5" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427E6" data-uri="chapter04.xhtml#P70004970270000000000000000427E6" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000427E7" data-uri="chapter04.xhtml#P70004970270000000000000000427E7" class="calibre20 pcalibre pcalibre1">0x017: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000427E8" data-uri="chapter04.xhtml#P70004970270000000000000000427E8" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000427E9" data-uri="chapter04.xhtml#P70004970270000000000000000427E9" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000427EA" data-uri="chapter04.xhtml#P70004970270000000000000000427EA" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000427EB" data-uri="chapter04.xhtml#P70004970270000000000000000427EB" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000427EC" data-uri="chapter04.xhtml#P70004970270000000000000000427EC" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
<p id="P70004970270000000000000000427ED" data-uri="chapter04.xhtml#P70004970270000000000000000427ED" class="pcalibre calibre3 pcalibre1">Cycle 5 is illustrated with W W_dstE = %rdx, W_valE = 10, R[%rdx] ← 10, M M_dstE = %rax, M_valE = 3, and D srcA = %rdx, srcB = %rax, valA ← W_valE = 10, valB ← W_valE = 3.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre1 pcalibre calibre2" id="P70004970270000000000000000427EE" data-uri="chapter04.xhtml#P70004970270000000000000000427EE"><code id="P70004970270000000000000000427EF" data-uri="chapter04.xhtml#P70004970270000000000000000427EF" class="pcalibre1 calibre8 pcalibre">%rax</code> is the source register for operand valB, and that there is also a pending write to <code id="P70004970270000000000000000427F0" data-uri="chapter04.xhtml#P70004970270000000000000000427F0" class="pcalibre1 calibre8 pcalibre">%rax</code> on write port E. It can therefore avoid stalling by simply using the data word supplied to port E (signal W_valE) as the value for operand valB. This technique of passing a result value directly from one pipeline stage to an earlier one is commonly known as <i class="calibre5 pcalibre pcalibre1">data forwarding</i> (or simply <i class="calibre5 pcalibre pcalibre1">forwarding</i>, and sometimes <i class="calibre5 pcalibre pcalibre1">bypassing</i>). It allows the instructions of <code id="P70004970270000000000000000427F1" data-uri="chapter04.xhtml#P70004970270000000000000000427F1" class="pcalibre1 calibre8 pcalibre">prog2</code> to proceed through the pipeline without any stalling. Data forwarding requires adding additional data connections and control logic to the basic hardware structure.</p>
<p id="P70004970270000000000000000427F2" data-uri="chapter04.xhtml#P70004970270000000000000000427F2" class="pcalibre1 pcalibre calibre2">As <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P700049702700000000000000000430C"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.50</span></a> illustrates, data forwarding can also be used when there is a pending write to a register in the memory stage, avoiding the need to stall for program <code id="P70004970270000000000000000427F3" data-uri="chapter04.xhtml#P70004970270000000000000000427F3" class="pcalibre1 calibre8 pcalibre">prog3</code>. In cycle 5, the decode-stage logic detects a pending write to register <code id="P70004970270000000000000000427F4" data-uri="chapter04.xhtml#P70004970270000000000000000427F4" class="pcalibre1 calibre8 pcalibre">%rdx</code> on port E in the write-back stage, as well as a pending write to register <code id="P70004970270000000000000000427F5" data-uri="chapter04.xhtml#P70004970270000000000000000427F5" class="pcalibre1 calibre8 pcalibre">%rax</code> that is on its way to port E but is still in the memory stage. Rather than stalling until the writes have occurred, it can use the value in the write-back stage (signal W_valE) for operand valA and the value in the memory stage (signal M_valE) for operand valB.</p>

<figure class="pcalibre5 figure pcalibre" id="P700049702700000000000000000431E" data-uri="chapter04.xhtml#P700049702700000000000000000431E">
<span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000431F" title="438" data-uri="chapter04.xhtml#P700049702700000000000000000431F" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipelined execution of prog4 using forwarding." id="P70004970270000000000000000427F6" data-uri="P700049702700000000000000000B6F8" src="../images/p438-1.png" class="calibre149 pcalibre pcalibre1"/>
<figcaption id="P70004970270000000000000000427F7" data-uri="chapter04.xhtml#P70004970270000000000000000427F7" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P70004970270000000000000000427F8" data-uri="chapter04.xhtml#P70004970270000000000000000427F8" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.51 </span>Pipelined execution of <code id="P70004970270000000000000000427F9" data-uri="chapter04.xhtml#P70004970270000000000000000427F9" class="pcalibre1 calibre8 pcalibre">prog4</code> <b class="calibre4 pcalibre pcalibre1">using forwarding.</b></h1></header>
<div class="edition pcalibre pcalibre1" id="P70004970270000000000000000427FA" data-uri="chapter04.xhtml#P70004970270000000000000000427FA"><p id="P70004970270000000000000000427FB" data-uri="chapter04.xhtml#P70004970270000000000000000427FB" class="pcalibre1 pcalibre calibre2">In cycle 4, the decode-stage logic detects a pending write to register <code id="P70004970270000000000000000427FC" data-uri="chapter04.xhtml#P70004970270000000000000000427FC" class="pcalibre1 calibre8 pcalibre">%rdx</code> in the memory stage. It also detects that a new value is being computed for register <code id="P70004970270000000000000000427FD" data-uri="chapter04.xhtml#P70004970270000000000000000427FD" class="pcalibre1 calibre8 pcalibre">%rax</code> in the execute stage. It uses these as the values for valA and valB rather than the values read from the register file.</p><p id="P70004970270000000000000000427FE" data-uri="chapter04.xhtml#P70004970270000000000000000427FE" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022ADA" data-uri="chapter04.xhtml#P7000497027000000000000000022ADA">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000427FF" data-uri="chapter04.xhtml#P70004970270000000000000000427FF" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P7000497027000000000000000042800" data-uri="chapter04.xhtml#P7000497027000000000000000042800">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000042801" data-uri="chapter04.xhtml#P7000497027000000000000000042801" class="calibre18 pcalibre pcalibre1">Prog4</th>
<th id="P7000497027000000000000000042802" data-uri="chapter04.xhtml#P7000497027000000000000000042802" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P7000497027000000000000000042803" data-uri="chapter04.xhtml#P7000497027000000000000000042803" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P7000497027000000000000000042804" data-uri="chapter04.xhtml#P7000497027000000000000000042804" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P7000497027000000000000000042805" data-uri="chapter04.xhtml#P7000497027000000000000000042805" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P7000497027000000000000000042806" data-uri="chapter04.xhtml#P7000497027000000000000000042806" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P7000497027000000000000000042807" data-uri="chapter04.xhtml#P7000497027000000000000000042807" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P7000497027000000000000000042808" data-uri="chapter04.xhtml#P7000497027000000000000000042808" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P7000497027000000000000000042809" data-uri="chapter04.xhtml#P7000497027000000000000000042809" class="calibre18 pcalibre pcalibre1">8</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004280A" data-uri="chapter04.xhtml#P700049702700000000000000004280A" class="calibre20 pcalibre pcalibre1">0x000: irmovq $10, %rdx</td>
<td id="P700049702700000000000000004280B" data-uri="chapter04.xhtml#P700049702700000000000000004280B" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004280C" data-uri="chapter04.xhtml#P700049702700000000000000004280C" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004280D" data-uri="chapter04.xhtml#P700049702700000000000000004280D" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004280E" data-uri="chapter04.xhtml#P700049702700000000000000004280E" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004280F" data-uri="chapter04.xhtml#P700049702700000000000000004280F" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042810" data-uri="chapter04.xhtml#P7000497027000000000000000042810" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042811" data-uri="chapter04.xhtml#P7000497027000000000000000042811" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042812" data-uri="chapter04.xhtml#P7000497027000000000000000042812" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042813" data-uri="chapter04.xhtml#P7000497027000000000000000042813" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042814" data-uri="chapter04.xhtml#P7000497027000000000000000042814" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042815" data-uri="chapter04.xhtml#P7000497027000000000000000042815" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042816" data-uri="chapter04.xhtml#P7000497027000000000000000042816" class="calibre20 pcalibre pcalibre1">0x014: addq %rdx, %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042817" data-uri="chapter04.xhtml#P7000497027000000000000000042817" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042818" data-uri="chapter04.xhtml#P7000497027000000000000000042818" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042819" data-uri="chapter04.xhtml#P7000497027000000000000000042819" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004281A" data-uri="chapter04.xhtml#P700049702700000000000000004281A" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004281B" data-uri="chapter04.xhtml#P700049702700000000000000004281B" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004281C" data-uri="chapter04.xhtml#P700049702700000000000000004281C" class="calibre20 pcalibre pcalibre1">0x016: halt </td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004281D" data-uri="chapter04.xhtml#P700049702700000000000000004281D" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004281E" data-uri="chapter04.xhtml#P700049702700000000000000004281E" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004281F" data-uri="chapter04.xhtml#P700049702700000000000000004281F" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042820" data-uri="chapter04.xhtml#P7000497027000000000000000042820" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042821" data-uri="chapter04.xhtml#P7000497027000000000000000042821" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
<p id="P7000497027000000000000000042822" data-uri="chapter04.xhtml#P7000497027000000000000000042822" class="pcalibre calibre3 pcalibre1">Cycle 4 is illustrated with M M_dstE = %rdx, M_valE = 10, E E_dstE = %rax, e_valE ← 0 + 3 = 3, and D srcA = %rdx, srcB = %rax, valA ← M_valE = 10, valB ← e_valE = 3.</p>
</details>
</figcaption>
</figure>
<p id="P7000497027000000000000000042823" data-uri="chapter04.xhtml#P7000497027000000000000000042823" class="pcalibre1 pcalibre calibre2">To exploit data forwarding to its full extent, we can also pass newly computed values from the execute stage to the decode stage, avoiding the need to stall for program <code id="P7000497027000000000000000042824" data-uri="chapter04.xhtml#P7000497027000000000000000042824" class="pcalibre1 calibre8 pcalibre">prog4</code>, as illustrated in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P700049702700000000000000000431E"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.51</span></a>. In cycle 4, the decode-stage logic detects a pending write to register <code id="P7000497027000000000000000042825" data-uri="chapter04.xhtml#P7000497027000000000000000042825" class="pcalibre1 calibre8 pcalibre">%rdx</code> in the memory stage, and also that the value being computed by the ALU in the execute stage will later be written to register <code id="P7000497027000000000000000042826" data-uri="chapter04.xhtml#P7000497027000000000000000042826" class="pcalibre1 calibre8 pcalibre">%rax</code>. It can use the value in the memory stage (signal M_valE) for operand valA. It can also use the ALU output (signal e_valE) for operand valB. Note that using the ALU output does not introduce any timing problems. The decode stage only needs to generate signals valA and valB by the end of the clock cycle so that pipeline register E can be loaded with the results from the decode stage as the clock rises to start the next cycle. The ALU output will be valid before this point.</p>
<p id="P7000497027000000000000000042827" data-uri="chapter04.xhtml#P7000497027000000000000000042827" class="pcalibre1 pcalibre calibre2">The uses of forwarding illustrated in programs <code id="P7000497027000000000000000042828" data-uri="chapter04.xhtml#P7000497027000000000000000042828" class="pcalibre1 calibre8 pcalibre">prog2</code> to <code id="P7000497027000000000000000042829" data-uri="chapter04.xhtml#P7000497027000000000000000042829" class="pcalibre1 calibre8 pcalibre">prog4</code> all involve the forwarding of values generated by the ALU and destined for write port E. Forwarding can also be used with values read from the memory and destined for write port M. From the memory stage, we can forward the value that has just been read from the data memory (signal m_valM). From the write-back stage, we can forward the pending write to port M (signal W_valM). This gives a total of five different forwarding sources (e_valE, m_valM, M_valE, W_valM, and W_valE) and two different forwarding destinations (valA and valB).</p>

<p id="P700049702700000000000000004282A" data-uri="chapter04.xhtml#P700049702700000000000000004282A" class="pcalibre1 pcalibre calibre2"><span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004330" title="439" data-uri="chapter04.xhtml#P7000497027000000000000000004330" epub:type="pagebreak"></span>The expanded diagrams of <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004350"><span class="pcalibre label pcalibre1">Figures </span><span class="pcalibre label pcalibre1">4.49</span></a> to <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004370"><span class="pcalibre label pcalibre1">4.51</span></a> also show how the decode-stage logic can determine whether to use a value from the register file or to use a forwarded value. Associated with every value that will be written back to the register file is the destination register ID. The logic can compare these IDs with the source register IDs srcA and srcB to detect a case for forwarding. It is possible to have multiple destination register IDs match one of the source IDs. We must establish a priority among the different forwarding sources to handle such cases. This will be discussed when we look at the detailed design of the forwarding logic.</p>
<p id="P700049702700000000000000004282B" data-uri="chapter04.xhtml#P700049702700000000000000004282B" class="pcalibre1 pcalibre calibre2"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004349"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.52</span></a> shows the structure of PIPE, an extension of PIPE— that can handle data hazards by forwarding. Comparing this to the structure of PIPE—(<a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.41</span></a>), we can see that the values from the five forwarding sources are fed back to the two blocks labeled "Sel+Fwd A" and "Fwd B" in the decode stage. The block labeled "Sel+Fwd A" combines the role of the block labeled "Select A" in PIPE— with the forwarding logic. It allows valA for pipeline register E to be either the incremented program counter valP, the value read from the A port of the register file, or one of the forwarded values. The block labeled "Fwd B" implements the forwarding logic for source operand valB.</p>
</section>
<section id="P7000497027000000000000000004332" data-uri="chapter04.xhtml#P7000497027000000000000000004332" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title5 pcalibre pcalibre1" id="P700049702700000000000000004282C" data-uri="chapter04.xhtml#P700049702700000000000000004282C" epub:type="title">Load/Use Data Hazards</h1></header>
<p id="P700049702700000000000000004282D" data-uri="chapter04.xhtml#P700049702700000000000000004282D" class="pcalibre1 pcalibre calibre2">One class of data hazards cannot be handled purely by forwarding, because memory reads occur late in the pipeline. <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004350"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.53</span></a> illustrates an example of a <i class="calibre5 pcalibre pcalibre1">load/use hazard</i>, where one instruction (the <code id="P700049702700000000000000004282E" data-uri="chapter04.xhtml#P700049702700000000000000004282E" class="pcalibre1 calibre8 pcalibre">mrmovq</code> at address <code id="P700049702700000000000000004282F" data-uri="chapter04.xhtml#P700049702700000000000000004282F" class="pcalibre1 calibre8 pcalibre">0x028</code>) reads a value from memory for register <code id="P7000497027000000000000000042830" data-uri="chapter04.xhtml#P7000497027000000000000000042830" class="pcalibre1 calibre8 pcalibre">%rax</code> while the next instruction (the <code id="P7000497027000000000000000042831" data-uri="chapter04.xhtml#P7000497027000000000000000042831" class="pcalibre1 calibre8 pcalibre">addq</code> at address <code id="P7000497027000000000000000042832" data-uri="chapter04.xhtml#P7000497027000000000000000042832" class="pcalibre1 calibre8 pcalibre">0x032</code>) needs this value as a source operand. Expanded views of cycles 7 and 8 are shown in the lower part of the figure, where we assume all program registers initially have value 0. The <code id="P7000497027000000000000000042833" data-uri="chapter04.xhtml#P7000497027000000000000000042833" class="pcalibre1 calibre8 pcalibre">addq</code> instruction requires the value of the register in cycle 7, but it is not generated by the <code id="P7000497027000000000000000042834" data-uri="chapter04.xhtml#P7000497027000000000000000042834" class="pcalibre1 calibre8 pcalibre">mrmovq</code> instruction until cycle 8. In order to "forward" from the <code id="P7000497027000000000000000042835" data-uri="chapter04.xhtml#P7000497027000000000000000042835" class="pcalibre1 calibre8 pcalibre">mrmovq</code> to the <code id="P7000497027000000000000000042836" data-uri="chapter04.xhtml#P7000497027000000000000000042836" class="pcalibre1 calibre8 pcalibre">addq</code>, the forwarding logic would have to make the value go backward in time! Since this is clearly impossible, we must find some other mechanism for handling this form of data hazard. (The data hazard for register <code id="P7000497027000000000000000042837" data-uri="chapter04.xhtml#P7000497027000000000000000042837" class="pcalibre1 calibre8 pcalibre">%rbx</code>, with the value being generated by the <code id="P7000497027000000000000000042838" data-uri="chapter04.xhtml#P7000497027000000000000000042838" class="pcalibre1 calibre8 pcalibre">irmovq</code> instruction at address <code id="P7000497027000000000000000042839" data-uri="chapter04.xhtml#P7000497027000000000000000042839" class="pcalibre1 calibre8 pcalibre">0x01e</code> and used by the <code id="P700049702700000000000000004283A" data-uri="chapter04.xhtml#P700049702700000000000000004283A" class="pcalibre1 calibre8 pcalibre">addq</code> instruction at address <code id="P700049702700000000000000004283B" data-uri="chapter04.xhtml#P700049702700000000000000004283B" class="pcalibre1 calibre8 pcalibre">0x032</code>, can be handled by forwarding.)</p>
<p id="P700049702700000000000000004283C" data-uri="chapter04.xhtml#P700049702700000000000000004283C" class="pcalibre1 pcalibre calibre2">As <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004362"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.54</span></a> demonstrates, we can avoid a load/use data hazard with a combination of stalling and forwarding. This requires modifications of the control logic, but it can use existing bypass paths. As the <code id="P700049702700000000000000004283D" data-uri="chapter04.xhtml#P700049702700000000000000004283D" class="pcalibre1 calibre8 pcalibre">mrmovq</code> instruction passes through the execute stage, the pipeline control logic detects that the instruction in the decode stage (the <code id="P700049702700000000000000004283E" data-uri="chapter04.xhtml#P700049702700000000000000004283E" class="pcalibre1 calibre8 pcalibre">addq</code>) requires the result read from memory. It stalls the instruction in the decode stage for one cycle, causing a bubble to be injected into the execute stage. As the expanded view of cycle 8 shows, the value read from memory can then be forwarded from the memory stage to the <code id="P700049702700000000000000004283F" data-uri="chapter04.xhtml#P700049702700000000000000004283F" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in the decode stage. The value for register <code id="P7000497027000000000000000042840" data-uri="chapter04.xhtml#P7000497027000000000000000042840" class="pcalibre1 calibre8 pcalibre">%rbx</code> is also forwarded from the write-back to the memory stage. As indicated in the pipeline diagram by the arrow from the box labeled "D" in cycle 7 to the box labeled "E" in cycle 8, the injected bubble replaces the <code id="P7000497027000000000000000042841" data-uri="chapter04.xhtml#P7000497027000000000000000042841" class="pcalibre1 calibre8 pcalibre">addq</code> instruction that would normally continue flowing through the pipeline.</p>
<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004349" data-uri="chapter04.xhtml#P7000497027000000000000000004349">
<span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000434A" title="440" data-uri="chapter04.xhtml#P700049702700000000000000000434A" epub:type="pagebreak"></span><img alt="A diagram illustrates a hardware structure divided into a final five-stage pipeline." id="P7000497027000000000000000042842" data-uri="P700049702700000000000000000B6F9" src="../images/p440-1.png" class="pcalibre1 calibre150 pcalibre"/>
<figcaption id="P7000497027000000000000000042843" data-uri="chapter04.xhtml#P7000497027000000000000000042843" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P7000497027000000000000000042844" data-uri="chapter04.xhtml#P7000497027000000000000000042844" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="number pcalibre pcalibre1">4.52 </span>Hardware structure of PIPE, our final pipelined implementation.</h1></header>
<div class="edition pcalibre pcalibre1" id="P7000497027000000000000000042845" data-uri="chapter04.xhtml#P7000497027000000000000000042845"><p id="P7000497027000000000000000042846" data-uri="chapter04.xhtml#P7000497027000000000000000042846" class="pcalibre1 pcalibre calibre2"> The additional bypassing paths enable forwarding the results from the three preceding instructions. This allows us to handle most forms of data hazards without stalling the pipeline.</p><p id="P7000497027000000000000000042847" data-uri="chapter04.xhtml#P7000497027000000000000000042847" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022B23" data-uri="chapter04.xhtml#P7000497027000000000000000022B23">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000042848" data-uri="chapter04.xhtml#P7000497027000000000000000042848" class="pcalibre1 pcalibre calibre2">The five pipelines in the structure are summarized below, from bottom to top.</p>
<ul id="P7000497027000000000000000042849" data-uri="chapter04.xhtml#P7000497027000000000000000042849" class="pcalibre calibre31 pcalibre1">
<li id="P700049702700000000000000004284A" data-uri="chapter04.xhtml#P700049702700000000000000004284A" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004284B" data-uri="chapter04.xhtml#P700049702700000000000000004284B" class="pcalibre calibre3 pcalibre1">F, below Fetch contains predPC with input form Predict PC and output to Select PC, which has:</p>
<ul id="P700049702700000000000000004284C" data-uri="chapter04.xhtml#P700049702700000000000000004284C" class="pcalibre calibre39 pcalibre1">
<li id="P700049702700000000000000004284D" data-uri="chapter04.xhtml#P700049702700000000000000004284D" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004284E" data-uri="chapter04.xhtml#P700049702700000000000000004284E" class="pcalibre calibre3 pcalibre1">Inputs M_valA from pipeline M, W_valM from pipeline W, and M_Cnd from pipeline M</p></li>
<li id="P700049702700000000000000004284F" data-uri="chapter04.xhtml#P700049702700000000000000004284F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042850" data-uri="chapter04.xhtml#P7000497027000000000000000042850" class="pcalibre calibre3 pcalibre1">Output f_pc to instruction memory and PC increment, each with output to Predict PC</p></li>
</ul></li>
<li id="P7000497027000000000000000042851" data-uri="chapter04.xhtml#P7000497027000000000000000042851" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042852" data-uri="chapter04.xhtml#P7000497027000000000000000042852" class="pcalibre calibre3 pcalibre1">D, between Fetch and Decode: includes the following, from left to right:</p>
<ul id="P7000497027000000000000000042853" data-uri="chapter04.xhtml#P7000497027000000000000000042853" class="pcalibre calibre39 pcalibre1">
<li id="P7000497027000000000000000042854" data-uri="chapter04.xhtml#P7000497027000000000000000042854" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042855" data-uri="chapter04.xhtml#P7000497027000000000000000042855" class="pcalibre calibre3 pcalibre1">Stat: input  from Stat, with input imem_error and instr_valid from Instruction memory; output to stat in pipeline E</p></li>
<li id="P7000497027000000000000000042856" data-uri="chapter04.xhtml#P7000497027000000000000000042856" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042857" data-uri="chapter04.xhtml#P7000497027000000000000000042857" class="pcalibre calibre3 pcalibre1">Icode: input from instruction memory; output to icode in pipeline E</p></li>
<li id="P7000497027000000000000000042858" data-uri="chapter04.xhtml#P7000497027000000000000000042858" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042859" data-uri="chapter04.xhtml#P7000497027000000000000000042859" class="pcalibre calibre3 pcalibre1">Ifun: input from instruction memory; output ifun in pipeline E</p></li>
<li id="P700049702700000000000000004285A" data-uri="chapter04.xhtml#P700049702700000000000000004285A" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004285B" data-uri="chapter04.xhtml#P700049702700000000000000004285B" class="pcalibre calibre3 pcalibre1">rA from instruction memory</p></li>
<li id="P700049702700000000000000004285C" data-uri="chapter04.xhtml#P700049702700000000000000004285C" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004285D" data-uri="chapter04.xhtml#P700049702700000000000000004285D" class="pcalibre calibre3 pcalibre1">rB from instruction memory</p></li>
<li id="P700049702700000000000000004285E" data-uri="chapter04.xhtml#P700049702700000000000000004285E" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004285F" data-uri="chapter04.xhtml#P700049702700000000000000004285F" class="pcalibre calibre3 pcalibre1">valC: input from instruction memory; output valC in pipeline E</p></li>
<li id="P7000497027000000000000000042860" data-uri="chapter04.xhtml#P7000497027000000000000000042860" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042861" data-uri="chapter04.xhtml#P7000497027000000000000000042861" class="pcalibre calibre3 pcalibre1">valP: input from PC increment; output Select A to valA in pipeline E</p></li>
</ul></li>
<li id="P7000497027000000000000000042862" data-uri="chapter04.xhtml#P7000497027000000000000000042862" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042863" data-uri="chapter04.xhtml#P7000497027000000000000000042863" class="pcalibre calibre3 pcalibre1">E, between Execute and Decode: includes the following, from left to right:</p>
<ul id="P7000497027000000000000000042864" data-uri="chapter04.xhtml#P7000497027000000000000000042864" class="pcalibre calibre39 pcalibre1">
<li id="P7000497027000000000000000042865" data-uri="chapter04.xhtml#P7000497027000000000000000042865" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042866" data-uri="chapter04.xhtml#P7000497027000000000000000042866" class="pcalibre calibre3 pcalibre1">Stat: from D to M</p></li>
<li id="P7000497027000000000000000042867" data-uri="chapter04.xhtml#P7000497027000000000000000042867" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042868" data-uri="chapter04.xhtml#P7000497027000000000000000042868" class="pcalibre calibre3 pcalibre1">Icode: from D to M</p></li>
<li id="P7000497027000000000000000042869" data-uri="chapter04.xhtml#P7000497027000000000000000042869" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004286A" data-uri="chapter04.xhtml#P700049702700000000000000004286A" class="pcalibre calibre3 pcalibre1">Ifun, from ifun in D</p></li>
<li id="P700049702700000000000000004286B" data-uri="chapter04.xhtml#P700049702700000000000000004286B" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004286C" data-uri="chapter04.xhtml#P700049702700000000000000004286C" class="pcalibre calibre3 pcalibre1">valC, from valC in D; output ALU A to ALU</p></li>
<li id="P700049702700000000000000004286D" data-uri="chapter04.xhtml#P700049702700000000000000004286D" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004286E" data-uri="chapter04.xhtml#P700049702700000000000000004286E" class="pcalibre calibre3 pcalibre1">valA: input from Sel+Fwd A, which receives input form valP and A from Register file, as well as inputs through Fwd B; output to ALU A and valA in pipeline M</p></li>
<li id="P700049702700000000000000004286F" data-uri="chapter04.xhtml#P700049702700000000000000004286F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042870" data-uri="chapter04.xhtml#P7000497027000000000000000042870" class="pcalibre calibre3 pcalibre1">dstE: input dstE and output e_dstE to dstE in M, with input e_Cnd from CC from ALU</p></li>
<li id="P7000497027000000000000000042871" data-uri="chapter04.xhtml#P7000497027000000000000000042871" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042872" data-uri="chapter04.xhtml#P7000497027000000000000000042872" class="pcalibre calibre3 pcalibre1">dstM: input dstM and output dstM in M</p></li>
<li id="P7000497027000000000000000042873" data-uri="chapter04.xhtml#P7000497027000000000000000042873" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042874" data-uri="chapter04.xhtml#P7000497027000000000000000042874" class="pcalibre calibre3 pcalibre1">srcA, with input d_srcA from srcA</p></li>
<li id="P7000497027000000000000000042875" data-uri="chapter04.xhtml#P7000497027000000000000000042875" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042876" data-uri="chapter04.xhtml#P7000497027000000000000000042876" class="pcalibre calibre3 pcalibre1">srcB with input d_srcB from srcB</p></li>
</ul></li>
<li id="P7000497027000000000000000042877" data-uri="chapter04.xhtml#P7000497027000000000000000042877" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042878" data-uri="chapter04.xhtml#P7000497027000000000000000042878" class="pcalibre calibre3 pcalibre1">M, between Memory and Execute: includes the following from left to right:</p>
<ul id="P7000497027000000000000000042879" data-uri="chapter04.xhtml#P7000497027000000000000000042879" class="pcalibre calibre39 pcalibre1">
<li id="P700049702700000000000000004287A" data-uri="chapter04.xhtml#P700049702700000000000000004287A" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004287B" data-uri="chapter04.xhtml#P700049702700000000000000004287B" class="pcalibre calibre3 pcalibre1">Stat from stat in E with output to Stat, which has output m_stat in W</p></li>
<li id="P700049702700000000000000004287C" data-uri="chapter04.xhtml#P700049702700000000000000004287C" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004287D" data-uri="chapter04.xhtml#P700049702700000000000000004287D" class="pcalibre calibre3 pcalibre1">Icode from E to W</p></li>
<li id="P700049702700000000000000004287E" data-uri="chapter04.xhtml#P700049702700000000000000004287E" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004287F" data-uri="chapter04.xhtml#P700049702700000000000000004287F" class="pcalibre calibre3 pcalibre1">Cnd: input e_Cnd from CC, from ALU (input from ALU A, ALU B, and ALU fun.); output M_Cnd to Select PC</p></li>
<li id="P7000497027000000000000000042880" data-uri="chapter04.xhtml#P7000497027000000000000000042880" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042881" data-uri="chapter04.xhtml#P7000497027000000000000000042881" class="pcalibre calibre3 pcalibre1">valE: input from ALU; outputs Addr to Data memory, M_valE to valE in W, and to Fwd B</p></li>
<li id="P7000497027000000000000000042882" data-uri="chapter04.xhtml#P7000497027000000000000000042882" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042883" data-uri="chapter04.xhtml#P7000497027000000000000000042883" class="pcalibre calibre3 pcalibre1">valA: input from valA in E; output data in to Data memory, to Addr, and M_valA to Fwd B and Select PC</p></li>
<li id="P7000497027000000000000000042884" data-uri="chapter04.xhtml#P7000497027000000000000000042884" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042885" data-uri="chapter04.xhtml#P7000497027000000000000000042885" class="pcalibre calibre3 pcalibre1">dstE: input from dstE, from dstE in E and e_Cnd from CC; output dstE in W</p></li>
<li id="P7000497027000000000000000042886" data-uri="chapter04.xhtml#P7000497027000000000000000042886" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042887" data-uri="chapter04.xhtml#P7000497027000000000000000042887" class="pcalibre calibre3 pcalibre1">dstM: from E to W</p></li>
</ul></li>
<li id="P7000497027000000000000000042888" data-uri="chapter04.xhtml#P7000497027000000000000000042888" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042889" data-uri="chapter04.xhtml#P7000497027000000000000000042889" class="pcalibre calibre3 pcalibre1">W, between Write back and Memory: includes the following from left to right:</p>
<ul id="P700049702700000000000000004288A" data-uri="chapter04.xhtml#P700049702700000000000000004288A" class="pcalibre calibre39 pcalibre1">
<li id="P700049702700000000000000004288B" data-uri="chapter04.xhtml#P700049702700000000000000004288B" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004288C" data-uri="chapter04.xhtml#P700049702700000000000000004288C" class="pcalibre calibre3 pcalibre1">Stat: input m_stat from Stat, and dmem_error from Data memory; output to Stat in Write back</p></li>
<li id="P700049702700000000000000004288D" data-uri="chapter04.xhtml#P700049702700000000000000004288D" class="calibre12 pcalibre pcalibre1"><p id="P700049702700000000000000004288E" data-uri="chapter04.xhtml#P700049702700000000000000004288E" class="pcalibre calibre3 pcalibre1">Icode from M</p></li>
<li id="P700049702700000000000000004288F" data-uri="chapter04.xhtml#P700049702700000000000000004288F" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042890" data-uri="chapter04.xhtml#P7000497027000000000000000042890" class="pcalibre calibre3 pcalibre1">valE: input from M; output W_valE to Fwd B and E in Register file</p></li>
<li id="P7000497027000000000000000042891" data-uri="chapter04.xhtml#P7000497027000000000000000042891" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042892" data-uri="chapter04.xhtml#P7000497027000000000000000042892" class="pcalibre calibre3 pcalibre1">valM: input data out from Data memory; output W_valM to M in Register file, Fwd B, and Select PC</p></li>
<li id="P7000497027000000000000000042893" data-uri="chapter04.xhtml#P7000497027000000000000000042893" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042894" data-uri="chapter04.xhtml#P7000497027000000000000000042894" class="pcalibre calibre3 pcalibre1">dstE from M</p></li>
<li id="P7000497027000000000000000042895" data-uri="chapter04.xhtml#P7000497027000000000000000042895" class="calibre12 pcalibre pcalibre1"><p id="P7000497027000000000000000042896" data-uri="chapter04.xhtml#P7000497027000000000000000042896" class="pcalibre calibre3 pcalibre1">dstM from M</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004350" data-uri="chapter04.xhtml#P7000497027000000000000000004350">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004351" title="441" data-uri="chapter04.xhtml#P7000497027000000000000000004351" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipeline example of load/use data hazard." id="P7000497027000000000000000042897" data-uri="P700049702700000000000000000B6FA" src="../images/p441-1.png" class="calibre151 pcalibre pcalibre1"/>
<figcaption id="P7000497027000000000000000042898" data-uri="chapter04.xhtml#P7000497027000000000000000042898" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P7000497027000000000000000042899" data-uri="chapter04.xhtml#P7000497027000000000000000042899" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="number pcalibre pcalibre1">4.53 </span>Example of load/use data hazard.</h1></header>
<div class="edition pcalibre pcalibre1" id="P700049702700000000000000004289A" data-uri="chapter04.xhtml#P700049702700000000000000004289A"><p id="P700049702700000000000000004289B" data-uri="chapter04.xhtml#P700049702700000000000000004289B" class="pcalibre1 pcalibre calibre2"> The <code id="P700049702700000000000000004289C" data-uri="chapter04.xhtml#P700049702700000000000000004289C" class="pcalibre1 calibre8 pcalibre">addq</code> instruction requires the value of register <code id="P700049702700000000000000004289D" data-uri="chapter04.xhtml#P700049702700000000000000004289D" class="pcalibre1 calibre8 pcalibre">%rax</code> during the decode stage in cycle 7. The preceding <code id="P700049702700000000000000004289E" data-uri="chapter04.xhtml#P700049702700000000000000004289E" class="pcalibre1 calibre8 pcalibre">mrmovq</code> reads a new value for this register during the memory stage in cycle 8, which is too late for the <code id="P700049702700000000000000004289F" data-uri="chapter04.xhtml#P700049702700000000000000004289F" class="pcalibre1 calibre8 pcalibre">addq</code> instruction.</p><p id="P70004970270000000000000000428A0" data-uri="chapter04.xhtml#P70004970270000000000000000428A0" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022B7C" data-uri="chapter04.xhtml#P7000497027000000000000000022B7C">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000428A1" data-uri="chapter04.xhtml#P70004970270000000000000000428A1" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P70004970270000000000000000428A2" data-uri="chapter04.xhtml#P70004970270000000000000000428A2">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000428A3" data-uri="chapter04.xhtml#P70004970270000000000000000428A3" class="calibre18 pcalibre pcalibre1">Prog5</th>
<th id="P70004970270000000000000000428A4" data-uri="chapter04.xhtml#P70004970270000000000000000428A4" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P70004970270000000000000000428A5" data-uri="chapter04.xhtml#P70004970270000000000000000428A5" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P70004970270000000000000000428A6" data-uri="chapter04.xhtml#P70004970270000000000000000428A6" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P70004970270000000000000000428A7" data-uri="chapter04.xhtml#P70004970270000000000000000428A7" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P70004970270000000000000000428A8" data-uri="chapter04.xhtml#P70004970270000000000000000428A8" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P70004970270000000000000000428A9" data-uri="chapter04.xhtml#P70004970270000000000000000428A9" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P70004970270000000000000000428AA" data-uri="chapter04.xhtml#P70004970270000000000000000428AA" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P70004970270000000000000000428AB" data-uri="chapter04.xhtml#P70004970270000000000000000428AB" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P70004970270000000000000000428AC" data-uri="chapter04.xhtml#P70004970270000000000000000428AC" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P70004970270000000000000000428AD" data-uri="chapter04.xhtml#P70004970270000000000000000428AD" class="calibre18 pcalibre pcalibre1">10</th>
<th id="P70004970270000000000000000428AE" data-uri="chapter04.xhtml#P70004970270000000000000000428AE" class="calibre18 pcalibre pcalibre1">11</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428AF" data-uri="chapter04.xhtml#P70004970270000000000000000428AF" class="calibre20 pcalibre pcalibre1">0x000: irmovq $128, %rdx</td>
<td id="P70004970270000000000000000428B0" data-uri="chapter04.xhtml#P70004970270000000000000000428B0" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428B1" data-uri="chapter04.xhtml#P70004970270000000000000000428B1" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428B2" data-uri="chapter04.xhtml#P70004970270000000000000000428B2" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428B3" data-uri="chapter04.xhtml#P70004970270000000000000000428B3" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428B4" data-uri="chapter04.xhtml#P70004970270000000000000000428B4" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428B5" data-uri="chapter04.xhtml#P70004970270000000000000000428B5" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rcx</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428B6" data-uri="chapter04.xhtml#P70004970270000000000000000428B6" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428B7" data-uri="chapter04.xhtml#P70004970270000000000000000428B7" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428B8" data-uri="chapter04.xhtml#P70004970270000000000000000428B8" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428B9" data-uri="chapter04.xhtml#P70004970270000000000000000428B9" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428BA" data-uri="chapter04.xhtml#P70004970270000000000000000428BA" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428BB" data-uri="chapter04.xhtml#P70004970270000000000000000428BB" class="calibre20 pcalibre pcalibre1">0x014: rmmovq %rcx, 0(%rdx)</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428BC" data-uri="chapter04.xhtml#P70004970270000000000000000428BC" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428BD" data-uri="chapter04.xhtml#P70004970270000000000000000428BD" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428BE" data-uri="chapter04.xhtml#P70004970270000000000000000428BE" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428BF" data-uri="chapter04.xhtml#P70004970270000000000000000428BF" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428C0" data-uri="chapter04.xhtml#P70004970270000000000000000428C0" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428C1" data-uri="chapter04.xhtml#P70004970270000000000000000428C1" class="calibre20 pcalibre pcalibre1">0x01e: irmovq $10, %rbx</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428C2" data-uri="chapter04.xhtml#P70004970270000000000000000428C2" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428C3" data-uri="chapter04.xhtml#P70004970270000000000000000428C3" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428C4" data-uri="chapter04.xhtml#P70004970270000000000000000428C4" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428C5" data-uri="chapter04.xhtml#P70004970270000000000000000428C5" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428C6" data-uri="chapter04.xhtml#P70004970270000000000000000428C6" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428C7" data-uri="chapter04.xhtml#P70004970270000000000000000428C7" class="calibre20 pcalibre pcalibre1">0x028: mrmovq 0(%rdx), %rax # Load %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428C8" data-uri="chapter04.xhtml#P70004970270000000000000000428C8" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428C9" data-uri="chapter04.xhtml#P70004970270000000000000000428C9" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428CA" data-uri="chapter04.xhtml#P70004970270000000000000000428CA" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428CB" data-uri="chapter04.xhtml#P70004970270000000000000000428CB" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428CC" data-uri="chapter04.xhtml#P70004970270000000000000000428CC" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428CD" data-uri="chapter04.xhtml#P70004970270000000000000000428CD" class="calibre20 pcalibre pcalibre1">0x032: addq %ebx, %eax # Use %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428CE" data-uri="chapter04.xhtml#P70004970270000000000000000428CE" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428CF" data-uri="chapter04.xhtml#P70004970270000000000000000428CF" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428D0" data-uri="chapter04.xhtml#P70004970270000000000000000428D0" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428D1" data-uri="chapter04.xhtml#P70004970270000000000000000428D1" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428D2" data-uri="chapter04.xhtml#P70004970270000000000000000428D2" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428D3" data-uri="chapter04.xhtml#P70004970270000000000000000428D3" class="calibre20 pcalibre pcalibre1"> 0x034: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428D4" data-uri="chapter04.xhtml#P70004970270000000000000000428D4" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428D5" data-uri="chapter04.xhtml#P70004970270000000000000000428D5" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428D6" data-uri="chapter04.xhtml#P70004970270000000000000000428D6" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428D7" data-uri="chapter04.xhtml#P70004970270000000000000000428D7" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428D8" data-uri="chapter04.xhtml#P70004970270000000000000000428D8" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
<p id="P70004970270000000000000000428D9" data-uri="chapter04.xhtml#P70004970270000000000000000428D9" class="pcalibre calibre3 pcalibre1">Cycle 7 is illustrated with M M_dstE = %rbx, M_valE = 10 and D valA ← M_valE = 10, valB ← R[%rax] = 0 (error). Cycle 8 is illustrated with M M_dstM = %rax, m_valM ← M[128] = 3.</p>
</details>
</figcaption>
</figure>
<p id="P70004970270000000000000000428DA" data-uri="chapter04.xhtml#P70004970270000000000000000428DA" class="pcalibre1 pcalibre calibre2">This use of a stall to handle a load/use hazard is called a <i class="calibre5 pcalibre pcalibre1">load interlock</i>. Load interlocks combined with forwarding suffice to handle all possible forms of data hazards. Since only load interlocks reduce the pipeline throughput, we can nearly achieve our throughput goal of issuing one new instruction on every clock cycle.</p>
</section>

<section id="P700049702700000000000000000435C" data-uri="chapter04.xhtml#P700049702700000000000000000435C" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title5 pcalibre pcalibre1" id="P70004970270000000000000000428DB" data-uri="chapter04.xhtml#P70004970270000000000000000428DB" epub:type="title">Avoiding Control Hazards</h1></header>
<p id="P70004970270000000000000000428DC" data-uri="chapter04.xhtml#P70004970270000000000000000428DC" class="pcalibre1 pcalibre calibre2">Control hazards arise when the processor cannot reliably determine the address of the next instruction based on the current instruction in the fetch stage. As was discussed in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P700049702700000000000000000423A"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.4</span></a>, control hazards can only occur in our pipelined processor for <code id="P70004970270000000000000000428DD" data-uri="chapter04.xhtml#P70004970270000000000000000428DD" class="pcalibre1 calibre8 pcalibre">ret</code> and jump instructions. Moreover, the latter case only causes difficulties when the direction of a conditional jump is mispredicted. In this section, we provide a high-level view of how these hazards can be handled. The detailed implementation will be presented in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.8</span></a> as part of a more general discussion of the pipeline control.</p>
<p id="P70004970270000000000000000428DE" data-uri="chapter04.xhtml#P70004970270000000000000000428DE" class="pcalibre1 pcalibre calibre2">For the <code id="P70004970270000000000000000428DF" data-uri="chapter04.xhtml#P70004970270000000000000000428DF" class="pcalibre1 calibre8 pcalibre">ret</code> instruction, consider the following example program. This program is shown in assembly code, but with the addresses of the different instructions on the left for reference:</p>

<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004362" data-uri="chapter04.xhtml#P7000497027000000000000000004362">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004363" title="442" data-uri="chapter04.xhtml#P7000497027000000000000000004363" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipeline example of load/use data hazard by stalling." id="P70004970270000000000000000428E0" data-uri="P700049702700000000000000000B6FB" src="../images/p442-1.png" class="pcalibre1 pcalibre calibre152"/>
<figcaption id="P70004970270000000000000000428E1" data-uri="chapter04.xhtml#P70004970270000000000000000428E1" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P70004970270000000000000000428E2" data-uri="chapter04.xhtml#P70004970270000000000000000428E2" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="number pcalibre pcalibre1">4.54 </span>Handling a load/use hazard by stalling.</h1></header>
<div class="edition pcalibre pcalibre1" id="P70004970270000000000000000428E3" data-uri="chapter04.xhtml#P70004970270000000000000000428E3"><p id="P70004970270000000000000000428E4" data-uri="chapter04.xhtml#P70004970270000000000000000428E4" class="pcalibre1 pcalibre calibre2">By stalling the <code id="P70004970270000000000000000428E5" data-uri="chapter04.xhtml#P70004970270000000000000000428E5" class="pcalibre1 calibre8 pcalibre">addq</code> instruction for one cycle in the decode stage, the value for valB can be forwarded from the <code id="P70004970270000000000000000428E6" data-uri="chapter04.xhtml#P70004970270000000000000000428E6" class="pcalibre1 calibre8 pcalibre">mrmovq</code> instruction in the memory stage to the <code id="P70004970270000000000000000428E7" data-uri="chapter04.xhtml#P70004970270000000000000000428E7" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in the decode stage.</p><p id="P70004970270000000000000000428E8" data-uri="chapter04.xhtml#P70004970270000000000000000428E8" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022BC4" data-uri="chapter04.xhtml#P7000497027000000000000000022BC4">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000428E9" data-uri="chapter04.xhtml#P70004970270000000000000000428E9" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P70004970270000000000000000428EA" data-uri="chapter04.xhtml#P70004970270000000000000000428EA">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P70004970270000000000000000428EB" data-uri="chapter04.xhtml#P70004970270000000000000000428EB" class="calibre18 pcalibre pcalibre1">Prog5</th>
<th id="P70004970270000000000000000428EC" data-uri="chapter04.xhtml#P70004970270000000000000000428EC" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P70004970270000000000000000428ED" data-uri="chapter04.xhtml#P70004970270000000000000000428ED" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P70004970270000000000000000428EE" data-uri="chapter04.xhtml#P70004970270000000000000000428EE" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P70004970270000000000000000428EF" data-uri="chapter04.xhtml#P70004970270000000000000000428EF" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P70004970270000000000000000428F0" data-uri="chapter04.xhtml#P70004970270000000000000000428F0" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P70004970270000000000000000428F1" data-uri="chapter04.xhtml#P70004970270000000000000000428F1" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P70004970270000000000000000428F2" data-uri="chapter04.xhtml#P70004970270000000000000000428F2" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P70004970270000000000000000428F3" data-uri="chapter04.xhtml#P70004970270000000000000000428F3" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P70004970270000000000000000428F4" data-uri="chapter04.xhtml#P70004970270000000000000000428F4" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P70004970270000000000000000428F5" data-uri="chapter04.xhtml#P70004970270000000000000000428F5" class="calibre18 pcalibre pcalibre1">10</th>
<th id="P70004970270000000000000000428F6" data-uri="chapter04.xhtml#P70004970270000000000000000428F6" class="calibre18 pcalibre pcalibre1">11</th>
<th id="P70004970270000000000000000428F7" data-uri="chapter04.xhtml#P70004970270000000000000000428F7" class="calibre18 pcalibre pcalibre1">12</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428F8" data-uri="chapter04.xhtml#P70004970270000000000000000428F8" class="calibre20 pcalibre pcalibre1">0x000: irmovq $128, %rdx</td>
<td id="P70004970270000000000000000428F9" data-uri="chapter04.xhtml#P70004970270000000000000000428F9" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000428FA" data-uri="chapter04.xhtml#P70004970270000000000000000428FA" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000428FB" data-uri="chapter04.xhtml#P70004970270000000000000000428FB" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000428FC" data-uri="chapter04.xhtml#P70004970270000000000000000428FC" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000428FD" data-uri="chapter04.xhtml#P70004970270000000000000000428FD" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000428FE" data-uri="chapter04.xhtml#P70004970270000000000000000428FE" class="calibre20 pcalibre pcalibre1">0x00a: irmovq $3, %rcx</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000428FF" data-uri="chapter04.xhtml#P70004970270000000000000000428FF" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042900" data-uri="chapter04.xhtml#P7000497027000000000000000042900" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042901" data-uri="chapter04.xhtml#P7000497027000000000000000042901" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042902" data-uri="chapter04.xhtml#P7000497027000000000000000042902" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042903" data-uri="chapter04.xhtml#P7000497027000000000000000042903" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042904" data-uri="chapter04.xhtml#P7000497027000000000000000042904" class="calibre20 pcalibre pcalibre1">0x014: rmmovq %rcx, 0(%rdx)</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042905" data-uri="chapter04.xhtml#P7000497027000000000000000042905" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042906" data-uri="chapter04.xhtml#P7000497027000000000000000042906" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042907" data-uri="chapter04.xhtml#P7000497027000000000000000042907" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042908" data-uri="chapter04.xhtml#P7000497027000000000000000042908" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042909" data-uri="chapter04.xhtml#P7000497027000000000000000042909" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004290A" data-uri="chapter04.xhtml#P700049702700000000000000004290A" class="calibre20 pcalibre pcalibre1">0x01e: irmovq $10, %rbx</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004290B" data-uri="chapter04.xhtml#P700049702700000000000000004290B" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004290C" data-uri="chapter04.xhtml#P700049702700000000000000004290C" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004290D" data-uri="chapter04.xhtml#P700049702700000000000000004290D" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004290E" data-uri="chapter04.xhtml#P700049702700000000000000004290E" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004290F" data-uri="chapter04.xhtml#P700049702700000000000000004290F" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042910" data-uri="chapter04.xhtml#P7000497027000000000000000042910" class="calibre20 pcalibre pcalibre1">0x028: mrmovq 0(%rdx), %rax # Load %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042911" data-uri="chapter04.xhtml#P7000497027000000000000000042911" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042912" data-uri="chapter04.xhtml#P7000497027000000000000000042912" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042913" data-uri="chapter04.xhtml#P7000497027000000000000000042913" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042914" data-uri="chapter04.xhtml#P7000497027000000000000000042914" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042915" data-uri="chapter04.xhtml#P7000497027000000000000000042915" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042916" data-uri="chapter04.xhtml#P7000497027000000000000000042916" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042917" data-uri="chapter04.xhtml#P7000497027000000000000000042917" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042918" data-uri="chapter04.xhtml#P7000497027000000000000000042918" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042919" data-uri="chapter04.xhtml#P7000497027000000000000000042919" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004291A" data-uri="chapter04.xhtml#P700049702700000000000000004291A" class="calibre20 pcalibre pcalibre1">0x032: addq %rbx, %rax # Use %rax</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004291B" data-uri="chapter04.xhtml#P700049702700000000000000004291B" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004291C" data-uri="chapter04.xhtml#P700049702700000000000000004291C" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004291D" data-uri="chapter04.xhtml#P700049702700000000000000004291D" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004291E" data-uri="chapter04.xhtml#P700049702700000000000000004291E" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004291F" data-uri="chapter04.xhtml#P700049702700000000000000004291F" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042920" data-uri="chapter04.xhtml#P7000497027000000000000000042920" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042921" data-uri="chapter04.xhtml#P7000497027000000000000000042921" class="calibre20 pcalibre pcalibre1">0x034: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042922" data-uri="chapter04.xhtml#P7000497027000000000000000042922" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042923" data-uri="chapter04.xhtml#P7000497027000000000000000042923" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042924" data-uri="chapter04.xhtml#P7000497027000000000000000042924" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042925" data-uri="chapter04.xhtml#P7000497027000000000000000042925" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042926" data-uri="chapter04.xhtml#P7000497027000000000000000042926" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042927" data-uri="chapter04.xhtml#P7000497027000000000000000042927" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
<p id="P7000497027000000000000000042928" data-uri="chapter04.xhtml#P7000497027000000000000000042928" class="pcalibre calibre3 pcalibre1">Cycle 8 is illustrated with W W_dstE = %rbx, W_valE = 10; M M_dstM = %rax, m_valM ← M[128] = 3; and D valA ← W_valE = 10, valB ← m_valM = 3.</p>
</details>
</figcaption>
</figure>

<pre id="P7000497027000000000000000042929" data-uri="chapter04.xhtml#P7000497027000000000000000042929" class="calibre9 pcalibre pcalibre1">
<code id="P700049702700000000000000004292A" data-uri="chapter04.xhtml#P700049702700000000000000004292A" class="calibre10 pcalibre pcalibre1">0x000:	irmovq stack,%rsp		# Initialize stack pointer
0x00a:	call proc			# Procedure call
0x013:	irmovq $10,%rdx			# Return point
0x01d:	halt
0x020:	.pos 0x20
0x020:	proc:				# proc:
0x020:	ret				# Return immediately
0x021:	rrmovq %rdx,%rbx		# Not executed
0x030:	.pos 0x30
0x030:	stack:				# stack: Stack pointer
</code>
</pre>

<p id="P700049702700000000000000004292B" data-uri="chapter04.xhtml#P700049702700000000000000004292B" class="pcalibre1 pcalibre calibre2"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004370"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.55</span></a> shows how we want the pipeline to process the <code id="P700049702700000000000000004292C" data-uri="chapter04.xhtml#P700049702700000000000000004292C" class="pcalibre1 calibre8 pcalibre">ret</code> instruction. As with our earlier pipeline diagrams, this figure shows the pipeline activity with</p>

<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004370" data-uri="chapter04.xhtml#P7000497027000000000000000004370">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004371" title="443" data-uri="chapter04.xhtml#P7000497027000000000000000004371" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipeline with a simplified view of ret instruction processing." id="P700049702700000000000000004292D" data-uri="P700049702700000000000000000B6FC" src="../images/p443-1.png" class="pcalibre calibre153 pcalibre1"/>
<figcaption id="P700049702700000000000000004292E" data-uri="chapter04.xhtml#P700049702700000000000000004292E" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P700049702700000000000000004292F" data-uri="chapter04.xhtml#P700049702700000000000000004292F" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="pcalibre label pcalibre1">4.55 </span>Simplified view of <code id="P7000497027000000000000000042930" data-uri="chapter04.xhtml#P7000497027000000000000000042930" class="pcalibre1 calibre8 pcalibre">ret</code> instruction processing.</h1></header>
<div class="edition pcalibre pcalibre1" id="P7000497027000000000000000042931" data-uri="chapter04.xhtml#P7000497027000000000000000042931"><p id="P7000497027000000000000000042932" data-uri="chapter04.xhtml#P7000497027000000000000000042932" class="pcalibre1 pcalibre calibre2">The pipeline should stall while the <code id="P7000497027000000000000000042933" data-uri="chapter04.xhtml#P7000497027000000000000000042933" class="pcalibre1 calibre8 pcalibre">ret</code> passes through the decode, execute, and memory stages, injecting three bubbles in the process. The PC selection logic will choose the return address as the instruction fetch address once the <code id="P7000497027000000000000000042934" data-uri="chapter04.xhtml#P7000497027000000000000000042934" class="pcalibre1 calibre8 pcalibre">ret</code> reaches the write-back stage (cycle 7).</p><p id="P7000497027000000000000000042935" data-uri="chapter04.xhtml#P7000497027000000000000000042935" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022C11" data-uri="chapter04.xhtml#P7000497027000000000000000022C11">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P7000497027000000000000000042936" data-uri="chapter04.xhtml#P7000497027000000000000000042936" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P7000497027000000000000000042937" data-uri="chapter04.xhtml#P7000497027000000000000000042937">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000042938" data-uri="chapter04.xhtml#P7000497027000000000000000042938" class="calibre18 pcalibre pcalibre1">Prog5</th>
<th id="P7000497027000000000000000042939" data-uri="chapter04.xhtml#P7000497027000000000000000042939" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P700049702700000000000000004293A" data-uri="chapter04.xhtml#P700049702700000000000000004293A" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P700049702700000000000000004293B" data-uri="chapter04.xhtml#P700049702700000000000000004293B" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P700049702700000000000000004293C" data-uri="chapter04.xhtml#P700049702700000000000000004293C" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P700049702700000000000000004293D" data-uri="chapter04.xhtml#P700049702700000000000000004293D" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P700049702700000000000000004293E" data-uri="chapter04.xhtml#P700049702700000000000000004293E" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P700049702700000000000000004293F" data-uri="chapter04.xhtml#P700049702700000000000000004293F" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P7000497027000000000000000042940" data-uri="chapter04.xhtml#P7000497027000000000000000042940" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P7000497027000000000000000042941" data-uri="chapter04.xhtml#P7000497027000000000000000042941" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P7000497027000000000000000042942" data-uri="chapter04.xhtml#P7000497027000000000000000042942" class="calibre18 pcalibre pcalibre1">10</th>
<th id="P7000497027000000000000000042943" data-uri="chapter04.xhtml#P7000497027000000000000000042943" class="calibre18 pcalibre pcalibre1">11</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042944" data-uri="chapter04.xhtml#P7000497027000000000000000042944" class="calibre20 pcalibre pcalibre1">0x000: irmovq Stack, %edx</td>
<td id="P7000497027000000000000000042945" data-uri="chapter04.xhtml#P7000497027000000000000000042945" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042946" data-uri="chapter04.xhtml#P7000497027000000000000000042946" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042947" data-uri="chapter04.xhtml#P7000497027000000000000000042947" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042948" data-uri="chapter04.xhtml#P7000497027000000000000000042948" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042949" data-uri="chapter04.xhtml#P7000497027000000000000000042949" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004294A" data-uri="chapter04.xhtml#P700049702700000000000000004294A" class="calibre20 pcalibre pcalibre1">0x00a: call proc</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004294B" data-uri="chapter04.xhtml#P700049702700000000000000004294B" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004294C" data-uri="chapter04.xhtml#P700049702700000000000000004294C" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004294D" data-uri="chapter04.xhtml#P700049702700000000000000004294D" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004294E" data-uri="chapter04.xhtml#P700049702700000000000000004294E" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004294F" data-uri="chapter04.xhtml#P700049702700000000000000004294F" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042950" data-uri="chapter04.xhtml#P7000497027000000000000000042950" class="calibre20 pcalibre pcalibre1">0x020: ret</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042951" data-uri="chapter04.xhtml#P7000497027000000000000000042951" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042952" data-uri="chapter04.xhtml#P7000497027000000000000000042952" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042953" data-uri="chapter04.xhtml#P7000497027000000000000000042953" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042954" data-uri="chapter04.xhtml#P7000497027000000000000000042954" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042955" data-uri="chapter04.xhtml#P7000497027000000000000000042955" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042956" data-uri="chapter04.xhtml#P7000497027000000000000000042956" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042957" data-uri="chapter04.xhtml#P7000497027000000000000000042957" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042958" data-uri="chapter04.xhtml#P7000497027000000000000000042958" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042959" data-uri="chapter04.xhtml#P7000497027000000000000000042959" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004295A" data-uri="chapter04.xhtml#P700049702700000000000000004295A" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004295B" data-uri="chapter04.xhtml#P700049702700000000000000004295B" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004295C" data-uri="chapter04.xhtml#P700049702700000000000000004295C" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004295D" data-uri="chapter04.xhtml#P700049702700000000000000004295D" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004295E" data-uri="chapter04.xhtml#P700049702700000000000000004295E" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004295F" data-uri="chapter04.xhtml#P700049702700000000000000004295F" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042960" data-uri="chapter04.xhtml#P7000497027000000000000000042960" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042961" data-uri="chapter04.xhtml#P7000497027000000000000000042961" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042962" data-uri="chapter04.xhtml#P7000497027000000000000000042962" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042963" data-uri="chapter04.xhtml#P7000497027000000000000000042963" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042964" data-uri="chapter04.xhtml#P7000497027000000000000000042964" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042965" data-uri="chapter04.xhtml#P7000497027000000000000000042965" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042966" data-uri="chapter04.xhtml#P7000497027000000000000000042966" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042967" data-uri="chapter04.xhtml#P7000497027000000000000000042967" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042968" data-uri="chapter04.xhtml#P7000497027000000000000000042968" class="calibre20 pcalibre pcalibre1">0x013: irmovq $10, %edx # Return point</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042969" data-uri="chapter04.xhtml#P7000497027000000000000000042969" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004296A" data-uri="chapter04.xhtml#P700049702700000000000000004296A" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004296B" data-uri="chapter04.xhtml#P700049702700000000000000004296B" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004296C" data-uri="chapter04.xhtml#P700049702700000000000000004296C" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004296D" data-uri="chapter04.xhtml#P700049702700000000000000004296D" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>

<p class="pcalibre1 pcalibre calibre2" id="P700049702700000000000000004296E" data-uri="chapter04.xhtml#P700049702700000000000000004296E">time growing to the right. Unlike before, the instructions are not listed in the same order they occur in the program, since this program involves a control flow where instructions are not executed in a linear sequence. It is useful to look at the instruction addresses to identify the different instructions in the program.</p>
<p id="P700049702700000000000000004296F" data-uri="chapter04.xhtml#P700049702700000000000000004296F" class="pcalibre1 pcalibre calibre2">As this diagram shows, the <code id="P7000497027000000000000000042970" data-uri="chapter04.xhtml#P7000497027000000000000000042970" class="pcalibre1 calibre8 pcalibre">ret</code> instruction is fetched during cycle 3 and proceeds down the pipeline, reaching the write-back stage in cycle 7. While it passes through the decode, execute, and memory stages, the pipeline cannot do any useful activity. Instead, we want to inject three bubbles into the pipeline. Once the <code id="P7000497027000000000000000042971" data-uri="chapter04.xhtml#P7000497027000000000000000042971" class="pcalibre1 calibre8 pcalibre">ret</code> instruction reaches the write-back stage, the PC selection logic will set the program counter to the return address, and therefore the fetch stage will fetch the <code id="P7000497027000000000000000042972" data-uri="chapter04.xhtml#P7000497027000000000000000042972" class="pcalibre1 calibre8 pcalibre">irmovq</code> instruction at the return point (address <code id="P7000497027000000000000000042973" data-uri="chapter04.xhtml#P7000497027000000000000000042973" class="pcalibre1 calibre8 pcalibre">0x013</code>).</p>
<p id="P7000497027000000000000000042974" data-uri="chapter04.xhtml#P7000497027000000000000000042974" class="pcalibre1 pcalibre calibre2">To handle a mispredicted branch, consider the following program, shown in assembly code but with the instruction addresses shown on the left for reference:</p>
<pre id="P7000497027000000000000000042975" data-uri="chapter04.xhtml#P7000497027000000000000000042975" class="calibre9 pcalibre pcalibre1">
<code id="P7000497027000000000000000042976" data-uri="chapter04.xhtml#P7000497027000000000000000042976" class="calibre10 pcalibre pcalibre1">0x000:	xorq %rax,%rax
0x002:	jne target	# Not taken
0x00b:	irmovq $1, %rax	# Fall through
0x015:	halt
0x016: target:
0x016:	irmovq $2, %rdx	# Target
0x020:	irmovq $3, %rbx	# Target+1
0x02a:	halt
</code>
</pre>

<p id="P7000497027000000000000000042977" data-uri="chapter04.xhtml#P7000497027000000000000000042977" class="pcalibre1 pcalibre calibre2"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004384"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.56</span></a> shows how these instructions are processed. As before, the instructions are listed in the order they enter the pipeline, rather than the order they occur in the program. Since the jump instruction is predicted as being taken, the instruction at the jump target will be fetched in cycle 3, and the instruction following this one will be fetched in cycle 4. By the time the branch logic detects that the jump should not be taken during cycle 4, two instructions have been fetched that should not continue being executed. Fortunately, neither of these instructions has caused a change in the programmer-visible state. That can only occur when an instruction</p>

<figure class="pcalibre5 figure pcalibre" id="P7000497027000000000000000004384" data-uri="chapter04.xhtml#P7000497027000000000000000004384">
<span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004385" title="444" data-uri="chapter04.xhtml#P7000497027000000000000000004385" epub:type="pagebreak"></span><img alt="A diagram illustrates a pipeline with processing mispredicted branch instructions." id="P7000497027000000000000000042978" data-uri="P700049702700000000000000000B6FD" src="../images/p444-1.png" class="calibre154 pcalibre pcalibre1"/>
<figcaption id="P7000497027000000000000000042979" data-uri="chapter04.xhtml#P7000497027000000000000000042979" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P700049702700000000000000004297A" data-uri="chapter04.xhtml#P700049702700000000000000004297A" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="number pcalibre pcalibre1">4.56 </span>Processing mispredicted branch instructions.</h1></header>
<div class="edition pcalibre pcalibre1" id="P700049702700000000000000004297B" data-uri="chapter04.xhtml#P700049702700000000000000004297B"><p id="P700049702700000000000000004297C" data-uri="chapter04.xhtml#P700049702700000000000000004297C" class="pcalibre1 pcalibre calibre2"> The pipeline predicts branches will be taken and so starts fetching instructions at the jump target. Two instructions are fetched before the misprediction is detected in cycle 4 when the jump instruction flows through the execute stage. In cycle 5, the pipeline <i class="calibre5 pcalibre pcalibre1">cancels</i> the two target instructions by injecting bubbles into the decode and execute stages, and it also fetches the instruction following the jump.</p><p id="P700049702700000000000000004297D" data-uri="chapter04.xhtml#P700049702700000000000000004297D" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022C59" data-uri="chapter04.xhtml#P7000497027000000000000000022C59">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P700049702700000000000000004297E" data-uri="chapter04.xhtml#P700049702700000000000000004297E" class="pcalibre1 pcalibre calibre2">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre largetable pcalibre1" id="P700049702700000000000000004297F" data-uri="chapter04.xhtml#P700049702700000000000000004297F">
<thead class="pcalibre1 pcalibre calibre16">
<tr class="pcalibre calibre17 pcalibre1">
<th id="P7000497027000000000000000042980" data-uri="chapter04.xhtml#P7000497027000000000000000042980" class="calibre18 pcalibre pcalibre1">Prog7</th>
<th id="P7000497027000000000000000042981" data-uri="chapter04.xhtml#P7000497027000000000000000042981" class="calibre18 pcalibre pcalibre1">1</th>
<th id="P7000497027000000000000000042982" data-uri="chapter04.xhtml#P7000497027000000000000000042982" class="calibre18 pcalibre pcalibre1">2</th>
<th id="P7000497027000000000000000042983" data-uri="chapter04.xhtml#P7000497027000000000000000042983" class="calibre18 pcalibre pcalibre1">3</th>
<th id="P7000497027000000000000000042984" data-uri="chapter04.xhtml#P7000497027000000000000000042984" class="calibre18 pcalibre pcalibre1">4</th>
<th id="P7000497027000000000000000042985" data-uri="chapter04.xhtml#P7000497027000000000000000042985" class="calibre18 pcalibre pcalibre1">5</th>
<th id="P7000497027000000000000000042986" data-uri="chapter04.xhtml#P7000497027000000000000000042986" class="calibre18 pcalibre pcalibre1">6</th>
<th id="P7000497027000000000000000042987" data-uri="chapter04.xhtml#P7000497027000000000000000042987" class="calibre18 pcalibre pcalibre1">7</th>
<th id="P7000497027000000000000000042988" data-uri="chapter04.xhtml#P7000497027000000000000000042988" class="calibre18 pcalibre pcalibre1">8</th>
<th id="P7000497027000000000000000042989" data-uri="chapter04.xhtml#P7000497027000000000000000042989" class="calibre18 pcalibre pcalibre1">9</th>
<th id="P700049702700000000000000004298A" data-uri="chapter04.xhtml#P700049702700000000000000004298A" class="calibre18 pcalibre pcalibre1">10</th>
</tr>
</thead>
<tbody class="calibre19 pcalibre pcalibre1">
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004298B" data-uri="chapter04.xhtml#P700049702700000000000000004298B" class="calibre20 pcalibre pcalibre1">0x000: xorq %rax, %rax</td>
<td id="P700049702700000000000000004298C" data-uri="chapter04.xhtml#P700049702700000000000000004298C" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P700049702700000000000000004298D" data-uri="chapter04.xhtml#P700049702700000000000000004298D" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P700049702700000000000000004298E" data-uri="chapter04.xhtml#P700049702700000000000000004298E" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004298F" data-uri="chapter04.xhtml#P700049702700000000000000004298F" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042990" data-uri="chapter04.xhtml#P7000497027000000000000000042990" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042991" data-uri="chapter04.xhtml#P7000497027000000000000000042991" class="calibre20 pcalibre pcalibre1">0x002: jne target # Not taken</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042992" data-uri="chapter04.xhtml#P7000497027000000000000000042992" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042993" data-uri="chapter04.xhtml#P7000497027000000000000000042993" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P7000497027000000000000000042994" data-uri="chapter04.xhtml#P7000497027000000000000000042994" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P7000497027000000000000000042995" data-uri="chapter04.xhtml#P7000497027000000000000000042995" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P7000497027000000000000000042996" data-uri="chapter04.xhtml#P7000497027000000000000000042996" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P7000497027000000000000000042997" data-uri="chapter04.xhtml#P7000497027000000000000000042997" class="calibre20 pcalibre pcalibre1">0x016: irmovl $2, %rdx # Target</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P7000497027000000000000000042998" data-uri="chapter04.xhtml#P7000497027000000000000000042998" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P7000497027000000000000000042999" data-uri="chapter04.xhtml#P7000497027000000000000000042999" class="calibre20 pcalibre pcalibre1">D</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004299A" data-uri="chapter04.xhtml#P700049702700000000000000004299A" class="calibre20 pcalibre pcalibre1"> bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004299B" data-uri="chapter04.xhtml#P700049702700000000000000004299B" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P700049702700000000000000004299C" data-uri="chapter04.xhtml#P700049702700000000000000004299C" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P700049702700000000000000004299D" data-uri="chapter04.xhtml#P700049702700000000000000004299D" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P700049702700000000000000004299E" data-uri="chapter04.xhtml#P700049702700000000000000004299E" class="calibre20 pcalibre pcalibre1">0x020: irmovl $3, %rbx # Target+1</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P700049702700000000000000004299F" data-uri="chapter04.xhtml#P700049702700000000000000004299F" class="calibre20 pcalibre pcalibre1">F</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000429A0" data-uri="chapter04.xhtml#P70004970270000000000000000429A0" class="calibre20 pcalibre pcalibre1">bubble</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000429A1" data-uri="chapter04.xhtml#P70004970270000000000000000429A1" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000429A2" data-uri="chapter04.xhtml#P70004970270000000000000000429A2" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000429A3" data-uri="chapter04.xhtml#P70004970270000000000000000429A3" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000429A4" data-uri="chapter04.xhtml#P70004970270000000000000000429A4" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000429A5" data-uri="chapter04.xhtml#P70004970270000000000000000429A5" class="calibre20 pcalibre pcalibre1">0x00b: irmovq $1, %rax # Fall through</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000429A6" data-uri="chapter04.xhtml#P70004970270000000000000000429A6" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000429A7" data-uri="chapter04.xhtml#P70004970270000000000000000429A7" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000429A8" data-uri="chapter04.xhtml#P70004970270000000000000000429A8" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000429A9" data-uri="chapter04.xhtml#P70004970270000000000000000429A9" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000429AA" data-uri="chapter04.xhtml#P70004970270000000000000000429AA" class="calibre20 pcalibre pcalibre1">W</td>
<td class="calibre20 pcalibre pcalibre1"/>
</tr>
<tr class="pcalibre calibre17 pcalibre1">
<td id="P70004970270000000000000000429AB" data-uri="chapter04.xhtml#P70004970270000000000000000429AB" class="calibre20 pcalibre pcalibre1">0x015: halt</td>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td class="calibre20 pcalibre pcalibre1"/>
<td id="P70004970270000000000000000429AC" data-uri="chapter04.xhtml#P70004970270000000000000000429AC" class="calibre20 pcalibre pcalibre1">F</td>
<td id="P70004970270000000000000000429AD" data-uri="chapter04.xhtml#P70004970270000000000000000429AD" class="calibre20 pcalibre pcalibre1">D</td>
<td id="P70004970270000000000000000429AE" data-uri="chapter04.xhtml#P70004970270000000000000000429AE" class="calibre20 pcalibre pcalibre1">E</td>
<td id="P70004970270000000000000000429AF" data-uri="chapter04.xhtml#P70004970270000000000000000429AF" class="calibre20 pcalibre pcalibre1">M</td>
<td id="P70004970270000000000000000429B0" data-uri="chapter04.xhtml#P70004970270000000000000000429B0" class="calibre20 pcalibre pcalibre1">W</td>
</tr>
</tbody>
</table>
</details>

</figcaption>
</figure>
<p class="pcalibre1 pcalibre calibre2" id="P70004970270000000000000000429B1" data-uri="chapter04.xhtml#P70004970270000000000000000429B1">reaches the execute stage, where it can cause the condition codes to change. At this point, the pipeline can simply <i class="calibre5 pcalibre pcalibre1">cancel</i> (sometimes called <i class="calibre5 pcalibre pcalibre1">instruction squashing</i>) the two misfetched instructions by injecting bubbles into the decode and execute stages on the following cycle while also fetching the instruction following the jump instruction. The two misfetched instructions will then simply disappear from the pipeline and therefore not have any effect on the programmer-visible state. The only drawback is that two clock cycles' worth of instruction processing capability have been wasted.</p>
<p id="P70004970270000000000000000429B2" data-uri="chapter04.xhtml#P70004970270000000000000000429B2" class="pcalibre1 pcalibre calibre2">This discussion of control hazards indicates that they can be handled by careful consideration of the pipeline control logic. Techniques such as stalling and injecting bubbles into the pipeline dynamically adjust the pipeline flow when special conditions arise. As we will discuss in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.5.8</span></a>, a simple extension to the basic clocked register design will enable us to stall stages and to inject bubbles into pipeline registers as part of the pipeline control logic.</p>
</section>
</section>
<section id="P700049702700000000000000000438D" data-uri="chapter04.xhtml#P700049702700000000000000000438D" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000429B3" data-uri="chapter04.xhtml#P70004970270000000000000000429B3" epub:type="title"><span class="pcalibre label pcalibre1">4.5.6 </span>Exception Handling</h1></header>
<p id="P70004970270000000000000000429B4" data-uri="chapter04.xhtml#P70004970270000000000000000429B4" class="pcalibre1 pcalibre calibre2">As we will discuss in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre label pcalibre1">Chapter </span><span class="pcalibre label pcalibre1">8</span></a>, a variety of activities in a processor can lead to <i class="calibre5 pcalibre pcalibre1">exceptional control flow</i>, where the normal chain of program execution gets broken. Exceptions can be generated either <i class="calibre5 pcalibre pcalibre1">internally</i>, by the executing program, or <i class="calibre5 pcalibre pcalibre1">externally</i>, by some outside signal. Our instruction set architecture includes three different internally generated exceptions, caused by (1) a halt instruction, (2) an instruction with an invalid combination of instruction and function code, and (3) an attempt to access an invalid address, either for instruction fetch or data read or write. A more complete processor design would also handle external exceptions, such as when the processor receives a signal that the network interface has received a new packet or the user has clicked a mouse button. Handling <span class="pcalibre pagebreak pcalibre1" id="P7000497027000000000000000004390" title="445" data-uri="chapter04.xhtml#P7000497027000000000000000004390" epub:type="pagebreak"></span>exceptions correctly is a challenging aspect of any microprocessor design. They can occur at unpredictable times, and they require creating a clean break in the flow of instructions through the processor pipeline. Our handling of the three internal exceptions gives just a glimpse of the true complexity of correctly detecting and handling exceptions.</p>
<p id="P70004970270000000000000000429B5" data-uri="chapter04.xhtml#P70004970270000000000000000429B5" class="pcalibre1 pcalibre calibre2">Let us refer to the instruction causing the exception as the <i class="calibre5 pcalibre pcalibre1">excepting instruction.</i> In the case of an invalid instruction address, there is no actual excepting instruction, but it is useful to think of there being a sort of "virtual instruction" at the invalid address. In our simplified ISA model, we want the processor to halt when it reaches an exception and to set the appropriate status code, as listed in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003BBD"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.5</span></a>. It should appear that all instructions up to the excepting instruction have completed, but none of the following instructions should have any effect on the programmer-visible state. In a more complete design, the processor would continue by invoking an exception handler, a procedure that is part of the operating system, but implementing this part of exception handling is beyond the scope of our presentation.</p>
<p id="P70004970270000000000000000429B6" data-uri="chapter04.xhtml#P70004970270000000000000000429B6" class="pcalibre1 pcalibre calibre2">In a pipelined system, exception handling involves several subtleties. First, it is possible to have exceptions triggered by multiple instructions simultaneously. For example, during one cycle of pipeline operation, we could have a halt instruction in the fetch stage, and the data memory could report an out-of-bounds data address for the instruction in the memory stage. We must determine which of these exceptions the processor should report to the operating system. The basic rule is to put priority on the exception triggered by the instruction that is furthest along the pipeline. In the example above, this would be the out-of-bounds address attempted by the instruction in the memory stage. In terms of the machine-language program, the instruction in the memory stage should appear to execute before one in the fetch stage, and therefore only this exception should be reported to the operating system.</p>
<p id="P70004970270000000000000000429B7" data-uri="chapter04.xhtml#P70004970270000000000000000429B7" class="pcalibre1 pcalibre calibre2">A second subtlety occurs when an instruction is first fetched and begins execution, causes an exception, and later is canceled due to a mispredicted branch. The following is an example of such a program in its object-code form:</p>
<pre id="P70004970270000000000000000429B8" data-uri="chapter04.xhtml#P70004970270000000000000000429B8" class="calibre9 pcalibre pcalibre1">
<code id="P70004970270000000000000000429B9" data-uri="chapter04.xhtml#P70004970270000000000000000429B9" class="calibre10 pcalibre pcalibre1">0x000: 6300			| xorq %rax,%rax
0x002: 741600000000000000	| jne target	  # Not taken
0x00b: 30f00100000000000000	| irmovq $1, %rax # Fall through
0x015: 00			| halt
0x016:				| target:
0x016: ff			| .byte OxFF	  # Invalid instruction code
</code>
</pre>
<p id="P70004970270000000000000000429BA" data-uri="chapter04.xhtml#P70004970270000000000000000429BA" class="pcalibre1 pcalibre calibre2">In this program, the pipeline will predict that the branch should be taken, and so it will fetch and attempt to use a byte with value <code id="P70004970270000000000000000429BB" data-uri="chapter04.xhtml#P70004970270000000000000000429BB" class="pcalibre1 calibre8 pcalibre">0xFF</code> as an instruction (generated in the assembly code using the <code id="P70004970270000000000000000429BC" data-uri="chapter04.xhtml#P70004970270000000000000000429BC" class="pcalibre1 calibre8 pcalibre">.byte</code> directive). The decode stage will therefore detect an invalid instruction exception. Later, the pipeline will discover that the branch should not be taken, and so the instruction at address <code id="P70004970270000000000000000429BD" data-uri="chapter04.xhtml#P70004970270000000000000000429BD" class="pcalibre1 calibre8 pcalibre">0x016</code> should never even have been fetched. The pipeline control logic will cancel this instruction, but we want to avoid raising an exception.</p>

<p id="P70004970270000000000000000429BE" data-uri="chapter04.xhtml#P70004970270000000000000000429BE" class="pcalibre1 pcalibre calibre2"><span class="pcalibre pagebreak pcalibre1" id="P700049702700000000000000000439B" title="446" data-uri="chapter04.xhtml#P700049702700000000000000000439B" epub:type="pagebreak"></span>A third subtlety arises because a pipelined processor updates different parts of the system state in different stages. It is possible for an instruction following one causing an exception to alter some part of the state before the excepting instruction completes. For example, consider the following code sequence, in which we assume that user programs are not allowed to access addresses at the upper end of the 64-bit range:</p>
<pre id="P70004970270000000000000000429BF" data-uri="chapter04.xhtml#P70004970270000000000000000429BF" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000429C0" data-uri="chapter04.xhtml#P70004970270000000000000000429C0" class="calibre10 pcalibre pcalibre1">1	irmovq $l,%rax
2	xorq %rsp,%rsp	# Set stack pointer to 0 and CC to 100
3	pushq %rax	# Attempt to write to 0xfffffffffffffff8
4	addq %rax/Zrax	# (Should not be executed) Would set CC to 000
</code>
</pre>
<p id="P70004970270000000000000000429C1" data-uri="chapter04.xhtml#P70004970270000000000000000429C1" class="pcalibre1 pcalibre calibre2">The <code id="P70004970270000000000000000429C2" data-uri="chapter04.xhtml#P70004970270000000000000000429C2" class="pcalibre1 calibre8 pcalibre">pushq</code> instruction causes an address exception, because decrementing the stack pointer causes it to wrap around to <code id="P70004970270000000000000000429C3" data-uri="chapter04.xhtml#P70004970270000000000000000429C3" class="pcalibre1 calibre8 pcalibre">0xfffffffffffffff8</code>. This exception is detected in the memory stage. On the same cycle, the <code id="P70004970270000000000000000429C4" data-uri="chapter04.xhtml#P70004970270000000000000000429C4" class="pcalibre1 calibre8 pcalibre">addq</code> instruction is in the execute stage, and it will cause the condition codes to be set to new values. This would violate our requirement that none of the instructions following the excepting instruction should have had any effect on the system state.</p>
<p id="P70004970270000000000000000429C5" data-uri="chapter04.xhtml#P70004970270000000000000000429C5" class="pcalibre1 pcalibre calibre2">In general, we can both correctly choose among the different exceptions and avoid raising exceptions for instructions that are fetched due to mispredicted branches by merging the exception-handling logic into the pipeline structure. That is the motivation for us to include a status code stat in each of our pipeline registers (<a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004291"><span class="pcalibre label pcalibre1">Figures </span><span class="pcalibre label pcalibre1">4.41</span></a> and <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P7000497027000000000000000004384"><span class="pcalibre label pcalibre1">4.52</span></a>). If an instruction generates an exception at some stage in its processing, the status field is set to indicate the nature of the exception. The exception status propagates through the pipeline with the rest of the information for that instruction, until it reaches the write-back stage. At this point, the pipeline control logic detects the occurrence of the exception and stops execution.</p>
<p id="P70004970270000000000000000429C6" data-uri="chapter04.xhtml#P70004970270000000000000000429C6" class="pcalibre1 pcalibre calibre2">To avoid having any updating of the programmer-visible state by instructions beyond the excepting instruction, the pipeline control logic must disable any updating of the condition code register or the data memory when an instruction in the memory or write-back stages has caused an exception. In the example program above, the control logic will detect that the <code id="P70004970270000000000000000429C7" data-uri="chapter04.xhtml#P70004970270000000000000000429C7" class="pcalibre1 calibre8 pcalibre">pushq</code> in the memory stage has caused an exception, and therefore the updating of the condition code register by the <code id="P70004970270000000000000000429C8" data-uri="chapter04.xhtml#P70004970270000000000000000429C8" class="pcalibre1 calibre8 pcalibre">addq</code> instruction in the execute stage will be disabled.</p>
<p id="P70004970270000000000000000429C9" data-uri="chapter04.xhtml#P70004970270000000000000000429C9" class="pcalibre1 pcalibre calibre2">Let us consider how this method of handling exceptions deals with the subtleties we have mentioned. When an exception occurs in one or more stages of a pipeline, the information is simply stored in the status fields of the pipeline registers. The event has no effect on the flow of instructions in the pipeline until an excepting instruction reaches the final pipeline stage, except to disable any updating of the programmer-visible state (the condition code register and the memory) by later instructions in the pipeline. Since instructions reach the write-back stage in the same order as they would be executed in a nonpipelined processor, we are guaranteed that the first instruction encountering an exception will arrive first in the write-back stage, at which point program execution can stop and the status code in pipeline register W can be recorded as the program status. If some instruction is fetched but later canceled, any exception status information about the <span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000043A7" title="447" data-uri="chapter04.xhtml#P70004970270000000000000000043A7" epub:type="pagebreak"></span>instruction gets canceled as well. No instruction following one that causes an exception can alter the programmer-visible state. The simple rule of carrying the exception status together with all other information about an instruction through the pipeline provides a simple and reliable mechanism for handling exceptions.</p>
</section>
<section id="P70004970270000000000000000043A8" data-uri="chapter04.xhtml#P70004970270000000000000000043A8" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="pcalibre title1 pcalibre1" id="P70004970270000000000000000429CA" data-uri="chapter04.xhtml#P70004970270000000000000000429CA" epub:type="title"><span class="pcalibre label pcalibre1">4.5.7 </span>PIPE Stage Implementations</h1></header>
<p id="P70004970270000000000000000429CB" data-uri="chapter04.xhtml#P70004970270000000000000000429CB" class="pcalibre1 pcalibre calibre2">We have now created an overall structure for PIPE, our pipelined Y86-64 processor with forwarding. It uses the same set of hardware units as the earlier sequential designs, with the addition of pipeline registers, some reconfigured logic blocks, and additional pipeline control logic. In this section, we go through the design of the different logic blocks, deferring the design of the pipeline control logic to the next section. Many of the logic blocks are identical to their counterparts in SEQ and SEQ+, except that we must choose proper versions of the different signals from the pipeline registers (written with the pipeline register name, written in uppercase, as a prefix) or from the stage computations (written with the first character of the stage name, written in lowercase, as a prefix).</p>
<p id="P70004970270000000000000000429CC" data-uri="chapter04.xhtml#P70004970270000000000000000429CC" class="pcalibre1 pcalibre calibre2">As an example, compare the HCL code for the logic that generates the srcA signal in SEQ to the corresponding code in PIPE:</p>
<pre id="P70004970270000000000000000429CD" data-uri="chapter04.xhtml#P70004970270000000000000000429CD" class="calibre9 pcalibre pcalibre1"><code id="P70004970270000000000000000429CE" data-uri="chapter04.xhtml#P70004970270000000000000000429CE" class="calibre10 pcalibre pcalibre1"># Code from SEQ
word srcA = [
icode in { IRRMOVQ, IRMMOVQ, IOPQ, IPUSHQ } : rA;
icode in { IPOPQ, IRET } : RRSP;
1 : RNONE; # Don't need register
];
# Code from PIPE
word d_srcA = [
D_icode in { IRRMOVQ, IRMMOVQ, IOPQ, IPUSHQ } : D_rA;
D_icode in { IPOPQ, IRET } : RRSP;
1 : RNONE; # Don't need register
];
</code></pre>
<p id="P70004970270000000000000000429CF" data-uri="chapter04.xhtml#P70004970270000000000000000429CF" class="pcalibre1 pcalibre calibre2">They differ only in the prefixes added to the PIPE signals: <code id="P70004970270000000000000000429D0" data-uri="chapter04.xhtml#P70004970270000000000000000429D0" class="pcalibre1 calibre8 pcalibre">D_</code> for the source values, to indicate that the signals come from pipeline register D, and <code id="P70004970270000000000000000429D1" data-uri="chapter04.xhtml#P70004970270000000000000000429D1" class="pcalibre1 calibre8 pcalibre">d_</code> for the result value, to indicate that it is generated in the decode stage. To avoid repetition, we will not show the HCL code here for blocks that only differ from those in SEQ because of the prefixes on names. As a reference, the complete HCL code for PIPE is given in Web Aside <span class="smallcaps pcalibre pcalibre1">arch:hcl </span>on page 472.</p>
<section id="P70004970270000000000000000043B1" data-uri="chapter04.xhtml#P70004970270000000000000000043B1" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title5 pcalibre pcalibre1" id="P70004970270000000000000000429D2" data-uri="chapter04.xhtml#P70004970270000000000000000429D2" epub:type="title">PC Selection and Fetch Stage</h1></header>
<p id="P70004970270000000000000000429D3" data-uri="chapter04.xhtml#P70004970270000000000000000429D3" class="pcalibre1 pcalibre calibre2"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000043B4"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.57</span></a> provides a detailed view of the PIPE fetch stage logic. As discussed earlier, this stage must also select a current value for the program counter and predict the next PC value. The hardware units for reading the instruction from</p>

<figure class="pcalibre5 figure pcalibre" id="P70004970270000000000000000043B4" data-uri="chapter04.xhtml#P70004970270000000000000000043B4">
<span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000043B5" title="448" data-uri="chapter04.xhtml#P70004970270000000000000000043B5" epub:type="pagebreak"></span><img alt="A diagram illustrates structure between pipelines F and D." id="P70004970270000000000000000429D4" data-uri="P700049702700000000000000000B6FE" src="../images/p448-1.png" class="calibre155 pcalibre pcalibre1"/>
<figcaption id="P70004970270000000000000000429D5" data-uri="chapter04.xhtml#P70004970270000000000000000429D5" class="calibre11 pcalibre pcalibre1"><header class="pcalibre halftitlepage pcalibre1"><h1 class="title3 pcalibre pcalibre1" id="P70004970270000000000000000429D6" data-uri="chapter04.xhtml#P70004970270000000000000000429D6" epub:type="title"><span class="pcalibre1 label2 pcalibre">Figure </span><span class="number pcalibre pcalibre1">4.57 </span>PIPE PC selection and fetch logic.</h1></header>
<div class="edition pcalibre pcalibre1" id="P70004970270000000000000000429D7" data-uri="chapter04.xhtml#P70004970270000000000000000429D7"><p id="P70004970270000000000000000429D8" data-uri="chapter04.xhtml#P70004970270000000000000000429D8" class="pcalibre1 pcalibre calibre2"> Within the one cycle time limit, the processor can only predict the address of the next instruction.</p><p id="P70004970270000000000000000429D9" data-uri="chapter04.xhtml#P70004970270000000000000000429D9" class="pcalibre calibre3 pcalibre1">
</p></div>
<details class="longdesc pcalibre pcalibre1" id="P7000497027000000000000000022CB5" data-uri="chapter04.xhtml#P7000497027000000000000000022CB5">
<summary class="pcalibre6 pcalibre1 pcalibre calibre30"><span class="number pcalibre pcalibre1">Description</span></summary>
<p id="P70004970270000000000000000429DA" data-uri="chapter04.xhtml#P70004970270000000000000000429DA" class="pcalibre1 pcalibre calibre2">Pipelines F and D, from bottom to top, are summarized from left to right below.</p>
<ul id="P70004970270000000000000000429DB" data-uri="chapter04.xhtml#P70004970270000000000000000429DB" class="pcalibre calibre31 pcalibre1">
<li id="P70004970270000000000000000429DC" data-uri="chapter04.xhtml#P70004970270000000000000000429DC" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429DD" data-uri="chapter04.xhtml#P70004970270000000000000000429DD" class="pcalibre calibre3 pcalibre1">F: predPC with input from Predict PC and output to Select PC, which has the following inputs and outputs:</p>
<ul id="P70004970270000000000000000429DE" data-uri="chapter04.xhtml#P70004970270000000000000000429DE" class="pcalibre calibre39 pcalibre1">
<li id="P70004970270000000000000000429DF" data-uri="chapter04.xhtml#P70004970270000000000000000429DF" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429E0" data-uri="chapter04.xhtml#P70004970270000000000000000429E0" class="pcalibre calibre3 pcalibre1">Inputs M_icode, M_Cnd, M_valA, W_icode, W_valM</p></li>
<li id="P70004970270000000000000000429E1" data-uri="chapter04.xhtml#P70004970270000000000000000429E1" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429E2" data-uri="chapter04.xhtml#P70004970270000000000000000429E2" class="pcalibre calibre3 pcalibre1">Output f_pc to Instruction memory and PC increment</p></li>
</ul></li>
<li id="P70004970270000000000000000429E3" data-uri="chapter04.xhtml#P70004970270000000000000000429E3" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429E4" data-uri="chapter04.xhtml#P70004970270000000000000000429E4" class="pcalibre calibre3 pcalibre1">D:</p>
<ul id="P70004970270000000000000000429E5" data-uri="chapter04.xhtml#P70004970270000000000000000429E5" class="pcalibre calibre39 pcalibre1">
<li id="P70004970270000000000000000429E6" data-uri="chapter04.xhtml#P70004970270000000000000000429E6" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429E7" data-uri="chapter04.xhtml#P70004970270000000000000000429E7" class="pcalibre calibre3 pcalibre1">Stat: input from Stat, which has input from:</p>
<ul id="P70004970270000000000000000429E8" data-uri="chapter04.xhtml#P70004970270000000000000000429E8" class="calibre112 pcalibre pcalibre1">
<li id="P70004970270000000000000000429E9" data-uri="chapter04.xhtml#P70004970270000000000000000429E9" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429EA" data-uri="chapter04.xhtml#P70004970270000000000000000429EA" class="pcalibre calibre3 pcalibre1">Instr valid, from from icode, from split, which is byte 0 from instruction memory</p></li>
<li id="P70004970270000000000000000429EB" data-uri="chapter04.xhtml#P70004970270000000000000000429EB" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429EC" data-uri="chapter04.xhtml#P70004970270000000000000000429EC" class="pcalibre calibre3 pcalibre1">Icode</p></li>
</ul></li>
<li id="P70004970270000000000000000429ED" data-uri="chapter04.xhtml#P70004970270000000000000000429ED" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429EE" data-uri="chapter04.xhtml#P70004970270000000000000000429EE" class="pcalibre calibre3 pcalibre1">Icode: input from icode, which also has output to the following:</p>
<ul id="P70004970270000000000000000429EF" data-uri="chapter04.xhtml#P70004970270000000000000000429EF" class="calibre112 pcalibre pcalibre1">
<li id="P70004970270000000000000000429F0" data-uri="chapter04.xhtml#P70004970270000000000000000429F0" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429F1" data-uri="chapter04.xhtml#P70004970270000000000000000429F1" class="pcalibre calibre3 pcalibre1">Predict PC, with inputs from Align (bytes 1–9 from instruction memory), and output to predPC</p></li>
<li id="P70004970270000000000000000429F2" data-uri="chapter04.xhtml#P70004970270000000000000000429F2" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429F3" data-uri="chapter04.xhtml#P70004970270000000000000000429F3" class="pcalibre calibre3 pcalibre1">Need valC, with output to PC increment</p></li>
<li id="P70004970270000000000000000429F4" data-uri="chapter04.xhtml#P70004970270000000000000000429F4" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429F5" data-uri="chapter04.xhtml#P70004970270000000000000000429F5" class="pcalibre calibre3 pcalibre1">Needs regids, with output to PC increments and align</p></li>
</ul></li>
<li id="P70004970270000000000000000429F6" data-uri="chapter04.xhtml#P70004970270000000000000000429F6" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429F7" data-uri="chapter04.xhtml#P70004970270000000000000000429F7" class="pcalibre calibre3 pcalibre1">Ifun: from ifun from split</p></li>
<li id="P70004970270000000000000000429F8" data-uri="chapter04.xhtml#P70004970270000000000000000429F8" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429F9" data-uri="chapter04.xhtml#P70004970270000000000000000429F9" class="pcalibre calibre3 pcalibre1">rA from align</p></li>
<li id="P70004970270000000000000000429FA" data-uri="chapter04.xhtml#P70004970270000000000000000429FA" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429FB" data-uri="chapter04.xhtml#P70004970270000000000000000429FB" class="pcalibre calibre3 pcalibre1">rB from align</p></li>
<li id="P70004970270000000000000000429FC" data-uri="chapter04.xhtml#P70004970270000000000000000429FC" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429FD" data-uri="chapter04.xhtml#P70004970270000000000000000429FD" class="pcalibre calibre3 pcalibre1">valC from align</p></li>
<li id="P70004970270000000000000000429FE" data-uri="chapter04.xhtml#P70004970270000000000000000429FE" class="calibre12 pcalibre pcalibre1"><p id="P70004970270000000000000000429FF" data-uri="chapter04.xhtml#P70004970270000000000000000429FF" class="pcalibre calibre3 pcalibre1">valP from PC increment</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre1 pcalibre calibre2" id="P7000497027000000000000000042A00" data-uri="chapter04.xhtml#P7000497027000000000000000042A00">memory and for extracting the different instruction fields are the same as those we considered for SEQ (see the fetch stage in <a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004038"><span class="pcalibre label pcalibre1">Section </span><span class="pcalibre label pcalibre1">4.3.4</span></a>).</p>
<p id="P7000497027000000000000000042A01" data-uri="chapter04.xhtml#P7000497027000000000000000042A01" class="pcalibre1 pcalibre calibre2">The PC selection logic chooses between three program counter sources. As a mispredicted branch enters the memory stage, the value of valP for this instruction (indicating the address of the following instruction) is read from pipeline register M (signal M_valA). When a <code id="P7000497027000000000000000042A02" data-uri="chapter04.xhtml#P7000497027000000000000000042A02" class="pcalibre1 calibre8 pcalibre">ret</code> instruction enters the write-back stage, the return address is read from pipeline register W (signal W_valM). All other cases use the predicted value of the PC, stored in pipeline register F (signal F_predPC):</p>
<pre id="P7000497027000000000000000042A03" data-uri="chapter04.xhtml#P7000497027000000000000000042A03" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000042A04" data-uri="chapter04.xhtml#P7000497027000000000000000042A04" class="calibre10 pcalibre pcalibre1">word f_pc = [
	# Mispredicted branch. Fetch at incremented PC
	M_icode == IJXX &amp;&amp; !M_Cnd : M_valA;
	# Completion of RET instruction
	W_icode == IRET : W_valM;
	# Default: Use predicted value of PC
	1 : F_predPC;
];
</code></pre>

<p id="P7000497027000000000000000042A05" data-uri="chapter04.xhtml#P7000497027000000000000000042A05" class="pcalibre1 pcalibre calibre2"><span class="pcalibre pagebreak pcalibre1" id="P70004970270000000000000000043C1" title="449" data-uri="chapter04.xhtml#P70004970270000000000000000043C1" epub:type="pagebreak"></span>The PC prediction logic chooses valC for the fetched instruction when it is either a call or a jump, and valP otherwise:</p>
<pre id="P7000497027000000000000000042A06" data-uri="chapter04.xhtml#P7000497027000000000000000042A06" class="calibre9 pcalibre pcalibre1"><code id="P7000497027000000000000000042A07" data-uri="chapter04.xhtml#P7000497027000000000000000042A07" class="calibre10 pcalibre pcalibre1">word f_predPC = [
	f_icode in { IJXX, ICALL } : f_valC;
	1 : f_valP;
];
</code></pre>
<p id="P7000497027000000000000000042A08" data-uri="chapter04.xhtml#P7000497027000000000000000042A08" class="pcalibre1 pcalibre calibre2">The logic blocks labeled "Instr valid," "Need regids," and "Need valC" are the same as for SEQ, with appropriately named source signals.</p>
<p id="P7000497027000000000000000042A09" data-uri="chapter04.xhtml#P7000497027000000000000000042A09" class="pcalibre1 pcalibre calibre2">Unlike in SEQ, we must split the computation of the instruction status into two parts. In the fetch stage, we can test for a memory error due to an out-of-range instruction address, and we can detect an illegal instruction or a halt instruction. Detecting an invalid data address must be deferred to the memory stage.</p>
<section id="P70004970270000000000000000043C6" data-uri="chapter04.xhtml#P70004970270000000000000000043C6" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title10 pcalibre pcalibre1" id="P7000497027000000000000000042A0A" data-uri="chapter04.xhtml#P7000497027000000000000000042A0A" epub:type="title"><span class="pcalibre label pcalibre1">Practice Problem </span><span class="pcalibre label pcalibre1">4.30 </span>(solution page <a class="ulink pcalibre pcalibre4 pcalibre2 pcalibre3 pcalibre1" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000480E">490</a>)</h1></header>
<p id="P7000497027000000000000000042A0B" data-uri="chapter04.xhtml#P7000497027000000000000000042A0B" class="pcalibre1 pcalibre calibre2">Write HCL code for the signal f_stat, providing the provisional status for the fetched instruction.</p>
</section>
</section>
<section id="P70004970270000000000000000043C9" data-uri="chapter04.xhtml#P70004970270000000000000000043C9" class="pcalibre halftitlepage pcalibre1"><header class="calibre1 pcalibre pcalibre1"><h1 class="title5 pcalibre pcalibre1" id="P7000497027000000000000000042A0C" data-uri="chapter04.xhtml#P7000497027000000000000000042A0C" epub:type="title">Decode and Write-Back Stages</h1></header>
<p id="P7000497027000000000000000042A0D" data-uri="chapter04.xhtml#P7000497027000000000000000042A0D" class="pcalibre1 pcalibre calibre2"><a class="pcalibre xref1 pcalibre4 pcalibre2 pcalibre3 pcalibre1" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000043D2"><span class="pcalibre label pcalibre1">Figure </span><span class="pcalibre label pcalibre1">4.58</span></a> gives a detailed view of the decode and write-back logic for PIPE. The blocks labeled dstE, dstM, srcA, and srcB are very similar to their counterparts in the implementation of SEQ. Observe that the register IDs supplied to the write ports come from the write-back stage (signals W_dstE and W_dstM), rather than from the decode stage. This is because we want the writes to occur to the destination registers specified by the instruction in the write-back stage.</p>
</section>
</section>

</section></body></html>
