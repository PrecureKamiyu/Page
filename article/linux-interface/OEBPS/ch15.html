<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:pls="http://www.w3.org/2005/01/pronunciation-lexicon" xmlns:ssml="http://www.w3.org/2001/10/synthesis" xmlns:svg="http://www.w3.org/2000/svg"><head><title>Chapter 15. File Attributes</title><link rel="stylesheet" type="text/css" href="core.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"/><link rel="up" href="index.html" title="The Linux Programming Interface"/><link rel="prev" href="ch14.html" title="Chapter 14. File Systems"/><link rel="next" href="ch16.html" title="Chapter 16. Extended Attributes"/></head><body><section class="chapter" title="Chapter 15. File Attributes" epub:type="chapter" id="file_attributes"><div class="titlepage"><div><div><h2 class="title">Chapter 15. File Attributes</h2></div></div></div><p>In this chapter, we investigate various attributes of files (file metadata). We begin
            with a description of the <span class="emphasis"><em>stat()</em></span> system call, which returns a
            structure containing many of these attributes, including file timestamps, file
            ownership, and file permissions. We then go on to look at various system calls used to
            change these attributes. (The discussion of file permissions continues in <a class="xref" href="ch17.html" title="Chapter 17. Access Control Lists">Chapter 17</a>, where we look at access control lists.) We
            conclude the chapter with a discussion of i-node flags (also known as
                <span class="emphasis"><em>ext2</em></span> extended file attributes), which control various aspects
            of the treatment of files by the kernel.<a id="IDX-CHP-15-1906" class="indexterm"/></p><div class="sect1" title="Retrieving File Information: stat()"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="retrieving_file_information_colon_stat_o">Retrieving File Information: <span class="emphasis"><em>stat()</em></span></h2></div></div></div><p>The <span class="emphasis"><em>stat()</em></span>, <span class="emphasis"><em>lstat()</em></span>, and
                    <span class="emphasis"><em>fstat()</em></span> system calls retrieve information about a file,
                mostly drawn from the file i-node.<a id="IDX-CHP-15-1907" class="indexterm"/><a id="IDX-CHP-15-1908" class="indexterm"/><a id="IDX-CHP-15-1909" class="indexterm"/><a id="IDX-CHP-15-1910" class="indexterm"/><a id="IDX-CHP-15-1911" class="indexterm"/><a id="IDX-CHP-15-1912" class="indexterm"/><a id="IDX-CHP-15-1913" class="indexterm"/></p><a id="I_programlisting15_d1e35438"/><pre class="programlisting">#include &lt;sys/stat.h&gt;

int <strong class="userinput"><code>stat</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, struct stat *<span class="emphasis"><em>statbuf</em></span>);
int <strong class="userinput"><code>lstat</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, struct stat *<span class="emphasis"><em>statbuf</em></span>);
int <strong class="userinput"><code>fstat</code></strong>(int <span class="emphasis"><em>fd</em></span>, struct stat *<span class="emphasis"><em>statbuf</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>All return 0 on success, or -1 on error</p></div><p>These three system calls differ only in the way that the file is specified:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>stat()</em></span> returns information about a named file;</p></li><li class="listitem"><p><span class="emphasis"><em>lstat()</em></span> is similar to <span class="emphasis"><em>stat()</em></span>,
                        except that if the named file is a symbolic link, information about the link
                        itself is returned, rather than the file to which the link points;
                        and</p></li><li class="listitem"><p><span class="emphasis"><em>fstat()</em></span> returns information about a file referred to
                        by an open file descriptor.</p></li></ul></div><p>The <span class="emphasis"><em>stat()</em></span> and <span class="emphasis"><em>lstat()</em></span> system calls
                don’t require permissions on the file itself. However, execute (search) permission
                is required on all of the parent directories specified in
                    <span class="emphasis"><em>pathname</em></span>. The <span class="emphasis"><em>fstat()</em></span> system call
                always succeeds, if provided with a valid file descriptor.</p><p>All of these system calls return a <span class="emphasis"><em>stat</em></span> structure in the
                buffer pointed to by <span class="emphasis"><em>statbuf</em></span>. This structure has the following
                    form:<a id="IDX-CHP-15-1914" class="indexterm"/></p><a id="I_programlisting15_d1e35519"/><pre class="programlisting">struct stat {
    dev_t     st_dev;         /* IDs of device on which file resides */
    ino_t     st_ino;         /* I-node number of file */
    mode_t    st_mode;        /* File type and permissions */
    nlink_t   st_nlink;       /* Number of (hard) links to file */
    uid_t     st_uid;         /* User ID of file owner */
    gid_t     st_gid;         /* Group ID of file owner */
    dev_t     st_rdev;        /* IDs for device special files */
    off_t     st_size;        /* Total file size (bytes) */
    blksize_t st_blksize;     /* Optimal block size for I/O (bytes) */
    blkcnt_t  st_blocks;      /* Number of (512B) blocks allocated */
    time_t    st_atime;       /* Time of last file access */
    time_t    st_mtime;       /* Time of last file modification */
    time_t    st_ctime;       /* Time of last status change */
};</pre><p>The various data types used to type the fields in the <span class="emphasis"><em>stat</em></span>
                structure are all specified in SUSv3. See <a class="xref" href="ch03.html#system_data_types" title="System Data Types">System Data Types</a> for
                further information about these types.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>According to SUSv3, when <span class="emphasis"><em>lstat()</em></span> is applied to a symbolic
                    link, it needs to return valid information only in the
                        <span class="emphasis"><em>st_size</em></span> field and in the file type component (described
                    shortly) of the <span class="emphasis"><em>st_mode</em></span> field. None of other fields (e.g.,
                    the time fields) need contain valid information. This gives an implementation
                    the freedom to not maintain these fields, which may be done for efficiency
                    reasons. In particular, the intent of earlier UNIX standards was to allow a
                    symbolic link to be implemented either as an i-node or as an entry in a
                    directory. Under the latter implementation, it is not possible to implement all
                    of the fields required by the <span class="emphasis"><em>stat</em></span> structure. (On all major
                    contemporary UNIX implementations, symbolic links are implemented as i-nodes.
                    See <a class="xref" href="ch18.html#symbolic_open_parenthesis_soft_close_par" title="Symbolic (Soft) Links">Symbolic (Soft) Links</a> for further
                    details.) On Linux, <span class="emphasis"><em>lstat()</em></span> returns information in all of
                    the <span class="emphasis"><em>stat</em></span> fields when applied to a symbolic link.</p></div><p>In the following pages, we look at some of the <span class="emphasis"><em>stat</em></span> structure
                fields in more detail, and finish with an example program that displays the entire
                    <span class="emphasis"><em>stat</em></span> structure.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="device_ids_and_i-node_number"/></div></div></div><div class="sect3" title="Device IDs and i-node number"><div class="titlepage"><div><div><h4 class="title" id="device_ids_and_i-node_number-id1">Device IDs and i-node number</h4></div></div></div><p>The <span class="emphasis"><em>st_dev</em></span> field identifies the device on which the
                        file resides. The <span class="emphasis"><em>st_ino</em></span> field contains the i-node
                        number of the file. The combination of <span class="emphasis"><em>st_dev</em></span> and
                            <span class="emphasis"><em>st_ino</em></span> uniquely identifies a file across all file
                        systems. The <span class="emphasis"><em>dev_t</em></span> type records the major and minor IDs
                        of a device (<a class="xref" href="ch14.html#device_special_files_open_parenthesis_de" title="Device Special Files (Devices)">Device Special Files (Devices)</a>).<a id="IDX-CHP-15-1915" class="indexterm"/><a id="IDX-CHP-15-1916" class="indexterm"/></p><p>If this is the i-node for a device, then the <span class="emphasis"><em>st_rdev</em></span>
                        field contains the major and minor IDs of the device.</p><p>The major and minor IDs of a <span class="emphasis"><em>dev_t</em></span> value can be
                        extracted using two macros: <code class="literal">major()</code> and
                            <code class="literal">minor()</code>. The header file required to
                        obtain the declarations of these two macros varies across UNIX
                        implementations. On Linux, they are exposed by <code class="literal">&lt;sys/types.h&gt;</code> if the <code class="literal">_BSD_SOURCE</code> macro is defined.<a id="IDX-CHP-15-1917" class="indexterm"/><a id="IDX-CHP-15-1918" class="indexterm"/></p><p>The size of the integer values returned by <code class="literal">major()</code> and <code class="literal">minor()</code> varies
                        across UNIX implementations. For portability, we always cast the returned
                        values to <span class="emphasis"><em>long</em></span> when printing them (see <a class="xref" href="ch03.html#system_data_types" title="System Data Types">System Data Types</a>).</p></div><div class="sect3" title="File ownership"><div class="titlepage"><div><div><h4 class="title" id="file_ownership">File ownership</h4></div></div></div><p>The <span class="emphasis"><em>st_uid</em></span> and <span class="emphasis"><em>st_gid</em></span> fields
                        identify, respectively, the owner (user ID) and group (group ID) to which
                        the file belongs.<a id="IDX-CHP-15-1919" class="indexterm"/><a id="IDX-CHP-15-1920" class="indexterm"/><a id="IDX-CHP-15-1921" class="indexterm"/><a id="IDX-CHP-15-1922" class="indexterm"/><a id="IDX-CHP-15-1923" class="indexterm"/><a id="IDX-CHP-15-1924" class="indexterm"/><a id="IDX-CHP-15-1925" class="indexterm"/><a id="IDX-CHP-15-1926" class="indexterm"/></p></div><div class="sect3" title="Link count"><div class="titlepage"><div><div><h4 class="title" id="link_count">Link count</h4></div></div></div><p>The <span class="emphasis"><em>st_nlink</em></span> field is the number of (hard) links to
                        the file. We describe links in detail in <a class="xref" href="ch18.html" title="Chapter 18. Directories and Links">Chapter 18</a>.</p></div><div class="sect3" title="File type and permissions"><div class="titlepage"><div><div><h4 class="title" id="file_type_and_permissions">File type and permissions</h4></div></div></div><p>The <span class="emphasis"><em>st_mode</em></span> field is a bit mask serving the dual
                        purpose of identifying the file type and specifying the file permissions.
                        The bits of this field are laid out as shown in <a class="xref" href="ch15.html#layout_of_st_underscore_mode_bit_mask" title="Figure 15-1. Layout of st_mode bit mask">Figure 15-1</a>.<a id="IDX-CHP-15-1927" class="indexterm"/></p><div class="figure"><a id="layout_of_st_underscore_mode_bit_mask"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject15_d1e35719"/><img src="figs/web/15-1_FILES-st_mode.png.jpg" alt="Layout of st_mode bit mask"/></div></div><div class="figure-title">Figure 15-1. Layout of <span class="emphasis"><em>st_mode</em></span> bit mask</div></div><p>The file type can be extracted from this field by ANDing (<code class="literal">&amp;</code>) with the constant <code class="literal">S_IFMT</code>. (On Linux, 4 bits are used for the
                        file-type component of the <span class="emphasis"><em>st_mode</em></span> field. However,
                        because SUSv3 makes no specification about how the file type is represented,
                        this detail may vary across implementations.) The resulting value can then
                        be compared with a range of constants to determine the file type, like
                        so:</p><a id="I_programlisting15_d1e35735"/><pre class="programlisting">if ((statbuf.st_mode &amp; S_IFMT) == S_IFREG)
    printf("regular file\n");</pre><p>Because this is a common operation, standard macros are provided to
                        simplify the above to the following:</p><a id="I_programlisting15_d1e35739"/><pre class="programlisting">if (S_ISREG(statbuf.st_mode))
    printf("regular file\n");</pre><p>The full set of file-type macros (defined in <code class="literal">&lt;sys/stat.h&gt;</code>) is shown in <a class="xref" href="ch15.html#macros_for_checking_file_types_in_the_st" title="Table 15-1. Macros for checking file types in the st_mode field of the stat structure">Table 15-1</a>. All of the
                        file-type macros in <a class="xref" href="ch15.html#macros_for_checking_file_types_in_the_st" title="Table 15-1. Macros for checking file types in the st_mode field of the stat structure">Table 15-1</a> are specified in SUSv3 and appear on Linux. Some other UNIX
                        implementations define additional file types (e.g., <code class="literal">S_IFDOOR</code>, for door files on Solaris). The type <code class="literal">S_IFLNK</code> is returned only by calls to
                            <span class="emphasis"><em>lstat()</em></span>, since calls to <span class="emphasis"><em>stat()</em></span>
                        always follow symbolic links.</p><p>The original POSIX.1 standard did not specify the constants shown in the
                        first column of <a class="xref" href="ch15.html#macros_for_checking_file_types_in_the_st" title="Table 15-1. Macros for checking file types in the st_mode field of the stat structure">Table 15-1</a>,
                        although most of them appeared on most UNIX implementations. SUSv3 requires
                        these constants.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>In order to obtain the definitions of <code class="literal">S_IFSOCK</code> and <code class="literal">S_ISSOCK()</code> from <code class="literal">&lt;sys/stat.h&gt;</code>, we must either define the
                                <code class="literal">_BSD_SOURCE</code> feature test macro or
                            define <code class="literal">_XOPEN_SOURCE</code> with a value
                            greater than or equal to 500. (The rules have varied somewhat across
                                <span class="emphasis"><em>glibc</em></span> versions: in some cases, <code class="literal">_XOPEN_SOURCE</code> must be defined with a value
                            of 600 or greater.)<a id="IDX-CHP-15-1928" class="indexterm"/></p></div><div class="table"><a id="macros_for_checking_file_types_in_the_st"/><div class="table-title">Table 15-1. Macros for checking file types in the <span class="emphasis"><em>st_mode</em></span>
                            field of the <span class="emphasis"><em>stat</em></span> structure</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/><col class="col3"/></colgroup><thead><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>Constant</p>
                                    </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>Test macro</p>
                                    </td><td style="text-align: left; vertical-align: bottom; border-bottom: 0.5pt solid ; ">
                                        <p>File type</p>
                                    </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFREG</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISREG()</code>
                                            <a id="IDX-CHP-15-1929" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>Regular file</p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFDIR</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISDIR()</code>
                                            <a id="IDX-CHP-15-1930" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>Directory</p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFCHR</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISCHR()</code>
                                            <a id="IDX-CHP-15-1931" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>Character device</p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFBLK</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISBLK()</code>
                                            <a id="IDX-CHP-15-1932" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>Block device</p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFIFO</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISFIFO()</code>
                                            <a id="IDX-CHP-15-1933" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>FIFO or pipe<a id="IDX-CHP-15-1935" class="indexterm"/><a id="IDX-CHP-15-1934" class="indexterm"/></p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFSOCK</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISSOCK()</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                        <p>Socket</p>
                                    </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_IFLNK</code>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                        <p>
                                            <code class="literal">S_ISLNK()</code>
                                            <a id="IDX-CHP-15-1936" class="indexterm"/>
                                        </p>
                                    </td><td style="text-align: left; vertical-align: top; ">
                                        <p>Symbolic link</p>
                                    </td></tr></tbody></table></div></div><p>The bottom 12 bits of the <span class="emphasis"><em>st_mode</em></span> field define the
                        permissions for the file. We describe the file permission bits in Section
                        15.4. For now, we simply note that the 9 least significant of the permission
                        bits are the read, write, and execute permissions for each of the categories
                        owner, group, and other.</p></div><div class="sect3" title="File size, blocks allocated, and optimal I/O block size"><div class="titlepage"><div><div><h4 class="title" id="file_size_comma_blocks_allocated_comma_a">File size, blocks allocated, and optimal I/O block size</h4></div></div></div><p>For regular files, the <span class="emphasis"><em>st_size</em></span> field is the total
                        size of the file in bytes. For a symbolic link, this field contains the
                        length (in bytes) of the pathname pointed to by the link. For a shared
                        memory object (<a class="xref" href="ch54.html" title="Chapter 54. POSIX Shared Memory">Chapter 54</a>), this field contains
                        the size of the object.<a id="IDX-CHP-15-1938" class="indexterm"/><a id="IDX-CHP-15-1939" class="indexterm"/><a id="IDX-CHP-15-1940" class="indexterm"/><a id="IDX-CHP-15-1941" class="indexterm"/><a id="IDX-CHP-15-1942" class="indexterm"/><a id="IDX-CHP-15-1943" class="indexterm"/><a id="IDX-CHP-15-1944" class="indexterm"/><a id="IDX-CHP-15-1945" class="indexterm"/><a id="IDX-CHP-15-1946" class="indexterm"/><a id="IDX-CHP-15-1947" class="indexterm"/><a id="IDX-CHP-15-1948" class="indexterm"/><a id="IDX-CHP-15-1949" class="indexterm"/><a id="IDX-CHP-15-1950" class="indexterm"/><a id="IDX-CHP-15-1951" class="indexterm"/><a id="IDX-CHP-15-1952" class="indexterm"/><a id="IDX-CHP-15-1953" class="indexterm"/><a id="IDX-CHP-15-1937" class="indexterm"/><a id="IDX-CHP-15-1954" class="indexterm"/></p><p>The <span class="emphasis"><em>st_blocks</em></span> field indicates the total number of
                        blocks allocated to the file, in 512-byte block units. This total includes
                        space allocated for pointer blocks (see <a class="xref" href="ch14.html#structure_of_file_blocks_for_a_file_in_a" title="Figure 14-2. Structure of file blocks for a file in an ext2 file system">Figure 14-2</a>, in <a class="xref" href="ch14.html#i-nodes_and_data_block_pointers_in-id1" title="I-nodes and data block pointers in ext2">I-nodes and data block pointers in <span class="emphasis"><em>ext2</em></span></a>). The choice of the
                        512-byte unit of measurement is historical—this is the smallest block size
                        on any of the file systems that have been implemented under UNIX. More
                        modern file systems use larger logical block sizes. For example, under
                            <span class="emphasis"><em>ext2</em></span>, the value in <span class="emphasis"><em>st_blocks</em></span>
                        is always a multiple of 2, 4, or 8, depending on whether the
                            <span class="emphasis"><em>ext2</em></span> logical block size is 1024, 2048, or 4096
                            bytes.<a id="IDX-CHP-15-1955" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>SUSv3 doesn’t define the units in which <span class="emphasis"><em>st_blocks</em></span>
                            is measured, allowing the possibility that an implementation uses a unit
                            other than 512 bytes. Most UNIX implementations do use 512-byte units,
                            but HP-UX 11 uses file system–specific units (e.g., 1024 bytes in some
                            cases).</p></div><p>The <span class="emphasis"><em>st_blocks</em></span> field records the number of disk blocks
                        actually allocated. If the file contains holes (<a class="xref" href="ch04.html#changing_the_file_offset_colon_lseek_ope" title="Changing the File Offset: lseek()">Changing the File Offset: <span class="emphasis"><em>lseek()</em></span></a>), this will be
                        smaller than might be expected from the corresponding number of bytes
                            <span class="emphasis"><em>(st_size)</em></span> in the file. (The disk usage command,
                            <span class="emphasis"><em>du -k file</em></span>, displays the actual space allocated for
                        a file, in kilobytes; that is, a figure calculated from the
                            <span class="emphasis"><em>st_blocks</em></span> value for the file, rather than the
                            <span class="emphasis"><em>st_size</em></span> value.)</p><p>The <span class="emphasis"><em>st_blksize</em></span> field is somewhat misleadingly named.
                        It is not the block size of the underlying file system, but rather the
                        optimal block size (in bytes) for I/O on files on this file system. I/O in
                        blocks smaller than this size is less efficient (refer to <a class="xref" href="ch13.html#kernel_buffering_of_file_i_solidus_o_col" title="Kernel Buffering of File I/O: The Buffer Cache">Kernel Buffering of File I/O: The Buffer Cache</a>). A typical value
                        returned in <span class="emphasis"><em>st_blksize</em></span> is 4096.</p></div><div class="sect3" title="File timestamps"><div class="titlepage"><div><div><h4 class="title" id="file_timestamps">File timestamps</h4></div></div></div><p>The <span class="emphasis"><em>st_atime</em></span>, <span class="emphasis"><em>st_mtime</em></span>, and
                            <span class="emphasis"><em>st_ctime</em></span> fields contain, respectively, the times of
                        last file access, last file modification, and last status change. These
                        fields are of type <span class="emphasis"><em>time_t</em></span>, the standard UNIX time
                        format of seconds since the Epoch. We say more about these fields in Section
                            15.2.<a id="IDX-CHP-15-1956" class="indexterm"/><a id="IDX-CHP-15-1957" class="indexterm"/><a id="IDX-CHP-15-1958" class="indexterm"/><a id="IDX-CHP-15-1959" class="indexterm"/><a id="IDX-CHP-15-1960" class="indexterm"/><a id="IDX-CHP-15-1961" class="indexterm"/><a id="IDX-CHP-15-1962" class="indexterm"/><a id="IDX-CHP-15-1963" class="indexterm"/><a id="IDX-CHP-15-1964" class="indexterm"/><a id="IDX-CHP-15-1965" class="indexterm"/></p></div><div class="sect3" title="Example program"><div class="titlepage"><div><div><h4 class="title" id="example_program-id13">Example program</h4></div></div></div><p>The program in <a class="xref" href="ch15.html#retrieving_and_interpreting_file_stat_in" title="Example 15-1. Retrieving and interpreting file stat information">Example 15-1</a>
                        uses <span class="emphasis"><em>stat()</em></span> to retrieve information about the file
                        named on its command line. If the <span class="emphasis"><em>-l</em></span> command-line
                        option is specified, then the program instead uses
                            <span class="emphasis"><em>lstat()</em></span> so that we can retrieve information about a
                        symbolic link instead of the file to which it refers. The program prints all
                        fields of the returned <span class="emphasis"><em>stat</em></span> structure. (For an
                        explanation of why we cast the <span class="emphasis"><em>st_size</em></span> and
                            <span class="emphasis"><em>st_blocks</em></span> fields to <span class="emphasis"><em>long long</em></span>,
                        see <a class="xref" href="ch05.html#i_solidus_o_on_large_files" title="I/O on Large Files">I/O on Large Files</a>.) The
                            <span class="emphasis"><em>filePermStr()</em></span> function used by this program is
                        shown in <a class="xref" href="ch15.html#convert_file_permissions_mask_to_string" title="Example 15-4. Convert file permissions mask to string">Example 15-4</a>, in <a class="xref" href="ch15.html#permissions_on_directories" title="Permissions on Directories">Permissions on Directories</a>.<a id="IDX-CHP-15-1966" class="indexterm"/><a id="IDX-CHP-15-1967" class="indexterm"/><a id="IDX-CHP-15-1968" class="indexterm"/><a id="IDX-CHP-15-1969" class="indexterm"/><a id="IDX-CHP-15-1970" class="indexterm"/></p><p>Here is an example of the use of the program:</p><a id="I_programlisting15_d1e36215"/><pre class="programlisting">$ <strong class="userinput"><code>echo 'All operating systems provide services for programs they run' &gt; apue</code></strong>
$ <strong class="userinput"><code>chmod g+s apue</code></strong>        <em class="lineannotation"><span class="lineannotation">Turn on set-group-ID bit; affects last status change time</span></em>
$ <strong class="userinput"><code>cat apue</code></strong>              <em class="lineannotation"><span class="lineannotation">Affects last file access time</span></em>
All operating systems provide services for programs they run
$ <strong class="userinput"><code>./t_stat apue</code></strong>
File type:                regular file
Device containing i-node: major=3   minor=11
I-node number:            234363
Mode:                     102644 (rw-r--r--)
    special bits set:     set-GID
Number of (hard) links:   1
Ownership:                UID=1000   GID=100
File size:                61 bytes
Optimal I/O block size:   4096 bytes
512B blocks allocated:    8
Last file access:         Mon Jun  8 09:40:07 2011
Last file modification:   Mon Jun  8 09:39:25 2011
Last status change:       Mon Jun  8 09:39:51 2011</pre><div class="example"><a id="retrieving_and_interpreting_file_stat_in"/><div class="example-title">Example 15-1. Retrieving and interpreting file <span class="emphasis"><em>stat</em></span>
                            information</div><div class="example-contents"><pre class="programlisting"><strong class="userinput"><code>files/t_stat.c</code></strong>
#define _BSD_SOURCE     /* Get major() and minor() from &lt;sys/types.h&gt; */
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;time.h&gt;
#include "file_perms.h"
#include "tlpi_hdr.h"

static void
displayStatInfo(const struct stat *sb)
{
    printf("File type:                ");

    switch (sb-&gt;st_mode &amp; S_IFMT) {
    case S_IFREG:  printf("regular file\n");            break;
    case S_IFDIR:  printf("directory\n");               break;
    case S_IFCHR:  printf("character device\n");        break;
    case S_IFBLK:  printf("block device\n");            break;
    case S_IFLNK:  printf("symbolic (soft) link\n");    break;
    case S_IFIFO:  printf("FIFO or pipe\n");            break;
    case S_IFSOCK: printf("socket\n");                  break;
    default:       printf("unknown file type?\n");      break;
    }

    printf("Device containing i-node: major=%ld   minor=%ld\n",
                (long) major(sb-&gt;st_dev), (long) minor(sb-&gt;st_dev));

    printf("I-node number:            %ld\n", (long) sb-&gt;st_ino);

    printf("Mode:                     %lo (%s)\n",
            (unsigned long) sb-&gt;st_mode, filePermStr(sb-&gt;st_mode, 0));

    if (sb-&gt;st_mode &amp; (S_ISUID | S_ISGID | S_ISVTX))
        printf("    special bits set:     %s%s%s\n",
                (sb-&gt;st_mode &amp; S_ISUID) ? "set-UID " : "",
                (sb-&gt;st_mode &amp; S_ISGID) ? "set-GID " : "",
                (sb-&gt;st_mode &amp; S_ISVTX) ? "sticky " : "");

    printf("Number of (hard) links:   %ld\n", (long) sb-&gt;st_nlink);

    printf("Ownership:                UID=%ld   GID=%ld\n",
            (long) sb-&gt;st_uid, (long) sb-&gt;st_gid);

    if (S_ISCHR(sb-&gt;st_mode) || S_ISBLK(sb-&gt;st_mode))
        printf("Device number (st_rdev):  major=%ld; minor=%ld\n",
                (long) major(sb-&gt;st_rdev), (long) minor(sb-&gt;st_rdev));

    printf("File size:                %lld bytes\n", (long long) sb-&gt;st_size);
    printf("Optimal I/O block size:   %ld bytes\n", (long) sb-&gt;st_blksize);
    printf("512B blocks allocated:    %lld\n", (long long) sb-&gt;st_blocks);

    printf("Last file access:         %s", ctime(&amp;sb-&gt;st_atime));
    printf("Last file modification:   %s", ctime(&amp;sb-&gt;st_mtime));
    printf("Last status change:       %s", ctime(&amp;sb-&gt;st_ctime));
}

int
main(int argc, char *argv[])
{
    struct stat sb;
    Boolean statLink;           /* True if "-l" specified (i.e., use lstat) */
    int fname;                  /* Location of filename argument in argv[] */

    statLink = (argc &gt; 1) &amp;&amp; strcmp(argv[1], "-l") == 0;
                                /* Simple parsing for "-l" */
    fname = statLink ? 2 : 1;

    if (fname &gt;= argc || (argc &gt; 1 &amp;&amp; strcmp(argv[1], "--help") == 0))
        usageErr("%s [-l] file\n"
                "        -l = use lstat() instead of stat()\n", argv[0]);

    if (statLink) {
        if (lstat(argv[fname], &amp;sb) == -1)
            errExit("lstat");
    } else {
        if (stat(argv[fname], &amp;sb) == -1)
            errExit("stat");
    }

    displayStatInfo(&amp;sb);

    exit(EXIT_SUCCESS);
}
      <strong class="userinput"><code>files/t_stat.c</code></strong></pre></div></div></div></div></div><div class="sect1" title="File Timestamps"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="file_timestamps-id1">File Timestamps</h2></div></div></div><p>The <span class="emphasis"><em>st_atime</em></span>, <span class="emphasis"><em>st_mtime</em></span>, and
                    <span class="emphasis"><em>st_ctime</em></span> fields of the <span class="emphasis"><em>stat</em></span> structure
                contain file timestamps. These fields record, respectively, the times of last file
                access, last file modification, and last file status change (i.e., last change to
                the file’s i-node information). Timestamps are recorded in seconds since the Epoch
                (1 January 1970; see <a class="xref" href="ch10.html#calendar_time" title="Calendar Time">Calendar Time</a>).<a id="IDX-CHP-15-1972" class="indexterm"/><a id="IDX-CHP-15-1973" class="indexterm"/><a id="IDX-CHP-15-1974" class="indexterm"/><a id="IDX-CHP-15-1975" class="indexterm"/><a id="IDX-CHP-15-1976" class="indexterm"/><a id="IDX-CHP-15-1977" class="indexterm"/><a id="IDX-CHP-15-1978" class="indexterm"/><a id="IDX-CHP-15-1979" class="indexterm"/><a id="IDX-CHP-15-1980" class="indexterm"/><a id="IDX-CHP-15-1971" class="indexterm"/></p><p>Most native Linux and UNIX file systems support all of the timestamp fields, but
                some non-UNIX file systems may not.</p><p><a class="xref" href="ch15.html#effect_of_various_functions_on_file_time" title="Table 15-2. Effect of various functions on file timestamps">Table 15-2</a> summarizes which of the
                timestamp fields (and in some cases, the analogous fields in the parent directory)
                are changed by various system calls and library functions described in this book. In
                the headings of this table, <span class="emphasis"><em>a</em></span>, <span class="emphasis"><em>m</em></span>, and
                    <span class="emphasis"><em>c</em></span> represent the <span class="emphasis"><em>st_atime</em></span>,
                    <span class="emphasis"><em>st_mtime</em></span>, and <span class="emphasis"><em>st_ctime</em></span> fields,
                respectively. In most cases, the relevant timestamp is set to the current time by
                the system call. The exceptions are <span class="emphasis"><em>utime()</em></span> and similar calls
                (discussed in <a class="xref" href="ch15.html#nanosecond_timestamps-id1" title="Nanosecond timestamps">Nanosecond timestamps</a> and <a class="xref" href="ch15.html#changing_file_timestamps_with_utime_open" title="Changing File Timestamps with utime() and utimes()">Changing File Timestamps with <span class="emphasis"><em>utime()</em></span> and
                        <span class="emphasis"><em>utimes()</em></span></a>), which can be used to
                explicitly set the last file access and modification times to arbitrary
                    values.<a id="IDX-CHP-15-1981" class="indexterm"/></p><div class="table"><a id="effect_of_various_functions_on_file_time"/><div class="table-title">Table 15-2. Effect of various functions on file timestamps</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/><col class="col3"/><col class="col4"/><col class="col5"/><col class="col6"/><col class="col7"/><col class="col8"/></colgroup><thead><tr><td style="text-align: center; vertical-align: bottom; border-right: 0.5pt solid ; " rowspan="2">
                                <p>Function</p>
                            </td><td style="text-align: center; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="3">
                                <p>File or directory</p>
                            </td><td style="text-align: center; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="3">
                                <p>Parent directory</p>
                            </td><td style="text-align: center; vertical-align: bottom; " rowspan="2">
                                <p>Notes</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>a</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>m</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>c</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>a</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>m</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>c</p>
                            </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>chmod()</em></span>
                                    <a id="IDX-CHP-15-1982" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>fchmod()</em></span><a id="IDX-CHP-15-1983" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>chown()</em></span>
                                    <a id="IDX-CHP-15-1984" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>lchown()</em></span> and
                                        <span class="emphasis"><em>fchown()</em></span><a id="IDX-CHP-15-1986" class="indexterm"/><a id="IDX-CHP-15-1985" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>exec()</em></span>
                                    <a id="IDX-CHP-15-1987" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-bottom: 0.5pt solid ; "> </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>link()</em></span>
                                    <a id="IDX-CHP-15-1988" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Affects parent directory of second argument</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>mkdir()</em></span>
                                    <a id="IDX-CHP-15-1989" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-bottom: 0.5pt solid ; "> </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>mkfifo()</em></span>
                                    <a id="IDX-CHP-15-1990" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-bottom: 0.5pt solid ; "> </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>mknod()</em></span>
                                    <a id="IDX-CHP-15-1991" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-bottom: 0.5pt solid ; "> </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>mmap()</em></span>
                                    <a id="IDX-CHP-15-1992" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p><span class="emphasis"><em>st_mtime</em></span> and
                                        <span class="emphasis"><em>st_ctime</em></span> are changed only on updates to
                                        <code class="literal">MAP_SHARED</code> mapping</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>msync()</em></span>
                                    <a id="IDX-CHP-15-1993" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Changed only if file is modified</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><span class="emphasis"><em>open()</em></span>,
                                        <span class="emphasis"><em>creat()</em></span><a id="IDX-CHP-15-1995" class="indexterm"/><a id="IDX-CHP-15-1994" class="indexterm"/></p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>When creating new file</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><span class="emphasis"><em>open()</em></span>,
                                    <span class="emphasis"><em>creat()</em></span></p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>When truncating existing file</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>pipe()</em></span>
                                    <a id="IDX-CHP-15-1996" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-bottom: 0.5pt solid ; "> </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>read()</em></span>
                                    <a id="IDX-CHP-15-1997" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>readv()</em></span>,
                                        <span class="emphasis"><em>pread()</em></span>, and
                                        <span class="emphasis"><em>preadv()</em></span><a id="IDX-CHP-15-2000" class="indexterm"/><a id="IDX-CHP-15-1998" class="indexterm"/><a id="IDX-CHP-15-1999" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>readdir()</em></span>
                                    <a id="IDX-CHP-15-2001" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>readdir() may buffer directory entries; timestamps updated
                                    only if directory is read</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>removexattr()</em></span>
                                    <a id="IDX-CHP-15-2002" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>fremovexattr()</em></span> and
                                        <span class="emphasis"><em>lremovexattr()</em></span><a id="IDX-CHP-15-2004" class="indexterm"/><a id="IDX-CHP-15-2003" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>rename()</em></span>
                                    <a id="IDX-CHP-15-2005" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Affects timestamps in both parent directories; SUSv3 doesn’t
                                    specify file <span class="emphasis"><em>st_ctime</em></span> change, but notes
                                    that some implementations do this</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>rmdir()</em></span>
                                    <a id="IDX-CHP-15-2006" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>remove(directory)</em></span></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>sendfile()</em></span>
                                    <a id="IDX-CHP-15-2007" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Timestamp changed for input file</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>setxattr()</em></span>
                                    <a id="IDX-CHP-15-2008" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>fsetxattr()</em></span> and
                                        <span class="emphasis"><em>lsetxattr()</em></span><a id="IDX-CHP-15-2010" class="indexterm"/><a id="IDX-CHP-15-2009" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>symlink()</em></span>
                                    <a id="IDX-CHP-15-2011" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Sets timestamps of link (not target file)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>truncate()</em></span>
                                    <a id="IDX-CHP-15-2012" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>ftruncate()</em></span>; timestamps change
                                    only if file size changes<a id="IDX-CHP-15-2013" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>unlink()</em></span>
                                    <a id="IDX-CHP-15-2014" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>remove(file)</em></span>; file
                                        <span class="emphasis"><em>st_ctime</em></span> changes if previous link count
                                    was &gt; 1</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>utime()</em></span>
                                    <a id="IDX-CHP-15-2015" class="indexterm"/>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Same for <span class="emphasis"><em>utimes()</em></span>,
                                        <span class="emphasis"><em>futimes()</em></span>,
                                        <span class="emphasis"><em>futimens()</em></span>,
                                        <span class="emphasis"><em>lutimes()</em></span>, and
                                        <span class="emphasis"><em>utimensat()</em></span><a id="IDX-CHP-15-2020" class="indexterm"/><a id="IDX-CHP-15-2016" class="indexterm"/><a id="IDX-CHP-15-2017" class="indexterm"/><a id="IDX-CHP-15-2018" class="indexterm"/><a id="IDX-CHP-15-2019" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                <p>
                                    <span class="emphasis"><em>write()</em></span>
                                    <a id="IDX-CHP-15-2021" class="indexterm"/>
                                </p>
                            </td><td style="border-right: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                <p>•</p>
                            </td><td style="border-right: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; "> </td><td style="border-right: 0.5pt solid ; "> </td><td style="text-align: left; vertical-align: top; ">
                                <p>Same for <span class="emphasis"><em>writev()</em></span>,
                                        <span class="emphasis"><em>pwrite()</em></span>, and
                                        <span class="emphasis"><em>pwritev()</em></span><a id="IDX-CHP-15-2024" class="indexterm"/><a id="IDX-CHP-15-2022" class="indexterm"/><a id="IDX-CHP-15-2023" class="indexterm"/></p>
                            </td></tr></tbody></table></div></div><p>In <a class="xref" href="ch14.html#mounting_a_file_system_colon_mount_open" title="Mounting a File System: mount()">Mounting a File System: <span class="emphasis"><em>mount()</em></span></a> and <a class="xref" href="ch15.html#i-node_flags_open_parenthesis_ext2_exten" title="I-node Flags (ext2 Extended File Attributes)">I-node Flags (<span class="emphasis"><em>ext2</em></span> Extended File Attributes)</a>, we describe
                    <span class="emphasis"><em>mount(2)</em></span> options and per-file flags that prevent updates to
                the last access time of a file. The <span class="emphasis"><em>open()</em></span>
                <code class="literal">O_NOATIME</code> flag described in <a class="xref" href="ch04.html#file_descriptor_number_returned_by-id1" title="File descriptor number returned by open()">File descriptor number returned by <span class="emphasis"><em>open()</em></span></a> also serves a similar purpose. In
                some applications, this can be useful for performance reasons, since it reduces the
                number of disk operations that are required when a file is accessed.<a id="IDX-CHP-15-2025" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Although most UNIX systems don’t record the creation time of a file, on recent
                    BSD systems, this time is recorded in a <span class="emphasis"><em>stat</em></span> field named
                        <span class="emphasis"><em>st_birthtime</em></span>.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="nanosecond_timestamps"/></div></div></div><div class="sect3" title="Nanosecond timestamps"><div class="titlepage"><div><div><h4 class="title" id="nanosecond_timestamps-id1">Nanosecond timestamps</h4></div></div></div><p>With version 2.6, Linux supports nanosecond resolution for the three
                        timestamp fields of the <span class="emphasis"><em>stat</em></span> structure. Nanosecond
                        resolution improves the accuracy of programs that need to make decisions
                        based on the relative order of file timestamps (e.g.,
                            <span class="emphasis"><em>make(1)</em></span>).</p><p>SUSv3 doesn’t specify nanosecond timestamps for the
                            <span class="emphasis"><em>stat</em></span> structure, but SUSv4 adds this
                        specification.</p><p>Not all file systems support nanosecond timestamps.
                            <span class="emphasis"><em>JFS</em></span>, <span class="emphasis"><em>XFS</em></span>,
                            <span class="emphasis"><em>ext4</em></span>, and <span class="emphasis"><em>Btrfs</em></span> do, but
                            <span class="emphasis"><em>ext2</em></span>, <span class="emphasis"><em>ext3</em></span>, and
                            <span class="emphasis"><em>Reiserfs</em></span> do not.</p><p>Under the <span class="emphasis"><em>glibc</em></span> API (since version 2.3), the
                        timestamp fields are each defined as a <span class="emphasis"><em>timespec</em></span>
                        structure (we describe this structure when we discuss
                            <span class="emphasis"><em>utimensat()</em></span> later in this section), which
                        represents a time in seconds and nanoseconds components. Suitable macro
                        definitions make the seconds component of these structures visible using the
                        traditional field names (<span class="emphasis"><em>st_atime</em></span>,
                            <span class="emphasis"><em>st_mtime</em></span>, and <span class="emphasis"><em>st_ctime</em></span>). The
                        nanosecond components can be accessed using field names such
                            <span class="emphasis"><em>st_atim.tv_nsec</em></span>, for the nanosecond component of
                        the last file access time.</p></div></div><div class="sect2" title="Changing File Timestamps with utime() and utimes()"><div class="titlepage"><div><div><h3 class="title" id="changing_file_timestamps_with_utime_open">Changing File Timestamps with <span class="emphasis"><em>utime()</em></span> and
                        <span class="emphasis"><em>utimes()</em></span></h3></div></div></div><p>The last file access and modification timestamps stored in a file i-node can
                    be explicitly changed using <span class="emphasis"><em>utime()</em></span> or one of a related set
                    of system calls. Programs such as <span class="emphasis"><em>tar(1)</em></span> and
                        <span class="emphasis"><em>unzip(1)</em></span> use these system calls to reset file
                    timestamps when unpacking an archive.<a id="IDX-CHP-15-2027" class="indexterm"/><a id="IDX-CHP-15-2028" class="indexterm"/><a id="IDX-CHP-15-2029" class="indexterm"/><a id="IDX-CHP-15-2030" class="indexterm"/><a id="IDX-CHP-15-2031" class="indexterm"/><a id="IDX-CHP-15-2032" class="indexterm"/><a id="IDX-CHP-15-2033" class="indexterm"/><a id="IDX-CHP-15-2034" class="indexterm"/><a id="IDX-CHP-15-2035" class="indexterm"/><a id="IDX-CHP-15-2036" class="indexterm"/><a id="IDX-CHP-15-2037" class="indexterm"/><a id="IDX-CHP-15-2038" class="indexterm"/><a id="IDX-CHP-15-2039" class="indexterm"/><a id="IDX-CHP-15-2040" class="indexterm"/><a id="IDX-CHP-15-2026" class="indexterm"/></p><a id="I_programlisting15_d1e37290"/><pre class="programlisting">#include &lt;utime.h&gt;

int <strong class="userinput"><code>utime</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, const struct utimbuf *<span class="emphasis"><em>buf</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Returns 0 on success, or -1 on error</p></div><p>The <span class="emphasis"><em>pathname</em></span> argument identifies the file whose times we
                    wish to modify. If <span class="emphasis"><em>pathname</em></span> is a symbolic link, it is
                    dereferenced. The <span class="emphasis"><em>buf</em></span> argument can be either <code class="literal">NULL</code> or a pointer to a
                        <span class="emphasis"><em>utimbuf</em></span> structure:<a id="IDX-CHP-15-2041" class="indexterm"/></p><a id="I_programlisting15_d1e37327"/><pre class="programlisting">struct utimbuf {
    time_t actime;      /* Access time */
    time_t modtime;     /* Modification time */
};</pre><p>The fields in this structure measure time in seconds since the Epoch (<a class="xref" href="ch10.html#calendar_time" title="Calendar Time">Calendar Time</a>).</p><p>Two different cases determine how <span class="emphasis"><em>utime()</em></span> works:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If <span class="emphasis"><em>buf</em></span> is specified as <code class="literal">NULL</code>, then both the last access and the last modification
                            times are set to the current time. In this case, either the effective
                            user ID of the process must match the file’s user ID (owner), the
                            process must have write permission on the file (logical, since a process
                            with write permission on a file could employ other system calls that
                            would have the side effect of changing these file timestamps), or the
                            process must be privileged (<code class="literal">CAP_FOWNER</code> or <code class="literal">CAP_DAC_OVERRIDE</code>). (To be accurate, on Linux, it is the
                            process’s file-system user ID, rather than its effective user ID, that
                            is checked against the file’s user ID, as described in Section
                                9.5.)<a id="IDX-CHP-15-2042" class="indexterm"/></p></li><li class="listitem"><p>If <span class="emphasis"><em>buf</em></span> is specified as pointer to a
                                <span class="emphasis"><em>utimbuf</em></span> structure, then the last file access
                            and modification times are updated using the corresponding fields of
                            this structure. In this case, the effective user ID of the process must
                            match the file’s user ID (having write permission on the file is not
                            sufficient) or the caller must be privileged (<code class="literal">CAP_FOWNER</code>).</p></li></ul></div><p>To change just one of the file timestamps, we first use
                        <span class="emphasis"><em>stat()</em></span> to retrieve both times, use one of these times
                    to initialize the <span class="emphasis"><em>utimbuf</em></span> structure, and then set the other
                    as desired. This is demonstrated in the following code, which makes the last
                    modification time of a file the same as the last access time:</p><a id="I_programlisting15_d1e37379"/><pre class="programlisting">struct stat sb;
struct utimbuf utb;

if (stat(pathname, &amp;sb) == -1)
    errExit("stat");
utb.actime = sb.st_atime;       /* Leave access time unchanged */
utb.modtime = sb.st_atime;
if (utime(pathname, &amp;utb) == -1)
    errExit("utime");</pre><p>A successful call to <span class="emphasis"><em>utime()</em></span> always sets the last status
                    change time to the current time.</p><p>Linux also provides the BSD-derived <span class="emphasis"><em>utimes()</em></span> system call,
                    which performs a similar task to <span class="emphasis"><em>utime()</em></span>.<a id="IDX-CHP-15-2043" class="indexterm"/></p><a id="I_programlisting15_d1e37399"/><pre class="programlisting">#include &lt;sys/time.h&gt;

int <strong class="userinput"><code>utimes</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, const struct timeval <span class="emphasis"><em>tv[2]</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Returns 0 on success, or -1 on error</p></div><p>The most notable difference between <span class="emphasis"><em>utime()</em></span> and
                        <span class="emphasis"><em>utimes()</em></span> is that <span class="emphasis"><em>utimes()</em></span> allows
                    time values to be specified with microsecond accuracy (the
                        <span class="emphasis"><em>timeval</em></span> structure is described in <a class="xref" href="ch10.html#calendar_time" title="Calendar Time">Calendar Time</a>). This provides (partial) access to the nanosecond
                    accuracy with which file timestamps are provided in Linux 2.6. The new file
                    access time is specified in <span class="emphasis"><em>tv[0]</em></span>, and the new modification
                    time is specified in <span class="emphasis"><em>tv[1]</em></span>.<a id="IDX-CHP-15-2044" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>An example of the use of <span class="emphasis"><em>utimes()</em></span> is provided in the
                        file <code class="literal">files/t_utimes.c</code> in the source code
                        distribution for this book.</p></div><p>The <span class="emphasis"><em>futimes()</em></span> and <span class="emphasis"><em>lutimes()</em></span> library
                    functions perform a similar task to <span class="emphasis"><em>utimes()</em></span>. They differ
                    from <span class="emphasis"><em>utimes()</em></span> in the argument used to specify the file
                    whose timestamps are to be changed.<a id="IDX-CHP-15-2045" class="indexterm"/><a id="IDX-CHP-15-2046" class="indexterm"/></p><a id="I_programlisting15_d1e37472"/><pre class="programlisting">#include &lt;sys/time.h&gt;

int <strong class="userinput"><code>futimes</code></strong>(int <span class="emphasis"><em>fd</em></span>, const struct timeval <span class="emphasis"><em>tv[2]</em></span>);
int <strong class="userinput"><code>lutimes</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, const struct timeval <span class="emphasis"><em>tv[2]</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Both return 0 on success, or -1 on error</p></div><p>With <span class="emphasis"><em>futimes()</em></span>, the file is specified via an open file
                    descriptor, <span class="emphasis"><em>fd</em></span>.</p><p>With <span class="emphasis"><em>lutimes()</em></span>, the file is specified via a pathname,
                    with the difference from <span class="emphasis"><em>utimes()</em></span> that if the pathname
                    refers to a symbolic link, then the link is not dereferenced; instead, the
                    timestamps of the link itself are changed.</p><p>The <span class="emphasis"><em>futimes()</em></span> function is supported since
                        <span class="emphasis"><em>glibc</em></span> 2.3. The <span class="emphasis"><em>lutimes()</em></span> function
                    is supported since <span class="emphasis"><em>glibc</em></span> 2.6.</p></div><div class="sect2" title="Changing File Timestamps with utimensat() and futimens()"><div class="titlepage"><div><div><h3 class="title" id="changing_file_timestamps_with_utimensat">Changing File Timestamps with <span class="emphasis"><em>utimensat()</em></span> and
                        <span class="emphasis"><em>futimens()</em></span></h3></div></div></div><p>The <span class="emphasis"><em>utimensat()</em></span> system call (supported since kernel
                    2.6.22) and the <span class="emphasis"><em>futimens()</em></span> library function (supported
                    since <span class="emphasis"><em>glibc</em></span> 2.6) provide extended functionality for setting
                    a file’s last access and last modification timestamps. Among the advantages of
                    these interfaces are the following:<a id="IDX-CHP-15-2048" class="indexterm"/><a id="IDX-CHP-15-2049" class="indexterm"/><a id="IDX-CHP-15-2050" class="indexterm"/><a id="IDX-CHP-15-2051" class="indexterm"/><a id="IDX-CHP-15-2052" class="indexterm"/><a id="IDX-CHP-15-2053" class="indexterm"/><a id="IDX-CHP-15-2054" class="indexterm"/><a id="IDX-CHP-15-2047" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We can set timestamps with nanosecond precision. This improves on the
                            microsecond precision provided by <span class="emphasis"><em>utimes()</em></span>.</p></li><li class="listitem"><p>It is possible to set the timestamps independently (i.e., one at a
                            time). As shown earlier, to change just one of the timestamps using the
                            older interfaces, we must first call <span class="emphasis"><em>stat()</em></span> to
                            retrieve the value of the other timestamp, and then specify the
                            retrieved value along with the timestamp whose value we want to change.
                            (This could lead to a race condition if another process performed an
                            operation that updated the timestamp between these two steps.)</p></li><li class="listitem"><p>We can independently set either of the timestamps to the current time.
                            To change just one timestamp to the current time with the older
                            interfaces, we need to employ a call to <span class="emphasis"><em>stat()</em></span> to
                            retrieve the setting of the timestamp whose value we wish to leave
                            unchanged, and a call to <span class="emphasis"><em>gettimeofday()</em></span> to obtain
                            the current time.</p></li></ul></div><p>These interfaces are not specified in SUSv3, but are included in SUSv4.</p><p>The <span class="emphasis"><em>utimensat()</em></span> system call updates the timestamps of the
                    file specified by <span class="emphasis"><em>pathname</em></span> to the values specified in the
                    array <span class="emphasis"><em>times</em></span>.</p><a id="I_programlisting15_d1e37625"/><pre class="programlisting">#define _XOPEN_SOURCE 700     /* Or define _POSIX_C_SOURCE &gt;= 200809 */
#include &lt;sys/stat.h&gt;

int <strong class="userinput"><code>utimensat</code></strong>(int <span class="emphasis"><em>dirfd</em></span>, const char *<span class="emphasis"><em>pathname</em></span>,
              const struct timespec <span class="emphasis"><em>times[2]</em></span>, int <span class="emphasis"><em>flags</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Returns 0 on success, or -1 on error</p></div><p>If <span class="emphasis"><em>times</em></span> is specified as <code class="literal">NULL</code>, then both file timestamps are updated to the current time.
                    If <span class="emphasis"><em>times</em></span> is not <code class="literal">NULL</code>,
                    then the new last access timestamp is specified in <span class="emphasis"><em>times[0]</em></span>
                    and the new last modification timestamp is specified in
                        <span class="emphasis"><em>times[1]</em></span>. Each of the elements of the array
                        <span class="emphasis"><em>times</em></span> is a structure of the following form:</p><a id="I_programlisting15_d1e37669"/><pre class="programlisting">struct timespec {
    time_t tv_sec;     /* Seconds ('time_t' is an integer type) */
    long   tv_nsec;    /* Nanoseconds */
};</pre><p>The fields in this structure specify a time in seconds and nanoseconds since
                    the Epoch (<a class="xref" href="ch10.html#calendar_time" title="Calendar Time">Calendar Time</a>).</p><p>To set one of the timestamps to the current time, we specify the special value
                        <code class="literal">UTIME_NOW</code> in the corresponding
                        <span class="emphasis"><em>tv_nsec</em></span> field. To leave one of the timestamps
                    unchanged, we specify the special value <code class="literal">UTIME_OMIT</code> in the corresponding <span class="emphasis"><em>tv_nsec</em></span>
                    field. In both cases, the value in the corresponding <span class="emphasis"><em>tv_sec</em></span>
                    field is ignored.</p><p>The <span class="emphasis"><em>dirfd</em></span> argument can either specify <code class="literal">AT_FDCWD</code>, in which case the
                        <span class="emphasis"><em>pathname</em></span> argument is interpreted as for
                        <span class="emphasis"><em>utimes()</em></span>, or it can specify a file descriptor referring
                    to a directory. The purpose of the latter choice is described in <a class="xref" href="ch18.html#operating_relative_to_a_directory_file_d" title="Operating Relative to a Directory File Descriptor">Operating Relative to a Directory File Descriptor</a>.</p><p>The <span class="emphasis"><em>flags</em></span> argument can be either 0, or <code class="literal">AT_SYMLINK_NOFOLLOW</code>, meaning that
                        <span class="emphasis"><em>pathname</em></span> should not be dereferenced if it is a symbolic
                    link (i.e., the timestamps of the symbolic link itself should be changed). By
                    contrast, <span class="emphasis"><em>utimes()</em></span> always dereferences symbolic
                    links.</p><p>The following code segment sets the last access time to the current time and
                    leaves the last modification time unchanged:</p><a id="I_programlisting15_d1e37725"/><pre class="programlisting">struct timespec times[2];

times[0].tv_sec = 0;
times[0].tv_nsec = UTIME_NOW;
times[1].tv_sec = 0;
times[1].tv_nsec = UTIME_OMIT;
if (utimensat(AT_FDCWD, "myfile", times, 0) == -1)
    errExit("utimensat");</pre><p>The permission rules for changing timestamps with
                        <span class="emphasis"><em>utimensat()</em></span> (and <span class="emphasis"><em>futimens()</em></span>) are
                    similar to those for the older APIs, and are detailed in the
                        <span class="emphasis"><em>utimensat(2)</em></span> manual page.</p><p>The <span class="emphasis"><em>futimens()</em></span> library function updates the timestamps of
                    the file referred to by the open file descriptor <span class="emphasis"><em>fd</em></span>.</p><a id="I_programlisting15_d1e37746"/><pre class="programlisting">#include _GNU_SOURCE
#include &lt;sys/stat.h&gt;

int <strong class="userinput"><code>futimens</code></strong>(int <span class="emphasis"><em>fd</em></span>, const struct timespec <span class="emphasis"><em>times[2]</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Returns 0 on success, or -1 on error</p></div><p>The <span class="emphasis"><em>times</em></span> argument of <span class="emphasis"><em>futimens()</em></span> is
                    used in the same way as for <span class="emphasis"><em>utimensat()</em></span>.</p></div></div><div class="sect1" title="File Ownership"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="file_ownership-id1">File Ownership</h2></div></div></div><p>Each file has an associated user ID (UID) and group ID (GID). These IDs determine
                which user and group the file belongs to. We now look at the rules that determine
                the ownership of new files and describe the system calls used to change a file’s
                    ownership.<a id="IDX-CHP-15-2055" class="indexterm"/></p><div class="sect2" title="Ownership of New Files"><div class="titlepage"><div><div><h3 class="title" id="ownership_of_new_files">Ownership of New Files</h3></div></div></div><p>When a new file is created, its user ID is taken from the effective user ID of
                    the process. The group ID of the new file may be taken from either the effective
                    group ID of the process (equivalent to the System V default behavior) or the
                    group ID of the parent directory (the BSD behavior). The latter possibility is
                    useful for creating project directories in which all files belong to a
                    particular group and are accessible to the members of that group. Which of the
                    two values is used as the new file’s group ID is determined by various factors,
                    including the type of file system on which the new file is created. We begin by
                    describing the rules followed by <span class="emphasis"><em>ext2</em></span> and a few other file
                        systems.<a id="IDX-CHP-15-2056" class="indexterm"/><a id="IDX-CHP-15-2057" class="indexterm"/><a id="IDX-CHP-15-2058" class="indexterm"/><a id="IDX-CHP-15-2059" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>To be accurate, on Linux, all uses of the terms <span class="emphasis"><em>effective
                            user</em></span> or <span class="emphasis"><em>group ID</em></span> in this section should
                        really be <span class="emphasis"><em>file-system user</em></span> or <span class="emphasis"><em>group
                            ID</em></span> (<a class="xref" href="ch09.html#file-system_user_id_and_file-system_grou" title="File-System User ID and File-System Group ID">File-System User ID and File-System Group ID</a>).</p></div><p>When an <span class="emphasis"><em>ext2</em></span> file system is mounted, either the
                        <span class="emphasis"><em>-o grpid</em></span> (or the synonymous <span class="emphasis"><em>-o
                        bsdgroups</em></span>) option or the <span class="emphasis"><em>-o nogrpid</em></span> (or the
                    synonymous <span class="emphasis"><em>-o sysvgroups</em></span>) option may be specified to the
                        <span class="emphasis"><em>mount</em></span> command. (If neither option is specified, the
                    default is <span class="emphasis"><em>-o nogrpid</em></span>.) If <span class="emphasis"><em>-o grpid</em></span> is
                    specified, then a new file always inherits its group ID from the parent
                    directory. If <span class="emphasis"><em>-o nogrpid</em></span> is specified, then, by default, a
                    new file takes its group ID from the process’s effective group ID. However, if
                    the set-group-ID bit is enabled for the directory (via <span class="emphasis"><em>chmod
                        g+s</em></span>), then the group ID of the file is inherited from the parent
                    directory. These rules are summarized in <a class="xref" href="ch15.html#rules_determining_the_group_ownership_of" title="Table 15-3. Rules determining the group ownership of a newly created file">Table 15-3</a>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>In <a class="xref" href="ch18.html#creating_and_removing_directories_colon" title="Creating and Removing Directories: mkdir() and rmdir()">Creating and Removing Directories: <span class="emphasis"><em>mkdir()</em></span> and
                    <span class="emphasis"><em>rmdir()</em></span></a>, we’ll see
                        that when the set-group-ID bit is set on a directory, then it is also set on
                        new subdirectories created within that directory. In this manner, the
                        set-group-ID behavior described in the main text is propagated down through
                        an entire directory tree.</p></div><div class="table"><a id="rules_determining_the_group_ownership_of"/><div class="table-title">Table 15-3. Rules determining the group ownership of a newly created file</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/><col class="col3"/></colgroup><thead><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>File system mount option</p>
                                </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>Set-group-ID bit enabled on parent directory?</p>
                                </td><td style="text-align: left; vertical-align: bottom; border-bottom: 0.5pt solid ; ">
                                    <p>Group ownership of new file taken from</p>
                                </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p><span class="emphasis"><em>-o grpid</em></span>, <span class="emphasis"><em>-o
                                            bsdgroups</em></span></p>
                                </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>(ignored)</p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>parent directory group ID</p>
                                </td></tr><tr><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; " rowspan="2">
                                    <p><span class="emphasis"><em>-o nogrpid</em></span>, <span class="emphasis"><em>-o
                                            sysvgroups</em></span>
                                        (<span class="emphasis"><em>default</em></span>)</p>
                                </td><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>no</p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>process effective group ID</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                    <p>yes</p>
                                </td><td style="text-align: left; vertical-align: top; ">
                                    <p>parent directory group ID</p>
                                </td></tr></tbody></table></div></div><p>At the time of writing, the only file systems that support the
                        <span class="emphasis"><em>grpid</em></span> and <span class="emphasis"><em>nogrpid</em></span> mount options
                    are <span class="emphasis"><em>ext2</em></span>, <span class="emphasis"><em>ext3</em></span>,
                        <span class="emphasis"><em>ext4</em></span>, and (since Linux 2.6.14)
                    <span class="emphasis"><em>XFS</em></span>. Other file systems follow the
                        <span class="emphasis"><em>nogrpid</em></span> rules.</p></div><div class="sect2" title="Changing File Ownership: chown(), fchown(), and lchown()"><div class="titlepage"><div><div><h3 class="title" id="changing_file_ownership_colon_chown_open">Changing File Ownership: <span class="emphasis"><em>chown()</em></span>,
                        <span class="emphasis"><em>fchown()</em></span>, and <span class="emphasis"><em>lchown()</em></span></h3></div></div></div><p>The <span class="emphasis"><em>chown()</em></span>, <span class="emphasis"><em>lchown()</em></span>, and
                        <span class="emphasis"><em>fchown()</em></span> system calls change the owner (user ID) and
                    group (group ID) of a file.<a id="IDX-CHP-15-2062" class="indexterm"/><a id="IDX-CHP-15-2063" class="indexterm"/><a id="IDX-CHP-15-2064" class="indexterm"/><a id="IDX-CHP-15-2065" class="indexterm"/><a id="IDX-CHP-15-2066" class="indexterm"/><a id="IDX-CHP-15-2067" class="indexterm"/><a id="IDX-CHP-15-2068" class="indexterm"/><a id="IDX-CHP-15-2069" class="indexterm"/><a id="IDX-CHP-15-2070" class="indexterm"/><a id="IDX-CHP-15-2071" class="indexterm"/><a id="IDX-CHP-15-2072" class="indexterm"/><a id="IDX-CHP-15-2060" class="indexterm"/><a id="IDX-CHP-15-2061" class="indexterm"/></p><a id="I_programlisting15_d1e38029"/><pre class="programlisting">#include &lt;unistd.h&gt;

int <strong class="userinput"><code>chown</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, uid_t <span class="emphasis"><em>owner</em></span>, gid_t <span class="emphasis"><em>group</em></span>);
int <strong class="userinput"><code>lchown</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, uid_t <span class="emphasis"><em>owner</em></span>, gid_t <span class="emphasis"><em>group</em></span>);
int <strong class="userinput"><code>fchown</code></strong>(int <span class="emphasis"><em>fd</em></span>, uid_t <span class="emphasis"><em>owner</em></span>, gid_t <span class="emphasis"><em>group</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>All return 0 on success, or -1 on error</p></div><p>The distinction between these three system calls is similar to the
                        <span class="emphasis"><em>stat()</em></span> family of system calls:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>chown()</em></span> changes the ownership of the file named
                            in the <span class="emphasis"><em>pathname</em></span> argument;</p></li><li class="listitem"><p><span class="emphasis"><em>lchown()</em></span> does the same, except that if
                                <span class="emphasis"><em>pathname</em></span> is a symbolic link, ownership of the
                            link file is changed, rather than the file to which it refers;
                                and<a id="IDX-CHP-15-2073" class="indexterm"/></p></li><li class="listitem"><p><span class="emphasis"><em>fchown()</em></span> changes the ownership of a file referred
                            to by the open file descriptor, <span class="emphasis"><em>fd</em></span>.</p></li></ul></div><p>The <span class="emphasis"><em>owner</em></span> argument specifies the new user ID for the
                    file, and the <span class="emphasis"><em>group</em></span> argument specifies the new group ID for
                    the file. To change just one of the IDs, we can specify -1 for the other
                    argument to leave that ID unchanged.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Prior to Linux 2.2, <span class="emphasis"><em>chown()</em></span> did not dereference
                        symbolic links. The semantics of <span class="emphasis"><em>chown()</em></span> were changed
                        with Linux 2.2, and the new <span class="emphasis"><em>lchown()</em></span> system call was
                        added to provide the behavior of the old <span class="emphasis"><em>chown()</em></span> system
                        call.</p></div><p>Only a privileged (<code class="literal">CAP_CHOWN</code>) process may
                    use <span class="emphasis"><em>chown()</em></span> to change the user ID of a file. An
                    unprivileged process can use <span class="emphasis"><em>chown()</em></span> to change the group ID
                    of a file that it owns (i.e., the process’s effective user ID matches the user
                    ID of the file) to any of the groups of which they are a member. A privileged
                    process can change the group ID of a file to any value.</p><p>If the owner or group of a file is changed, then the set-user-ID and
                    set-group-ID permission bits are both turned off. This is a security precaution
                    to ensure that a normal user could not enable the set-user-ID (or set-group-ID)
                    bit on an executable file and then somehow make it owned by some privileged user
                    (or group), thereby gaining that privileged identity when executing the
                    file.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>SUSv3 leaves it unspecified whether the set-user-ID and set-group-ID bits
                        should be turned off when the superuser changes the owner or group of an
                        executable file. Linux 2.0 did turn these bits off in this case, while some
                        of the early 2.2 kernels (up to 2.2.12) did not. Later 2.2 kernels returned
                        to the 2.0 behavior, where changes by the superuser are treated the same as
                        everyone else, and this behavior is maintained in subsequent kernel
                        versions. (However, if we use the <span class="emphasis"><em>chown(1)</em></span> command
                        under a <span class="emphasis"><em>root</em></span> login to change the ownership of a file,
                        then, after calling <span class="emphasis"><em>chown(2)</em></span>, the
                            <span class="emphasis"><em>chown</em></span> command uses the <span class="emphasis"><em>chmod()</em></span>
                        system call to reenable the set-user-ID and set-group-ID bits.)<a id="IDX-CHP-15-2074" class="indexterm"/></p></div><p>When changing the owner or group of a file, the set-group-ID permission bit is
                    not turned off if the group-execute permission bit is already off or if we are
                    changing the ownership of a directory. In both of these cases, the set-group-ID
                    bit is being used for a purpose other than the creation of a set-group-ID
                    program, and therefore it is undesirable to turn the bit off. These other uses
                    of the set-group-ID bit are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If the group-execute permission bit is off, then the set-group-ID
                            permission bit is being used to enable mandatory file locking (discussed
                            in <a class="xref" href="ch55.html#mandatory_locking" title="Mandatory Locking">Mandatory Locking</a>).<a id="IDX-CHP-15-2075" class="indexterm"/></p></li><li class="listitem"><p>In the case of a directory, the set-group-ID bit is being used to
                            control the ownership of new files created in the directory (<a class="xref" href="ch15.html#ownership_of_new_files" title="Ownership of New Files">Ownership of New Files</a>).</p></li></ul></div><p>The use of <span class="emphasis"><em>chown()</em></span> is demonstrated in <a class="xref" href="ch15.html#changing_the_owner_and_group_of_a_file" title="Example 15-2. Changing the owner and group of a file">Example 15-2</a>, a program that allows
                    the user to change the owner and group of an arbitrary number of files,
                    specified as command-line arguments. (This program uses the
                        <span class="emphasis"><em>userIdFromName()</em></span> and
                        <span class="emphasis"><em>groupIdFromName()</em></span> functions from <a class="xref" href="ch08.html#functions_to_convert_user_and_group_ids" title="Example 8-1. Functions to convert user and group IDs to and from user and group names">Example 8-1</a>, in <a class="xref" href="ch08.html#example_program-id5" title="Example program">Example program</a>, to convert user and group names into
                    corresponding numeric IDs.)</p><div class="example"><a id="changing_the_owner_and_group_of_a_file"/><div class="example-title">Example 15-2. Changing the owner and group of a file</div><div class="example-contents"><pre class="programlisting"><strong class="userinput"><code>files/t_chown.c</code></strong>
#include &lt;pwd.h&gt;
#include &lt;grp.h&gt;
#include "ugid_functions.h"             /* Declarations of userIdFromName()
                                           and groupIdFromName() */
#include "tlpi_hdr.h"

int
main(int argc, char *argv[])
{
    uid_t uid;
    gid_t gid;
    int j;
    Boolean errFnd;

    if (argc &lt; 3 || strcmp(argv[1], "--help") == 0)
        usageErr("%s owner group [file...]\n"
                "        owner or group can be '-', "
                "meaning leave unchanged\n", argv[0]);

    if (strcmp(argv[1], "-") == 0) {            /* "-" ==&gt; don't change owner */
        uid = -1;
    } else {                                    /* Turn user name into UID */
        uid = userIdFromName(argv[1]);
        if (uid == -1)
            fatal("No such user (%s)", argv[1]);
    }

    if (strcmp(argv[2], "-") == 0) {            /* "-" ==&gt; don't change group */
        gid = -1;
    } else {                                    /* Turn group name into GID */
        gid = groupIdFromName(argv[2]);
        if (gid == -1)
            fatal("No group user (%s)", argv[1]);
    }

    /* Change ownership of all files named in remaining arguments */

    errFnd = FALSE;
    for (j = 3; j &lt; argc; j++) {
        if (chown(argv[j], uid, gid) == -1) {
            errMsg("chown: %s", argv[j]);
            errFnd = TRUE;
        }
    }

    exit(errFnd ? EXIT_FAILURE : EXIT_SUCCESS);
}
     <strong class="userinput"><code>files/t_chown.c</code></strong></pre></div></div></div></div><div class="sect1" title="File Permissions"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="file_permissions">File Permissions</h2></div></div></div><p>In this section, we describe the permission scheme applied to files and
                directories. Although we talk about permissions here mainly as they apply to regular
                files and directories, the rules that we describe apply to all types of files,
                including devices, FIFOs, and UNIX domain sockets. Furthermore, the System V and
                POSIX interprocess communication objects (shared memory, semaphores, and message
                queues) also have permission masks, and the rules that apply for these objects are
                similar to those for files.<a id="IDX-CHP-15-2076" class="indexterm"/><a id="IDX-CHP-15-2077" class="indexterm"/><a id="IDX-CHP-15-2078" class="indexterm"/><a id="IDX-CHP-15-2079" class="indexterm"/><a id="IDX-CHP-15-2080" class="indexterm"/><a id="IDX-CHP-15-2081" class="indexterm"/></p><div class="sect2" title="Permissions on Regular Files"><div class="titlepage"><div><div><h3 class="title" id="permissions_on_regular_files">Permissions on Regular Files</h3></div></div></div><p>As noted in <a class="xref" href="ch15.html#retrieving_file_information_colon_stat_o" title="Retrieving File Information: stat()">Retrieving File Information: <span class="emphasis"><em>stat()</em></span></a>, the
                    bottom 12 bits of the <span class="emphasis"><em>st_mode</em></span> field of the
                        <span class="emphasis"><em>stat</em></span> structure define the permissions for a file. The
                    first 3 of these bits are special bits known as the set-user-ID, set-group-ID,
                    and sticky bits (labeled U, G, and T, respectively, in <a class="xref" href="ch15.html#layout_of_st_underscore_mode_bit_mask" title="Figure 15-1. Layout of st_mode bit mask">Figure 15-1</a>). We say more about these
                    bits in <a class="xref" href="ch15.html#set-user-id_comma_set-group-id_comma_and" title="Set-User-ID, Set-Group-ID, and Sticky Bits">Set-User-ID, Set-Group-ID, and Sticky Bits</a>. The
                    remaining 9 bits form the mask defining the permissions that are granted to
                    various categories of users accessing the file. The file permissions mask
                    divides the world into three categories:<a id="IDX-CHP-15-2082" class="indexterm"/><a id="IDX-CHP-15-2083" class="indexterm"/><a id="IDX-CHP-15-2084" class="indexterm"/><a id="IDX-CHP-15-2085" class="indexterm"/><a id="IDX-CHP-15-2086" class="indexterm"/><a id="IDX-CHP-15-2087" class="indexterm"/><a id="IDX-CHP-15-2088" class="indexterm"/><a id="IDX-CHP-15-2089" class="indexterm"/><a id="IDX-CHP-15-2090" class="indexterm"/><a id="IDX-CHP-15-2091" class="indexterm"/><a id="IDX-CHP-15-2092" class="indexterm"/><a id="IDX-CHP-15-2093" class="indexterm"/><a id="IDX-CHP-15-2094" class="indexterm"/><a id="IDX-CHP-15-2095" class="indexterm"/><a id="IDX-CHP-15-2096" class="indexterm"/><a id="IDX-CHP-15-2097" class="indexterm"/><a id="IDX-CHP-15-2098" class="indexterm"/><a id="IDX-CHP-15-2099" class="indexterm"/><a id="IDX-CHP-15-2100" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>Owner</em></span> (also known as <span class="emphasis"><em>user</em></span>):
                            The permissions granted to the owner of the file.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The term <span class="emphasis"><em>user</em></span> is used by commands such as
                                    <span class="emphasis"><em>chmod(1)</em></span>, which uses the abbreviation
                                    <span class="emphasis"><em>u</em></span> to refer to this permission
                                category.</p></div></li><li class="listitem"><p><span class="emphasis"><em>Group</em></span>: The permissions granted to users who are
                            members of the file’s group.</p></li><li class="listitem"><p><span class="emphasis"><em>Other</em></span>: The permissions granted to everyone
                            else.</p></li></ul></div><p>Three permissions may be granted to each user category:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>Read</em></span>: The contents of the file may be
                            read.</p></li><li class="listitem"><p><span class="emphasis"><em>Write</em></span>: The contents of the file may be
                            changed.</p></li><li class="listitem"><p><span class="emphasis"><em>Execute</em></span>: The file may be executed (i.e., it is a
                            program or a script). In order to execute a script file (e.g., a
                                <span class="emphasis"><em>bash</em></span> script), both read and execute permissions
                            are required.</p></li></ul></div><p>The permissions and ownership of a file can be viewed using the command
                        <span class="emphasis"><em>ls -l</em></span>, as in the following example:</p><a id="I_programlisting15_d1e38402"/><pre class="programlisting">$ <strong class="userinput"><code>ls -l myscript.sh</code></strong>
-<strong class="userinput"><code>rwxr-x---</code></strong>    1 mtk      users        1667 Jan 15 09:22 myscript.sh</pre><p>In the above example, the file permissions are displayed as <code class="literal">rwxr-x---</code> (the initial hyphen preceding this
                    string indicates the type of this file: a regular file). To interpret this
                    string, we break these 9 characters into sets of 3 characters, which
                    respectively indicate whether read, write, and execute permission are enabled.
                    The first set indicates the permissions for owner, which has read, write, and
                    execute permissions enabled. The next set indicates the permissions for group,
                    which has read and execute enabled, but not write. The final set are the
                    permissions for other, which doesn’t have any permissions enabled.<a id="IDX-CHP-15-2101" class="indexterm"/></p><p>The <code class="literal">&lt;sys/stat.h&gt;</code> header file
                    defines constants that can be ANDed (<code class="literal">&amp;</code>) with <span class="emphasis"><em>st_mode</em></span> of the
                        <span class="emphasis"><em>stat</em></span> structure, in order to check whether particular
                    permission bits are set. (These constants are also defined via the inclusion of
                        <code class="literal">&lt;fcntl.h&gt;</code>, which prototypes
                    the <span class="emphasis"><em>open()</em></span> system call.) These constants are shown in <a class="xref" href="ch15.html#constants_for_file_permission_bits" title="Table 15-4. Constants for file permission bits">Table 15-4</a>.</p><div class="table"><a id="constants_for_file_permission_bits"/><div class="table-title">Table 15-4. Constants for file permission bits</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/><col class="col3"/></colgroup><thead><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>Constant</p>
                                </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>Octal value</p>
                                </td><td style="text-align: left; vertical-align: bottom; border-bottom: 0.5pt solid ; ">
                                    <p>Permission bit</p>
                                </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_ISUID</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">04000</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Set-user-ID</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_ISGID</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">02000</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Set-group-ID</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_ISVTX</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">01000</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Sticky</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IRUSR</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">0400</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>User-read</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IWUSR</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">0200</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>User-write</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IXUSR</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">0100</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>User-execute</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IRGRP</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">040</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Group-read</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IWGRP</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">020</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Group-write</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IXGRP</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">010</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Group-execute</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IROTH</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">04</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Other-read</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IWOTH</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">02</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Other-write</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">S_IXOTH</code>
                                    </p>
                                </td><td style="text-align: right; vertical-align: top; border-right: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">01</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; ">
                                    <p>Other-execute</p>
                                </td></tr></tbody></table></div></div><p>In addition to the constants shown in <a class="xref" href="ch15.html#constants_for_file_permission_bits" title="Table 15-4. Constants for file permission bits">Table 15-4</a>, three constants are defined
                    to equate to masks for all three permissions for each of the categories owner,
                    group, and other: <code class="literal">S_IRWXU</code> (0700), <code class="literal">S_IRWXG</code> (070), and <code class="literal">S_IRWXO</code> (07).</p><p>The header file in <a class="xref" href="ch15.html#header_file_for_file_underscore_perms.c" title="Example 15-3. Header file for file_perms.c">Example 15-3</a>
                    declares a function, <span class="emphasis"><em>filePermStr()</em></span>, which, given a file
                    permissions mask, returns a statically allocated string representation of that
                    mask in the same style as is used by <span class="emphasis"><em>ls(1)</em></span>.<a id="IDX-CHP-15-2102" class="indexterm"/></p><div class="example"><a id="header_file_for_file_underscore_perms.c"/><div class="example-title">Example 15-3. Header file for <code class="literal">file_perms.c</code></div><div class="example-contents"><pre class="programlisting"><strong class="userinput"><code>files/file_perms.h</code></strong>
#ifndef FILE_PERMS_H
#define FILE_PERMS_H

#include &lt;sys/types.h&gt;

#define FP_SPECIAL 1            /* Include set-user-ID, set-group-ID, and sticky
                                   bit information in returned string */

char *filePermStr(mode_t perm, int flags);

#endif
      <strong class="userinput"><code>files/file_perms.h</code></strong></pre></div></div><p>If the <code class="literal">FP_SPECIAL</code> flag is set in the
                        <span class="emphasis"><em>filePermStr() flags</em></span> argument, then the returned string
                    includes the settings of the set-user-ID, set-group-ID, and sticky bits, again
                    in the style of <span class="emphasis"><em>ls(1)</em></span>.</p><p>The implementation of the <span class="emphasis"><em>filePermStr()</em></span> function is shown
                    in <a class="xref" href="ch15.html#convert_file_permissions_mask_to_string" title="Example 15-4. Convert file permissions mask to string">Example 15-4</a>. We employ this
                    function in the program in <a class="xref" href="ch15.html#retrieving_and_interpreting_file_stat_in" title="Example 15-1. Retrieving and interpreting file stat information">Example 15-1</a>.</p><div class="example"><a id="convert_file_permissions_mask_to_string"/><div class="example-title">Example 15-4. Convert file permissions mask to string</div><div class="example-contents"><pre class="programlisting"><strong class="userinput"><code>files/file_perms.c</code></strong>
#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;
#include "file_perms.h"                 /* Interface for this implementation */

#define STR_SIZE sizeof("rwxrwxrwx")

char *          /* Return ls(1)-style string for file permissions mask */
filePermStr(mode_t perm, int flags)
{
    static char str[STR_SIZE];

    snprintf(str, STR_SIZE, "%c%c%c%c%c%c%c%c%c",
        (perm &amp; S_IRUSR) ? 'r' : '-', (perm &amp; S_IWUSR) ? 'w' : '-',
        (perm &amp; S_IXUSR) ?
            (((perm &amp; S_ISUID) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 's' : 'x') :
            (((perm &amp; S_ISUID) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 'S' : '-'),
        (perm &amp; S_IRGRP) ? 'r' : '-', (perm &amp; S_IWGRP) ? 'w' : '-',
        (perm &amp; S_IXGRP) ?
            (((perm &amp; S_ISGID) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 's' : 'x') :
            (((perm &amp; S_ISGID) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 'S' : '-'),
        (perm &amp; S_IROTH) ? 'r' : '-', (perm &amp; S_IWOTH) ? 'w' : '-',
        (perm &amp; S_IXOTH) ?
            (((perm &amp; S_ISVTX) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 't' : 'x') :
            (((perm &amp; S_ISVTX) &amp;&amp; (flags &amp; FP_SPECIAL)) ? 'T' : '-'));

    return str;
}
      <strong class="userinput"><code>files/file_perms.c</code></strong></pre></div></div></div><div class="sect2" title="Permissions on Directories"><div class="titlepage"><div><div><h3 class="title" id="permissions_on_directories">Permissions on Directories</h3></div></div></div><p>Directories have the same permission scheme as files. However, the three
                    permissions are interpreted differently:<a id="IDX-CHP-15-2103" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>Read</em></span>: The contents (i.e., the list of filenames)
                            of the directory may be listed (e.g., by
                            <span class="emphasis"><em>ls</em></span>).</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If experimenting to verify the operation of the directory read
                                permission bit, be aware that some Linux distributions alias the
                                    <span class="emphasis"><em>ls</em></span> command to include flags (e.g.,
                                    <span class="emphasis"><em>-F</em></span>) that require access to i-node
                                information for files in the directory, and this requires execute
                                permission on the directory. To ensure that we are using an
                                unadulterated ls, we can specify the full pathname of the command
                                    <code class="literal">(/bin/ls)</code>.<a id="IDX-CHP-15-2104" class="indexterm"/><a id="IDX-CHP-15-2105" class="indexterm"/></p></div></li><li class="listitem"><p><span class="emphasis"><em>Write</em></span>: Files may be created in and removed from
                            the directory. Note that it is not necessary to have any permission on a
                            file itself in order to be able to delete it.</p></li><li class="listitem"><p><span class="emphasis"><em>Execute</em></span>: Files within the directory may be
                            accessed. Execute permission on a directory is sometimes called
                                <span class="emphasis"><em>search</em></span> permission.</p></li></ul></div><p>When accessing a file, execute permission is required on all of the
                    directories listed in the pathname. For example, reading the file <code class="literal">/home/mtk/x</code> would require execute permission on
                        <code class="literal">/</code>, <code class="literal">/home</code>, and <code class="literal">/home/mtk</code> (as well
                    as read permission on the file <code class="literal">x</code> itself). If
                    the current working directory is <code class="literal">/home/mtk/sub1</code> and we access the relative pathname <code class="literal">../sub2/x</code>, then we need execute permission on
                        <code class="literal">/home/mtk</code> and <code class="literal">/home/mtk/sub2</code> (but not on <code class="literal">/</code>
                    or <code class="literal">/home</code>).</p><p>Read permission on a directory only lets us view the list of filenames in the
                    directory. We must have execute permission on the directory in order to access
                    the contents or the i-node information of files in the directory.</p><p>Conversely, if we have execute permission on a directory, but not read
                    permission, then we can access a file in the directory if we know its name, but
                    we can’t list the contents of (i.e., the other filenames in) the directory. This
                    is a simple and frequently used technique to control access to the contents of a
                    public directory.</p><p>To add or remove files in a directory, we need both execute and write
                    permissions on the directory.</p></div><div class="sect2" title="Permission-Checking Algorithm"><div class="titlepage"><div><div><h3 class="title" id="permission-checking_algorithm">Permission-Checking Algorithm</h3></div></div></div><p>The kernel checks file permissions whenever we specify a pathname in a system
                    call that accesses a file or directory. When the pathname given to the system
                    call includes a directory prefix, then, in addition to checking for the required
                    permissions on the file itself, the kernel also checks for execute permission on
                    each of the directories in this prefix. Permission checks are made using the
                    process’s effective user ID, effective group ID, and supplementary group IDs.
                    (To be strictly accurate, for file permission checks on Linux, the file-system
                    user and group IDs are used instead of the corresponding effective IDs, as
                    described in Section 9.5.)<a id="IDX-CHP-15-2106" class="indexterm"/><a id="IDX-CHP-15-2107" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Once a file has been opened with <span class="emphasis"><em>open()</em></span>, no
                        permission checking is performed by subsequent system calls that work with
                        the returned file descriptor (such as <span class="emphasis"><em>read()</em></span>,
                            <span class="emphasis"><em>write()</em></span>, <span class="emphasis"><em>fstat()</em></span>,
                            <span class="emphasis"><em>fcntl()</em></span>, and <span class="emphasis"><em>mmap()</em></span>).</p></div><p>The rules applied by the kernel when checking permissions are as
                    follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>If the process is privileged, all access is granted.</p></li><li class="listitem"><p>If the effective user ID of the process is the same as the user ID
                            (owner) of the file, then access is granted according to the
                                <span class="emphasis"><em>owner</em></span> permissions on the file. For example,
                            read access is granted if the owner-read permission bit is turned on in
                            the file permissions mask; otherwise, read access is denied.</p></li><li class="listitem"><p>If the effective group ID of the process or any of the process
                            supplementary group IDs matches the group ID (group owner) of the file,
                            then access is granted according to the <span class="emphasis"><em>group</em></span>
                            permissions on the file.</p></li><li class="listitem"><p>Otherwise, access is granted according to the
                                <span class="emphasis"><em>other</em></span> permissions on the file.</p></li></ol></div><div class="note" title="Note"><h3 class="title">Note</h3><p>In the kernel code, the above tests are actually constructed so that the
                        test to see whether a process is privileged is performed only if the process
                        is not granted the permissions it needs via one of the other tests. This is
                        done to avoid unnecessarily setting the <code class="literal">ASU</code> process accounting flag, which indicates that the process
                        made use of superuser privileges (<a class="xref" href="ch28.html#process_accounting" title="Process Accounting">Process Accounting</a>).</p></div><p>The checks against owner, group, and other permissions are done in order, and
                    checking stops as soon as the applicable rule is found. This can have an
                    unexpected consequence: if, for example, the permissions for group exceed those
                    of owner, then the owner will actually have fewer permissions on the file than
                    members of the file’s group, as illustrated by the following example:</p><a id="I_programlisting15_d1e38834"/><pre class="programlisting">$ <strong class="userinput"><code>echo 'Hello world' &gt; a.txt</code></strong>
$ <strong class="userinput"><code>ls -l a.txt</code></strong>
-rw-r--r--   1 mtk    users    12 Jun 18 12:26 a.txt
$ <strong class="userinput"><code>chmod u-rw a.txt</code></strong>               <em class="lineannotation"><span class="lineannotation">Remove read and write permission from owner</span></em>
$ <strong class="userinput"><code>ls -l a.txt</code></strong>
----r--r--   1 mtk    users    12 Jun 18 12:26 a.txt
$ <strong class="userinput"><code>cat a.txt</code></strong>
cat: a.txt: Permission denied    <em class="lineannotation"><span class="lineannotation">Owner can no longer read file</span></em>
$ <strong class="userinput"><code>su avr</code></strong>                         <em class="lineannotation"><span class="lineannotation">Become someone else...</span></em>
Password:
$ <strong class="userinput"><code>groups</code></strong>                         <em class="lineannotation"><span class="lineannotation">who is in the group owning the file...</span></em>
users staff teach cs
$ <strong class="userinput"><code>cat a.txt</code></strong>                      <em class="lineannotation"><span class="lineannotation">and thus can read the file</span></em>
Hello world</pre><p>Similar remarks apply if other grants more permissions than owner or
                    group.</p><p>Since file permissions and ownership information are maintained within a file
                    i-node, all filenames (links) that refer to the same i-node share this
                    information.</p><p>Linux 2.6 provides access control lists (ACLs), which make it possible to
                    define file permissions on a per-user and per-group basis. If a file has an ACL,
                    then a modified version of the above algorithm is used. We describe ACLs in
                        <a class="xref" href="ch17.html" title="Chapter 17. Access Control Lists">Chapter 17</a>.</p><div class="sect3" title="Permission checking for privileged processes"><div class="titlepage"><div><div><h4 class="title" id="permission_checking_for_privileged_proce">Permission checking for privileged processes</h4></div></div></div><p>Above, we said that if a process is privileged, all access is granted when
                        checking permissions. We need to add one proviso to this statement. For a
                        file that is not a directory, Linux grants execute permission to a
                        privileged process only if that permission is granted to at least one of the
                        permission categories for the file. On some other UNIX implementations, a
                        privileged process can execute a file even when no permission category
                        grants execute permission. When accessing a directory, a privileged process
                        is always granted execute (search) permission.<a id="IDX-CHP-15-2108" class="indexterm"/><a id="IDX-CHP-15-2109" class="indexterm"/><a id="IDX-CHP-15-2110" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>We can rephrase our description of a privileged process in terms of
                            two Linux process capabilities: <code class="literal">CAP_DAC_READ_SEARCH</code> and <code class="literal">CAP_DAC_OVERRIDE</code> (<a class="xref" href="ch39.html#the_linux_capabilities" title="The Linux Capabilities">The Linux Capabilities</a>). A process with the <code class="literal">CAP_DAC_READ_SEARCH</code> capability always has read permission
                            for any type of file, and always has read and execute permissions for a
                            directory (i.e., can always access files in a directory and read the
                            list of files in a directory). A process with the <code class="literal">CAP_DAC_OVERRIDE</code> capability always has
                            read and write permissions for any type of file, and also has execute
                            permission if the file is a directory or if execute permission is
                            granted to at least one of the permission categories for the
                                file.<a id="IDX-CHP-15-2111" class="indexterm"/><a id="IDX-CHP-15-2112" class="indexterm"/></p></div></div></div><div class="sect2" title="Checking File Accessibility: access()"><div class="titlepage"><div><div><h3 class="title" id="checking_file_accessibility_colon_access">Checking File Accessibility: <span class="emphasis"><em>access()</em></span></h3></div></div></div><p>As noted in <a class="xref" href="ch15.html#permission-checking_algorithm" title="Permission-Checking Algorithm">Permission-Checking Algorithm</a>, the
                        <span class="emphasis"><em>effective</em></span> user and group IDs, as well as supplementary
                    group IDs, are used to determine the permissions a process has when accessing a
                    file. It is also possible for a program (e.g., a set-user-ID or set-group-ID
                    program) to check file accessibility based on the <span class="emphasis"><em>real</em></span> user
                    and group IDs of the process.<a id="IDX-CHP-15-2113" class="indexterm"/><a id="IDX-CHP-15-2114" class="indexterm"/><a id="IDX-CHP-15-2115" class="indexterm"/><a id="IDX-CHP-15-2116" class="indexterm"/><a id="IDX-CHP-15-2117" class="indexterm"/></p><p>The <span class="emphasis"><em>access()</em></span> system call checks the accessibility of the
                    file specified in <span class="emphasis"><em>pathname</em></span> based on a process’s real user
                    and group IDs (and supplementary group IDs).</p><a id="I_programlisting15_d1e38982"/><pre class="programlisting">#include &lt;unistd.h&gt;

int <strong class="userinput"><code>access</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, int <span class="emphasis"><em>mode</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Returns 0 if all permissions are granted, otherwise -1</p></div><p>If <span class="emphasis"><em>pathname</em></span> is a symbolic link,
                        <span class="emphasis"><em>access()</em></span> dereferences it.</p><p>The <span class="emphasis"><em>mode</em></span> argument is a bit mask consisting of one or more
                    of the constants shown in <a class="xref" href="ch15.html#mode_constants_for_access_open_parenthes" title="Table 15-5. mode constants for access()">Table 15-5</a>, ORed (<code class="literal">|</code>) together. If all of the permissions specified
                    in <span class="emphasis"><em>mode</em></span> are granted on <span class="emphasis"><em>pathname</em></span>, then
                        <span class="emphasis"><em>access()</em></span> returns 0; if at least one of the requested
                    permissions is not available (or an error occurred), then
                        <span class="emphasis"><em>access()</em></span> returns -1.</p><div class="table"><a id="mode_constants_for_access_open_parenthes"/><div class="table-title">Table 15-5. <span class="emphasis"><em>mode</em></span> constants for
                        <span class="emphasis"><em>access()</em></span></div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/></colgroup><thead><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>Constant</p>
                                </td><td style="text-align: left; vertical-align: bottom; border-bottom: 0.5pt solid ; ">
                                    <p>Description</p>
                                </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">F_OK</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Does the file exist?</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">R_OK</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Can the file be read?</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">W_OK</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                    <p>Can the file be written?</p>
                                </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                    <p>
                                        <code class="literal">X_OK</code>
                                    </p>
                                </td><td style="text-align: left; vertical-align: top; ">
                                    <p>Can the file be executed?</p>
                                </td></tr></tbody></table></div></div><p>The time gap between a call to <span class="emphasis"><em>access()</em></span> and a subsequent
                    operation on a file means that there is no guarantee that the information
                    returned by <span class="emphasis"><em>access()</em></span> will still be true at the time of the
                    later operation (no matter how brief the interval). This situation could lead to
                    security holes in some application designs.</p><p>Suppose, for example, that we have a set-user-ID-<span class="emphasis"><em>root</em></span>
                    program that uses <span class="emphasis"><em>access()</em></span> to check that a file is
                    accessible to the real user ID of the program, and, if so, performs an operation
                    on the file (e.g., <span class="emphasis"><em>open()</em></span> or
                    <span class="emphasis"><em>exec()</em></span>).</p><p>The problem is that if the pathname given to <span class="emphasis"><em>access()</em></span> is
                    a symbolic link, and a malicious user manages to change the link so that it
                    refers to a different file before the second step, then the
                        set-user-ID-<span class="emphasis"><em>root</em></span> may end up operating on a file for
                    which the real user ID does not have permission. (This is an example of the type
                    of time-of-check, time-of-use race condition described in Section 38.6.) For
                    this reason, recommended practice is to avoid the use of
                        <span class="emphasis"><em>access()</em></span> altogether (see, for example, [Borisov,
                    2005]). In the example just given, we can achieve this by temporarily changing
                    the effective (or file system) user ID of the set-user-ID process, attempting
                    the desired operation (e.g., <span class="emphasis"><em>open()</em></span> or
                        <span class="emphasis"><em>exec()</em></span>), and then checking the return value and
                        <span class="emphasis"><em>errno</em></span> to determine whether the operation failed because
                    of a permissions problem.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The GNU C library provides an analogous, nonstandard function,
                            <span class="emphasis"><em>euidaccess()</em></span> (or synonymously,
                            <span class="emphasis"><em>eaccess()</em></span>), that checks file access permissions
                        using the effective user ID of the process.<a id="IDX-CHP-15-2118" class="indexterm"/><a id="IDX-CHP-15-2119" class="indexterm"/></p></div></div><div class="sect2" title="Set-User-ID, Set-Group-ID, and Sticky Bits"><div class="titlepage"><div><div><h3 class="title" id="set-user-id_comma_set-group-id_comma_and">Set-User-ID, Set-Group-ID, and Sticky Bits</h3></div></div></div><p>As well as the 9 bits used for owner, group, and other permissions, the file
                    permissions mask contains 3 additional bits, known as the
                        <span class="emphasis"><em>set-user-ID</em></span> (bit 04000),
                        <span class="emphasis"><em>set-group-ID</em></span> (bit 02000), and
                        <span class="emphasis"><em>sticky</em></span> (bit 01000) bits. We have already discussed the
                    use of the set-user-ID and set-group-ID permission bits for creating privileged
                    programs in Section 9.3. The set-group-ID bit also serves two other purposes
                    that we describe elsewhere: controlling the group ownership of new files created
                    in a directory mounted with the <span class="emphasis"><em>nogrpid</em></span> option (<a class="xref" href="ch15.html#ownership_of_new_files" title="Ownership of New Files">Ownership of New Files</a>), and enabling mandatory locking on a
                    file (<a class="xref" href="ch55.html#mandatory_locking" title="Mandatory Locking">Mandatory Locking</a>). In the remainder of this section, we
                    limit our discussion to the use of the sticky bit.<a id="IDX-CHP-15-2120" class="indexterm"/><a id="IDX-CHP-15-2121" class="indexterm"/><a id="IDX-CHP-15-2122" class="indexterm"/><a id="IDX-CHP-15-2123" class="indexterm"/><a id="IDX-CHP-15-2124" class="indexterm"/></p><p>On older UNIX implementations, the sticky bit was provided as a way of making
                    commonly used programs run faster. If the sticky bit was set on a program file,
                    then the first time the program was executed, a copy of the program text was
                    saved in the swap area—thus it <span class="emphasis"><em>sticks</em></span> in swap, and loads
                    faster on subsequent executions. Modern UNIX implementations have more
                    sophisticated memory-management systems, which have rendered this use of the
                    sticky permission bit obsolete.<a id="IDX-CHP-15-2125" class="indexterm"/><a id="IDX-CHP-15-2126" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>The name of the constant for the sticky permission bit shown in <a class="xref" href="ch15.html#constants_for_file_permission_bits" title="Table 15-4. Constants for file permission bits">Table 15-4</a>, <code class="literal">S_ISVTX</code>, derives from an alternative name for the sticky bit:
                        the <span class="emphasis"><em>saved-text</em></span> bit.</p></div><p>In modern UNIX implementations (including Linux), the sticky permission bit
                    serves another, quite different purpose. For directories, the sticky bit acts as
                    the <span class="emphasis"><em>restricted deletion</em></span> flag. Setting this bit on a
                    directory means that an unprivileged process can unlink
                        (<span class="emphasis"><em>unlink()</em></span>, <span class="emphasis"><em>rmdir()</em></span>) and rename
                        (<span class="emphasis"><em>rename()</em></span>) files in the directory only if it has write
                    permission on the directory <span class="emphasis"><em>and</em></span> owns either the file or the
                    directory. (A process with the <code class="literal">CAP_FOWNER</code>
                    capability can bypass the latter ownership check.) This makes it possible to
                    create a directory that is shared by many users, who can each create and delete
                    their own files in the directory but can’t delete files owned by other users.
                    The sticky permission bit is commonly set on the <code class="literal">/tmp</code> directory for this reason.<a id="IDX-CHP-15-2127" class="indexterm"/><a id="IDX-CHP-15-2128" class="indexterm"/><a id="IDX-CHP-15-2129" class="indexterm"/><a id="IDX-CHP-15-2130" class="indexterm"/><a id="IDX-CHP-15-2131" class="indexterm"/></p><p>A file’s sticky permission bit is set via the <span class="emphasis"><em>chmod</em></span>
                    command (<span class="emphasis"><em>chmod +t file</em></span>) or via the
                        <span class="emphasis"><em>chmod()</em></span> system call. If the sticky bit for a file is
                    set, <span class="emphasis"><em>ls -l</em></span> shows a lowercase or uppercase letter
                        <span class="emphasis"><em>T</em></span> in the other-execute permission field, depending on
                    whether the other-execute permission bit is on or off, as in the
                    following:</p><a id="I_programlisting15_d1e39267"/><pre class="programlisting">$ <strong class="userinput"><code>touch tfile</code></strong>
$ <strong class="userinput"><code>ls -l tfile</code></strong>
-rw-r--r--   1 mtk    users     0 Jun 23 14:44 tfile
$ <strong class="userinput"><code>chmod +t tfile</code></strong>
$ <strong class="userinput"><code>ls -l tfile</code></strong>
-rw-r--r-T   1 mtk    users     0 Jun 23 14:44 tfile
$ <strong class="userinput"><code>chmod o+x tfile</code></strong>
$ <strong class="userinput"><code>ls -l tfile</code></strong>
-rw-r--r-t   1 mtk    users     0 Jun 23 14:44 tfile</pre></div><div class="sect2" title="The Process File Mode Creation Mask: umask()"><div class="titlepage"><div><div><h3 class="title" id="the_process_file_mode_creation_mask_colo">The Process File Mode Creation Mask: <span class="emphasis"><em>umask()</em></span></h3></div></div></div><p>We now consider in more detail the permissions that are placed on a newly
                    created file or directory. For new files, the kernel uses the permissions
                    specified in the <span class="emphasis"><em>mode</em></span> argument to
                        <span class="emphasis"><em>open()</em></span> or <span class="emphasis"><em>creat()</em></span>. For new
                    directories, permissions are set according to the <span class="emphasis"><em>mode</em></span>
                    argument to <span class="emphasis"><em>mkdir()</em></span>. However, these settings are modified
                    by the file mode creation mask, also known simply as the
                        <span class="emphasis"><em>umask</em></span>. The umask is a process attribute that specifies
                    which permission bits should always be turned <span class="emphasis"><em>off</em></span> when new
                    files or directories are created by the process.<a id="IDX-CHP-15-2133" class="indexterm"/><a id="IDX-CHP-15-2134" class="indexterm"/><a id="IDX-CHP-15-2135" class="indexterm"/><a id="IDX-CHP-15-2136" class="indexterm"/><a id="IDX-CHP-15-2137" class="indexterm"/><a id="IDX-CHP-15-2138" class="indexterm"/><a id="IDX-CHP-15-2139" class="indexterm"/><a id="IDX-CHP-15-2132" class="indexterm"/></p><p>Often, a process just uses the umask it inherits from its parent shell, with
                    the (usually desirable) consequence that the user can control the umask of
                    programs executed from the shell using the shell built-in command
                        <span class="emphasis"><em>umask</em></span>, which changes the umask of the shell
                    process.</p><p>The initialization files for most shells set the default umask to the octal
                    value 022 (<code class="literal">----w--w-</code>). This value specifies
                    that write permission should always be turned off for group and other. Thus,
                    assuming the <span class="emphasis"><em>mode</em></span> argument in a call to
                        <span class="emphasis"><em>open()</em></span> is 0666 (i.e., read and write permitted for all
                    users, which is typical), then new files are created with read and write
                    permissions for owner, and only read permission for everyone else (displayed by
                        <span class="emphasis"><em>ls -l</em></span> as <code class="literal">rw-r--r--</code>).
                    Correspondingly, assuming that the <span class="emphasis"><em>mode</em></span> argument to
                        <span class="emphasis"><em>mkdir()</em></span> is specified as 0777 (i.e., all permissions
                    granted to all users), new directories are created with all permissions granted
                    for owner, and just read and execute permissions for group and other (i.e.,
                        <code class="literal">rwxr-xr-x</code>).</p><p>The <span class="emphasis"><em>umask()</em></span> system call changes a process’s umask to the
                    value specified in <span class="emphasis"><em>mask</em></span>.<a id="IDX-CHP-15-2140" class="indexterm"/></p><a id="I_programlisting15_d1e39407"/><pre class="programlisting">#include &lt;sys/stat.h&gt;

mode_t <strong class="userinput"><code>umask</code></strong>(mode_t <span class="emphasis"><em>mask</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Always successfully returns the previous process umask</p></div><p>The <span class="emphasis"><em>mask</em></span> argument can be specified either as an octal
                    number or by ORing (<code class="literal">|</code>) together the constants
                    listed in <a class="xref" href="ch15.html#constants_for_file_permission_bits" title="Table 15-4. Constants for file permission bits">Table 15-4</a>.</p><p>A call to <span class="emphasis"><em>umask()</em></span> is always successful, and returns the
                    previous umask.</p><p><a class="xref" href="ch15.html#using_umask_open_parenthesis_close_paren" title="Example 15-5. Using umask()">Example 15-5</a> illustrates the use
                    of <span class="emphasis"><em>umask()</em></span> in conjunction with <span class="emphasis"><em>open()</em></span>
                    and <span class="emphasis"><em>mkdir()</em></span>. When we run this program, we see the
                    following:</p><a id="I_programlisting15_d1e39445"/><pre class="programlisting">$ <strong class="userinput"><code>./t_umask</code></strong>
Requested file perms: rw-rw----             <em class="lineannotation"><span class="lineannotation">This is what we asked for</span></em>
Process umask:        ----wx-wx             <em class="lineannotation"><span class="lineannotation">This is what we are denied</span></em>
Actual file perms:    rw-r-----             <em class="lineannotation"><span class="lineannotation">So this is what we end up with</span></em>

Requested dir. perms: rwxrwxrwx
Process umask:        ----wx-wx
Actual dir. perms:    rwxr--r--</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>In <a class="xref" href="ch15.html#using_umask_open_parenthesis_close_paren" title="Example 15-5. Using umask()">Example 15-5</a>, we employ
                        the <span class="emphasis"><em>mkdir()</em></span> and <span class="emphasis"><em>rmdir()</em></span> system
                        calls to create and remove a directory, and the
                            <span class="emphasis"><em>unlink()</em></span> system call to remove a file. We describe
                        these system calls in <a class="xref" href="ch18.html" title="Chapter 18. Directories and Links">Chapter 18</a>.</p></div><div class="example"><a id="using_umask_open_parenthesis_close_paren"/><div class="example-title">Example 15-5. Using <span class="emphasis"><em>umask()</em></span></div><div class="example-contents"><pre class="programlisting"><strong class="userinput"><code>files/t_umask.c</code></strong>
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include "file_perms.h"
#include "tlpi_hdr.h"

#define MYFILE "myfile"
#define MYDIR  "mydir"
#define FILE_PERMS    (S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP)
#define DIR_PERMS     (S_IRWXU | S_IRWXG | S_IRWXO)
#define UMASK_SETTING (S_IWGRP | S_IXGRP | S_IWOTH | S_IXOTH)

int
main(int argc, char *argv[])
{
    int fd;
    struct stat sb;
    mode_t u;

    umask(UMASK_SETTING);

    fd = open(MYFILE, O_RDWR | O_CREAT | O_EXCL, FILE_PERMS);
    if (fd == -1)
        errExit("open-%s", MYFILE);
    if (mkdir(MYDIR, DIR_PERMS) == -1)
        errExit("mkdir-%s", MYDIR);

    u = umask(0);               /* Retrieves (and clears) umask value */

    if (stat(MYFILE, &amp;sb) == -1)
        errExit("stat-%s", MYFILE);
    printf("Requested file perms: %s\n", filePermStr(FILE_PERMS, 0));
    printf("Process umask:        %s\n", filePermStr(u, 0));
    printf("Actual file perms:    %s\n\n", filePermStr(sb.st_mode, 0));

    if (stat(MYDIR, &amp;sb) == -1)
        errExit("stat-%s", MYDIR);
    printf("Requested dir. perms: %s\n", filePermStr(DIR_PERMS, 0));
    printf("Process umask:        %s\n", filePermStr(u, 0));
    printf("Actual dir. perms:    %s\n", filePermStr(sb.st_mode, 0));

    if (unlink(MYFILE) == -1)
        errMsg("unlink-%s", MYFILE);
    if (rmdir(MYDIR) == -1)
        errMsg("rmdir-%s", MYDIR);
    exit(EXIT_SUCCESS);
}
     <strong class="userinput"><code>files/t_umask.c</code></strong></pre></div></div></div><div class="sect2" title="Changing File Permissions: chmod() and fchmod()"><div class="titlepage"><div><div><h3 class="title" id="changing_file_permissions_colon_chmod_op">Changing File Permissions: <span class="emphasis"><em>chmod()</em></span> and
                        <span class="emphasis"><em>fchmod()</em></span></h3></div></div></div><p>The <span class="emphasis"><em>chmod()</em></span> and <span class="emphasis"><em>fchmod()</em></span> system
                    calls change the permissions of a file.<a id="IDX-CHP-15-2143" class="indexterm"/><a id="IDX-CHP-15-2144" class="indexterm"/><a id="IDX-CHP-15-2145" class="indexterm"/><a id="IDX-CHP-15-2146" class="indexterm"/><a id="IDX-CHP-15-2147" class="indexterm"/><a id="IDX-CHP-15-2148" class="indexterm"/><a id="IDX-CHP-15-2149" class="indexterm"/><a id="IDX-CHP-15-2141" class="indexterm"/><a id="IDX-CHP-15-2142" class="indexterm"/></p><a id="I_programlisting15_d1e39555"/><pre class="programlisting">#include &lt;sys/stat.h&gt;

int <strong class="userinput"><code>chmod</code></strong>(const char *<span class="emphasis"><em>pathname</em></span>, mode_t <span class="emphasis"><em>mode</em></span>);
int <strong class="userinput"><code>fchmod</code></strong>(int <span class="emphasis"><em>fd</em></span>, mode_t <span class="emphasis"><em>mode</em></span>);</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Both return 0 on success, or -1 on error</p></div><p>The <span class="emphasis"><em>chmod()</em></span> system call changes the permissions of the
                    file named in <span class="emphasis"><em>pathname</em></span>. If this argument is a symbolic
                    link, <span class="emphasis"><em>chmod()</em></span> changes the permissions of the file to which
                    it refers, rather than the permissions of the link itself. (A symbolic link is
                    always created with read, write, and execute permissions enabled for all users,
                    and these permission can’t be changed. These permissions are ignored when
                    dereferencing the link.)</p><p>The <span class="emphasis"><em>fchmod()</em></span> system call changes the permissions on the
                    file referred to by the open file descriptor <span class="emphasis"><em>fd</em></span>.</p><p>The <span class="emphasis"><em>mode</em></span> argument specifies the new permissions of the
                    file, either numerically (octal) or as a mask formed by ORing (|) the permission
                    bits listed in <a class="xref" href="ch15.html#constants_for_file_permission_bits" title="Table 15-4. Constants for file permission bits">Table 15-4</a>. In order to
                    change the permissions on a file, either the process must be privileged
                        (<code class="literal">CAP_FOWNER</code>) or its effective user ID
                    must match the owner (user ID) of the file. (To be strictly accurate, on Linux,
                    for an unprivileged process, it is the process’s file-system user ID, rather
                    than its effective user ID, that must match the user ID of the file, as
                    described in Section 9.5.)</p><p>To set the permissions on a file so that only read permission is granted to
                    all users, we could use the following call:</p><a id="I_programlisting15_d1e39610"/><pre class="programlisting">if (chmod("myfile", S_IRUSR | S_IRGRP | S_IROTH) == -1)
    errExit("chmod");
/* Or equivalently: chmod("myfile", 0444); */</pre><p>In order to modify selected bits of the file permissions, we first retrieve
                    the existing permissions using <span class="emphasis"><em>stat()</em></span>, tweak the bits we
                    want to change, and then use <span class="emphasis"><em>chmod()</em></span> to update the
                    permissions:</p><a id="I_programlisting15_d1e39620"/><pre class="programlisting">struct stat sb;
mode_t mode;

if (stat("myfile", &amp;sb) == -1)
    errExit("stat");
mode = (sb.st_mode | S_IWUSR) &amp; ~S_IROTH;
       /* owner-write on, other-read off, remaining bits unchanged */
if (chmod("myfile", mode) == -1)
    errExit("chmod");</pre><p>The above is equivalent to the following shell command:</p><a id="I_programlisting15_d1e39625"/><pre class="programlisting">$ <strong class="userinput"><code>chmod u+w,o-r myfile</code></strong></pre><p>In <a class="xref" href="ch15.html#ownership_of_new_files" title="Ownership of New Files">Ownership of New Files</a>, we noted that if a directory
                    resides on an <span class="emphasis"><em>ext2</em></span> system mounted with the <span class="emphasis"><em>-o
                        bsdgroups</em></span> option, or on one mounted with the <span class="emphasis"><em>-o
                        sysvgroups</em></span> option <span class="emphasis"><em>and</em></span> the set-group-ID
                    permission bit is turned on for the directory, then a newly created file in the
                    directory takes its ownership from the parent directory, not the effective group
                    ID of the creating process. It may be the case that the group ID of such a file
                    doesn’t match any of the group IDs of the creating process. For this reason,
                    when an unprivileged process (one that doesn’t have the <code class="literal">CAP_FSETID</code> capability) calls <span class="emphasis"><em>chmod()</em></span> (or
                        <span class="emphasis"><em>fchmod()</em></span>) on a file whose group ID is not equal to the
                    effective group ID or any of the supplementary group IDs of the process, the
                    kernel always clears the set-group-ID permission bit. This is a security measure
                    designed to prevent a user from creating a set-group-ID program for a group of
                    which they are not a member. The following shell commands show the attempted
                    exploit that this measure prevents:<a id="IDX-CHP-15-2150" class="indexterm"/><a id="IDX-CHP-15-2151" class="indexterm"/></p><a id="I_programlisting15_d1e39663"/><pre class="programlisting">$ <strong class="userinput"><code>mount | grep test</code></strong>                <em class="lineannotation"><span class="lineannotation">Hmmm,</span></em> /test <em class="lineannotation"><span class="lineannotation">is mounted with -o bsdgroups</span></em>
/dev/sda9 on /test type ext3 (rw,bsdgroups)
$ <strong class="userinput"><code>ls -ld /test</code></strong>                     <em class="lineannotation"><span class="lineannotation">Directory has GID root, writable by anyone</span></em>
drwxrwxrwx   3 root   root    4096 Jun 30 20:11 /test
$ <strong class="userinput"><code>id</code></strong>                               <em class="lineannotation"><span class="lineannotation">I'm an ordinary user, not part of root group</span></em>
uid=1000(mtk) gid=100(users) groups=100(users),101(staff),104(teach)
$ <strong class="userinput"><code>cd /test</code></strong>
$ <strong class="userinput"><code>cp ~/myprog .</code></strong>                    <em class="lineannotation"><span class="lineannotation">Copy some mischievous program here</span></em>
$ <strong class="userinput"><code>ls -l myprog</code></strong>                     <em class="lineannotation"><span class="lineannotation">Hey! It's in the root group!</span></em>
-rwxr-xr-x   1 mtk    root   19684 Jun 30 20:43 myprog
$ <strong class="userinput"><code>chmod g+s myprog</code></strong>                 <em class="lineannotation"><span class="lineannotation">Can I make it set-group-ID to root?</span></em>
$ <strong class="userinput"><code>ls -l myprog</code></strong>                     <em class="lineannotation"><span class="lineannotation">Hmm, no...</span></em>
-rwxr-xr-x   1 mtk    root   19684 Jun 30 20:43 myprog</pre></div></div><div class="sect1" title="I-node Flags (ext2 Extended File Attributes)"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="i-node_flags_open_parenthesis_ext2_exten">I-node Flags (<span class="emphasis"><em>ext2</em></span> Extended File Attributes)</h2></div></div></div><p>Some Linux file systems allow various <span class="emphasis"><em>i-node flags</em></span> to be set
                on files and directories. This feature is a nonstandard Linux extension.<a id="IDX-CHP-15-2152" class="indexterm"/><a id="IDX-CHP-15-2153" class="indexterm"/><a id="IDX-CHP-15-2154" class="indexterm"/><a id="IDX-CHP-15-2155" class="indexterm"/><a id="IDX-CHP-15-2156" class="indexterm"/><a id="IDX-CHP-15-2157" class="indexterm"/><a id="IDX-CHP-15-2158" class="indexterm"/><a id="IDX-CHP-15-2159" class="indexterm"/><a id="IDX-CHP-15-2160" class="indexterm"/><a id="IDX-CHP-15-2161" class="indexterm"/><a id="IDX-CHP-15-2162" class="indexterm"/><a id="IDX-CHP-15-2163" class="indexterm"/><a id="IDX-CHP-15-2164" class="indexterm"/><a id="IDX-CHP-15-2165" class="indexterm"/><a id="IDX-CHP-15-2166" class="indexterm"/><a id="IDX-CHP-15-2167" class="indexterm"/><a id="IDX-CHP-15-2168" class="indexterm"/><a id="IDX-CHP-15-2169" class="indexterm"/><a id="IDX-CHP-15-2170" class="indexterm"/><a id="IDX-CHP-15-2171" class="indexterm"/><a id="IDX-CHP-15-2172" class="indexterm"/><a id="IDX-CHP-15-2173" class="indexterm"/><a id="IDX-CHP-15-2174" class="indexterm"/><a id="IDX-CHP-15-2175" class="indexterm"/><a id="IDX-CHP-15-2176" class="indexterm"/><a id="IDX-CHP-15-2177" class="indexterm"/><a id="IDX-CHP-15-2178" class="indexterm"/><a id="IDX-CHP-15-2179" class="indexterm"/><a id="IDX-CHP-15-2180" class="indexterm"/><a id="IDX-CHP-15-2181" class="indexterm"/><a id="IDX-CHP-15-2182" class="indexterm"/><a id="IDX-CHP-15-2183" class="indexterm"/><a id="IDX-CHP-15-2184" class="indexterm"/><a id="IDX-CHP-15-2185" class="indexterm"/><a id="IDX-CHP-15-2186" class="indexterm"/><a id="IDX-CHP-15-2187" class="indexterm"/><a id="IDX-CHP-15-2188" class="indexterm"/><a id="IDX-CHP-15-2189" class="indexterm"/><a id="IDX-CHP-15-2190" class="indexterm"/><a id="IDX-CHP-15-2191" class="indexterm"/><a id="IDX-CHP-15-2192" class="indexterm"/><a id="IDX-CHP-15-2193" class="indexterm"/><a id="IDX-CHP-15-2194" class="indexterm"/><a id="IDX-CHP-15-2195" class="indexterm"/><a id="IDX-CHP-15-2196" class="indexterm"/><a id="IDX-CHP-15-2197" class="indexterm"/><a id="IDX-CHP-15-2198" class="indexterm"/><a id="IDX-CHP-15-2199" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>The modern BSDs provide a similar feature to i-node flags in the form of file
                    flags set using <span class="emphasis"><em>chflags(1)</em></span> and
                        <span class="emphasis"><em>chflags(2)</em></span>.</p></div><p>The first Linux file system to support i-node flags was <span class="emphasis"><em>ext2</em></span>,
                and these flags are sometimes referred to as <span class="emphasis"><em>ext2 extended file
                    attributes</em></span>. Subsequently, support for i-node flags has been added on
                other file systems, including <span class="emphasis"><em>Btrfs</em></span>, <span class="emphasis"><em>ext3</em></span>,
                    <span class="emphasis"><em>ext4</em></span>, <span class="emphasis"><em>Reiserfs</em></span> (since Linux 2.4.19),
                    <span class="emphasis"><em>XFS</em></span> (since Linux 2.4.25 and 2.6), and
                    <span class="emphasis"><em>JFS</em></span> (since Linux 2.6.17).</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The range of i-node flags supported varies somewhat across file systems. In
                    order to use i-node flags on a <span class="emphasis"><em>Reiserfs</em></span> file system, we
                    must use the <span class="emphasis"><em>mount -o attrs</em></span> option when mounting the file
                    system.</p></div><p>From the shell, i-node flags can be set and viewed using the
                    <span class="emphasis"><em>chattr</em></span> and <span class="emphasis"><em>lsattr</em></span> commands, as shown
                in the following example:</p><a id="I_programlisting15_d1e40017"/><pre class="programlisting">$ <strong class="userinput"><code>lsattr myfile</code></strong>
-------- myfile
$ <strong class="userinput"><code>chattr +ai myfile</code></strong>               <em class="lineannotation"><span class="lineannotation">Turn on Append Only and Immutable flags</span></em>
$ <strong class="userinput"><code>lsattr myfile</code></strong>
----ia-- myfile</pre><p>Within a program, i-node flags can be retrieved and modified using the
                    <span class="emphasis"><em>ioctl()</em></span> system call, as detailed shortly.</p><p>I-node flags can be set on both regular files and directories. Most i-node flags
                are intended for use with regular files, although some of them also (or only) have
                meaning for directories. <a class="xref" href="ch15.html#i-node_flags" title="Table 15-6. I-node flags">Table 15-6</a> summarizes the range of
                available i-node flags, showing the corresponding flag name (defined in <code class="literal">&lt;linux/fs.h&gt;</code>) that is used from programs
                in <span class="emphasis"><em>ioctl()</em></span> calls, and the option letter that is used with the
                    <span class="emphasis"><em>chattr</em></span> command.<a id="IDX-CHP-15-2200" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Before Linux 2.6.19, the <code class="literal">FS_*</code> constants
                    shown in <a class="xref" href="ch15.html#i-node_flags" title="Table 15-6. I-node flags">Table 15-6</a> were not defined in <code class="literal">&lt;linux/fs.h&gt;</code>. Instead, there was a
                    set of file system–specific header files that defined file system-specific
                    constant names, all with the same value. Thus, <span class="emphasis"><em>ext2</em></span> had
                        <code class="literal">EXT2_APPEND_FL</code>, defined in <code class="literal">&lt;linux/ext2_fs.h&gt;</code>;
                        <span class="emphasis"><em>Reiserfs</em></span> had <code class="literal">REISERFS_APPEND_FL</code>, defined with the same value in <code class="literal">&lt;linux/reiser_fs.h&gt;</code>; and so on.
                    Since each of the header files defines the corresponding constants with the same
                    value, on older systems that don’t provide the definitions in <code class="literal">&lt;linux/fs.h&gt;</code>, it is possible to
                    include any of the header files and use the file system–specific names.</p></div><div class="table"><a id="i-node_flags"/><div class="table-title">Table 15-6. I-node flags</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col1"/><col class="col2"/><col class="col3"/></colgroup><thead><tr><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>Constant</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p><span class="emphasis"><em>chattr</em></span> option</p>
                            </td><td style="text-align: left; vertical-align: bottom; border-bottom: 0.5pt solid ; ">
                                <p>Purpose</p>
                            </td></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_APPEND_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">a</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Append only (privilege required)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_COMPR_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">c</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Enable file compression (not implemented)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_DIRSYNC_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">D</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Synchronous directory updates (since Linux 2.6)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_IMMUTABLE_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">i</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Immutable (privilege required)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_JOURNAL_DATA_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">j</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Enable data journaling (privilege required)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_NOATIME_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">A</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Don’t update file last access time<a id="IDX-CHP-15-2201" class="indexterm"/></p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_NODUMP_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">d</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>No dump</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_NOTAIL_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">t</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>No tail packing</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_SECRM_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">s</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Secure deletion (not implemented)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_SYNC_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">S</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Synchronous file (and directory) updates</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_TOPDIR_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">T</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; border-bottom: 0.5pt solid ; ">
                                <p>Treat as top-level directory for Orlov (since Linux
                                    2.6)</p>
                            </td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">FS_UNRM_FL</code>
                                </p>
                            </td><td style="text-align: center; vertical-align: top; border-right: 0.5pt solid ; ">
                                <p>
                                    <code class="literal">u</code>
                                </p>
                            </td><td style="text-align: left; vertical-align: top; ">
                                <p>File can be undeleted (not implemented)</p>
                            </td></tr></tbody></table></div></div><p>The various <code class="literal">FL_*</code> flags and their meanings are
                as follows:</p><div class="variablelist"><dl><dt><span class="term">
                        <code class="literal">FS_APPEND_FL</code>
                    </span></dt><dd><p>The file can be opened for writing only if the <code class="literal">O_APPEND</code> flag is specified (thus forcing
                            all file updates to append to the end of the file). This flag could be
                            used for a log file, for example. Only privileged (<code class="literal">CAP_LINUX_IMMUTABLE</code>) processes can set
                            this flag.</p></dd><dt><span class="term">
                        <code class="literal">FS_COMPR_FL</code>
                    </span></dt><dd><p>Store the file on disk in a compressed format. This feature is not
                            implemented as a standard part of any of the major native Linux file
                            systems. (There are packages that implement this feature for
                                <span class="emphasis"><em>ext2</em></span> and <span class="emphasis"><em>ext3</em></span>.) Given the
                            low cost of disk storage, the CPU overhead involved in compression and
                            decompression, and the fact that compressing a file means that it is no
                            longer a simple matter to randomly access the file’s contents (via
                                <span class="emphasis"><em>lseek()</em></span>), file compression is undesirable for
                            many applications.<a id="IDX-CHP-15-2202" class="indexterm"/></p></dd><dt><span class="term"><code class="literal">FS_DIRSYNC_FL</code> (since Linux 2.6)</span></dt><dd><p>Make directory updates (e.g., <span class="emphasis"><em>open(pathname,
                                O_CREAT)</em></span>, <span class="emphasis"><em>link()</em></span>,
                                <span class="emphasis"><em>unlink()</em></span>, and <span class="emphasis"><em>mkdir()</em></span>)
                            synchronous. This is analogous to the synchronous file update mechanism
                            described in Section 13.3. As with synchronous file updates, there is a
                            performance impact associated with synchronous directory updates. This
                            setting can be applied only to directories. (The <code class="literal">MS_DIRSYNC</code> mount flag described in <a class="xref" href="ch14.html#mounting_a_file_system_colon_mount_open" title="Mounting a File System: mount()">Mounting a File System: <span class="emphasis"><em>mount()</em></span></a> provides similar
                            functionality, but on a per-mount basis.)</p></dd><dt><span class="term">
                        <code class="literal">FS_IMMUTABLE_FL</code>
                    </span></dt><dd><p>Make the file immutable. File data can’t be updated
                                (<span class="emphasis"><em>write()</em></span> and <span class="emphasis"><em>truncate()</em></span>)
                            and metadata changes are prevented (e.g., <span class="emphasis"><em>chmod()</em></span>,
                                <span class="emphasis"><em>chown()</em></span>, <span class="emphasis"><em>unlink()</em></span>,
                                <span class="emphasis"><em>link()</em></span>, <span class="emphasis"><em>rename()</em></span>,
                                <span class="emphasis"><em>rmdir()</em></span>, <span class="emphasis"><em>utime()</em></span>,
                                <span class="emphasis"><em>setxattr()</em></span>, and
                                <span class="emphasis"><em>removexattr()</em></span>). Only privileged (<code class="literal">CAP_LINUX_IMMUTABLE</code>) processes can set
                            this flag for a file. When this flag is set, even a privileged process
                            can’t change the file contents or metadata.</p></dd><dt><span class="term">
                        <code class="literal">FS_JOURNAL_DATA_FL</code>
                    </span></dt><dd><p>Enable journaling of data. This flag is supported only on the
                                <span class="emphasis"><em>ext3</em></span> and <span class="emphasis"><em>ext4</em></span> file
                            systems. These file systems provide three levels of journaling:
                                <span class="emphasis"><em>journal</em></span>, <span class="emphasis"><em>ordered</em></span>, and
                                <span class="emphasis"><em>writeback</em></span>. All modes journal updates to file
                            metadata, but the <span class="emphasis"><em>journal</em></span> mode additionally
                            journals updates to file data. On a file system that is journaling in
                                <span class="emphasis"><em>ordered</em></span> or <span class="emphasis"><em>writeback</em></span> mode,
                            a privileged <code class="literal">(CAP_SYS_RESOURCE)</code>
                            process can enable journaling of data updates on a per-file basis by
                            setting this flag. (The <span class="emphasis"><em>mount(8)</em></span> manual page
                            describes the difference between the <span class="emphasis"><em>ordered</em></span> and
                                <span class="emphasis"><em>writeback</em></span> modes.)</p></dd><dt><span class="term">
                        <code class="literal">FS_NOATIME_FL</code>
                    </span></dt><dd><p>Don’t update the file last access time when the file is accessed. This
                            eliminates the need to update the file’s i-node each time the file is
                            accessed, thus improving I/O performance (see the description of the
                                <code class="literal">MS_NOATIME</code> flag in <a class="xref" href="ch14.html#mounting_a_file_system_colon_mount_open" title="Mounting a File System: mount()">Mounting a File System: <span class="emphasis"><em>mount()</em></span></a>).<a id="IDX-CHP-15-2203" class="indexterm"/></p></dd><dt><span class="term">
                        <code class="literal">FS_NODUMP_FL</code>
                    </span></dt><dd><p>Don’t include this file in backups made using
                                <span class="emphasis"><em>dump(8)</em></span>. The effect of this flag is dependent
                            on the <span class="emphasis"><em>-h</em></span> option described in the
                                <span class="emphasis"><em>dump(8)</em></span> manual page.</p></dd><dt><span class="term">
                        <code class="literal">FS_NOTAIL_FL</code>
                    </span></dt><dd><p>Disable tail packing. This flag is supported only on the
                                <span class="emphasis"><em>Reiserfs</em></span> file system. It disables the
                                <span class="emphasis"><em>Reiserfs</em></span> tail-packing feature, which tries to
                            pack small files (and the final fragment of larger files) into the same
                            disk block as the file metadata. Tail packing can also be disabled for
                            an entire <span class="emphasis"><em>Reiserfs</em></span> file system by mounting it with
                            the <span class="emphasis"><em>mount -o notail</em></span> option.<a id="IDX-CHP-15-2204" class="indexterm"/></p></dd><dt><span class="term">
                        <code class="literal">FS_SECRM_FL</code>
                    </span></dt><dd><p>Delete the file securely. The intended purpose of this unimplemented
                            feature is that, when removed, a file is securely deleted, meaning that
                            it is first overwritten to prevent a disk-scanning program from reading
                            or re-creating it. (The issue of truly secure deletion is rather
                            complex: it can actually require multiple writes on magnetic media to
                            securely erase previously recorded data; see [Gutmann, 1996].)</p></dd><dt><span class="term">
                        <code class="literal">FS_SYNC_FL</code>
                    </span></dt><dd><p>Make file updates synchronous. When applied to files, this flag causes
                            writes to the file to be synchronous (as though the <code class="literal">O_SYNC</code> flag was specified on all opens of
                            this file). When applied to a directory, this flag has the same effect
                            as the synchronous directory updates flag described above.</p></dd><dt><span class="term"><code class="literal">FS_TOPDIR_FL</code> (since Linux 2.6)</span></dt><dd><p>This marks a directory for special treatment under the
                                <span class="emphasis"><em>Orlov</em></span> block-allocation strategy. The Orlov
                            strategy is a BSD-inspired modification of the <span class="emphasis"><em>ext2</em></span>
                            block-allocation strategy that tries to improve the chances that related
                            files (e.g., the files within a single directory) are placed close to
                            each other on disk, which can improve disk seek times. For details, see
                            [Corbet, 2002] and [Kumar, et al. 2008]. <code class="literal">FS_TOPDIR_FL</code> has an effect only for
                                <span class="emphasis"><em>ext2</em></span> and its descendants,
                                <span class="emphasis"><em>ext3</em></span> and <span class="emphasis"><em>ext4</em></span>.</p></dd><dt><span class="term">
                        <code class="literal">FS_UNRM_FL</code>
                    </span></dt><dd><p>Allow this file to be recovered (undeleted) if it is deleted. This
                            feature is not implemented, since it is possible to implement
                            file-recovery mechanisms outside the kernel.</p></dd></dl></div><p>Generally, when i-node flags are set on a directory, they are automatically
                inherited by new files and subdirectories created in that directory. There are
                exceptions to this rule:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">FS_DIRSYNC_FL</code> (<span class="emphasis"><em>chattr
                            +D</em></span>) flag, which can be applied only to a directory, is
                        inherited only by subdirectories created in that directory.</p></li><li class="listitem"><p>When the <code class="literal">FS_IMMUTABLE_FL</code>
                            (<span class="emphasis"><em>chattr +i</em></span>) flag is applied to a directory, it is
                        not inherited by files and subdirectories created within that directory,
                        since this flag prevents new entries being added to the directory.</p></li></ul></div><p>Within a program, i-node flags can be retrieved and modified using the
                    <span class="emphasis"><em>ioctl()</em></span>
                <code class="literal">FS_IOC_GETFLAGS</code> and <code class="literal">FS_IOC_SETFLAGS</code> operations. (These constants are defined in <code class="literal">&lt;linux/fs.h&gt;</code>.) The following code shows
                how to enable the <code class="literal">FS_NOATIME_FL</code> flag on the file
                referred to by the open file descriptor <span class="emphasis"><em>fd</em></span>:<a id="IDX-CHP-15-2205" class="indexterm"/></p><a id="I_programlisting15_d1e40570"/><pre class="programlisting">int attr;

if (ioctl(fd, FS_IOC_GETFLAGS, &amp;attr) == -1)    /* Fetch current flags */
    errExit("ioctl");
attr |= FS_NOATIME_FL;
if (ioctl(fd, FS_IOC_SETFLAGS, &amp;attr) == -1)    /* Update flags */
    errExit("ioctl");</pre><p>In order to change the i-node flags of a file, either the effective user ID of the
                process must match the user ID (owner) of the file, or the process must be
                privileged (<code class="literal">CAP_FOWNER</code>). (To be strictly
                accurate, on Linux, for an unprivileged process it is the process’s file-system user
                ID, rather than its effective user ID, that must match the user ID of the file, as
                described in Section 9.5.)</p></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summary-id14">Summary</h2></div></div></div><p>The <span class="emphasis"><em>stat()</em></span> system call retrieves information about a file
                (metadata), most of which is drawn from the file i-node. This information includes
                file ownership, file permissions, and file timestamps.<a id="IDX-CHP-15-2206" class="indexterm"/><a id="IDX-CHP-15-2207" class="indexterm"/><a id="IDX-CHP-15-2208" class="indexterm"/></p><p>A program can update a file’s last access time and last modification time using
                    <span class="emphasis"><em>utime()</em></span>, <span class="emphasis"><em>utimes()</em></span>, and various similar
                interfaces.</p><p>Each file has an associated user ID (owner) and group ID, as well as a set of
                permission bits. For permissions purposes, file users are divided into three
                categories: <span class="emphasis"><em>owner</em></span> (also known as <span class="emphasis"><em>user</em></span>),
                    <span class="emphasis"><em>group</em></span>, and <span class="emphasis"><em>other</em></span>. Three permissions
                may be granted to each category of user: <span class="emphasis"><em>read</em></span>,
                    <span class="emphasis"><em>write</em></span>, and <span class="emphasis"><em>execute</em></span>. The same scheme is
                used with directories, although the permission bits have slightly different
                meanings. The <span class="emphasis"><em>chown()</em></span> and <span class="emphasis"><em>chmod()</em></span> system
                calls change the ownership and permissions of a file. The
                    <span class="emphasis"><em>umask()</em></span> system call sets a mask of permission bits that are
                always turned off when the calling process creates a file.</p><p>Three additional permission bits are used for files and directories. The
                set-user-ID and set-group-ID permission bits can be applied to program files to
                create programs that cause the executing process to gain privilege by assuming a
                different effective user or group identity (that of the program file). For
                directories residing on file systems mounted using the <span class="emphasis"><em>nogrpid</em></span>
                    (<span class="emphasis"><em>sysvgroups</em></span>) option, the set-group-ID permission bit can be
                used to control whether new files created in the directory inherit their group ID
                from the process’s effective group ID or from the parent directory’s group ID. When
                applied to directories, the sticky permission bit acts as the restricted deletion
                flag.</p><p>I-node flags control the various behaviors of files and directories. Although
                originally defined for <span class="emphasis"><em>ext2</em></span>, these flags are now supported on
                several other file systems.</p></div><div class="sect1" title="Exercises"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="exercises-id10">Exercises</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="ch15.html#file_permissions" title="File Permissions">File Permissions</a> contained several statements about the
                        permissions required for various file-system operations. Use shell commands
                        or write programs to verify or answer the following:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Removing all owner permissions from a file denies the file owner
                                access, even though group and other do have access.</p></li><li class="listitem"><p>On a directory with read permission but not execute permission,
                                the names of files in the directory can be listed, but the files
                                themselves can’t be accessed, regardless of the permissions on
                                them.</p></li><li class="listitem"><p>What permissions are required on the parent directory and the file
                                itself in order to create a new file, open a file for reading, open
                                a file for writing, and delete a file? What permissions are required
                                on the source and target directory to rename a file? If the target
                                file of a rename operation already exists, what permissions are
                                required on that file? How does setting the sticky permission bit
                                    (<span class="emphasis"><em>chmod +t</em></span>) of a directory affect renaming
                                and deletion operations?</p></li></ol></div></li><li class="listitem"><p>Do you expect any of a file’s three timestamps to be changed by the
                            <span class="emphasis"><em>stat()</em></span> system call? If not, explain why.</p></li><li class="listitem"><p>On a system running Linux 2.6, modify the program in <a class="xref" href="ch15.html#retrieving_and_interpreting_file_stat_in" title="Example 15-1. Retrieving and interpreting file stat information">Example 15-1</a> (<code class="literal">t_stat.c</code>) so that the file timestamps are
                        displayed with nanosecond accuracy.</p></li><li class="listitem"><p>The <span class="emphasis"><em>access()</em></span> system call checks permissions using the
                        process’s real user and group IDs. Write a corresponding function that
                        performs the checks according to the process’s effective user and group
                        IDs.</p></li><li class="listitem"><p>As noted in <a class="xref" href="ch15.html#the_process_file_mode_creation_mask_colo" title="The Process File Mode Creation Mask: umask()">The Process File Mode Creation Mask: <span class="emphasis"><em>umask()</em></span></a>,
                            <span class="emphasis"><em>umask()</em></span> always sets the process umask and, at the
                        same time, returns a copy of the old umask. How can we obtain a copy of the
                        current process umask while leaving it unchanged?<a id="IDX-CHP-15-2209" class="indexterm"/></p></li><li class="listitem"><p>The <span class="emphasis"><em>chmod a+rX file</em></span> command enables read permission
                        for all categories of user, and likewise enables execute permission for all
                        categories of user if <span class="emphasis"><em>file</em></span> is a directory or execute
                        permission is enabled for any of the user categories for
                            <span class="emphasis"><em>file</em></span>, as demonstrated in the following
                        example:</p><a id="I_programlisting15_d1e40719"/><pre class="programlisting">$ <strong class="userinput"><code>ls -ld dir file prog</code></strong>
dr--------  2 mtk users    48 May  4 12:28 dir
-r--------  1 mtk users 19794 May  4 12:22 file
-r-x------  1 mtk users 19336 May  4 12:21 prog
$ <strong class="userinput"><code>chmod a+rX dir file prog</code></strong>
$ <strong class="userinput"><code>ls -ld dir file prog</code></strong>
dr-xr-xr-x  2 mtk users    48 May  4 12:28 dir
-r--r--r--  1 mtk users 19794 May  4 12:22 file
-r-xr-xr-x  1 mtk users 19336 May  4 12:21 prog</pre><p>Write a program that uses <span class="emphasis"><em>stat()</em></span> and
                            <span class="emphasis"><em>chmod()</em></span> to perform the equivalent of
                            <span class="emphasis"><em>chmod a+rX</em></span>.</p></li><li class="listitem"><p>Write a simple version of the <span class="emphasis"><em>chattr(1)</em></span> command,
                        which modifies file i-node flags. See the <span class="emphasis"><em>chattr(1)</em></span> man
                        page for details of the <span class="emphasis"><em>chattr</em></span> command-line interface.
                        (You don’t need to implement the <span class="emphasis"><em>-R</em></span>,
                            <span class="emphasis"><em>-V</em></span>, and <span class="emphasis"><em>-v</em></span> options.)</p></li></ol></div></div></section></body></html>
