<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>10.4 Single-Queue Scheduling</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part108.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part110.htm">下一个 &gt;</a></p><p class="s40" style="padding-top: 4pt;padding-left: 11pt;text-indent: 0pt;text-align: justify;">10.4 Single-Queue Scheduling</p><p style="padding-top: 3pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">With this background in place, we now discuss how to build a sched- uler for a multiprocessor system. The most basic approach is to simply reuse the basic framework for single processor scheduling, by putting all jobs that need to be scheduled into a single queue; we call this <b>single- queue multiprocessor scheduling </b>or <b>SQMS </b>for short. This approach has the advantage of simplicity; it does not require much work to take an existing policy that picks the best job to run next and adapt it to work on more than one CPU (where it might pick the best two jobs to run, if there are two CPUs, for example).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">However, SQMS has obvious shortcomings. The first problem is a lack of <b>scalability</b>. To ensure the scheduler works correctly on multiple CPUs, the developers will have inserted some form of <b>locking </b>into the code, as described above. Locks ensure that when SQMS code accesses the single queue (say, to find the next job to run), the proper outcome arises.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: right;">Locks, unfortunately, can greatly reduce performance, particularly as the number of CPUs in the systems grows [A91]. As contention for such a single lock increases, the system spends more and more time in lock overhead and less time doing the work the system should be doing (note: it would be great to include a real measurement of this in here someday). The second main problem with SQMS is cache affinity. For example,</p><p style="padding-left: 68pt;text-indent: 0pt;line-height: 89%;text-align: left;">let us assume we have five jobs to run (<span class="s43">A</span>, <span class="s43">B</span>, <span class="s43">C</span>, <span class="s43">D</span>, <span class="s43">E</span>) and four processors. Our scheduling queue thus looks like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="217" height="22" alt="image" src="Image_113.png"/></span></p><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">A</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">B</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">C</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">D</p><p style="text-indent: 0pt;text-align: left;"/><p class="s67" style="text-indent: 0pt;line-height: 8pt;text-align: left;">E</p><p style="text-indent: 0pt;text-align: left;"/><p class="s47" style="padding-top: 3pt;padding-left: 38pt;text-indent: 0pt;text-align: right;">Queue</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s65" style="padding-left: 54pt;text-indent: 0pt;text-align: center;">NULL</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: left;">Over time, assuming each job runs for a time slice and then another job is chosen, here is a possible job schedule across CPUs:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-top: 3pt;padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 2</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 3</p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">E</p></td><td style="width:20pt" bgcolor="#000000"><p class="s79" style="padding-top: 3pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">B</p></td></tr><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">E</p></td><td style="width:19pt" bgcolor="#000000"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">C</p></td></tr><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">E</p></td><td style="width:19pt" bgcolor="#000000"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">D</p></td></tr><tr style="height:20pt"><td style="width:19pt" bgcolor="#000000"><p class="s79" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">C</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">E</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">Because each CPU simply picks the next job to run from the globally- shared queue, each job ends up bouncing around from CPU to CPU, thus doing exactly the opposite of what would make sense from the stand- point of cache affinity.</p><p style="padding-left: 68pt;text-indent: 12pt;line-height: 89%;text-align: justify;">To handle this problem, most SQMS schedulers include some kind of affinity mechanism to try to make it more likely that process will continue to run on the same CPU if possible. Specifically, one might provide affin- ity for some jobs, but move others around to balance load. For example, imagine the same five jobs scheduled as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-top: 3pt;padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 0</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 2</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s76" style="padding-left: 38pt;text-indent: 0pt;text-align: right;">CPU 3</p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">E</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 3pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">A</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt"><p class="s78" style="padding-top: 3pt;text-indent: 0pt;text-align: center;">A</p></td></tr><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">E</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#A8A8A8"><p class="s79" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">B</p></td></tr><tr style="height:20pt"><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">C</p></td><td style="width:20pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;padding-right: 5pt;text-indent: 0pt;text-align: right;">C</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">E</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#D3D3D3"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">C</p></td></tr><tr style="height:20pt"><td style="width:77pt" colspan="4" bgcolor="#000000"><p class="s79" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D D D D</p></td><td style="width:19pt;border-top-style:solid;border-top-width:1pt;border-left-style:solid;border-left-width:1pt;border-bottom-style:solid;border-bottom-width:1pt;border-right-style:solid;border-right-width:1pt" bgcolor="#7F7F7F"><p class="s78" style="padding-top: 4pt;text-indent: 0pt;text-align: center;">E</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-top: 4pt;padding-left: 54pt;text-indent: 0pt;text-align: center;">... (repeat) ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">In this arrangement, jobs <span class="s43">A </span>through <span class="s43">D </span>are not moved across proces- sors, with only job <span class="s43">E </span><b>migrating </b>from CPU to CPU, thus preserving affin- ity for most. You could then decide to migrate a different job the next time through, thus achieving some kind of affinity fairness as well. Im- plementing such a scheme, however, can be complex.</p><p style="padding-left: 41pt;text-indent: 11pt;line-height: 89%;text-align: justify;">Thus, we can see the SQMS approach has its strengths and weak- nesses. It is straightforward to implement given an existing single-CPU scheduler, which by definition has only a single queue. However, it does not scale well (due to synchronization overheads), and it does not readily preserve cache affinity.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part108.htm">&lt; 上一个</a><span> | </span><a href="../ostep.html">内容</a><span> | </span><a href="part110.htm">下一个 &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
